<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.5.0"/>
    <title>velosearaptor.madcp API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../velosearaptor.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;velosearaptor</a>

            <img src="https://github.com/modscripps/velosearaptor/raw/main/logo/velosearaptor.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="class" href="#ProcessADCP">ProcessADCP</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ProcessADCP.__init__">ProcessADCP</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.meta_data">meta_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.ibad">ibad</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.logdir">logdir</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.verbose">verbose</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.parse_file_locations">parse_file_locations</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.pressure_lp">pressure_lp</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.default_dgridparams">default_dgridparams</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.parse_dgridparams">parse_dgridparams</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.parse_tgridparams">parse_tgridparams</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.parse_editparams">parse_editparams</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.parse_driftparams">parse_driftparams</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.make_start_ddays">make_start_ddays</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.read_ensemble">read_ensemble</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.magdec">magdec</a>
                        </li>
                        <li>
                                <a class="variable" href="#ProcessADCP.raw">raw</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.process_pings">process_pings</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.average_ensembles">average_ensembles</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.burst_average_ensembles">burst_average_ensembles</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.plot_echo_stats">plot_echo_stats</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.plot_pressure">plot_pressure</a>
                        </li>
                        <li>
                                <a class="function" href="#ProcessADCP.generate_binmask">generate_binmask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ProcessADCPyml">ProcessADCPyml</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ProcessADCPyml.__init__">ProcessADCPyml</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                        <a class="pdoc-button git-button" href="https://github.com/modscripps/velosearaptor/blob/main/velosearaptor/madcp.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../velosearaptor.html">velosearaptor</a><wbr>.madcp    </h1>

                        <div class="docstring"><p>Module <a href="">velosearaptor.madcp</a> with functions for moored ADCPs.</p>

<h3 id="general-use">General Use</h3>

<p>Processing a raw ADCP file from a moored deployment is a two-step process.</p>

<ul>
<li>Instantiate a processing object with <code><a href="#ProcessADCP">ProcessADCP</a></code> or <code><a href="#ProcessADCPyml">ProcessADCPyml</a></code>. The
former expects the path to the raw data and a number of dictionaries with
processing parameters as input. The latter reads a .yml file containing the
processing parameters. See the respective docstrings for more information.</li>
<li>Process raw pings and possibly run a ping-averaging method on the data.
Options here are <code><a href="#ProcessADCP.process_pings">ProcessADCP.process_pings</a></code>,
<code><a href="#ProcessADCP.average_ensembles">ProcessADCP.average_ensembles</a></code>, and <code><a href="#ProcessADCP.burst_average_ensembles">ProcessADCP.burst_average_ensembles</a></code>.</li>
</ul>

<h3 id="notes">Notes</h3>

<p>Some general notes for this module.</p>

<h4 id="depth-gridding">Depth Gridding</h4>

<p>The depth vector for the ADCP raw data (in instrument coordinates) is
calculated in <code>pycurrents.rdiraw.FileBBWHOS()</code> as <br>
<code>dep = np.arange(NCells) * CellSize + Bin1Dist</code>
The depth vector thus points to the center of each bin.</p>

<p>From the RDI manual <em>WorkHorse Monitor, Sentinel, Mariner, Quartermaster, and
Long Ranger ADCPs Commands and Output Data Format</em>:</p>

<blockquote>
  <p>This [Bin1Dist] field contains the distance to the middle of the first depth
  cell (bin). This distance is a function of depth cell length (WS), the
  profiling mode (WM), the blank after transmit distance (WF), and speed of
  sound.</p>
</blockquote>
</div>

                        <input id="mod-madcp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-madcp-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="ch">#!/usr/bin/env python</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">&quot;&quot;&quot;Module velosearaptor.madcp with functions for moored ADCPs.</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">### General Use</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">Processing a raw ADCP file from a moored deployment is a two-step process.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">- Instantiate a processing object with `ProcessADCP` or `ProcessADCPyml`. The</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">  former expects the path to the raw data and a number of dictionaries with</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">  processing parameters as input. The latter reads a .yml file containing the</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">  processing parameters. See the respective docstrings for more information.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">- Process raw pings and possibly run a ping-averaging method on the data.</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">  Options here are `ProcessADCP.process_pings`,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">  `ProcessADCP.average_ensembles`, and `ProcessADCP.burst_average_ensembles`.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">### Notes</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">Some general notes for this module.</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">#### Depth Gridding</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">The depth vector for the ADCP raw data (in instrument coordinates) is</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">calculated in :meth:`pycurrents.rdiraw.FileBBWHOS` as &lt;br&gt;</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">`dep = np.arange(NCells) * CellSize + Bin1Dist`</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">The depth vector thus points to the center of each bin.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">From the RDI manual *WorkHorse Monitor, Sentinel, Mariner, Quartermaster, and</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">Long Ranger ADCPs Commands and Output Data Format*:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">&gt; This [Bin1Dist] field contains the distance to the middle of the first depth</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">&gt; cell (bin). This distance is a function of depth cell length (WS), the</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">&gt; profiling mode (WM), the blank after transmit distance (WF), and speed of</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">&gt; sound.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">import</span> <span class="nn">datetime</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">import</span> <span class="nn">pathlib</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">which</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">Popen</span>  <span class="c1"># for magdec</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="kn">import</span> <span class="nn">gsw</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="kn">from</span> <span class="nn">pycurrents.adcp.rdiraw</span> <span class="kn">import</span> <span class="n">Multiread</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="kn">from</span> <span class="nn">pycurrents.adcp.transform</span> <span class="kn">import</span> <span class="n">Transform</span><span class="p">,</span> <span class="n">rdi_xyz_enu</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="kn">from</span> <span class="nn">pycurrents.codas</span> <span class="kn">import</span> <span class="n">to_date</span><span class="p">,</span> <span class="n">to_day</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="kn">from</span> <span class="nn">pycurrents.data</span> <span class="kn">import</span> <span class="n">seawater</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="kn">from</span> <span class="nn">pycurrents.num</span> <span class="kn">import</span> <span class="n">interp1</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="kn">from</span> <span class="nn">pycurrents.num.nptools</span> <span class="kn">import</span> <span class="n">rangeslice</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="kn">from</span> <span class="nn">pycurrents.system</span> <span class="kn">import</span> <span class="n">Bunch</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">tools</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="c1"># Standard logging</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="k">class</span> <span class="nc">ProcessADCP</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Moored ADCP Processing.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    An instance of ProcessADCP is initialized by providing raw data and</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">    processing parameters. Once initialized, the instance method</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">    :meth:`average_ensembles` can be used to average over just a few or</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">    all pings.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">    Magnetic declination is automatically calculated via a call to the command</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">    line tool</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">    [magdec](https://currents.soest.hawaii.edu/hgstage/geomag/file/tip) that</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    must be installed. Once calculated, the magnetic declination is stored in</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">    `magdec` and automatically applied to the data.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    Prior to time averaging, data are edited based on correlation and error</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">    velocity thresholds. The variable `pg` is calculated based on the number of</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">    excluded pings, i.e. it is the numbur of good pings divided by the number</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">    of total pings within one depth bin and one time bin. It may be used to</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">    further filter the data.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">    A pdf document on ADCP data collection and processing principles can be</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">    downloaded from RDI</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">    [here](https://www.comm-tec.com/Docs/Manuali/RDI/BBPRIME.pdf).</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    Time-averaged data are grouped together in an `xarray.Dataset` in the</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">    instance attribute `ds` for easy access and convenient output to netcdf</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">    format.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">    Parameters</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">    ----------</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">    raw_data : str or list or Path</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        Location(s) of raw data.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">    meta_data : dict</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        Dictionary with meta data. At a minimum entries for `lon` and `lat` are</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        needed. If `mooring` and `sn` provide mooring name and serial number</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        then these will be used to name the log file produced during</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        processing.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">    driftparams : dict, optional</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">        Time drift parameters. See notes below.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">    tgridparams : dict, optional</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        Time gridding parameters. See notes below.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    dgridparams : dict, optional</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">        Depth gridding parameters. See notes below.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">    editparams : dict, optional</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">        Editing parameters. See notes below.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">    ibad : int, optional</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        Mark beam with bad data (zero based). Defaults to None.</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">    logdir : str, optional</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        Log file directory. Defaults to `log/`.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        Output more processing info to screen.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">    magdec : float, optional</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">        Magnetic declination in degrees.</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    pressure : xr.DataArray, optional</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        Supply external pressure time series in dbar as xr.DataAarray with</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        coordinate `time`.</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">    use_raw_pressure : bool, optional</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">        Pressure time series is low-pass filtered at 30 minutes or 50 ping</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">        cutoff period, whatever is shorter. Set this to True to use raw</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">        pressure. Defaults to False. Does not matter for burst-averaging</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">        (pressure is averaged over full burst) or when supplying external</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">        pressure time series.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">    pressure_scale_factor : float, optional</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">        Can be used to scale a (likely broken) pressure time series. Defaults</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">        to 1 (no scaling).</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    Attributes</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    ----------</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">    files : list</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">        List pointing to raw data file(s).</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    dday_start : float</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">        Start time of ADCP time series, determined either through `t0` in</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">        `tgridparams` or the start of the time series once at depth.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">    dday_end : float</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        End time of ADCP time series, determined either through `t1` in</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">        `tgridparams` or the end of the time series at depth.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    start_ddays : list</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        Start times of averaging intervals</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    dday_mid : float</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        Time stamp for ping average as determined in :meth:`make_start_ddays`.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">    dt : float</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        Time that is inclusive of one average. For regular averaging, this is</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        `dt_hours` in `tgridparams` converted to Julian days. For</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        burst-averagint, this is a time interval that is inclusive of all pings</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        in one bursts (but goes slightly beyond that into the time between</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">        bursts).</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">    time_drift_rate : float</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">        Clock drift calculated from `driftparams`.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">    orientation : str</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        Instrument orientation `up` or `down`.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">    magdec : float</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">        Magnetic declination.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">    m : pycurrents.adcp.rdiraw.Multiread</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">        Multiread instance.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">    tsdat : Bunch</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        Auxiliary data.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">    raw : xarray.Dataset</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">        Raw ADCP data.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    ds : xarray.Dataset</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        Time-averaged dataset added by running :meth:`average_ensembles`.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">    Notes</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">    -----</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">    Various parameters are passed to the instance through dictionaries. Their</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">    specifics are described below. Gridding and editing parameters can be</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">    updated after creating the ProcessADCP instance via `parse_dgridparams`,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">    `parse_tgridparams`, and  `parse_editparams`.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">    **Time drift parameters**</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">    Provide clock drift parameters via `driftparams`. Accepted entries are</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">    - `end_adcp` : Time of ADCP at data download</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">    - `end_pc` : UTC time at data download</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">    The difference between `end_adcp` and `end_pc` is used to linearly correct</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">    for instrument clock drift.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">    **Time gridding parameters**</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">    Provide time gridding parameters via `tgridparams`. Accepted entries are</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">    - `dt_hours` : Time grid interval. Defaults to 0.5h.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">    - `t0` : Start time for gridding. Determined from data if not provided.</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">    - `t1` : End time for gridding. Determined from data if not provided.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">    - burst_average : bool</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">        Set ensemble averaging to act on burst sampling scheme. Defaults to False.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">    **Depth gridding parameters**</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">    Provide depth gridding parameters via `dgridparams`. Accepted entries are</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">    - `dtop` : Shallow depth in m.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">    - `dbot` : Deep depth in m.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">    - `dinterval` : Vertical grid size in m. Defaults to 5m.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">    Values for `dbot` and `dtop` are generated if not provided.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">    **Editing parameters**</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">    Provide editing parameters via `editparams`.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">    - `max_e`=0.2,  # absolute max e</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">    - `max_e_deviation`=2,  # max in terms of sigma</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">    - `min_correlation`=64,  # 64 is RDI default</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">    - `maskbins` : Array with booleans indexing into the ADCP bins. Use the</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">      convenience method `generate_binmask`.</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">    - `pg_limit` : float or int or None.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">            Percent good limit applied prior to interpolating to the universal</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">            depth grid in `burst_average_ensembles`. Not applied in</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">            `average_ensembles` as the user can filter based on pg later.</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>    <span class="c1"># Default editing parameters.</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="n">_editparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="n">max_e</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># absolute max e</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="n">max_e_deviation</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># max in terms of sigma</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="n">min_correlation</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>  <span class="c1"># 64 is RDI default</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="n">maskbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># do not mask any bins</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="n">pg_limit</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># percent good limit applied in `burst_average_ensembles`</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    <span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">raw_data</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="n">meta_data</span><span class="p">,</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="n">driftparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="n">tgridparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>        <span class="n">dgridparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="n">editparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="n">ibad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="n">magdec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="n">use_raw_pressure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="n">pressure_scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>    <span class="p">):</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">meta_data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ibad</span> <span class="o">=</span> <span class="n">ibad</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="n">logdir</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span> <span class="o">=</span> <span class="n">magdec</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="n">magdec</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="o">=</span> <span class="n">pressure</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span> <span class="o">=</span> <span class="n">pressure_scale_factor</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_use_raw_pressure</span> <span class="o">=</span> <span class="n">use_raw_pressure</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_file_locations</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_data_reader</span><span class="p">()</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_auxiliary_data</span><span class="p">()</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_meta_data</span><span class="p">()</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_logger</span><span class="p">()</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_driftparams</span><span class="p">(</span><span class="n">driftparams</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sysconfig</span><span class="p">()</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_dgridparams</span><span class="p">(</span><span class="n">dgridparams</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_tgridparams</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_editparams</span><span class="p">(</span><span class="n">editparams</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">make_start_ddays</span><span class="p">()</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_pressure</span><span class="p">()</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>    <span class="k">def</span> <span class="nf">parse_file_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">min_file_size</span><span class="o">=</span><span class="mf">1e4</span><span class="p">):</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse input for raw data files.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        Input can either be a single file name as a str, a single file as a</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        Path instance, a list of either of these, or a Path instance pointing to a</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">        directory with raw ADCP files. In the latter case, files that are</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        smaller than a threshold will not be included in the processing.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        Outputs to attribute `files`. The output can be fed to Multiread instances.</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        Parameters</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        ----------</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        raw_data : str or list or Path</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">            Location(s) of raw data.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        min_file_size : int</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">            Minimum size for file to be included. Defaults to 1e4 which</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">            corresponds to about 10kB and is a good value for excluding small</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">            files without any actual data.</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">min_file_size</span><span class="p">):</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="c1"># List all raw files.</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            <span class="n">all_raw_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.00*&quot;</span><span class="p">)))</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>            <span class="c1"># only files larger than about 10kB</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">all_raw_files</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="n">min_file_size</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>            <span class="p">]</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="k">return</span> <span class="n">files</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="n">input_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="k">if</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">raw_data</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">list_dir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">raw_data</span><span class="p">),</span> <span class="n">min_file_size</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_data</span><span class="p">]</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="k">if</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">list_dir</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">min_file_size</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_data</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()]</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>    <span class="k">def</span> <span class="nf">_initiate_data_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiate a Multiread data reader.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">        Adds attribute `m`.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">Multiread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span> <span class="n">sonar</span><span class="o">=</span><span class="s2">&quot;wh&quot;</span><span class="p">,</span> <span class="n">ibad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ibad</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>        <span class="c1"># Make some more meta data readily available by reading a single ping</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="c1"># from the raw data.</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        <span class="n">ping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">Bin1Dist</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">Bin1Dist</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">NCells</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">NCells</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">CellSize</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">CellSize</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>    <span class="k">def</span> <span class="nf">_generate_external_pressure_interpolator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate external pressure to pycurrents time vector.</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">        Parameters</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">        ----------</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">            Data structure.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">        Returns</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">        -------</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">        Interpolator</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="c1"># We already have a function to convert the pycurrents time to</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="c1"># datetime64. Interpolate in this time domain.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="n">time</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">yday0_to_datetime64</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="n">p_interpolated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="c1"># Beginning and end may have NaN&#39;s if the ADCP was started before</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="c1"># the external pressure sensor. Make sure this happens only when</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="c1"># outside the water and then replace with atmospheric pressure.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">)):</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">nan_mask</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="n">first_few_good_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">][:</span><span class="mi">20</span><span class="p">])</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="n">last_few_good_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">][</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="k">if</span> <span class="n">first_few_good_median</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="n">i_divide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">i_nan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                <span class="k">if</span> <span class="n">i_divide</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_few_good_median</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_divide</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_few_good_median</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>            <span class="k">if</span> <span class="n">last_few_good_median</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                <span class="n">i_divide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">i_nan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                <span class="k">if</span> <span class="n">i_divide</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_few_good_median</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="n">i_divide</span><span class="p">:]</span> <span class="o">=</span> <span class="n">last_few_good_median</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="c1"># Now generate an interpolation function that will take dday as input</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="c1"># for later per-ensemble interpolation.</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_interpolator</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="n">p_interpolated</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>        <span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>    <span class="k">def</span> <span class="nf">_external_pressure_to_dat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate external pressure to pycurrents time vector.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        Parameters</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        ----------</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">            Data structure.</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">        Returns</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        -------</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">        array-like</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">            Pressure</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_interpolator</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>    <span class="k">def</span> <span class="nf">_scale_pycurrents_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        <span class="c1"># Initial pressure units: 10 Pa (about 1 mm or 0.001 decibar).</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="c1"># Converting to decibars.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="k">return</span> <span class="n">dat</span><span class="o">.</span><span class="n">VL</span><span class="p">[</span><span class="s2">&quot;Pressure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>    <span class="nd">@property</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    <span class="k">def</span> <span class="nf">pressure_lp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Low-pass filtered pressure time series&quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="k">if</span> <span class="s2">&quot;pressure_lp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="p">:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure_lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lowpassfilter_pressure</span><span class="p">()</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure_lp</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>    <span class="k">def</span> <span class="nf">_lowpassfilter_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="n">t64</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">yday0_to_datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">tools</span><span class="o">.</span><span class="n">dominant_period_in_s</span><span class="p">(</span><span class="n">t64</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>        <span class="c1"># Make cutoff period either 30 minutes or 50 data points,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="c1"># whatever is shorter.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="n">cutoff</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">fs</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="k">if</span> <span class="n">cutoff</span> <span class="o">&gt;</span> <span class="mi">1800</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="n">cutoff</span> <span class="o">=</span> <span class="mi">1800</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">lowpassfilter</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>    <span class="k">def</span> <span class="nf">_read_auxiliary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Read auxiliary data.</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">        Adds attribute `tsdat`.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="n">tsdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">varlist</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;VariableLeader&quot;</span><span class="p">])</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="n">tsdat</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">tsdat</span><span class="o">.</span><span class="n">VL</span><span class="p">[</span><span class="s2">&quot;Temperature&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="c1"># Replace pressure if provided from external sensor</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_external_pressure_interpolator</span><span class="p">(</span><span class="n">tsdat</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">tsdat</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">tsdat</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span> <span class="o">=</span> <span class="n">tsdat</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>    <span class="k">def</span> <span class="nf">_parse_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse meta data.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">        - Add essential meta data to attributes. Will throw a KeyError if no</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a><span class="sd">          lon/lat provided.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a><span class="sd">        - Read serial number from raw data and complain if it does not match</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a><span class="sd">          the meta data SN.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="n">essential_meta_data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="p">[</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_safely_add_attribute_from_params</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">essential_meta_data</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>        <span class="c1"># Check SN</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="n">sn_internal</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">Inst_SN</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="k">if</span> <span class="s2">&quot;sn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">sn</span> <span class="o">=</span> <span class="n">sn_internal</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="c1"># Check internal SN matches user set one</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="k">if</span> <span class="n">sn_internal</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">sn</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="n">warn</span><span class="p">(</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="sa">f</span><span class="s2">&quot;Serial number in file, </span><span class="si">{</span><span class="n">sn_internal</span><span class="si">}</span><span class="s2">, is different from that set by user, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">sn</span><span class="si">}</span><span class="s2">. Keeping user value.&quot;</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>    <span class="nd">@property</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>    <span class="k">def</span> <span class="nf">default_dgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine default depth gridding parameters.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        The grid is centered on the  median depth of the ADCP (plus distance to</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">        the center of the first bin) to avoid unnecessary binning into</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        neighboring depth cells. The default size of the depth bins mimicks the</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">        size of ADCP bins.</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>            <span class="c1"># Only use pressure at depth, not on deck</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>            <span class="c1"># Determine limits of the pressure distribution but leave out the</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>            <span class="c1"># top 5 and bottom 2 percent of data points. This way we are hoping</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>            <span class="c1"># to avoid any outliers and a possible pressure record of ascent</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>            <span class="c1"># and/or descent.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>            <span class="n">p_top</span><span class="p">,</span> <span class="n">p_bot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">98</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>            <span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="n">pdep_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_median</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">NCells</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="n">d_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">CellSize</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>            <span class="n">distance_to_first_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">Bin1Dist</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>            <span class="n">distance_to_last_bin</span> <span class="o">=</span> <span class="n">distance_to_first_bin</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">d_interval</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span><span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">]:</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>                <span class="c1"># Set minimum grid depth level. Anything shallower than 10m</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>                <span class="c1"># will be garbage anyways so let&#39;s throw this out.</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>                <span class="n">dtop</span> <span class="o">=</span> <span class="n">p_top</span> <span class="o">-</span> <span class="n">distance_to_last_bin</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>                <span class="k">if</span> <span class="n">dtop</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>                    <span class="n">dtop</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                <span class="n">dbot</span> <span class="o">=</span> <span class="n">pdep_median</span> <span class="o">-</span> <span class="n">distance_to_first_bin</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="c1"># Successively add bins until we reach maximum pressure. This</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                <span class="c1"># will take care of mooring knockdowns.</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                <span class="k">while</span> <span class="n">dbot</span> <span class="o">&lt;</span> <span class="n">p_bot</span><span class="p">:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>                    <span class="n">dbot</span> <span class="o">+=</span> <span class="n">d_interval</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                <span class="n">dtop</span> <span class="o">=</span> <span class="n">pdep_median</span> <span class="o">+</span> <span class="n">distance_to_first_bin</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="k">while</span> <span class="n">dtop</span> <span class="o">&gt;</span> <span class="n">p_top</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                    <span class="n">dtop</span> <span class="o">-=</span> <span class="n">d_interval</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">dbot</span> <span class="o">=</span> <span class="n">p_bot</span> <span class="o">+</span> <span class="n">distance_to_last_bin</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>                <span class="n">dtop</span><span class="o">=</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>                <span class="n">dbot</span><span class="o">=</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>                <span class="n">d_interval</span><span class="o">=</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>    <span class="k">def</span> <span class="nf">parse_dgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgridparams</span><span class="p">):</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse depth gridding parameters.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">        Parameters</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        ----------</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        dgridparams : dict</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_dgridparams</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="k">if</span> <span class="n">dgridparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">dgridparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="s2">&quot;No depth gridding parameters provided, using default values.&quot;</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="c1"># Default depth grid parameters are based on the median pressure to</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>        <span class="c1"># avoid binning into neighboring grid cells as much as possible.</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="c1"># Therefore, we start assembling the depth grid from the bottom up for</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="c1"># an uplooker and from the top down for a downlooker.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>    <span class="k">def</span> <span class="nf">parse_tgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgridparams</span><span class="p">):</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse time gridding parameters.</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">        Parameters</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="sd">        ----------</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="sd">        tgridparams : dict</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="c1"># Find time at depth to determine default time grid parameters.</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="c1"># Differentiate between time series only in the water and time series</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="c1"># including the overshoot on mooring deployment.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="n">at_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">at_depth</span><span class="p">]</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>            <span class="c1"># in_water = np.nonzero(p &gt; self.p_median / 2)[0][-1]</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>            <span class="c1"># t1 = self.dday[in_water]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>            <span class="n">at_depth_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span> <span class="o">/</span> <span class="mf">1.05</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">at_depth_last</span><span class="p">]</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="c1"># Generate a set of default time gridding parameters and then update</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="c1"># from the input parameters provided.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="n">default_tgridparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt_hours</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">burst_average</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">default_tgridparams</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="k">if</span> <span class="n">tgridparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>            <span class="c1"># convert time to dday if provided as str</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="s2">&quot;t1&quot;</span><span class="p">]:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                <span class="k">if</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">tgridparams</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                        <span class="n">t64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                        <span class="n">year</span><span class="p">,</span> <span class="n">dday</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">datetime64_to_yday0</span><span class="p">(</span><span class="n">t64</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                        <span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">]</span> <span class="o">=</span> <span class="n">dday</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="c1"># update parameters in processing object</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                <span class="s2">&quot;No time gridding parameters provided, using default values.&quot;</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>            <span class="p">)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>    <span class="k">def</span> <span class="nf">parse_editparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editparams</span><span class="p">):</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse editing parameters.</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">        Parameters</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        ----------</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">        editparams : dict</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_editparams</span><span class="p">)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>        <span class="k">if</span> <span class="n">editparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">editparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No edit parameters provided, using default values.&quot;</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>    <span class="k">def</span> <span class="nf">parse_driftparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driftparams</span><span class="p">):</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse time drift parameters.</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">        Parameters</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        ----------</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">        driftparams : dict</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="n">driftparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">driftparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">driftparams</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">driftparams</span> <span class="o">=</span> <span class="n">driftparams</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="n">t1_adcp</span> <span class="o">=</span> <span class="n">driftparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_adcp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="k">if</span> <span class="n">t1_adcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="n">t1_pc</span> <span class="o">=</span> <span class="n">to_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="o">*</span><span class="n">driftparams</span><span class="p">[</span><span class="s2">&quot;end_pc&quot;</span><span class="p">])</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="n">t1_adcp</span> <span class="o">=</span> <span class="n">to_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="o">*</span><span class="n">driftparams</span><span class="p">[</span><span class="s2">&quot;end_adcp&quot;</span><span class="p">])</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1_pc</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1_adcp</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="s2">&quot;No time drift parameters provided, not applying any clock correction.&quot;</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="k">def</span> <span class="nf">_correct_dday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dday_orig</span><span class="p">):</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply linear correction for clock drift.</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">        Parameters</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        ----------</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        dday_orig : array-like</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">            Origial time vector.</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">        Returns</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">        -------</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">        array-like</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">            Corrected time vector</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">dday_orig</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    <span class="k">def</span> <span class="nf">_parse_sysconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="c1"># We have to get the up/down reading from sysconfig for a time when the</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="c1"># instrument was in the water. Look at pressure and determine ensembles</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="c1"># during time at depth.</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">depth_ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">depth_ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;could not determine ensemble index at depth for reading sysconfig&quot;</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="n">at_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="n">varlist</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;VariableLeader&quot;</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">depth_ii</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">depth_ii</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">at_depth</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">up</span> <span class="k">else</span> <span class="s2">&quot;down&quot;</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span> <span class="o">=</span> <span class="n">at_depth</span><span class="o">.</span><span class="n">sysconfig</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>    <span class="k">def</span> <span class="nf">make_start_ddays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate time stamps for ping averaging.</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">        Notes</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">        -----</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        If turning on burst averaging, other input values will be ignored and</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        the averaging interval will be determined from the burst sampling</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        scheme apparent in the ping pattern.</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        <span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">t0</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="n">dday_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">t1</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="n">dt_hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">dt_hours</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="n">is_burst_average</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">burst_average</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="c1"># Save whether we are averaging over bursts or not.</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span> <span class="o">=</span> <span class="n">is_burst_average</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="c1"># Generate time stamps and stuff.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no burst average&quot;</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="n">dday_start</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span> <span class="o">=</span> <span class="n">dday_end</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt_hours</span> <span class="o">/</span> <span class="mf">24.0</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dday_start</span><span class="p">,</span> <span class="n">dday_end</span><span class="p">,</span> <span class="n">dt_hours</span> <span class="o">/</span> <span class="mf">24.0</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="c1"># Time stamps for the averages. Midpoints of averaging intervals.</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>            <span class="n">dday_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="c1"># Determine ping interval within burst and time between bursts.</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="n">burst_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dday_diff</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time between pings within burst: </span><span class="si">{</span><span class="n">burst_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="c1"># It seems safe to assume that the time between bursts is at least</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>            <span class="c1"># four times as long as the time between individual pings within a</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="c1"># burst.</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>            <span class="n">inter_burst_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dday_diff</span><span class="p">[</span><span class="n">dday_diff</span> <span class="o">&gt;</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time between bursts: </span><span class="si">{</span><span class="n">inter_burst_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="c1"># Find starting points of all bursts.</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">dday_diff</span> <span class="o">&gt;</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>            <span class="c1"># Increase index so we are at the end of the larger time differences.</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>            <span class="n">start_indices</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>            <span class="c1"># Include the very beginning.</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>            <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">start_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">start_indices</span><span class="p">]</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="c1"># Generate a dt that is inclusive of one burst.  We know the number</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="c1"># of pings in a burst from the difference between the</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="c1"># start_indices. Let&#39;s go a bit beyond the time needed (3 more ping</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="c1"># intervals chosen here).</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="n">pings_per_burst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">start_indices</span><span class="p">)))</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pings_per_burst</span><span class="si">}</span><span class="s2"> pings per burst&quot;</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bursts total&quot;</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="n">pings_per_burst</span> <span class="o">+</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">3</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span> <span class="o">=</span> <span class="n">dday_end</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="c1"># Time stamps in the middle of the burst</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">+</span> <span class="n">pings_per_burst</span> <span class="o">*</span> <span class="n">burst_dt</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>    <span class="k">def</span> <span class="nf">read_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iens</span><span class="p">):</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Read ensembles (several individual pings grouped together).</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">        Parameters</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">        ----------</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">        iens : int</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">            Index into ensemble start times (they are generated in</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">            :meth:`make_start_ddays`).</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">        Returns</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        -------</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">            Dictionary with data.</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        Raises</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">        ------</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        ValueError</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">            If `iens` is too large to index into `start_ddays`.</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="k">if</span> <span class="n">iens</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ens num </span><span class="si">%d</span><span class="s2"> is out of range&quot;</span> <span class="o">%</span> <span class="n">iens</span><span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="c1"># Get indices within the interval</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>        <span class="n">sl</span> <span class="o">=</span> <span class="n">rangeslice</span><span class="p">(</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">iens</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">iens</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="c1"># Use the indices to extract data</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">sl</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">dday_orig</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">dday_orig</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="c1"># Replace pressure if provided</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="c1"># Use raw pressure</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_raw_pressure</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="c1"># Use raw pressure</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="c1"># Use low-pass filtered pressure</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">ens_num</span> <span class="o">&gt;=</span> <span class="n">dat</span><span class="o">.</span><span class="n">ens_num</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">ens_num</span> <span class="o">&lt;=</span> <span class="n">dat</span><span class="o">.</span><span class="n">ens_num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_lp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="n">pdepth</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">dat</span><span class="o">.</span><span class="n">dep</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="k">return</span> <span class="n">dat</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>    <span class="nd">@property</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>    <span class="k">def</span> <span class="nf">magdec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Magnetic declination.</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">        If not provided as input argument magdec is calculated using</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">        [magdec](https://currents.soest.hawaii.edu/hgstage/geomag/file/tip)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="sd">        (must be installed) based on `lon` and `lat`.</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                    <span class="s2">&quot;No lon/lat provided, cannot calculate magnetic declination.&quot;</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                <span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                <span class="c1"># Look for magdec executable</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                <span class="n">magdec_found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;magdec&quot;</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                <span class="k">if</span> <span class="n">magdec_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>                    <span class="n">package_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                    <span class="c1"># Try this package directory</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                    <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;magdec&quot;</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">magdec_path</span><span class="p">)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                    <span class="c1"># Try the magdec installation directory</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                    <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;../geomag/magdec&quot;</span><span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                    <span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">magdec_path</span><span class="p">)</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>                        <span class="s2">&quot;Cannot find program magdec on the system path or paths within velosearaptor.&quot;</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                    <span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magdec found at </span><span class="si">{</span><span class="n">magdec_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                <span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="n">dday_mid</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                    <span class="p">[</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                        <span class="n">magdec_path</span><span class="p">,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                    <span class="p">],</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                    <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;magdec output is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magdec </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span><span class="si">}</span><span class="s2"> provided.&quot;</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>    <span class="nd">@property</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw ADCP data.&quot;&quot;&quot;</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading raw data...&quot;</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read_raw_rdi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>    <span class="k">def</span> <span class="nf">_edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply editing to xyze.&quot;&quot;&quot;</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">cor</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">.</span><span class="n">min_correlation</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="n">max_e</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">max_e</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">ep</span><span class="o">.</span><span class="n">max_e_deviation</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">max_e_applied</span> <span class="o">=</span> <span class="n">max_e</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_e</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="k">if</span> <span class="n">ep</span><span class="o">.</span><span class="n">maskbins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[:,</span> <span class="n">ep</span><span class="o">.</span><span class="n">maskbins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>    <span class="k">def</span> <span class="nf">_to_enu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">        add enu</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        GV: enu is east, north, up, errvel (optional) whereas xyz are</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        instrument coordinates.</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">enu</span> <span class="o">=</span> <span class="n">rdi_xyz_enu</span><span class="p">(</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">,</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">heading</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">roll</span><span class="p">,</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>            <span class="n">orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>        <span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="k">def</span> <span class="nf">_burst_average_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Depth-average within a burst.</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">        Average the depth vectors if doing burst-averages. Otherwise we just</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">        return all depth vectors of this ensemble.</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        Parameters</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        ----------</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">        ens : Bunch</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">            Ensemble data.</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        Returns</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">        -------</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">        depth : array-like</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">            Depth vector for each ping.</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="n">depth_mean</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">depth_mean</span><span class="p">,</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">depth</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="k">return</span> <span class="n">depth</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>    <span class="k">def</span> <span class="nf">_regrid_enu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Depth-grid enu velocities.&quot;&quot;&quot;</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="n">enu_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="n">enu_grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="c1"># Average the depth vectors if doing burst-averages. Otherwise we just</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="c1"># return all depth vectors of this ensemble.</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="c1"># TO DO: If calculating averages over regular time intervals, we need</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="c1"># to low pass filter the pressure time series prior to creating the</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="c1"># depth vectors.</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">enu_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>                <span class="n">depth</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>            <span class="p">)</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span> <span class="o">=</span> <span class="n">enu_grid</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>    <span class="k">def</span> <span class="nf">_regrid_amp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Depth-grid amplitudes (averaged over all 4 beams).&quot;&quot;&quot;</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">amp_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">amp_grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="n">amp_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>                <span class="n">depth</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>            <span class="p">)</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span> <span class="o">=</span> <span class="n">amp_grid</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>    <span class="k">def</span> <span class="nf">_binmap_one_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">beam_number</span><span class="p">):</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Binmap single ping data for a single beam by linear interpolation.</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        Mapping is applied to velocity, amplitude and correlation.</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        Currently only works for 4 beam ADCP.</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">        Parameters</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">        ----------</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">        ens : Bunch</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">            An ADCP dataset read by Multiread.</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">        beam_number : int</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">            An integer from 1 to 4 representing the beam number.</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">        Returns</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">        -------</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">        veli : ndarray</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">            Mapped velocity.</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        ampi : ndarray</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">            Mapped amplitude.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        cori : ndarray</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">            Mapped correlation.</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="k">if</span> <span class="n">beam_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Beam number must be 1, 2, 3 or 4.&quot;</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="n">tba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">angle</span><span class="p">))</span>  <span class="c1"># Tangent of beam angle</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">roll</span><span class="p">)</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="c1"># The true bin distances</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="k">if</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span> <span class="o">-</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="p">)</span>  <span class="c1"># None adds a new axis.</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="k">elif</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span> <span class="o">+</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>            <span class="p">)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="k">elif</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span> <span class="o">+</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>            <span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="k">elif</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span> <span class="o">-</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="p">)</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="n">vel</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">vel</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="n">cor</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">cor</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="c1"># Calculate interpolating weights (this hogs RAM!)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">ens</span><span class="o">.</span><span class="n">dep</span> <span class="o">-</span> <span class="n">dep</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="c1"># Determine data above or below the deepest bins</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="n">above</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="n">below</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>        <span class="n">bad</span> <span class="o">=</span> <span class="n">above</span> <span class="o">|</span> <span class="n">below</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="c1"># Calculate differences</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="n">dvel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="n">damp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">dcor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="n">veli</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">dvel</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">veli</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="n">ampi</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">damp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="n">ampi</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="n">cori</span> <span class="o">=</span> <span class="n">cor</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">dcor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="n">cori</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="k">return</span> <span class="n">veli</span><span class="p">,</span> <span class="n">ampi</span><span class="p">,</span> <span class="n">cori</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>    <span class="k">def</span> <span class="nf">_binmap_all_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Binmap single ping data for all beams.&quot;&quot;&quot;</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="k">for</span> <span class="n">beam_number</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="n">veli</span><span class="p">,</span> <span class="n">ampi</span><span class="p">,</span> <span class="n">cori</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binmap_one_beam</span><span class="p">(</span><span class="n">ens</span><span class="p">,</span> <span class="n">beam_number</span><span class="p">)</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">vel</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">veli</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampi</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">cor</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cori</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="n">ens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;vel</span><span class="si">{</span><span class="n">beam_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">veli</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>            <span class="n">ens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;amp</span><span class="si">{</span><span class="n">beam_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampi</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>            <span class="n">ens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cor</span><span class="si">{</span><span class="n">beam_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cori</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>    <span class="k">def</span> <span class="nf">_calculate_xyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">ibad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate xyze from along-beam data.&quot;&quot;&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">ens</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">convex</span><span class="p">:</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>            <span class="n">geom</span> <span class="o">=</span> <span class="s2">&quot;convex&quot;</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>            <span class="n">geom</span> <span class="o">=</span> <span class="s2">&quot;concave&quot;</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="n">trans</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="n">ens</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geom</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">beam_to_xyz</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">vel</span><span class="p">,</span> <span class="n">ibad</span><span class="o">=</span><span class="n">ibad</span><span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>    <span class="k">def</span> <span class="nf">process_pings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ens_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">):</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process single ping data without averaging.</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">        Parameters</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">        ----------</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">        start : int, optional</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">            Start processing at this ping number.</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">        stop : int, optional</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">            Stop processing at this ping number.</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">        binmap : bool, optional</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">            Do binmapping of along-beam data.</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">        ens_size : int, optional</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="sd">            Pings are processed in ensembles to reduce memory usage.</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">            This parameter sets how many pings are in an ensemble. The default is 50000.</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="n">idx_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span><span class="p">)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="n">ens_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idx_start</span><span class="p">,</span> <span class="n">idx_stop</span><span class="p">,</span> <span class="n">ens_size</span><span class="p">),</span> <span class="n">idx_stop</span><span class="p">))</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">write_idxs</span> <span class="o">=</span> <span class="n">ens_idxs</span> <span class="o">-</span> <span class="n">ens_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Arrays we write to start at index 0</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">idx_stop</span> <span class="o">-</span> <span class="n">idx_start</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="n">ens_idxs</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dep</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing all pings&quot;</span><span class="p">)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binmapping is </span><span class="si">{</span><span class="n">binmap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="c1"># temperature = np.ma.zeros((npings,), dtype=np.float32)</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="c1"># pressure = np.ma.zeros((npings,), dtype=np.float32)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">temperature</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="c1"># Loop over ensembles</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nens</span><span class="p">)):</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">ens_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="n">ens_idxs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="n">idx0</span> <span class="o">=</span> <span class="n">write_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">idx1</span> <span class="o">=</span> <span class="n">write_idxs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                <span class="c1"># I pulled this out of read_ensembles because we need to</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                <span class="c1"># calculate depth for _ave2nc to work.</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dday_orig</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">dday</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday_orig</span><span class="p">)</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>                    <span class="c1"># Replace pressure if provided</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>                    <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                    <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                <span class="n">pdepth</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">dep</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                <span class="k">if</span> <span class="n">binmap</span><span class="p">:</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_binmap_all_beams</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>                    <span class="c1"># Now we have to recalculate xyze with the binmapped data.</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_xyze</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                <span class="c1"># pressure[idx0:idx1] = np.ma.masked</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>                <span class="c1"># temperature[idx0:idx1] = np.ma.masked</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>                <span class="k">continue</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>            <span class="c1"># pgi = 100 * ens.enu_grid[..., 0].count(axis=0) // nprofs</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="c1"># pg[i] = pgi.astype(np.int8)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Average over beams... why?</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="c1"># npings=npings,</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="n">dep</span><span class="o">=</span><span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">,</span>  <span class="c1"># &lt;&lt;&lt;&lt;----- BAD!!! This a fudge because I don&#39;t want to calculated a depth vector. We use the depth vector from the last ensemble.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="c1"># dgridparams=self.dgridparams,</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>        <span class="p">)</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>    <span class="k">def</span> <span class="nf">average_ensembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-averaging.</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">        Parameters</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">        ----------</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">        start : int</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">            intervals.</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">        stop : int</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">            intervals.</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="n">nens_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        <span class="n">indices_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens_orig</span><span class="p">)</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_orig</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all ensembles&quot;</span><span class="p">)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaging ensembles </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">)</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>        <span class="n">uvwe_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="n">pressure_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="n">pressure_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ensemble</span><span class="p">(</span><span class="n">iens</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_amp</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>            <span class="n">npings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nprofs</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="k">if</span> <span class="n">nprofs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                <span class="c1"># (pg is not a masked array)</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>                <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>                <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>                <span class="k">continue</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>            <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="n">pgi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">nprofs</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>            <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">u_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="n">v_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="n">w_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>            <span class="n">e_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>            <span class="n">pressure_std</span><span class="o">=</span><span class="n">pressure_std</span><span class="p">,</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>            <span class="n">pressure_max</span><span class="o">=</span><span class="n">pressure_max</span><span class="p">,</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>            <span class="n">npings</span><span class="o">=</span><span class="n">npings</span><span class="p">,</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>            <span class="n">dep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">,</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>        <span class="p">)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>    <span class="k">def</span> <span class="nf">burst_average_ensembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interpolate_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-averaging prior to depth-gridding.</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">        Uses pre-defined editing parameters that can be updated with</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">        `parse_editparams`.</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">        Parameters</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a><span class="sd">        ----------</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a><span class="sd">        start : int, optional</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="sd">            intervals. Defaults to None (start at beginning).</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">        stop : int, optional</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">            intervals. Defaults to None (start at beginning).</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">        interpolate_bin : int or None, optional</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">            Interpolate over a single, previously masked, bin. Defaults to None (no interpolation).</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>        <span class="n">pg_condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="o">.</span><span class="n">pg_limit</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>        <span class="n">nens_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>        <span class="n">indices_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens_orig</span><span class="p">)</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_orig</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all ensembles&quot;</span><span class="p">)</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaging ensembles </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>        <span class="n">uvwe_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>        <span class="n">pressure_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>        <span class="n">pressure_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ensemble</span><span class="p">(</span><span class="n">iens</span><span class="p">)</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_amp</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>            <span class="n">npings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nprofs</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="k">if</span> <span class="n">nprofs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>                <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>                <span class="c1"># (pg is not a masked array)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>                <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>                <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>                <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>                <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>                <span class="k">continue</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>            <span class="c1"># Depth vector for interpolation</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="c1"># Calculate burst-average on instrument-relative depth grid</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>            <span class="n">uvwe_inst</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>            <span class="n">uvwe_std_inst</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="n">pgi_inst</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">nprofs</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="k">if</span> <span class="n">pg_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>                <span class="n">pgi_index</span> <span class="o">=</span> <span class="n">pgi_inst</span> <span class="o">&lt;</span> <span class="n">pg_condition</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>                <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">pgi_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>                <span class="n">uvwe_std_inst</span><span class="p">[</span><span class="n">pgi_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="k">if</span> <span class="n">interpolate_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>                <span class="n">zi</span> <span class="o">=</span> <span class="n">interpolate_bin</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>                <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">zi</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zi</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>                <span class="n">dtmp</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>                    <span class="n">dtmp</span><span class="p">,</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>                    <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">neighbors</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>                    <span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">],</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>                <span class="p">)</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>                <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="c1"># Interpolate burst-average to universal depth grid.</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="n">uvwe_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">uvwe_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="n">uvwe_std_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                <span class="n">depth</span><span class="p">,</span> <span class="n">uvwe_std_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            <span class="p">)</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvwe_grid</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvwe_std_grid</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="c1"># Interpolate pg to universal depth grid. Not overly satisfying but</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="c1"># seems like that&#39;s what we need to do here.</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="n">pgi_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">pgi_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi_grid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="c1"># Not changed to averaging in instrument-relative coordinates first.</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>            <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="n">u_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="n">v_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>            <span class="n">w_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>            <span class="n">e_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="n">pressure_std</span><span class="o">=</span><span class="n">pressure_std</span><span class="p">,</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="n">pressure_max</span><span class="o">=</span><span class="n">pressure_max</span><span class="p">,</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>            <span class="n">npings</span><span class="o">=</span><span class="n">npings</span><span class="p">,</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>            <span class="n">dep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">,</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>        <span class="p">)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>    <span class="k">def</span> <span class="nf">_safely_add_attribute_from_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add attribute from dictionary and throw an exception if the key is missing.</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a><span class="sd">        Parameters</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a><span class="sd">        ----------</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a><span class="sd">        key : str</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a><span class="sd">        d : dict</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2"> is missing in input parameters&quot;</span><span class="p">)</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>            <span class="k">raise</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>    <span class="k">def</span> <span class="nf">_set_up_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up logging to both a file and to screen.</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="sd">        Default for screen logging is to show only warnings unless `verbose` is</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">        set to True.</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="c1"># Parse metadata for naming the log.</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>            <span class="k">if</span> <span class="s2">&quot;sn&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="ow">and</span> <span class="s2">&quot;mooring&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>                <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;sn&quot;</span><span class="p">]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                <span class="n">mooring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;mooring&quot;</span><span class="p">]</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>                <span class="n">has_mooring_id</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>                <span class="n">sn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>                <span class="n">mooring</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>                <span class="n">has_mooring_id</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>            <span class="n">has_mooring_id</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="c1"># Set up a logger that will collect log info from this module and the</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="c1"># other pycurrent methods as well.</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        <span class="n">logdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="n">logdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="k">if</span> <span class="n">has_mooring_id</span><span class="p">:</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mooring</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2">.log&quot;</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;adcp_proc.log&quot;</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="c1"># Delete any existing handlers. This may be bad style, but I kept adding handlers when developing this.</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>            <span class="n">filename</span><span class="o">=</span><span class="n">logdir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>            <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(name)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>            <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>            <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="p">)</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>        <span class="n">ConsoleOutputHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>        <span class="n">ConsoleOutputHandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>            <span class="n">ConsoleOutputHandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ConsoleOutputHandler</span><span class="p">)</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>        <span class="c1"># current date</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="n">datestr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="n">strformat</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>        <span class="n">datestr</span> <span class="o">=</span> <span class="n">datestr</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">strformat</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        <span class="k">if</span> <span class="n">has_mooring_id</span><span class="p">:</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">mooring</span><span class="si">}</span><span class="s2"> SN </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">datestr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>                <span class="s2">&quot;No meta data provided, logging to generic filename &#39;adcp_proc.log&#39;&quot;</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="p">)</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing on </span><span class="si">{</span><span class="n">datestr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>    <span class="k">def</span> <span class="nf">_log_processing_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write processing parameters to log file.&quot;&quot;&quot;</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;processing settings&quot;</span><span class="p">)</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------&quot;</span><span class="p">)</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">)</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">)</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------&quot;</span><span class="p">)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>    <span class="k">def</span> <span class="nf">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pd</span><span class="p">):</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Print ADCP processing parameter dict to logs.</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a><span class="sd">        Parameters</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="sd">        ----------</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="sd">        pd : dict</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a><span class="sd">            Parameter dict.</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;maskbins&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>                <span class="n">logstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">logstr</span><span class="p">)</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>                <span class="n">logstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">logstr</span><span class="p">)</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>    <span class="k">def</span> <span class="nf">_ave2nc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert data structure from ave to xarray.Dataset format.&quot;&quot;&quot;</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>        <span class="c1"># load npz file</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ave</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="c1"># identify variables</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>        <span class="n">varsint</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="n">vars1d</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>        <span class="n">vars2d</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                    <span class="n">vars1d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                    <span class="n">vars2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="n">varsint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>            <span class="c1"># print(ki, tmp)</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="c1"># generate time vector</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">ti</span><span class="p">)</span> <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">]</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>        <span class="n">adcptime</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>        <span class="c1"># generate Dataset</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>            <span class="p">{</span><span class="s2">&quot;pg&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">T</span><span class="p">)},</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">adcptime</span><span class="p">),</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="o">.</span><span class="n">dep</span><span class="p">)},</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="p">)</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>        <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="n">vars2d</span><span class="p">:</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="n">vars1d</span><span class="p">:</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="n">vari</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dep&quot;</span><span class="p">,</span> <span class="s2">&quot;dday&quot;</span><span class="p">]:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                <span class="n">out</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="n">vari</span><span class="p">])</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>        <span class="c1"># Percent good is currently defined everywhere. Set to NaN where we</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>        <span class="c1"># don&#39;t have any amplitude data (i.e. no data).</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">amp</span><span class="p">),</span> <span class="n">other</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        <span class="c1"># Drop depth levels with all nan</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>        <span class="c1"># Drop pressure_std, pressure_max, and e_std</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        <span class="n">dropvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pressure_std&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure_max&quot;</span><span class="p">,</span> <span class="s2">&quot;e_std&quot;</span><span class="p">]</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dropvars</span><span class="p">:</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>        <span class="c1"># Change u/v/w std to standard error by dividing by sqrt(npings)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_std&quot;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_std&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">})</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>                <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;npings&quot;</span><span class="p">])</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>        <span class="c1"># Calculate transducer depth from pressure</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;xducer_depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">gsw</span><span class="o">.</span><span class="n">z_from_p</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>        <span class="c1"># add variable names and units for plotting</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_names_and_units</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">out</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>    <span class="k">def</span> <span class="nf">_add_names_and_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add variable attributes based on CF conventions.</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a><span class="sd">        Parameters</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a><span class="sd">        ----------</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a><span class="sd">        ds : xarray.Dataset</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a><span class="sd">        Returns</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a><span class="sd">        -------</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a><span class="sd">        ds : xarray.Dataset</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="n">CF</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">cf_conventions</span><span class="p">()</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CF</span><span class="p">:</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>                <span class="n">ds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">CF</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="k">return</span> <span class="n">ds</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>    <span class="k">def</span> <span class="nf">_add_meta_data_to_ds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        <span class="c1"># Add some more info.</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;magdec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magdec</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;max_e&quot;</span><span class="p">,</span> <span class="s2">&quot;max_e_deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;min_correlation&quot;</span><span class="p">]:</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        <span class="c1"># Add meta data if provided.</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;proc time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>    <span class="k">def</span> <span class="nf">plot_echo_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot beam statistics (correlation and amplitude) from raw ADCP data.&quot;&quot;&quot;</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>            <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">),</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>            <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>        <span class="p">)</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>        <span class="n">r</span><span class="o">.</span><span class="n">cor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="p">)</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="n">r</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="n">add_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>        <span class="p">)</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>        <span class="k">for</span> <span class="n">axi</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>            <span class="n">axi</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>    <span class="k">def</span> <span class="nf">plot_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot pressure time series and mark time at depth.&quot;&quot;&quot;</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>            <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="p">)</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;subsurface&quot;</span><span class="p">)</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;pressure [dbar]&quot;</span><span class="p">)</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>    <span class="k">def</span> <span class="nf">generate_binmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>        <span class="n">binmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>        <span class="n">binmask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>        <span class="k">return</span> <span class="n">binmask</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="k">class</span> <span class="nc">ProcessADCPyml</span><span class="p">(</span><span class="n">ProcessADCP</span><span class="p">):</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Moored ADCP processing with parameters provided via .yml file.</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a><span class="sd">    An example parameter file is included at</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="sd">    [`notebooks/parameters.yml`](https://github.com/modscripps/velosearaptor/tree/main/notebooks/parameters.yml)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_file</span><span class="p">,</span> <span class="n">mooring</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">parse_yaml_input</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="n">mooring</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>            <span class="n">meta_data</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">],</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>            <span class="n">driftparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;driftparams&quot;</span><span class="p">],</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;tgridparams&quot;</span><span class="p">],</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;dgridparams&quot;</span><span class="p">],</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;editparams&quot;</span><span class="p">],</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>        <span class="p">)</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">velosearaptor.madcp</a> (WARNING)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
    

                </section>
                <section id="ProcessADCP">
                            <input id="ProcessADCP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ProcessADCP</span>:

                <label class="view-source-button" for="ProcessADCP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP-65"><a href="#ProcessADCP-65"><span class="linenos">  65</span></a><span class="k">class</span> <span class="nc">ProcessADCP</span><span class="p">:</span>
</span><span id="ProcessADCP-66"><a href="#ProcessADCP-66"><span class="linenos">  66</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Moored ADCP Processing.</span>
</span><span id="ProcessADCP-67"><a href="#ProcessADCP-67"><span class="linenos">  67</span></a>
</span><span id="ProcessADCP-68"><a href="#ProcessADCP-68"><span class="linenos">  68</span></a><span class="sd">    An instance of ProcessADCP is initialized by providing raw data and</span>
</span><span id="ProcessADCP-69"><a href="#ProcessADCP-69"><span class="linenos">  69</span></a><span class="sd">    processing parameters. Once initialized, the instance method</span>
</span><span id="ProcessADCP-70"><a href="#ProcessADCP-70"><span class="linenos">  70</span></a><span class="sd">    :meth:`average_ensembles` can be used to average over just a few or</span>
</span><span id="ProcessADCP-71"><a href="#ProcessADCP-71"><span class="linenos">  71</span></a><span class="sd">    all pings.</span>
</span><span id="ProcessADCP-72"><a href="#ProcessADCP-72"><span class="linenos">  72</span></a>
</span><span id="ProcessADCP-73"><a href="#ProcessADCP-73"><span class="linenos">  73</span></a><span class="sd">    Magnetic declination is automatically calculated via a call to the command</span>
</span><span id="ProcessADCP-74"><a href="#ProcessADCP-74"><span class="linenos">  74</span></a><span class="sd">    line tool</span>
</span><span id="ProcessADCP-75"><a href="#ProcessADCP-75"><span class="linenos">  75</span></a><span class="sd">    [magdec](https://currents.soest.hawaii.edu/hgstage/geomag/file/tip) that</span>
</span><span id="ProcessADCP-76"><a href="#ProcessADCP-76"><span class="linenos">  76</span></a><span class="sd">    must be installed. Once calculated, the magnetic declination is stored in</span>
</span><span id="ProcessADCP-77"><a href="#ProcessADCP-77"><span class="linenos">  77</span></a><span class="sd">    `magdec` and automatically applied to the data.</span>
</span><span id="ProcessADCP-78"><a href="#ProcessADCP-78"><span class="linenos">  78</span></a>
</span><span id="ProcessADCP-79"><a href="#ProcessADCP-79"><span class="linenos">  79</span></a><span class="sd">    Prior to time averaging, data are edited based on correlation and error</span>
</span><span id="ProcessADCP-80"><a href="#ProcessADCP-80"><span class="linenos">  80</span></a><span class="sd">    velocity thresholds. The variable `pg` is calculated based on the number of</span>
</span><span id="ProcessADCP-81"><a href="#ProcessADCP-81"><span class="linenos">  81</span></a><span class="sd">    excluded pings, i.e. it is the numbur of good pings divided by the number</span>
</span><span id="ProcessADCP-82"><a href="#ProcessADCP-82"><span class="linenos">  82</span></a><span class="sd">    of total pings within one depth bin and one time bin. It may be used to</span>
</span><span id="ProcessADCP-83"><a href="#ProcessADCP-83"><span class="linenos">  83</span></a><span class="sd">    further filter the data.</span>
</span><span id="ProcessADCP-84"><a href="#ProcessADCP-84"><span class="linenos">  84</span></a>
</span><span id="ProcessADCP-85"><a href="#ProcessADCP-85"><span class="linenos">  85</span></a><span class="sd">    A pdf document on ADCP data collection and processing principles can be</span>
</span><span id="ProcessADCP-86"><a href="#ProcessADCP-86"><span class="linenos">  86</span></a><span class="sd">    downloaded from RDI</span>
</span><span id="ProcessADCP-87"><a href="#ProcessADCP-87"><span class="linenos">  87</span></a><span class="sd">    [here](https://www.comm-tec.com/Docs/Manuali/RDI/BBPRIME.pdf).</span>
</span><span id="ProcessADCP-88"><a href="#ProcessADCP-88"><span class="linenos">  88</span></a>
</span><span id="ProcessADCP-89"><a href="#ProcessADCP-89"><span class="linenos">  89</span></a><span class="sd">    Time-averaged data are grouped together in an `xarray.Dataset` in the</span>
</span><span id="ProcessADCP-90"><a href="#ProcessADCP-90"><span class="linenos">  90</span></a><span class="sd">    instance attribute `ds` for easy access and convenient output to netcdf</span>
</span><span id="ProcessADCP-91"><a href="#ProcessADCP-91"><span class="linenos">  91</span></a><span class="sd">    format.</span>
</span><span id="ProcessADCP-92"><a href="#ProcessADCP-92"><span class="linenos">  92</span></a>
</span><span id="ProcessADCP-93"><a href="#ProcessADCP-93"><span class="linenos">  93</span></a><span class="sd">    Parameters</span>
</span><span id="ProcessADCP-94"><a href="#ProcessADCP-94"><span class="linenos">  94</span></a><span class="sd">    ----------</span>
</span><span id="ProcessADCP-95"><a href="#ProcessADCP-95"><span class="linenos">  95</span></a><span class="sd">    raw_data : str or list or Path</span>
</span><span id="ProcessADCP-96"><a href="#ProcessADCP-96"><span class="linenos">  96</span></a><span class="sd">        Location(s) of raw data.</span>
</span><span id="ProcessADCP-97"><a href="#ProcessADCP-97"><span class="linenos">  97</span></a><span class="sd">    meta_data : dict</span>
</span><span id="ProcessADCP-98"><a href="#ProcessADCP-98"><span class="linenos">  98</span></a><span class="sd">        Dictionary with meta data. At a minimum entries for `lon` and `lat` are</span>
</span><span id="ProcessADCP-99"><a href="#ProcessADCP-99"><span class="linenos">  99</span></a><span class="sd">        needed. If `mooring` and `sn` provide mooring name and serial number</span>
</span><span id="ProcessADCP-100"><a href="#ProcessADCP-100"><span class="linenos"> 100</span></a><span class="sd">        then these will be used to name the log file produced during</span>
</span><span id="ProcessADCP-101"><a href="#ProcessADCP-101"><span class="linenos"> 101</span></a><span class="sd">        processing.</span>
</span><span id="ProcessADCP-102"><a href="#ProcessADCP-102"><span class="linenos"> 102</span></a><span class="sd">    driftparams : dict, optional</span>
</span><span id="ProcessADCP-103"><a href="#ProcessADCP-103"><span class="linenos"> 103</span></a><span class="sd">        Time drift parameters. See notes below.</span>
</span><span id="ProcessADCP-104"><a href="#ProcessADCP-104"><span class="linenos"> 104</span></a><span class="sd">    tgridparams : dict, optional</span>
</span><span id="ProcessADCP-105"><a href="#ProcessADCP-105"><span class="linenos"> 105</span></a><span class="sd">        Time gridding parameters. See notes below.</span>
</span><span id="ProcessADCP-106"><a href="#ProcessADCP-106"><span class="linenos"> 106</span></a><span class="sd">    dgridparams : dict, optional</span>
</span><span id="ProcessADCP-107"><a href="#ProcessADCP-107"><span class="linenos"> 107</span></a><span class="sd">        Depth gridding parameters. See notes below.</span>
</span><span id="ProcessADCP-108"><a href="#ProcessADCP-108"><span class="linenos"> 108</span></a><span class="sd">    editparams : dict, optional</span>
</span><span id="ProcessADCP-109"><a href="#ProcessADCP-109"><span class="linenos"> 109</span></a><span class="sd">        Editing parameters. See notes below.</span>
</span><span id="ProcessADCP-110"><a href="#ProcessADCP-110"><span class="linenos"> 110</span></a><span class="sd">    ibad : int, optional</span>
</span><span id="ProcessADCP-111"><a href="#ProcessADCP-111"><span class="linenos"> 111</span></a><span class="sd">        Mark beam with bad data (zero based). Defaults to None.</span>
</span><span id="ProcessADCP-112"><a href="#ProcessADCP-112"><span class="linenos"> 112</span></a><span class="sd">    logdir : str, optional</span>
</span><span id="ProcessADCP-113"><a href="#ProcessADCP-113"><span class="linenos"> 113</span></a><span class="sd">        Log file directory. Defaults to `log/`.</span>
</span><span id="ProcessADCP-114"><a href="#ProcessADCP-114"><span class="linenos"> 114</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="ProcessADCP-115"><a href="#ProcessADCP-115"><span class="linenos"> 115</span></a><span class="sd">        Output more processing info to screen.</span>
</span><span id="ProcessADCP-116"><a href="#ProcessADCP-116"><span class="linenos"> 116</span></a><span class="sd">    magdec : float, optional</span>
</span><span id="ProcessADCP-117"><a href="#ProcessADCP-117"><span class="linenos"> 117</span></a><span class="sd">        Magnetic declination in degrees.</span>
</span><span id="ProcessADCP-118"><a href="#ProcessADCP-118"><span class="linenos"> 118</span></a><span class="sd">    pressure : xr.DataArray, optional</span>
</span><span id="ProcessADCP-119"><a href="#ProcessADCP-119"><span class="linenos"> 119</span></a><span class="sd">        Supply external pressure time series in dbar as xr.DataAarray with</span>
</span><span id="ProcessADCP-120"><a href="#ProcessADCP-120"><span class="linenos"> 120</span></a><span class="sd">        coordinate `time`.</span>
</span><span id="ProcessADCP-121"><a href="#ProcessADCP-121"><span class="linenos"> 121</span></a><span class="sd">    use_raw_pressure : bool, optional</span>
</span><span id="ProcessADCP-122"><a href="#ProcessADCP-122"><span class="linenos"> 122</span></a><span class="sd">        Pressure time series is low-pass filtered at 30 minutes or 50 ping</span>
</span><span id="ProcessADCP-123"><a href="#ProcessADCP-123"><span class="linenos"> 123</span></a><span class="sd">        cutoff period, whatever is shorter. Set this to True to use raw</span>
</span><span id="ProcessADCP-124"><a href="#ProcessADCP-124"><span class="linenos"> 124</span></a><span class="sd">        pressure. Defaults to False. Does not matter for burst-averaging</span>
</span><span id="ProcessADCP-125"><a href="#ProcessADCP-125"><span class="linenos"> 125</span></a><span class="sd">        (pressure is averaged over full burst) or when supplying external</span>
</span><span id="ProcessADCP-126"><a href="#ProcessADCP-126"><span class="linenos"> 126</span></a><span class="sd">        pressure time series.</span>
</span><span id="ProcessADCP-127"><a href="#ProcessADCP-127"><span class="linenos"> 127</span></a><span class="sd">    pressure_scale_factor : float, optional</span>
</span><span id="ProcessADCP-128"><a href="#ProcessADCP-128"><span class="linenos"> 128</span></a><span class="sd">        Can be used to scale a (likely broken) pressure time series. Defaults</span>
</span><span id="ProcessADCP-129"><a href="#ProcessADCP-129"><span class="linenos"> 129</span></a><span class="sd">        to 1 (no scaling).</span>
</span><span id="ProcessADCP-130"><a href="#ProcessADCP-130"><span class="linenos"> 130</span></a>
</span><span id="ProcessADCP-131"><a href="#ProcessADCP-131"><span class="linenos"> 131</span></a>
</span><span id="ProcessADCP-132"><a href="#ProcessADCP-132"><span class="linenos"> 132</span></a><span class="sd">    Attributes</span>
</span><span id="ProcessADCP-133"><a href="#ProcessADCP-133"><span class="linenos"> 133</span></a><span class="sd">    ----------</span>
</span><span id="ProcessADCP-134"><a href="#ProcessADCP-134"><span class="linenos"> 134</span></a><span class="sd">    files : list</span>
</span><span id="ProcessADCP-135"><a href="#ProcessADCP-135"><span class="linenos"> 135</span></a><span class="sd">        List pointing to raw data file(s).</span>
</span><span id="ProcessADCP-136"><a href="#ProcessADCP-136"><span class="linenos"> 136</span></a><span class="sd">    dday_start : float</span>
</span><span id="ProcessADCP-137"><a href="#ProcessADCP-137"><span class="linenos"> 137</span></a><span class="sd">        Start time of ADCP time series, determined either through `t0` in</span>
</span><span id="ProcessADCP-138"><a href="#ProcessADCP-138"><span class="linenos"> 138</span></a><span class="sd">        `tgridparams` or the start of the time series once at depth.</span>
</span><span id="ProcessADCP-139"><a href="#ProcessADCP-139"><span class="linenos"> 139</span></a><span class="sd">    dday_end : float</span>
</span><span id="ProcessADCP-140"><a href="#ProcessADCP-140"><span class="linenos"> 140</span></a><span class="sd">        End time of ADCP time series, determined either through `t1` in</span>
</span><span id="ProcessADCP-141"><a href="#ProcessADCP-141"><span class="linenos"> 141</span></a><span class="sd">        `tgridparams` or the end of the time series at depth.</span>
</span><span id="ProcessADCP-142"><a href="#ProcessADCP-142"><span class="linenos"> 142</span></a><span class="sd">    start_ddays : list</span>
</span><span id="ProcessADCP-143"><a href="#ProcessADCP-143"><span class="linenos"> 143</span></a><span class="sd">        Start times of averaging intervals</span>
</span><span id="ProcessADCP-144"><a href="#ProcessADCP-144"><span class="linenos"> 144</span></a><span class="sd">    dday_mid : float</span>
</span><span id="ProcessADCP-145"><a href="#ProcessADCP-145"><span class="linenos"> 145</span></a><span class="sd">        Time stamp for ping average as determined in :meth:`make_start_ddays`.</span>
</span><span id="ProcessADCP-146"><a href="#ProcessADCP-146"><span class="linenos"> 146</span></a><span class="sd">    dt : float</span>
</span><span id="ProcessADCP-147"><a href="#ProcessADCP-147"><span class="linenos"> 147</span></a><span class="sd">        Time that is inclusive of one average. For regular averaging, this is</span>
</span><span id="ProcessADCP-148"><a href="#ProcessADCP-148"><span class="linenos"> 148</span></a><span class="sd">        `dt_hours` in `tgridparams` converted to Julian days. For</span>
</span><span id="ProcessADCP-149"><a href="#ProcessADCP-149"><span class="linenos"> 149</span></a><span class="sd">        burst-averagint, this is a time interval that is inclusive of all pings</span>
</span><span id="ProcessADCP-150"><a href="#ProcessADCP-150"><span class="linenos"> 150</span></a><span class="sd">        in one bursts (but goes slightly beyond that into the time between</span>
</span><span id="ProcessADCP-151"><a href="#ProcessADCP-151"><span class="linenos"> 151</span></a><span class="sd">        bursts).</span>
</span><span id="ProcessADCP-152"><a href="#ProcessADCP-152"><span class="linenos"> 152</span></a><span class="sd">    time_drift_rate : float</span>
</span><span id="ProcessADCP-153"><a href="#ProcessADCP-153"><span class="linenos"> 153</span></a><span class="sd">        Clock drift calculated from `driftparams`.</span>
</span><span id="ProcessADCP-154"><a href="#ProcessADCP-154"><span class="linenos"> 154</span></a><span class="sd">    orientation : str</span>
</span><span id="ProcessADCP-155"><a href="#ProcessADCP-155"><span class="linenos"> 155</span></a><span class="sd">        Instrument orientation `up` or `down`.</span>
</span><span id="ProcessADCP-156"><a href="#ProcessADCP-156"><span class="linenos"> 156</span></a><span class="sd">    magdec : float</span>
</span><span id="ProcessADCP-157"><a href="#ProcessADCP-157"><span class="linenos"> 157</span></a><span class="sd">        Magnetic declination.</span>
</span><span id="ProcessADCP-158"><a href="#ProcessADCP-158"><span class="linenos"> 158</span></a><span class="sd">    m : pycurrents.adcp.rdiraw.Multiread</span>
</span><span id="ProcessADCP-159"><a href="#ProcessADCP-159"><span class="linenos"> 159</span></a><span class="sd">        Multiread instance.</span>
</span><span id="ProcessADCP-160"><a href="#ProcessADCP-160"><span class="linenos"> 160</span></a><span class="sd">    tsdat : Bunch</span>
</span><span id="ProcessADCP-161"><a href="#ProcessADCP-161"><span class="linenos"> 161</span></a><span class="sd">        Auxiliary data.</span>
</span><span id="ProcessADCP-162"><a href="#ProcessADCP-162"><span class="linenos"> 162</span></a><span class="sd">    raw : xarray.Dataset</span>
</span><span id="ProcessADCP-163"><a href="#ProcessADCP-163"><span class="linenos"> 163</span></a><span class="sd">        Raw ADCP data.</span>
</span><span id="ProcessADCP-164"><a href="#ProcessADCP-164"><span class="linenos"> 164</span></a><span class="sd">    ds : xarray.Dataset</span>
</span><span id="ProcessADCP-165"><a href="#ProcessADCP-165"><span class="linenos"> 165</span></a><span class="sd">        Time-averaged dataset added by running :meth:`average_ensembles`.</span>
</span><span id="ProcessADCP-166"><a href="#ProcessADCP-166"><span class="linenos"> 166</span></a>
</span><span id="ProcessADCP-167"><a href="#ProcessADCP-167"><span class="linenos"> 167</span></a><span class="sd">    Notes</span>
</span><span id="ProcessADCP-168"><a href="#ProcessADCP-168"><span class="linenos"> 168</span></a><span class="sd">    -----</span>
</span><span id="ProcessADCP-169"><a href="#ProcessADCP-169"><span class="linenos"> 169</span></a><span class="sd">    Various parameters are passed to the instance through dictionaries. Their</span>
</span><span id="ProcessADCP-170"><a href="#ProcessADCP-170"><span class="linenos"> 170</span></a><span class="sd">    specifics are described below. Gridding and editing parameters can be</span>
</span><span id="ProcessADCP-171"><a href="#ProcessADCP-171"><span class="linenos"> 171</span></a><span class="sd">    updated after creating the ProcessADCP instance via `parse_dgridparams`,</span>
</span><span id="ProcessADCP-172"><a href="#ProcessADCP-172"><span class="linenos"> 172</span></a><span class="sd">    `parse_tgridparams`, and  `parse_editparams`.</span>
</span><span id="ProcessADCP-173"><a href="#ProcessADCP-173"><span class="linenos"> 173</span></a>
</span><span id="ProcessADCP-174"><a href="#ProcessADCP-174"><span class="linenos"> 174</span></a><span class="sd">    **Time drift parameters**</span>
</span><span id="ProcessADCP-175"><a href="#ProcessADCP-175"><span class="linenos"> 175</span></a><span class="sd">    Provide clock drift parameters via `driftparams`. Accepted entries are</span>
</span><span id="ProcessADCP-176"><a href="#ProcessADCP-176"><span class="linenos"> 176</span></a><span class="sd">    - `end_adcp` : Time of ADCP at data download</span>
</span><span id="ProcessADCP-177"><a href="#ProcessADCP-177"><span class="linenos"> 177</span></a><span class="sd">    - `end_pc` : UTC time at data download</span>
</span><span id="ProcessADCP-178"><a href="#ProcessADCP-178"><span class="linenos"> 178</span></a>
</span><span id="ProcessADCP-179"><a href="#ProcessADCP-179"><span class="linenos"> 179</span></a><span class="sd">    The difference between `end_adcp` and `end_pc` is used to linearly correct</span>
</span><span id="ProcessADCP-180"><a href="#ProcessADCP-180"><span class="linenos"> 180</span></a><span class="sd">    for instrument clock drift.</span>
</span><span id="ProcessADCP-181"><a href="#ProcessADCP-181"><span class="linenos"> 181</span></a>
</span><span id="ProcessADCP-182"><a href="#ProcessADCP-182"><span class="linenos"> 182</span></a><span class="sd">    **Time gridding parameters**</span>
</span><span id="ProcessADCP-183"><a href="#ProcessADCP-183"><span class="linenos"> 183</span></a><span class="sd">    Provide time gridding parameters via `tgridparams`. Accepted entries are</span>
</span><span id="ProcessADCP-184"><a href="#ProcessADCP-184"><span class="linenos"> 184</span></a><span class="sd">    - `dt_hours` : Time grid interval. Defaults to 0.5h.</span>
</span><span id="ProcessADCP-185"><a href="#ProcessADCP-185"><span class="linenos"> 185</span></a><span class="sd">    - `t0` : Start time for gridding. Determined from data if not provided.</span>
</span><span id="ProcessADCP-186"><a href="#ProcessADCP-186"><span class="linenos"> 186</span></a><span class="sd">    - `t1` : End time for gridding. Determined from data if not provided.</span>
</span><span id="ProcessADCP-187"><a href="#ProcessADCP-187"><span class="linenos"> 187</span></a><span class="sd">    - burst_average : bool</span>
</span><span id="ProcessADCP-188"><a href="#ProcessADCP-188"><span class="linenos"> 188</span></a><span class="sd">        Set ensemble averaging to act on burst sampling scheme. Defaults to False.</span>
</span><span id="ProcessADCP-189"><a href="#ProcessADCP-189"><span class="linenos"> 189</span></a>
</span><span id="ProcessADCP-190"><a href="#ProcessADCP-190"><span class="linenos"> 190</span></a><span class="sd">    **Depth gridding parameters**</span>
</span><span id="ProcessADCP-191"><a href="#ProcessADCP-191"><span class="linenos"> 191</span></a><span class="sd">    Provide depth gridding parameters via `dgridparams`. Accepted entries are</span>
</span><span id="ProcessADCP-192"><a href="#ProcessADCP-192"><span class="linenos"> 192</span></a><span class="sd">    - `dtop` : Shallow depth in m.</span>
</span><span id="ProcessADCP-193"><a href="#ProcessADCP-193"><span class="linenos"> 193</span></a><span class="sd">    - `dbot` : Deep depth in m.</span>
</span><span id="ProcessADCP-194"><a href="#ProcessADCP-194"><span class="linenos"> 194</span></a><span class="sd">    - `dinterval` : Vertical grid size in m. Defaults to 5m.</span>
</span><span id="ProcessADCP-195"><a href="#ProcessADCP-195"><span class="linenos"> 195</span></a>
</span><span id="ProcessADCP-196"><a href="#ProcessADCP-196"><span class="linenos"> 196</span></a><span class="sd">    Values for `dbot` and `dtop` are generated if not provided.</span>
</span><span id="ProcessADCP-197"><a href="#ProcessADCP-197"><span class="linenos"> 197</span></a>
</span><span id="ProcessADCP-198"><a href="#ProcessADCP-198"><span class="linenos"> 198</span></a><span class="sd">    **Editing parameters**</span>
</span><span id="ProcessADCP-199"><a href="#ProcessADCP-199"><span class="linenos"> 199</span></a><span class="sd">    Provide editing parameters via `editparams`.</span>
</span><span id="ProcessADCP-200"><a href="#ProcessADCP-200"><span class="linenos"> 200</span></a><span class="sd">    - `max_e`=0.2,  # absolute max e</span>
</span><span id="ProcessADCP-201"><a href="#ProcessADCP-201"><span class="linenos"> 201</span></a><span class="sd">    - `max_e_deviation`=2,  # max in terms of sigma</span>
</span><span id="ProcessADCP-202"><a href="#ProcessADCP-202"><span class="linenos"> 202</span></a><span class="sd">    - `min_correlation`=64,  # 64 is RDI default</span>
</span><span id="ProcessADCP-203"><a href="#ProcessADCP-203"><span class="linenos"> 203</span></a><span class="sd">    - `maskbins` : Array with booleans indexing into the ADCP bins. Use the</span>
</span><span id="ProcessADCP-204"><a href="#ProcessADCP-204"><span class="linenos"> 204</span></a><span class="sd">      convenience method `generate_binmask`.</span>
</span><span id="ProcessADCP-205"><a href="#ProcessADCP-205"><span class="linenos"> 205</span></a><span class="sd">    - `pg_limit` : float or int or None.</span>
</span><span id="ProcessADCP-206"><a href="#ProcessADCP-206"><span class="linenos"> 206</span></a><span class="sd">            Percent good limit applied prior to interpolating to the universal</span>
</span><span id="ProcessADCP-207"><a href="#ProcessADCP-207"><span class="linenos"> 207</span></a><span class="sd">            depth grid in `burst_average_ensembles`. Not applied in</span>
</span><span id="ProcessADCP-208"><a href="#ProcessADCP-208"><span class="linenos"> 208</span></a><span class="sd">            `average_ensembles` as the user can filter based on pg later.</span>
</span><span id="ProcessADCP-209"><a href="#ProcessADCP-209"><span class="linenos"> 209</span></a>
</span><span id="ProcessADCP-210"><a href="#ProcessADCP-210"><span class="linenos"> 210</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-211"><a href="#ProcessADCP-211"><span class="linenos"> 211</span></a>
</span><span id="ProcessADCP-212"><a href="#ProcessADCP-212"><span class="linenos"> 212</span></a>    <span class="c1"># Default editing parameters.</span>
</span><span id="ProcessADCP-213"><a href="#ProcessADCP-213"><span class="linenos"> 213</span></a>    <span class="n">_editparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ProcessADCP-214"><a href="#ProcessADCP-214"><span class="linenos"> 214</span></a>        <span class="n">max_e</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># absolute max e</span>
</span><span id="ProcessADCP-215"><a href="#ProcessADCP-215"><span class="linenos"> 215</span></a>        <span class="n">max_e_deviation</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># max in terms of sigma</span>
</span><span id="ProcessADCP-216"><a href="#ProcessADCP-216"><span class="linenos"> 216</span></a>        <span class="n">min_correlation</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>  <span class="c1"># 64 is RDI default</span>
</span><span id="ProcessADCP-217"><a href="#ProcessADCP-217"><span class="linenos"> 217</span></a>        <span class="n">maskbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># do not mask any bins</span>
</span><span id="ProcessADCP-218"><a href="#ProcessADCP-218"><span class="linenos"> 218</span></a>        <span class="n">pg_limit</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># percent good limit applied in `burst_average_ensembles`</span>
</span><span id="ProcessADCP-219"><a href="#ProcessADCP-219"><span class="linenos"> 219</span></a>    <span class="p">)</span>
</span><span id="ProcessADCP-220"><a href="#ProcessADCP-220"><span class="linenos"> 220</span></a>
</span><span id="ProcessADCP-221"><a href="#ProcessADCP-221"><span class="linenos"> 221</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ProcessADCP-222"><a href="#ProcessADCP-222"><span class="linenos"> 222</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ProcessADCP-223"><a href="#ProcessADCP-223"><span class="linenos"> 223</span></a>        <span class="n">raw_data</span><span class="p">,</span>
</span><span id="ProcessADCP-224"><a href="#ProcessADCP-224"><span class="linenos"> 224</span></a>        <span class="n">meta_data</span><span class="p">,</span>
</span><span id="ProcessADCP-225"><a href="#ProcessADCP-225"><span class="linenos"> 225</span></a>        <span class="n">driftparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-226"><a href="#ProcessADCP-226"><span class="linenos"> 226</span></a>        <span class="n">tgridparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-227"><a href="#ProcessADCP-227"><span class="linenos"> 227</span></a>        <span class="n">dgridparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-228"><a href="#ProcessADCP-228"><span class="linenos"> 228</span></a>        <span class="n">editparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-229"><a href="#ProcessADCP-229"><span class="linenos"> 229</span></a>        <span class="n">ibad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-230"><a href="#ProcessADCP-230"><span class="linenos"> 230</span></a>        <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-231"><a href="#ProcessADCP-231"><span class="linenos"> 231</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP-232"><a href="#ProcessADCP-232"><span class="linenos"> 232</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP-233"><a href="#ProcessADCP-233"><span class="linenos"> 233</span></a>        <span class="n">magdec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-234"><a href="#ProcessADCP-234"><span class="linenos"> 234</span></a>        <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP-235"><a href="#ProcessADCP-235"><span class="linenos"> 235</span></a>        <span class="n">use_raw_pressure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP-236"><a href="#ProcessADCP-236"><span class="linenos"> 236</span></a>        <span class="n">pressure_scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP-237"><a href="#ProcessADCP-237"><span class="linenos"> 237</span></a>    <span class="p">):</span>
</span><span id="ProcessADCP-238"><a href="#ProcessADCP-238"><span class="linenos"> 238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">meta_data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="ProcessADCP-239"><a href="#ProcessADCP-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ibad</span> <span class="o">=</span> <span class="n">ibad</span>
</span><span id="ProcessADCP-240"><a href="#ProcessADCP-240"><span class="linenos"> 240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="n">logdir</span>
</span><span id="ProcessADCP-241"><a href="#ProcessADCP-241"><span class="linenos"> 241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="ProcessADCP-242"><a href="#ProcessADCP-242"><span class="linenos"> 242</span></a>
</span><span id="ProcessADCP-243"><a href="#ProcessADCP-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span> <span class="o">=</span> <span class="n">magdec</span>
</span><span id="ProcessADCP-244"><a href="#ProcessADCP-244"><span class="linenos"> 244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="n">magdec</span>
</span><span id="ProcessADCP-245"><a href="#ProcessADCP-245"><span class="linenos"> 245</span></a>
</span><span id="ProcessADCP-246"><a href="#ProcessADCP-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="o">=</span> <span class="n">pressure</span>
</span><span id="ProcessADCP-247"><a href="#ProcessADCP-247"><span class="linenos"> 247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span> <span class="o">=</span> <span class="n">pressure_scale_factor</span>
</span><span id="ProcessADCP-248"><a href="#ProcessADCP-248"><span class="linenos"> 248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_use_raw_pressure</span> <span class="o">=</span> <span class="n">use_raw_pressure</span>
</span><span id="ProcessADCP-249"><a href="#ProcessADCP-249"><span class="linenos"> 249</span></a>
</span><span id="ProcessADCP-250"><a href="#ProcessADCP-250"><span class="linenos"> 250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP-251"><a href="#ProcessADCP-251"><span class="linenos"> 251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP-252"><a href="#ProcessADCP-252"><span class="linenos"> 252</span></a>
</span><span id="ProcessADCP-253"><a href="#ProcessADCP-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_file_locations</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span><span id="ProcessADCP-254"><a href="#ProcessADCP-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_data_reader</span><span class="p">()</span>
</span><span id="ProcessADCP-255"><a href="#ProcessADCP-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_auxiliary_data</span><span class="p">()</span>
</span><span id="ProcessADCP-256"><a href="#ProcessADCP-256"><span class="linenos"> 256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_meta_data</span><span class="p">()</span>
</span><span id="ProcessADCP-257"><a href="#ProcessADCP-257"><span class="linenos"> 257</span></a>
</span><span id="ProcessADCP-258"><a href="#ProcessADCP-258"><span class="linenos"> 258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_logger</span><span class="p">()</span>
</span><span id="ProcessADCP-259"><a href="#ProcessADCP-259"><span class="linenos"> 259</span></a>
</span><span id="ProcessADCP-260"><a href="#ProcessADCP-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_driftparams</span><span class="p">(</span><span class="n">driftparams</span><span class="p">)</span>
</span><span id="ProcessADCP-261"><a href="#ProcessADCP-261"><span class="linenos"> 261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sysconfig</span><span class="p">()</span>
</span><span id="ProcessADCP-262"><a href="#ProcessADCP-262"><span class="linenos"> 262</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_dgridparams</span><span class="p">(</span><span class="n">dgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP-263"><a href="#ProcessADCP-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_tgridparams</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP-264"><a href="#ProcessADCP-264"><span class="linenos"> 264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_editparams</span><span class="p">(</span><span class="n">editparams</span><span class="p">)</span>
</span><span id="ProcessADCP-265"><a href="#ProcessADCP-265"><span class="linenos"> 265</span></a>
</span><span id="ProcessADCP-266"><a href="#ProcessADCP-266"><span class="linenos"> 266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">make_start_ddays</span><span class="p">()</span>
</span><span id="ProcessADCP-267"><a href="#ProcessADCP-267"><span class="linenos"> 267</span></a>
</span><span id="ProcessADCP-268"><a href="#ProcessADCP-268"><span class="linenos"> 268</span></a>        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="ProcessADCP-269"><a href="#ProcessADCP-269"><span class="linenos"> 269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_pressure</span><span class="p">()</span>
</span><span id="ProcessADCP-270"><a href="#ProcessADCP-270"><span class="linenos"> 270</span></a>
</span><span id="ProcessADCP-271"><a href="#ProcessADCP-271"><span class="linenos"> 271</span></a>    <span class="k">def</span> <span class="nf">parse_file_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">min_file_size</span><span class="o">=</span><span class="mf">1e4</span><span class="p">):</span>
</span><span id="ProcessADCP-272"><a href="#ProcessADCP-272"><span class="linenos"> 272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse input for raw data files.</span>
</span><span id="ProcessADCP-273"><a href="#ProcessADCP-273"><span class="linenos"> 273</span></a>
</span><span id="ProcessADCP-274"><a href="#ProcessADCP-274"><span class="linenos"> 274</span></a><span class="sd">        Input can either be a single file name as a str, a single file as a</span>
</span><span id="ProcessADCP-275"><a href="#ProcessADCP-275"><span class="linenos"> 275</span></a><span class="sd">        Path instance, a list of either of these, or a Path instance pointing to a</span>
</span><span id="ProcessADCP-276"><a href="#ProcessADCP-276"><span class="linenos"> 276</span></a><span class="sd">        directory with raw ADCP files. In the latter case, files that are</span>
</span><span id="ProcessADCP-277"><a href="#ProcessADCP-277"><span class="linenos"> 277</span></a><span class="sd">        smaller than a threshold will not be included in the processing.</span>
</span><span id="ProcessADCP-278"><a href="#ProcessADCP-278"><span class="linenos"> 278</span></a>
</span><span id="ProcessADCP-279"><a href="#ProcessADCP-279"><span class="linenos"> 279</span></a><span class="sd">        Outputs to attribute `files`. The output can be fed to Multiread instances.</span>
</span><span id="ProcessADCP-280"><a href="#ProcessADCP-280"><span class="linenos"> 280</span></a>
</span><span id="ProcessADCP-281"><a href="#ProcessADCP-281"><span class="linenos"> 281</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-282"><a href="#ProcessADCP-282"><span class="linenos"> 282</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-283"><a href="#ProcessADCP-283"><span class="linenos"> 283</span></a><span class="sd">        raw_data : str or list or Path</span>
</span><span id="ProcessADCP-284"><a href="#ProcessADCP-284"><span class="linenos"> 284</span></a><span class="sd">            Location(s) of raw data.</span>
</span><span id="ProcessADCP-285"><a href="#ProcessADCP-285"><span class="linenos"> 285</span></a><span class="sd">        min_file_size : int</span>
</span><span id="ProcessADCP-286"><a href="#ProcessADCP-286"><span class="linenos"> 286</span></a><span class="sd">            Minimum size for file to be included. Defaults to 1e4 which</span>
</span><span id="ProcessADCP-287"><a href="#ProcessADCP-287"><span class="linenos"> 287</span></a><span class="sd">            corresponds to about 10kB and is a good value for excluding small</span>
</span><span id="ProcessADCP-288"><a href="#ProcessADCP-288"><span class="linenos"> 288</span></a><span class="sd">            files without any actual data.</span>
</span><span id="ProcessADCP-289"><a href="#ProcessADCP-289"><span class="linenos"> 289</span></a>
</span><span id="ProcessADCP-290"><a href="#ProcessADCP-290"><span class="linenos"> 290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-291"><a href="#ProcessADCP-291"><span class="linenos"> 291</span></a>
</span><span id="ProcessADCP-292"><a href="#ProcessADCP-292"><span class="linenos"> 292</span></a>        <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">min_file_size</span><span class="p">):</span>
</span><span id="ProcessADCP-293"><a href="#ProcessADCP-293"><span class="linenos"> 293</span></a>            <span class="c1"># List all raw files.</span>
</span><span id="ProcessADCP-294"><a href="#ProcessADCP-294"><span class="linenos"> 294</span></a>            <span class="n">all_raw_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.00*&quot;</span><span class="p">)))</span>
</span><span id="ProcessADCP-295"><a href="#ProcessADCP-295"><span class="linenos"> 295</span></a>            <span class="c1"># only files larger than about 10kB</span>
</span><span id="ProcessADCP-296"><a href="#ProcessADCP-296"><span class="linenos"> 296</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ProcessADCP-297"><a href="#ProcessADCP-297"><span class="linenos"> 297</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
</span><span id="ProcessADCP-298"><a href="#ProcessADCP-298"><span class="linenos"> 298</span></a>                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">all_raw_files</span>
</span><span id="ProcessADCP-299"><a href="#ProcessADCP-299"><span class="linenos"> 299</span></a>                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="n">min_file_size</span>
</span><span id="ProcessADCP-300"><a href="#ProcessADCP-300"><span class="linenos"> 300</span></a>            <span class="p">]</span>
</span><span id="ProcessADCP-301"><a href="#ProcessADCP-301"><span class="linenos"> 301</span></a>            <span class="k">return</span> <span class="n">files</span>
</span><span id="ProcessADCP-302"><a href="#ProcessADCP-302"><span class="linenos"> 302</span></a>
</span><span id="ProcessADCP-303"><a href="#ProcessADCP-303"><span class="linenos"> 303</span></a>        <span class="n">input_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span><span id="ProcessADCP-304"><a href="#ProcessADCP-304"><span class="linenos"> 304</span></a>        <span class="k">if</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="ProcessADCP-305"><a href="#ProcessADCP-305"><span class="linenos"> 305</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ProcessADCP-306"><a href="#ProcessADCP-306"><span class="linenos"> 306</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">raw_data</span>
</span><span id="ProcessADCP-307"><a href="#ProcessADCP-307"><span class="linenos"> 307</span></a>            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
</span><span id="ProcessADCP-308"><a href="#ProcessADCP-308"><span class="linenos"> 308</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">]</span>
</span><span id="ProcessADCP-309"><a href="#ProcessADCP-309"><span class="linenos"> 309</span></a>        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ProcessADCP-310"><a href="#ProcessADCP-310"><span class="linenos"> 310</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="ProcessADCP-311"><a href="#ProcessADCP-311"><span class="linenos"> 311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">list_dir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">raw_data</span><span class="p">),</span> <span class="n">min_file_size</span><span class="p">)</span>
</span><span id="ProcessADCP-312"><a href="#ProcessADCP-312"><span class="linenos"> 312</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-313"><a href="#ProcessADCP-313"><span class="linenos"> 313</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_data</span><span class="p">]</span>
</span><span id="ProcessADCP-314"><a href="#ProcessADCP-314"><span class="linenos"> 314</span></a>        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
</span><span id="ProcessADCP-315"><a href="#ProcessADCP-315"><span class="linenos"> 315</span></a>            <span class="k">if</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="ProcessADCP-316"><a href="#ProcessADCP-316"><span class="linenos"> 316</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">list_dir</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">min_file_size</span><span class="p">)</span>
</span><span id="ProcessADCP-317"><a href="#ProcessADCP-317"><span class="linenos"> 317</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-318"><a href="#ProcessADCP-318"><span class="linenos"> 318</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_data</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()]</span>
</span><span id="ProcessADCP-319"><a href="#ProcessADCP-319"><span class="linenos"> 319</span></a>
</span><span id="ProcessADCP-320"><a href="#ProcessADCP-320"><span class="linenos"> 320</span></a>    <span class="k">def</span> <span class="nf">_initiate_data_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-321"><a href="#ProcessADCP-321"><span class="linenos"> 321</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiate a Multiread data reader.</span>
</span><span id="ProcessADCP-322"><a href="#ProcessADCP-322"><span class="linenos"> 322</span></a>
</span><span id="ProcessADCP-323"><a href="#ProcessADCP-323"><span class="linenos"> 323</span></a><span class="sd">        Adds attribute `m`.</span>
</span><span id="ProcessADCP-324"><a href="#ProcessADCP-324"><span class="linenos"> 324</span></a>
</span><span id="ProcessADCP-325"><a href="#ProcessADCP-325"><span class="linenos"> 325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-326"><a href="#ProcessADCP-326"><span class="linenos"> 326</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">Multiread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span> <span class="n">sonar</span><span class="o">=</span><span class="s2">&quot;wh&quot;</span><span class="p">,</span> <span class="n">ibad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ibad</span><span class="p">)</span>
</span><span id="ProcessADCP-327"><a href="#ProcessADCP-327"><span class="linenos"> 327</span></a>        <span class="c1"># Make some more meta data readily available by reading a single ping</span>
</span><span id="ProcessADCP-328"><a href="#ProcessADCP-328"><span class="linenos"> 328</span></a>        <span class="c1"># from the raw data.</span>
</span><span id="ProcessADCP-329"><a href="#ProcessADCP-329"><span class="linenos"> 329</span></a>        <span class="n">ping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-330"><a href="#ProcessADCP-330"><span class="linenos"> 330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">Bin1Dist</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">Bin1Dist</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="ProcessADCP-331"><a href="#ProcessADCP-331"><span class="linenos"> 331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">NCells</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">NCells</span>
</span><span id="ProcessADCP-332"><a href="#ProcessADCP-332"><span class="linenos"> 332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">CellSize</span> <span class="o">=</span> <span class="n">ping</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">CellSize</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="ProcessADCP-333"><a href="#ProcessADCP-333"><span class="linenos"> 333</span></a>
</span><span id="ProcessADCP-334"><a href="#ProcessADCP-334"><span class="linenos"> 334</span></a>    <span class="k">def</span> <span class="nf">_generate_external_pressure_interpolator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
</span><span id="ProcessADCP-335"><a href="#ProcessADCP-335"><span class="linenos"> 335</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate external pressure to pycurrents time vector.</span>
</span><span id="ProcessADCP-336"><a href="#ProcessADCP-336"><span class="linenos"> 336</span></a>
</span><span id="ProcessADCP-337"><a href="#ProcessADCP-337"><span class="linenos"> 337</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-338"><a href="#ProcessADCP-338"><span class="linenos"> 338</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-339"><a href="#ProcessADCP-339"><span class="linenos"> 339</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="ProcessADCP-340"><a href="#ProcessADCP-340"><span class="linenos"> 340</span></a><span class="sd">            Data structure.</span>
</span><span id="ProcessADCP-341"><a href="#ProcessADCP-341"><span class="linenos"> 341</span></a>
</span><span id="ProcessADCP-342"><a href="#ProcessADCP-342"><span class="linenos"> 342</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-343"><a href="#ProcessADCP-343"><span class="linenos"> 343</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-344"><a href="#ProcessADCP-344"><span class="linenos"> 344</span></a><span class="sd">        Interpolator</span>
</span><span id="ProcessADCP-345"><a href="#ProcessADCP-345"><span class="linenos"> 345</span></a>
</span><span id="ProcessADCP-346"><a href="#ProcessADCP-346"><span class="linenos"> 346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-347"><a href="#ProcessADCP-347"><span class="linenos"> 347</span></a>
</span><span id="ProcessADCP-348"><a href="#ProcessADCP-348"><span class="linenos"> 348</span></a>        <span class="c1"># We already have a function to convert the pycurrents time to</span>
</span><span id="ProcessADCP-349"><a href="#ProcessADCP-349"><span class="linenos"> 349</span></a>        <span class="c1"># datetime64. Interpolate in this time domain.</span>
</span><span id="ProcessADCP-350"><a href="#ProcessADCP-350"><span class="linenos"> 350</span></a>        <span class="n">time</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">yday0_to_datetime64</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="ProcessADCP-351"><a href="#ProcessADCP-351"><span class="linenos"> 351</span></a>        <span class="n">p_interpolated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</span><span id="ProcessADCP-352"><a href="#ProcessADCP-352"><span class="linenos"> 352</span></a>
</span><span id="ProcessADCP-353"><a href="#ProcessADCP-353"><span class="linenos"> 353</span></a>        <span class="c1"># Beginning and end may have NaN&#39;s if the ADCP was started before</span>
</span><span id="ProcessADCP-354"><a href="#ProcessADCP-354"><span class="linenos"> 354</span></a>        <span class="c1"># the external pressure sensor. Make sure this happens only when</span>
</span><span id="ProcessADCP-355"><a href="#ProcessADCP-355"><span class="linenos"> 355</span></a>        <span class="c1"># outside the water and then replace with atmospheric pressure.</span>
</span><span id="ProcessADCP-356"><a href="#ProcessADCP-356"><span class="linenos"> 356</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">)):</span>
</span><span id="ProcessADCP-357"><a href="#ProcessADCP-357"><span class="linenos"> 357</span></a>            <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">)</span>
</span><span id="ProcessADCP-358"><a href="#ProcessADCP-358"><span class="linenos"> 358</span></a>            <span class="n">i_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">nan_mask</span><span class="p">)</span>
</span><span id="ProcessADCP-359"><a href="#ProcessADCP-359"><span class="linenos"> 359</span></a>
</span><span id="ProcessADCP-360"><a href="#ProcessADCP-360"><span class="linenos"> 360</span></a>            <span class="n">first_few_good_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">][:</span><span class="mi">20</span><span class="p">])</span>
</span><span id="ProcessADCP-361"><a href="#ProcessADCP-361"><span class="linenos"> 361</span></a>            <span class="n">last_few_good_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">][</span><span class="o">-</span><span class="mi">20</span><span class="p">:])</span>
</span><span id="ProcessADCP-362"><a href="#ProcessADCP-362"><span class="linenos"> 362</span></a>
</span><span id="ProcessADCP-363"><a href="#ProcessADCP-363"><span class="linenos"> 363</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="ProcessADCP-364"><a href="#ProcessADCP-364"><span class="linenos"> 364</span></a>            <span class="k">if</span> <span class="n">first_few_good_median</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ProcessADCP-365"><a href="#ProcessADCP-365"><span class="linenos"> 365</span></a>                <span class="n">i_divide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">i_nan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ProcessADCP-366"><a href="#ProcessADCP-366"><span class="linenos"> 366</span></a>                <span class="k">if</span> <span class="n">i_divide</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ProcessADCP-367"><a href="#ProcessADCP-367"><span class="linenos"> 367</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_few_good_median</span>
</span><span id="ProcessADCP-368"><a href="#ProcessADCP-368"><span class="linenos"> 368</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-369"><a href="#ProcessADCP-369"><span class="linenos"> 369</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_divide</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_few_good_median</span>
</span><span id="ProcessADCP-370"><a href="#ProcessADCP-370"><span class="linenos"> 370</span></a>
</span><span id="ProcessADCP-371"><a href="#ProcessADCP-371"><span class="linenos"> 371</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_interpolated</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="ProcessADCP-372"><a href="#ProcessADCP-372"><span class="linenos"> 372</span></a>            <span class="k">if</span> <span class="n">last_few_good_median</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ProcessADCP-373"><a href="#ProcessADCP-373"><span class="linenos"> 373</span></a>                <span class="n">i_divide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">i_nan</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ProcessADCP-374"><a href="#ProcessADCP-374"><span class="linenos"> 374</span></a>                <span class="k">if</span> <span class="n">i_divide</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ProcessADCP-375"><a href="#ProcessADCP-375"><span class="linenos"> 375</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_few_good_median</span>
</span><span id="ProcessADCP-376"><a href="#ProcessADCP-376"><span class="linenos"> 376</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-377"><a href="#ProcessADCP-377"><span class="linenos"> 377</span></a>                    <span class="n">p_interpolated</span><span class="p">[</span><span class="n">i_divide</span><span class="p">:]</span> <span class="o">=</span> <span class="n">last_few_good_median</span>
</span><span id="ProcessADCP-378"><a href="#ProcessADCP-378"><span class="linenos"> 378</span></a>
</span><span id="ProcessADCP-379"><a href="#ProcessADCP-379"><span class="linenos"> 379</span></a>        <span class="c1"># Now generate an interpolation function that will take dday as input</span>
</span><span id="ProcessADCP-380"><a href="#ProcessADCP-380"><span class="linenos"> 380</span></a>        <span class="c1"># for later per-ensemble interpolation.</span>
</span><span id="ProcessADCP-381"><a href="#ProcessADCP-381"><span class="linenos"> 381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_interpolator</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
</span><span id="ProcessADCP-382"><a href="#ProcessADCP-382"><span class="linenos"> 382</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP-383"><a href="#ProcessADCP-383"><span class="linenos"> 383</span></a>            <span class="n">p_interpolated</span><span class="p">,</span>
</span><span id="ProcessADCP-384"><a href="#ProcessADCP-384"><span class="linenos"> 384</span></a>            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP-385"><a href="#ProcessADCP-385"><span class="linenos"> 385</span></a>            <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-386"><a href="#ProcessADCP-386"><span class="linenos"> 386</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-387"><a href="#ProcessADCP-387"><span class="linenos"> 387</span></a>
</span><span id="ProcessADCP-388"><a href="#ProcessADCP-388"><span class="linenos"> 388</span></a>    <span class="k">def</span> <span class="nf">_external_pressure_to_dat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
</span><span id="ProcessADCP-389"><a href="#ProcessADCP-389"><span class="linenos"> 389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interpolate external pressure to pycurrents time vector.</span>
</span><span id="ProcessADCP-390"><a href="#ProcessADCP-390"><span class="linenos"> 390</span></a>
</span><span id="ProcessADCP-391"><a href="#ProcessADCP-391"><span class="linenos"> 391</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-392"><a href="#ProcessADCP-392"><span class="linenos"> 392</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-393"><a href="#ProcessADCP-393"><span class="linenos"> 393</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="ProcessADCP-394"><a href="#ProcessADCP-394"><span class="linenos"> 394</span></a><span class="sd">            Data structure.</span>
</span><span id="ProcessADCP-395"><a href="#ProcessADCP-395"><span class="linenos"> 395</span></a>
</span><span id="ProcessADCP-396"><a href="#ProcessADCP-396"><span class="linenos"> 396</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-397"><a href="#ProcessADCP-397"><span class="linenos"> 397</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-398"><a href="#ProcessADCP-398"><span class="linenos"> 398</span></a><span class="sd">        array-like</span>
</span><span id="ProcessADCP-399"><a href="#ProcessADCP-399"><span class="linenos"> 399</span></a><span class="sd">            Pressure</span>
</span><span id="ProcessADCP-400"><a href="#ProcessADCP-400"><span class="linenos"> 400</span></a>
</span><span id="ProcessADCP-401"><a href="#ProcessADCP-401"><span class="linenos"> 401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-402"><a href="#ProcessADCP-402"><span class="linenos"> 402</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_interpolator</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="ProcessADCP-403"><a href="#ProcessADCP-403"><span class="linenos"> 403</span></a>
</span><span id="ProcessADCP-404"><a href="#ProcessADCP-404"><span class="linenos"> 404</span></a>    <span class="k">def</span> <span class="nf">_scale_pycurrents_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
</span><span id="ProcessADCP-405"><a href="#ProcessADCP-405"><span class="linenos"> 405</span></a>        <span class="c1"># Initial pressure units: 10 Pa (about 1 mm or 0.001 decibar).</span>
</span><span id="ProcessADCP-406"><a href="#ProcessADCP-406"><span class="linenos"> 406</span></a>        <span class="c1"># Converting to decibars.</span>
</span><span id="ProcessADCP-407"><a href="#ProcessADCP-407"><span class="linenos"> 407</span></a>        <span class="k">return</span> <span class="n">dat</span><span class="o">.</span><span class="n">VL</span><span class="p">[</span><span class="s2">&quot;Pressure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span>
</span><span id="ProcessADCP-408"><a href="#ProcessADCP-408"><span class="linenos"> 408</span></a>
</span><span id="ProcessADCP-409"><a href="#ProcessADCP-409"><span class="linenos"> 409</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP-410"><a href="#ProcessADCP-410"><span class="linenos"> 410</span></a>    <span class="k">def</span> <span class="nf">pressure_lp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-411"><a href="#ProcessADCP-411"><span class="linenos"> 411</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Low-pass filtered pressure time series&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-412"><a href="#ProcessADCP-412"><span class="linenos"> 412</span></a>        <span class="k">if</span> <span class="s2">&quot;pressure_lp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="p">:</span>
</span><span id="ProcessADCP-413"><a href="#ProcessADCP-413"><span class="linenos"> 413</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure_lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lowpassfilter_pressure</span><span class="p">()</span>
</span><span id="ProcessADCP-414"><a href="#ProcessADCP-414"><span class="linenos"> 414</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure_lp</span>
</span><span id="ProcessADCP-415"><a href="#ProcessADCP-415"><span class="linenos"> 415</span></a>
</span><span id="ProcessADCP-416"><a href="#ProcessADCP-416"><span class="linenos"> 416</span></a>    <span class="k">def</span> <span class="nf">_lowpassfilter_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-417"><a href="#ProcessADCP-417"><span class="linenos"> 417</span></a>        <span class="n">t64</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">yday0_to_datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="ProcessADCP-418"><a href="#ProcessADCP-418"><span class="linenos"> 418</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">tools</span><span class="o">.</span><span class="n">dominant_period_in_s</span><span class="p">(</span><span class="n">t64</span><span class="p">)</span>
</span><span id="ProcessADCP-419"><a href="#ProcessADCP-419"><span class="linenos"> 419</span></a>        <span class="c1"># Make cutoff period either 30 minutes or 50 data points,</span>
</span><span id="ProcessADCP-420"><a href="#ProcessADCP-420"><span class="linenos"> 420</span></a>        <span class="c1"># whatever is shorter.</span>
</span><span id="ProcessADCP-421"><a href="#ProcessADCP-421"><span class="linenos"> 421</span></a>        <span class="n">cutoff</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">fs</span><span class="p">)</span>
</span><span id="ProcessADCP-422"><a href="#ProcessADCP-422"><span class="linenos"> 422</span></a>        <span class="k">if</span> <span class="n">cutoff</span> <span class="o">&gt;</span> <span class="mi">1800</span><span class="p">:</span>
</span><span id="ProcessADCP-423"><a href="#ProcessADCP-423"><span class="linenos"> 423</span></a>            <span class="n">cutoff</span> <span class="o">=</span> <span class="mi">1800</span>
</span><span id="ProcessADCP-424"><a href="#ProcessADCP-424"><span class="linenos"> 424</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span>
</span><span id="ProcessADCP-425"><a href="#ProcessADCP-425"><span class="linenos"> 425</span></a>        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">lowpassfilter</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
</span><span id="ProcessADCP-426"><a href="#ProcessADCP-426"><span class="linenos"> 426</span></a>
</span><span id="ProcessADCP-427"><a href="#ProcessADCP-427"><span class="linenos"> 427</span></a>    <span class="k">def</span> <span class="nf">_read_auxiliary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-428"><a href="#ProcessADCP-428"><span class="linenos"> 428</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Read auxiliary data.</span>
</span><span id="ProcessADCP-429"><a href="#ProcessADCP-429"><span class="linenos"> 429</span></a>
</span><span id="ProcessADCP-430"><a href="#ProcessADCP-430"><span class="linenos"> 430</span></a><span class="sd">        Adds attribute `tsdat`.</span>
</span><span id="ProcessADCP-431"><a href="#ProcessADCP-431"><span class="linenos"> 431</span></a>
</span><span id="ProcessADCP-432"><a href="#ProcessADCP-432"><span class="linenos"> 432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-433"><a href="#ProcessADCP-433"><span class="linenos"> 433</span></a>        <span class="n">tsdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">varlist</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;VariableLeader&quot;</span><span class="p">])</span>
</span><span id="ProcessADCP-434"><a href="#ProcessADCP-434"><span class="linenos"> 434</span></a>        <span class="n">tsdat</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">tsdat</span><span class="o">.</span><span class="n">VL</span><span class="p">[</span><span class="s2">&quot;Temperature&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>
</span><span id="ProcessADCP-435"><a href="#ProcessADCP-435"><span class="linenos"> 435</span></a>        <span class="c1"># Replace pressure if provided from external sensor</span>
</span><span id="ProcessADCP-436"><a href="#ProcessADCP-436"><span class="linenos"> 436</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-437"><a href="#ProcessADCP-437"><span class="linenos"> 437</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_external_pressure_interpolator</span><span class="p">(</span><span class="n">tsdat</span><span class="p">)</span>
</span><span id="ProcessADCP-438"><a href="#ProcessADCP-438"><span class="linenos"> 438</span></a>            <span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">tsdat</span><span class="p">)</span>
</span><span id="ProcessADCP-439"><a href="#ProcessADCP-439"><span class="linenos"> 439</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-440"><a href="#ProcessADCP-440"><span class="linenos"> 440</span></a>            <span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">tsdat</span><span class="p">)</span>
</span><span id="ProcessADCP-441"><a href="#ProcessADCP-441"><span class="linenos"> 441</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span> <span class="o">=</span> <span class="n">tsdat</span>
</span><span id="ProcessADCP-442"><a href="#ProcessADCP-442"><span class="linenos"> 442</span></a>
</span><span id="ProcessADCP-443"><a href="#ProcessADCP-443"><span class="linenos"> 443</span></a>    <span class="k">def</span> <span class="nf">_parse_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-444"><a href="#ProcessADCP-444"><span class="linenos"> 444</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse meta data.</span>
</span><span id="ProcessADCP-445"><a href="#ProcessADCP-445"><span class="linenos"> 445</span></a>
</span><span id="ProcessADCP-446"><a href="#ProcessADCP-446"><span class="linenos"> 446</span></a><span class="sd">        - Add essential meta data to attributes. Will throw a KeyError if no</span>
</span><span id="ProcessADCP-447"><a href="#ProcessADCP-447"><span class="linenos"> 447</span></a><span class="sd">          lon/lat provided.</span>
</span><span id="ProcessADCP-448"><a href="#ProcessADCP-448"><span class="linenos"> 448</span></a>
</span><span id="ProcessADCP-449"><a href="#ProcessADCP-449"><span class="linenos"> 449</span></a><span class="sd">        - Read serial number from raw data and complain if it does not match</span>
</span><span id="ProcessADCP-450"><a href="#ProcessADCP-450"><span class="linenos"> 450</span></a><span class="sd">          the meta data SN.</span>
</span><span id="ProcessADCP-451"><a href="#ProcessADCP-451"><span class="linenos"> 451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-452"><a href="#ProcessADCP-452"><span class="linenos"> 452</span></a>        <span class="n">essential_meta_data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span>
</span><span id="ProcessADCP-453"><a href="#ProcessADCP-453"><span class="linenos"> 453</span></a>
</span><span id="ProcessADCP-454"><a href="#ProcessADCP-454"><span class="linenos"> 454</span></a>        <span class="p">[</span>
</span><span id="ProcessADCP-455"><a href="#ProcessADCP-455"><span class="linenos"> 455</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_safely_add_attribute_from_params</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">)</span>
</span><span id="ProcessADCP-456"><a href="#ProcessADCP-456"><span class="linenos"> 456</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">essential_meta_data</span>
</span><span id="ProcessADCP-457"><a href="#ProcessADCP-457"><span class="linenos"> 457</span></a>        <span class="p">]</span>
</span><span id="ProcessADCP-458"><a href="#ProcessADCP-458"><span class="linenos"> 458</span></a>
</span><span id="ProcessADCP-459"><a href="#ProcessADCP-459"><span class="linenos"> 459</span></a>        <span class="c1"># Check SN</span>
</span><span id="ProcessADCP-460"><a href="#ProcessADCP-460"><span class="linenos"> 460</span></a>        <span class="n">sn_internal</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">FL</span><span class="o">.</span><span class="n">Inst_SN</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-461"><a href="#ProcessADCP-461"><span class="linenos"> 461</span></a>
</span><span id="ProcessADCP-462"><a href="#ProcessADCP-462"><span class="linenos"> 462</span></a>        <span class="k">if</span> <span class="s2">&quot;sn&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
</span><span id="ProcessADCP-463"><a href="#ProcessADCP-463"><span class="linenos"> 463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">sn</span> <span class="o">=</span> <span class="n">sn_internal</span>
</span><span id="ProcessADCP-464"><a href="#ProcessADCP-464"><span class="linenos"> 464</span></a>
</span><span id="ProcessADCP-465"><a href="#ProcessADCP-465"><span class="linenos"> 465</span></a>        <span class="c1"># Check internal SN matches user set one</span>
</span><span id="ProcessADCP-466"><a href="#ProcessADCP-466"><span class="linenos"> 466</span></a>        <span class="k">if</span> <span class="n">sn_internal</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">sn</span><span class="p">:</span>
</span><span id="ProcessADCP-467"><a href="#ProcessADCP-467"><span class="linenos"> 467</span></a>            <span class="n">warn</span><span class="p">(</span>
</span><span id="ProcessADCP-468"><a href="#ProcessADCP-468"><span class="linenos"> 468</span></a>                <span class="sa">f</span><span class="s2">&quot;Serial number in file, </span><span class="si">{</span><span class="n">sn_internal</span><span class="si">}</span><span class="s2">, is different from that set by user, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">sn</span><span class="si">}</span><span class="s2">. Keeping user value.&quot;</span>
</span><span id="ProcessADCP-469"><a href="#ProcessADCP-469"><span class="linenos"> 469</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-470"><a href="#ProcessADCP-470"><span class="linenos"> 470</span></a>
</span><span id="ProcessADCP-471"><a href="#ProcessADCP-471"><span class="linenos"> 471</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP-472"><a href="#ProcessADCP-472"><span class="linenos"> 472</span></a>    <span class="k">def</span> <span class="nf">default_dgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-473"><a href="#ProcessADCP-473"><span class="linenos"> 473</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine default depth gridding parameters.</span>
</span><span id="ProcessADCP-474"><a href="#ProcessADCP-474"><span class="linenos"> 474</span></a>
</span><span id="ProcessADCP-475"><a href="#ProcessADCP-475"><span class="linenos"> 475</span></a><span class="sd">        The grid is centered on the  median depth of the ADCP (plus distance to</span>
</span><span id="ProcessADCP-476"><a href="#ProcessADCP-476"><span class="linenos"> 476</span></a><span class="sd">        the center of the first bin) to avoid unnecessary binning into</span>
</span><span id="ProcessADCP-477"><a href="#ProcessADCP-477"><span class="linenos"> 477</span></a><span class="sd">        neighboring depth cells. The default size of the depth bins mimicks the</span>
</span><span id="ProcessADCP-478"><a href="#ProcessADCP-478"><span class="linenos"> 478</span></a><span class="sd">        size of ADCP bins.</span>
</span><span id="ProcessADCP-479"><a href="#ProcessADCP-479"><span class="linenos"> 479</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-480"><a href="#ProcessADCP-480"><span class="linenos"> 480</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-481"><a href="#ProcessADCP-481"><span class="linenos"> 481</span></a>            <span class="c1"># Only use pressure at depth, not on deck</span>
</span><span id="ProcessADCP-482"><a href="#ProcessADCP-482"><span class="linenos"> 482</span></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="ProcessADCP-483"><a href="#ProcessADCP-483"><span class="linenos"> 483</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ProcessADCP-484"><a href="#ProcessADCP-484"><span class="linenos"> 484</span></a>            <span class="c1"># Determine limits of the pressure distribution but leave out the</span>
</span><span id="ProcessADCP-485"><a href="#ProcessADCP-485"><span class="linenos"> 485</span></a>            <span class="c1"># top 5 and bottom 2 percent of data points. This way we are hoping</span>
</span><span id="ProcessADCP-486"><a href="#ProcessADCP-486"><span class="linenos"> 486</span></a>            <span class="c1"># to avoid any outliers and a possible pressure record of ascent</span>
</span><span id="ProcessADCP-487"><a href="#ProcessADCP-487"><span class="linenos"> 487</span></a>            <span class="c1"># and/or descent.</span>
</span><span id="ProcessADCP-488"><a href="#ProcessADCP-488"><span class="linenos"> 488</span></a>            <span class="n">p_top</span><span class="p">,</span> <span class="n">p_bot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="ProcessADCP-489"><a href="#ProcessADCP-489"><span class="linenos"> 489</span></a>                <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">98</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP-490"><a href="#ProcessADCP-490"><span class="linenos"> 490</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-491"><a href="#ProcessADCP-491"><span class="linenos"> 491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="ProcessADCP-492"><a href="#ProcessADCP-492"><span class="linenos"> 492</span></a>            <span class="n">pdep_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_median</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
</span><span id="ProcessADCP-493"><a href="#ProcessADCP-493"><span class="linenos"> 493</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">NCells</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="ProcessADCP-494"><a href="#ProcessADCP-494"><span class="linenos"> 494</span></a>            <span class="n">d_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">CellSize</span>
</span><span id="ProcessADCP-495"><a href="#ProcessADCP-495"><span class="linenos"> 495</span></a>            <span class="n">distance_to_first_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">Bin1Dist</span><span class="p">)</span>
</span><span id="ProcessADCP-496"><a href="#ProcessADCP-496"><span class="linenos"> 496</span></a>            <span class="n">distance_to_last_bin</span> <span class="o">=</span> <span class="n">distance_to_first_bin</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">d_interval</span>
</span><span id="ProcessADCP-497"><a href="#ProcessADCP-497"><span class="linenos"> 497</span></a>
</span><span id="ProcessADCP-498"><a href="#ProcessADCP-498"><span class="linenos"> 498</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span><span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP-499"><a href="#ProcessADCP-499"><span class="linenos"> 499</span></a>                <span class="c1"># Set minimum grid depth level. Anything shallower than 10m</span>
</span><span id="ProcessADCP-500"><a href="#ProcessADCP-500"><span class="linenos"> 500</span></a>                <span class="c1"># will be garbage anyways so let&#39;s throw this out.</span>
</span><span id="ProcessADCP-501"><a href="#ProcessADCP-501"><span class="linenos"> 501</span></a>                <span class="n">dtop</span> <span class="o">=</span> <span class="n">p_top</span> <span class="o">-</span> <span class="n">distance_to_last_bin</span>
</span><span id="ProcessADCP-502"><a href="#ProcessADCP-502"><span class="linenos"> 502</span></a>                <span class="k">if</span> <span class="n">dtop</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="ProcessADCP-503"><a href="#ProcessADCP-503"><span class="linenos"> 503</span></a>                    <span class="n">dtop</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="ProcessADCP-504"><a href="#ProcessADCP-504"><span class="linenos"> 504</span></a>                <span class="n">dbot</span> <span class="o">=</span> <span class="n">pdep_median</span> <span class="o">-</span> <span class="n">distance_to_first_bin</span>
</span><span id="ProcessADCP-505"><a href="#ProcessADCP-505"><span class="linenos"> 505</span></a>                <span class="c1"># Successively add bins until we reach maximum pressure. This</span>
</span><span id="ProcessADCP-506"><a href="#ProcessADCP-506"><span class="linenos"> 506</span></a>                <span class="c1"># will take care of mooring knockdowns.</span>
</span><span id="ProcessADCP-507"><a href="#ProcessADCP-507"><span class="linenos"> 507</span></a>                <span class="k">while</span> <span class="n">dbot</span> <span class="o">&lt;</span> <span class="n">p_bot</span><span class="p">:</span>
</span><span id="ProcessADCP-508"><a href="#ProcessADCP-508"><span class="linenos"> 508</span></a>                    <span class="n">dbot</span> <span class="o">+=</span> <span class="n">d_interval</span>
</span><span id="ProcessADCP-509"><a href="#ProcessADCP-509"><span class="linenos"> 509</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-510"><a href="#ProcessADCP-510"><span class="linenos"> 510</span></a>                <span class="n">dtop</span> <span class="o">=</span> <span class="n">pdep_median</span> <span class="o">+</span> <span class="n">distance_to_first_bin</span>
</span><span id="ProcessADCP-511"><a href="#ProcessADCP-511"><span class="linenos"> 511</span></a>                <span class="k">while</span> <span class="n">dtop</span> <span class="o">&gt;</span> <span class="n">p_top</span><span class="p">:</span>
</span><span id="ProcessADCP-512"><a href="#ProcessADCP-512"><span class="linenos"> 512</span></a>                    <span class="n">dtop</span> <span class="o">-=</span> <span class="n">d_interval</span>
</span><span id="ProcessADCP-513"><a href="#ProcessADCP-513"><span class="linenos"> 513</span></a>                <span class="n">dbot</span> <span class="o">=</span> <span class="n">p_bot</span> <span class="o">+</span> <span class="n">distance_to_last_bin</span>
</span><span id="ProcessADCP-514"><a href="#ProcessADCP-514"><span class="linenos"> 514</span></a>
</span><span id="ProcessADCP-515"><a href="#ProcessADCP-515"><span class="linenos"> 515</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ProcessADCP-516"><a href="#ProcessADCP-516"><span class="linenos"> 516</span></a>                <span class="n">dtop</span><span class="o">=</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="ProcessADCP-517"><a href="#ProcessADCP-517"><span class="linenos"> 517</span></a>                <span class="n">dbot</span><span class="o">=</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="ProcessADCP-518"><a href="#ProcessADCP-518"><span class="linenos"> 518</span></a>                <span class="n">d_interval</span><span class="o">=</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="ProcessADCP-519"><a href="#ProcessADCP-519"><span class="linenos"> 519</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-520"><a href="#ProcessADCP-520"><span class="linenos"> 520</span></a>
</span><span id="ProcessADCP-521"><a href="#ProcessADCP-521"><span class="linenos"> 521</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span>
</span><span id="ProcessADCP-522"><a href="#ProcessADCP-522"><span class="linenos"> 522</span></a>
</span><span id="ProcessADCP-523"><a href="#ProcessADCP-523"><span class="linenos"> 523</span></a>    <span class="k">def</span> <span class="nf">parse_dgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgridparams</span><span class="p">):</span>
</span><span id="ProcessADCP-524"><a href="#ProcessADCP-524"><span class="linenos"> 524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse depth gridding parameters.</span>
</span><span id="ProcessADCP-525"><a href="#ProcessADCP-525"><span class="linenos"> 525</span></a>
</span><span id="ProcessADCP-526"><a href="#ProcessADCP-526"><span class="linenos"> 526</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP-527"><a href="#ProcessADCP-527"><span class="linenos"> 527</span></a>
</span><span id="ProcessADCP-528"><a href="#ProcessADCP-528"><span class="linenos"> 528</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-529"><a href="#ProcessADCP-529"><span class="linenos"> 529</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-530"><a href="#ProcessADCP-530"><span class="linenos"> 530</span></a><span class="sd">        dgridparams : dict</span>
</span><span id="ProcessADCP-531"><a href="#ProcessADCP-531"><span class="linenos"> 531</span></a>
</span><span id="ProcessADCP-532"><a href="#ProcessADCP-532"><span class="linenos"> 532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-533"><a href="#ProcessADCP-533"><span class="linenos"> 533</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_dgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP-534"><a href="#ProcessADCP-534"><span class="linenos"> 534</span></a>        <span class="k">if</span> <span class="n">dgridparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-535"><a href="#ProcessADCP-535"><span class="linenos"> 535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">dgridparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP-536"><a href="#ProcessADCP-536"><span class="linenos"> 536</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-537"><a href="#ProcessADCP-537"><span class="linenos"> 537</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP-538"><a href="#ProcessADCP-538"><span class="linenos"> 538</span></a>                <span class="s2">&quot;No depth gridding parameters provided, using default values.&quot;</span>
</span><span id="ProcessADCP-539"><a href="#ProcessADCP-539"><span class="linenos"> 539</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-540"><a href="#ProcessADCP-540"><span class="linenos"> 540</span></a>        <span class="c1"># Default depth grid parameters are based on the median pressure to</span>
</span><span id="ProcessADCP-541"><a href="#ProcessADCP-541"><span class="linenos"> 541</span></a>        <span class="c1"># avoid binning into neighboring grid cells as much as possible.</span>
</span><span id="ProcessADCP-542"><a href="#ProcessADCP-542"><span class="linenos"> 542</span></a>        <span class="c1"># Therefore, we start assembling the depth grid from the bottom up for</span>
</span><span id="ProcessADCP-543"><a href="#ProcessADCP-543"><span class="linenos"> 543</span></a>        <span class="c1"># an uplooker and from the top down for a downlooker.</span>
</span><span id="ProcessADCP-544"><a href="#ProcessADCP-544"><span class="linenos"> 544</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span>
</span><span id="ProcessADCP-545"><a href="#ProcessADCP-545"><span class="linenos"> 545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="ProcessADCP-546"><a href="#ProcessADCP-546"><span class="linenos"> 546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="ProcessADCP-547"><a href="#ProcessADCP-547"><span class="linenos"> 547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="ProcessADCP-548"><a href="#ProcessADCP-548"><span class="linenos"> 548</span></a>                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="ProcessADCP-549"><a href="#ProcessADCP-549"><span class="linenos"> 549</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ProcessADCP-550"><a href="#ProcessADCP-550"><span class="linenos"> 550</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-551"><a href="#ProcessADCP-551"><span class="linenos"> 551</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span><span class="p">:</span>
</span><span id="ProcessADCP-552"><a href="#ProcessADCP-552"><span class="linenos"> 552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="ProcessADCP-553"><a href="#ProcessADCP-553"><span class="linenos"> 553</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="ProcessADCP-554"><a href="#ProcessADCP-554"><span class="linenos"> 554</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="ProcessADCP-555"><a href="#ProcessADCP-555"><span class="linenos"> 555</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="ProcessADCP-556"><a href="#ProcessADCP-556"><span class="linenos"> 556</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ProcessADCP-557"><a href="#ProcessADCP-557"><span class="linenos"> 557</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-558"><a href="#ProcessADCP-558"><span class="linenos"> 558</span></a>
</span><span id="ProcessADCP-559"><a href="#ProcessADCP-559"><span class="linenos"> 559</span></a>    <span class="k">def</span> <span class="nf">parse_tgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgridparams</span><span class="p">):</span>
</span><span id="ProcessADCP-560"><a href="#ProcessADCP-560"><span class="linenos"> 560</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse time gridding parameters.</span>
</span><span id="ProcessADCP-561"><a href="#ProcessADCP-561"><span class="linenos"> 561</span></a>
</span><span id="ProcessADCP-562"><a href="#ProcessADCP-562"><span class="linenos"> 562</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP-563"><a href="#ProcessADCP-563"><span class="linenos"> 563</span></a>
</span><span id="ProcessADCP-564"><a href="#ProcessADCP-564"><span class="linenos"> 564</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-565"><a href="#ProcessADCP-565"><span class="linenos"> 565</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-566"><a href="#ProcessADCP-566"><span class="linenos"> 566</span></a><span class="sd">        tgridparams : dict</span>
</span><span id="ProcessADCP-567"><a href="#ProcessADCP-567"><span class="linenos"> 567</span></a>
</span><span id="ProcessADCP-568"><a href="#ProcessADCP-568"><span class="linenos"> 568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-569"><a href="#ProcessADCP-569"><span class="linenos"> 569</span></a>        <span class="c1"># Find time at depth to determine default time grid parameters.</span>
</span><span id="ProcessADCP-570"><a href="#ProcessADCP-570"><span class="linenos"> 570</span></a>        <span class="c1"># Differentiate between time series only in the water and time series</span>
</span><span id="ProcessADCP-571"><a href="#ProcessADCP-571"><span class="linenos"> 571</span></a>        <span class="c1"># including the overshoot on mooring deployment.</span>
</span><span id="ProcessADCP-572"><a href="#ProcessADCP-572"><span class="linenos"> 572</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span>
</span><span id="ProcessADCP-573"><a href="#ProcessADCP-573"><span class="linenos"> 573</span></a>        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="ProcessADCP-574"><a href="#ProcessADCP-574"><span class="linenos"> 574</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-575"><a href="#ProcessADCP-575"><span class="linenos"> 575</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-576"><a href="#ProcessADCP-576"><span class="linenos"> 576</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-577"><a href="#ProcessADCP-577"><span class="linenos"> 577</span></a>            <span class="n">at_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-578"><a href="#ProcessADCP-578"><span class="linenos"> 578</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">at_depth</span><span class="p">]</span>
</span><span id="ProcessADCP-579"><a href="#ProcessADCP-579"><span class="linenos"> 579</span></a>            <span class="c1"># in_water = np.nonzero(p &gt; self.p_median / 2)[0][-1]</span>
</span><span id="ProcessADCP-580"><a href="#ProcessADCP-580"><span class="linenos"> 580</span></a>            <span class="c1"># t1 = self.dday[in_water]</span>
</span><span id="ProcessADCP-581"><a href="#ProcessADCP-581"><span class="linenos"> 581</span></a>            <span class="n">at_depth_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span> <span class="o">/</span> <span class="mf">1.05</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-582"><a href="#ProcessADCP-582"><span class="linenos"> 582</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">at_depth_last</span><span class="p">]</span>
</span><span id="ProcessADCP-583"><a href="#ProcessADCP-583"><span class="linenos"> 583</span></a>
</span><span id="ProcessADCP-584"><a href="#ProcessADCP-584"><span class="linenos"> 584</span></a>        <span class="c1"># Generate a set of default time gridding parameters and then update</span>
</span><span id="ProcessADCP-585"><a href="#ProcessADCP-585"><span class="linenos"> 585</span></a>        <span class="c1"># from the input parameters provided.</span>
</span><span id="ProcessADCP-586"><a href="#ProcessADCP-586"><span class="linenos"> 586</span></a>        <span class="n">default_tgridparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt_hours</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">burst_average</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ProcessADCP-587"><a href="#ProcessADCP-587"><span class="linenos"> 587</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">default_tgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP-588"><a href="#ProcessADCP-588"><span class="linenos"> 588</span></a>        <span class="k">if</span> <span class="n">tgridparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-589"><a href="#ProcessADCP-589"><span class="linenos"> 589</span></a>            <span class="c1"># convert time to dday if provided as str</span>
</span><span id="ProcessADCP-590"><a href="#ProcessADCP-590"><span class="linenos"> 590</span></a>            <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="s2">&quot;t1&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP-591"><a href="#ProcessADCP-591"><span class="linenos"> 591</span></a>                <span class="k">if</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">tgridparams</span><span class="p">:</span>
</span><span id="ProcessADCP-592"><a href="#ProcessADCP-592"><span class="linenos"> 592</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ProcessADCP-593"><a href="#ProcessADCP-593"><span class="linenos"> 593</span></a>                        <span class="n">t64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>
</span><span id="ProcessADCP-594"><a href="#ProcessADCP-594"><span class="linenos"> 594</span></a>                        <span class="n">year</span><span class="p">,</span> <span class="n">dday</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">datetime64_to_yday0</span><span class="p">(</span><span class="n">t64</span><span class="p">)</span>
</span><span id="ProcessADCP-595"><a href="#ProcessADCP-595"><span class="linenos"> 595</span></a>                        <span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">]</span> <span class="o">=</span> <span class="n">dday</span>
</span><span id="ProcessADCP-596"><a href="#ProcessADCP-596"><span class="linenos"> 596</span></a>            <span class="c1"># update parameters in processing object</span>
</span><span id="ProcessADCP-597"><a href="#ProcessADCP-597"><span class="linenos"> 597</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP-598"><a href="#ProcessADCP-598"><span class="linenos"> 598</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-599"><a href="#ProcessADCP-599"><span class="linenos"> 599</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP-600"><a href="#ProcessADCP-600"><span class="linenos"> 600</span></a>                <span class="s2">&quot;No time gridding parameters provided, using default values.&quot;</span>
</span><span id="ProcessADCP-601"><a href="#ProcessADCP-601"><span class="linenos"> 601</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-602"><a href="#ProcessADCP-602"><span class="linenos"> 602</span></a>
</span><span id="ProcessADCP-603"><a href="#ProcessADCP-603"><span class="linenos"> 603</span></a>    <span class="k">def</span> <span class="nf">parse_editparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editparams</span><span class="p">):</span>
</span><span id="ProcessADCP-604"><a href="#ProcessADCP-604"><span class="linenos"> 604</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse editing parameters.</span>
</span><span id="ProcessADCP-605"><a href="#ProcessADCP-605"><span class="linenos"> 605</span></a>
</span><span id="ProcessADCP-606"><a href="#ProcessADCP-606"><span class="linenos"> 606</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP-607"><a href="#ProcessADCP-607"><span class="linenos"> 607</span></a>
</span><span id="ProcessADCP-608"><a href="#ProcessADCP-608"><span class="linenos"> 608</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-609"><a href="#ProcessADCP-609"><span class="linenos"> 609</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-610"><a href="#ProcessADCP-610"><span class="linenos"> 610</span></a><span class="sd">        editparams : dict</span>
</span><span id="ProcessADCP-611"><a href="#ProcessADCP-611"><span class="linenos"> 611</span></a>
</span><span id="ProcessADCP-612"><a href="#ProcessADCP-612"><span class="linenos"> 612</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-613"><a href="#ProcessADCP-613"><span class="linenos"> 613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_editparams</span><span class="p">)</span>
</span><span id="ProcessADCP-614"><a href="#ProcessADCP-614"><span class="linenos"> 614</span></a>        <span class="k">if</span> <span class="n">editparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-615"><a href="#ProcessADCP-615"><span class="linenos"> 615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">editparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP-616"><a href="#ProcessADCP-616"><span class="linenos"> 616</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-617"><a href="#ProcessADCP-617"><span class="linenos"> 617</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No edit parameters provided, using default values.&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-618"><a href="#ProcessADCP-618"><span class="linenos"> 618</span></a>
</span><span id="ProcessADCP-619"><a href="#ProcessADCP-619"><span class="linenos"> 619</span></a>    <span class="k">def</span> <span class="nf">parse_driftparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driftparams</span><span class="p">):</span>
</span><span id="ProcessADCP-620"><a href="#ProcessADCP-620"><span class="linenos"> 620</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse time drift parameters.</span>
</span><span id="ProcessADCP-621"><a href="#ProcessADCP-621"><span class="linenos"> 621</span></a>
</span><span id="ProcessADCP-622"><a href="#ProcessADCP-622"><span class="linenos"> 622</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP-623"><a href="#ProcessADCP-623"><span class="linenos"> 623</span></a>
</span><span id="ProcessADCP-624"><a href="#ProcessADCP-624"><span class="linenos"> 624</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-625"><a href="#ProcessADCP-625"><span class="linenos"> 625</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-626"><a href="#ProcessADCP-626"><span class="linenos"> 626</span></a><span class="sd">        driftparams : dict</span>
</span><span id="ProcessADCP-627"><a href="#ProcessADCP-627"><span class="linenos"> 627</span></a>
</span><span id="ProcessADCP-628"><a href="#ProcessADCP-628"><span class="linenos"> 628</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-629"><a href="#ProcessADCP-629"><span class="linenos"> 629</span></a>        <span class="n">driftparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">driftparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">driftparams</span>
</span><span id="ProcessADCP-630"><a href="#ProcessADCP-630"><span class="linenos"> 630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">driftparams</span> <span class="o">=</span> <span class="n">driftparams</span>
</span><span id="ProcessADCP-631"><a href="#ProcessADCP-631"><span class="linenos"> 631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span>
</span><span id="ProcessADCP-632"><a href="#ProcessADCP-632"><span class="linenos"> 632</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-633"><a href="#ProcessADCP-633"><span class="linenos"> 633</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="ProcessADCP-634"><a href="#ProcessADCP-634"><span class="linenos"> 634</span></a>        <span class="n">t1_adcp</span> <span class="o">=</span> <span class="n">driftparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_adcp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ProcessADCP-635"><a href="#ProcessADCP-635"><span class="linenos"> 635</span></a>        <span class="k">if</span> <span class="n">t1_adcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-636"><a href="#ProcessADCP-636"><span class="linenos"> 636</span></a>            <span class="n">t1_pc</span> <span class="o">=</span> <span class="n">to_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="o">*</span><span class="n">driftparams</span><span class="p">[</span><span class="s2">&quot;end_pc&quot;</span><span class="p">])</span>
</span><span id="ProcessADCP-637"><a href="#ProcessADCP-637"><span class="linenos"> 637</span></a>            <span class="n">t1_adcp</span> <span class="o">=</span> <span class="n">to_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="o">*</span><span class="n">driftparams</span><span class="p">[</span><span class="s2">&quot;end_adcp&quot;</span><span class="p">])</span>
</span><span id="ProcessADCP-638"><a href="#ProcessADCP-638"><span class="linenos"> 638</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1_pc</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1_adcp</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
</span><span id="ProcessADCP-639"><a href="#ProcessADCP-639"><span class="linenos"> 639</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-640"><a href="#ProcessADCP-640"><span class="linenos"> 640</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP-641"><a href="#ProcessADCP-641"><span class="linenos"> 641</span></a>                <span class="s2">&quot;No time drift parameters provided, not applying any clock correction.&quot;</span>
</span><span id="ProcessADCP-642"><a href="#ProcessADCP-642"><span class="linenos"> 642</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-643"><a href="#ProcessADCP-643"><span class="linenos"> 643</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ProcessADCP-644"><a href="#ProcessADCP-644"><span class="linenos"> 644</span></a>
</span><span id="ProcessADCP-645"><a href="#ProcessADCP-645"><span class="linenos"> 645</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="ProcessADCP-646"><a href="#ProcessADCP-646"><span class="linenos"> 646</span></a>
</span><span id="ProcessADCP-647"><a href="#ProcessADCP-647"><span class="linenos"> 647</span></a>    <span class="k">def</span> <span class="nf">_correct_dday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dday_orig</span><span class="p">):</span>
</span><span id="ProcessADCP-648"><a href="#ProcessADCP-648"><span class="linenos"> 648</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply linear correction for clock drift.</span>
</span><span id="ProcessADCP-649"><a href="#ProcessADCP-649"><span class="linenos"> 649</span></a>
</span><span id="ProcessADCP-650"><a href="#ProcessADCP-650"><span class="linenos"> 650</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-651"><a href="#ProcessADCP-651"><span class="linenos"> 651</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-652"><a href="#ProcessADCP-652"><span class="linenos"> 652</span></a><span class="sd">        dday_orig : array-like</span>
</span><span id="ProcessADCP-653"><a href="#ProcessADCP-653"><span class="linenos"> 653</span></a><span class="sd">            Origial time vector.</span>
</span><span id="ProcessADCP-654"><a href="#ProcessADCP-654"><span class="linenos"> 654</span></a>
</span><span id="ProcessADCP-655"><a href="#ProcessADCP-655"><span class="linenos"> 655</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-656"><a href="#ProcessADCP-656"><span class="linenos"> 656</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-657"><a href="#ProcessADCP-657"><span class="linenos"> 657</span></a><span class="sd">        array-like</span>
</span><span id="ProcessADCP-658"><a href="#ProcessADCP-658"><span class="linenos"> 658</span></a><span class="sd">            Corrected time vector</span>
</span><span id="ProcessADCP-659"><a href="#ProcessADCP-659"><span class="linenos"> 659</span></a>
</span><span id="ProcessADCP-660"><a href="#ProcessADCP-660"><span class="linenos"> 660</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-661"><a href="#ProcessADCP-661"><span class="linenos"> 661</span></a>
</span><span id="ProcessADCP-662"><a href="#ProcessADCP-662"><span class="linenos"> 662</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">dday_orig</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span>
</span><span id="ProcessADCP-663"><a href="#ProcessADCP-663"><span class="linenos"> 663</span></a>
</span><span id="ProcessADCP-664"><a href="#ProcessADCP-664"><span class="linenos"> 664</span></a>    <span class="k">def</span> <span class="nf">_parse_sysconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-665"><a href="#ProcessADCP-665"><span class="linenos"> 665</span></a>        <span class="c1"># We have to get the up/down reading from sysconfig for a time when the</span>
</span><span id="ProcessADCP-666"><a href="#ProcessADCP-666"><span class="linenos"> 666</span></a>        <span class="c1"># instrument was in the water. Look at pressure and determine ensembles</span>
</span><span id="ProcessADCP-667"><a href="#ProcessADCP-667"><span class="linenos"> 667</span></a>        <span class="c1"># during time at depth.</span>
</span><span id="ProcessADCP-668"><a href="#ProcessADCP-668"><span class="linenos"> 668</span></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="ProcessADCP-669"><a href="#ProcessADCP-669"><span class="linenos"> 669</span></a>        <span class="n">depth_ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="ProcessADCP-670"><a href="#ProcessADCP-670"><span class="linenos"> 670</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ProcessADCP-671"><a href="#ProcessADCP-671"><span class="linenos"> 671</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">depth_ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span>
</span><span id="ProcessADCP-672"><a href="#ProcessADCP-672"><span class="linenos"> 672</span></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="ProcessADCP-673"><a href="#ProcessADCP-673"><span class="linenos"> 673</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;could not determine ensemble index at depth for reading sysconfig&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-674"><a href="#ProcessADCP-674"><span class="linenos"> 674</span></a>        <span class="n">at_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
</span><span id="ProcessADCP-675"><a href="#ProcessADCP-675"><span class="linenos"> 675</span></a>            <span class="n">varlist</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;VariableLeader&quot;</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">depth_ii</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">depth_ii</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="ProcessADCP-676"><a href="#ProcessADCP-676"><span class="linenos"> 676</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-677"><a href="#ProcessADCP-677"><span class="linenos"> 677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span> <span class="k">if</span> <span class="n">at_depth</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">up</span> <span class="k">else</span> <span class="s2">&quot;down&quot;</span>
</span><span id="ProcessADCP-678"><a href="#ProcessADCP-678"><span class="linenos"> 678</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span> <span class="o">=</span> <span class="n">at_depth</span><span class="o">.</span><span class="n">sysconfig</span>
</span><span id="ProcessADCP-679"><a href="#ProcessADCP-679"><span class="linenos"> 679</span></a>
</span><span id="ProcessADCP-680"><a href="#ProcessADCP-680"><span class="linenos"> 680</span></a>    <span class="k">def</span> <span class="nf">make_start_ddays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-681"><a href="#ProcessADCP-681"><span class="linenos"> 681</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate time stamps for ping averaging.</span>
</span><span id="ProcessADCP-682"><a href="#ProcessADCP-682"><span class="linenos"> 682</span></a>
</span><span id="ProcessADCP-683"><a href="#ProcessADCP-683"><span class="linenos"> 683</span></a><span class="sd">        Notes</span>
</span><span id="ProcessADCP-684"><a href="#ProcessADCP-684"><span class="linenos"> 684</span></a><span class="sd">        -----</span>
</span><span id="ProcessADCP-685"><a href="#ProcessADCP-685"><span class="linenos"> 685</span></a><span class="sd">        If turning on burst averaging, other input values will be ignored and</span>
</span><span id="ProcessADCP-686"><a href="#ProcessADCP-686"><span class="linenos"> 686</span></a><span class="sd">        the averaging interval will be determined from the burst sampling</span>
</span><span id="ProcessADCP-687"><a href="#ProcessADCP-687"><span class="linenos"> 687</span></a><span class="sd">        scheme apparent in the ping pattern.</span>
</span><span id="ProcessADCP-688"><a href="#ProcessADCP-688"><span class="linenos"> 688</span></a>
</span><span id="ProcessADCP-689"><a href="#ProcessADCP-689"><span class="linenos"> 689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-690"><a href="#ProcessADCP-690"><span class="linenos"> 690</span></a>        <span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">t0</span>
</span><span id="ProcessADCP-691"><a href="#ProcessADCP-691"><span class="linenos"> 691</span></a>        <span class="n">dday_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">t1</span>
</span><span id="ProcessADCP-692"><a href="#ProcessADCP-692"><span class="linenos"> 692</span></a>        <span class="n">dt_hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">dt_hours</span>
</span><span id="ProcessADCP-693"><a href="#ProcessADCP-693"><span class="linenos"> 693</span></a>        <span class="n">is_burst_average</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">burst_average</span>
</span><span id="ProcessADCP-694"><a href="#ProcessADCP-694"><span class="linenos"> 694</span></a>
</span><span id="ProcessADCP-695"><a href="#ProcessADCP-695"><span class="linenos"> 695</span></a>        <span class="c1"># Save whether we are averaging over bursts or not.</span>
</span><span id="ProcessADCP-696"><a href="#ProcessADCP-696"><span class="linenos"> 696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span> <span class="o">=</span> <span class="n">is_burst_average</span>
</span><span id="ProcessADCP-697"><a href="#ProcessADCP-697"><span class="linenos"> 697</span></a>        <span class="c1"># Generate time stamps and stuff.</span>
</span><span id="ProcessADCP-698"><a href="#ProcessADCP-698"><span class="linenos"> 698</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="ProcessADCP-699"><a href="#ProcessADCP-699"><span class="linenos"> 699</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no burst average&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-700"><a href="#ProcessADCP-700"><span class="linenos"> 700</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="n">dday_start</span>
</span><span id="ProcessADCP-701"><a href="#ProcessADCP-701"><span class="linenos"> 701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span> <span class="o">=</span> <span class="n">dday_end</span>
</span><span id="ProcessADCP-702"><a href="#ProcessADCP-702"><span class="linenos"> 702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt_hours</span> <span class="o">/</span> <span class="mf">24.0</span>
</span><span id="ProcessADCP-703"><a href="#ProcessADCP-703"><span class="linenos"> 703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dday_start</span><span class="p">,</span> <span class="n">dday_end</span><span class="p">,</span> <span class="n">dt_hours</span> <span class="o">/</span> <span class="mf">24.0</span><span class="p">)</span>
</span><span id="ProcessADCP-704"><a href="#ProcessADCP-704"><span class="linenos"> 704</span></a>            <span class="c1"># Time stamps for the averages. Midpoints of averaging intervals.</span>
</span><span id="ProcessADCP-705"><a href="#ProcessADCP-705"><span class="linenos"> 705</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ProcessADCP-706"><a href="#ProcessADCP-706"><span class="linenos"> 706</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-707"><a href="#ProcessADCP-707"><span class="linenos"> 707</span></a>            <span class="n">dday_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="ProcessADCP-708"><a href="#ProcessADCP-708"><span class="linenos"> 708</span></a>            <span class="c1"># Determine ping interval within burst and time between bursts.</span>
</span><span id="ProcessADCP-709"><a href="#ProcessADCP-709"><span class="linenos"> 709</span></a>            <span class="n">burst_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dday_diff</span><span class="p">)</span>
</span><span id="ProcessADCP-710"><a href="#ProcessADCP-710"><span class="linenos"> 710</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time between pings within burst: </span><span class="si">{</span><span class="n">burst_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-711"><a href="#ProcessADCP-711"><span class="linenos"> 711</span></a>            <span class="c1"># It seems safe to assume that the time between bursts is at least</span>
</span><span id="ProcessADCP-712"><a href="#ProcessADCP-712"><span class="linenos"> 712</span></a>            <span class="c1"># four times as long as the time between individual pings within a</span>
</span><span id="ProcessADCP-713"><a href="#ProcessADCP-713"><span class="linenos"> 713</span></a>            <span class="c1"># burst.</span>
</span><span id="ProcessADCP-714"><a href="#ProcessADCP-714"><span class="linenos"> 714</span></a>            <span class="n">inter_burst_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dday_diff</span><span class="p">[</span><span class="n">dday_diff</span> <span class="o">&gt;</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="ProcessADCP-715"><a href="#ProcessADCP-715"><span class="linenos"> 715</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time between bursts: </span><span class="si">{</span><span class="n">inter_burst_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-716"><a href="#ProcessADCP-716"><span class="linenos"> 716</span></a>            <span class="c1"># Find starting points of all bursts.</span>
</span><span id="ProcessADCP-717"><a href="#ProcessADCP-717"><span class="linenos"> 717</span></a>            <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">dday_diff</span> <span class="o">&gt;</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="ProcessADCP-718"><a href="#ProcessADCP-718"><span class="linenos"> 718</span></a>            <span class="c1"># Increase index so we are at the end of the larger time differences.</span>
</span><span id="ProcessADCP-719"><a href="#ProcessADCP-719"><span class="linenos"> 719</span></a>            <span class="n">start_indices</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ProcessADCP-720"><a href="#ProcessADCP-720"><span class="linenos"> 720</span></a>            <span class="c1"># Include the very beginning.</span>
</span><span id="ProcessADCP-721"><a href="#ProcessADCP-721"><span class="linenos"> 721</span></a>            <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">start_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-722"><a href="#ProcessADCP-722"><span class="linenos"> 722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">start_indices</span><span class="p">]</span>
</span><span id="ProcessADCP-723"><a href="#ProcessADCP-723"><span class="linenos"> 723</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-724"><a href="#ProcessADCP-724"><span class="linenos"> 724</span></a>            <span class="c1"># Generate a dt that is inclusive of one burst.  We know the number</span>
</span><span id="ProcessADCP-725"><a href="#ProcessADCP-725"><span class="linenos"> 725</span></a>            <span class="c1"># of pings in a burst from the difference between the</span>
</span><span id="ProcessADCP-726"><a href="#ProcessADCP-726"><span class="linenos"> 726</span></a>            <span class="c1"># start_indices. Let&#39;s go a bit beyond the time needed (3 more ping</span>
</span><span id="ProcessADCP-727"><a href="#ProcessADCP-727"><span class="linenos"> 727</span></a>            <span class="c1"># intervals chosen here).</span>
</span><span id="ProcessADCP-728"><a href="#ProcessADCP-728"><span class="linenos"> 728</span></a>            <span class="n">pings_per_burst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">start_indices</span><span class="p">)))</span>
</span><span id="ProcessADCP-729"><a href="#ProcessADCP-729"><span class="linenos"> 729</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pings_per_burst</span><span class="si">}</span><span class="s2"> pings per burst&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-730"><a href="#ProcessADCP-730"><span class="linenos"> 730</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bursts total&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-731"><a href="#ProcessADCP-731"><span class="linenos"> 731</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="n">pings_per_burst</span> <span class="o">+</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">3</span>
</span><span id="ProcessADCP-732"><a href="#ProcessADCP-732"><span class="linenos"> 732</span></a>
</span><span id="ProcessADCP-733"><a href="#ProcessADCP-733"><span class="linenos"> 733</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-734"><a href="#ProcessADCP-734"><span class="linenos"> 734</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span> <span class="o">=</span> <span class="n">dday_end</span>
</span><span id="ProcessADCP-735"><a href="#ProcessADCP-735"><span class="linenos"> 735</span></a>
</span><span id="ProcessADCP-736"><a href="#ProcessADCP-736"><span class="linenos"> 736</span></a>            <span class="c1"># Time stamps in the middle of the burst</span>
</span><span id="ProcessADCP-737"><a href="#ProcessADCP-737"><span class="linenos"> 737</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">+</span> <span class="n">pings_per_burst</span> <span class="o">*</span> <span class="n">burst_dt</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ProcessADCP-738"><a href="#ProcessADCP-738"><span class="linenos"> 738</span></a>
</span><span id="ProcessADCP-739"><a href="#ProcessADCP-739"><span class="linenos"> 739</span></a>    <span class="k">def</span> <span class="nf">read_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iens</span><span class="p">):</span>
</span><span id="ProcessADCP-740"><a href="#ProcessADCP-740"><span class="linenos"> 740</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Read ensembles (several individual pings grouped together).</span>
</span><span id="ProcessADCP-741"><a href="#ProcessADCP-741"><span class="linenos"> 741</span></a>
</span><span id="ProcessADCP-742"><a href="#ProcessADCP-742"><span class="linenos"> 742</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-743"><a href="#ProcessADCP-743"><span class="linenos"> 743</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-744"><a href="#ProcessADCP-744"><span class="linenos"> 744</span></a><span class="sd">        iens : int</span>
</span><span id="ProcessADCP-745"><a href="#ProcessADCP-745"><span class="linenos"> 745</span></a><span class="sd">            Index into ensemble start times (they are generated in</span>
</span><span id="ProcessADCP-746"><a href="#ProcessADCP-746"><span class="linenos"> 746</span></a><span class="sd">            :meth:`make_start_ddays`).</span>
</span><span id="ProcessADCP-747"><a href="#ProcessADCP-747"><span class="linenos"> 747</span></a>
</span><span id="ProcessADCP-748"><a href="#ProcessADCP-748"><span class="linenos"> 748</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-749"><a href="#ProcessADCP-749"><span class="linenos"> 749</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-750"><a href="#ProcessADCP-750"><span class="linenos"> 750</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="ProcessADCP-751"><a href="#ProcessADCP-751"><span class="linenos"> 751</span></a><span class="sd">            Dictionary with data.</span>
</span><span id="ProcessADCP-752"><a href="#ProcessADCP-752"><span class="linenos"> 752</span></a>
</span><span id="ProcessADCP-753"><a href="#ProcessADCP-753"><span class="linenos"> 753</span></a><span class="sd">        Raises</span>
</span><span id="ProcessADCP-754"><a href="#ProcessADCP-754"><span class="linenos"> 754</span></a><span class="sd">        ------</span>
</span><span id="ProcessADCP-755"><a href="#ProcessADCP-755"><span class="linenos"> 755</span></a><span class="sd">        ValueError</span>
</span><span id="ProcessADCP-756"><a href="#ProcessADCP-756"><span class="linenos"> 756</span></a><span class="sd">            If `iens` is too large to index into `start_ddays`.</span>
</span><span id="ProcessADCP-757"><a href="#ProcessADCP-757"><span class="linenos"> 757</span></a>
</span><span id="ProcessADCP-758"><a href="#ProcessADCP-758"><span class="linenos"> 758</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-759"><a href="#ProcessADCP-759"><span class="linenos"> 759</span></a>
</span><span id="ProcessADCP-760"><a href="#ProcessADCP-760"><span class="linenos"> 760</span></a>        <span class="k">if</span> <span class="n">iens</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ProcessADCP-761"><a href="#ProcessADCP-761"><span class="linenos"> 761</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ens num </span><span class="si">%d</span><span class="s2"> is out of range&quot;</span> <span class="o">%</span> <span class="n">iens</span><span class="p">)</span>
</span><span id="ProcessADCP-762"><a href="#ProcessADCP-762"><span class="linenos"> 762</span></a>
</span><span id="ProcessADCP-763"><a href="#ProcessADCP-763"><span class="linenos"> 763</span></a>        <span class="c1"># Get indices within the interval</span>
</span><span id="ProcessADCP-764"><a href="#ProcessADCP-764"><span class="linenos"> 764</span></a>        <span class="n">sl</span> <span class="o">=</span> <span class="n">rangeslice</span><span class="p">(</span>
</span><span id="ProcessADCP-765"><a href="#ProcessADCP-765"><span class="linenos"> 765</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">iens</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">iens</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="ProcessADCP-766"><a href="#ProcessADCP-766"><span class="linenos"> 766</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-767"><a href="#ProcessADCP-767"><span class="linenos"> 767</span></a>        <span class="c1"># Use the indices to extract data</span>
</span><span id="ProcessADCP-768"><a href="#ProcessADCP-768"><span class="linenos"> 768</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">sl</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
</span><span id="ProcessADCP-769"><a href="#ProcessADCP-769"><span class="linenos"> 769</span></a>        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-770"><a href="#ProcessADCP-770"><span class="linenos"> 770</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ProcessADCP-771"><a href="#ProcessADCP-771"><span class="linenos"> 771</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">dday_orig</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span>
</span><span id="ProcessADCP-772"><a href="#ProcessADCP-772"><span class="linenos"> 772</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">dday_orig</span><span class="p">)</span>
</span><span id="ProcessADCP-773"><a href="#ProcessADCP-773"><span class="linenos"> 773</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-774"><a href="#ProcessADCP-774"><span class="linenos"> 774</span></a>            <span class="c1"># Replace pressure if provided</span>
</span><span id="ProcessADCP-775"><a href="#ProcessADCP-775"><span class="linenos"> 775</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP-776"><a href="#ProcessADCP-776"><span class="linenos"> 776</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="ProcessADCP-777"><a href="#ProcessADCP-777"><span class="linenos"> 777</span></a>            <span class="c1"># Use raw pressure</span>
</span><span id="ProcessADCP-778"><a href="#ProcessADCP-778"><span class="linenos"> 778</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP-779"><a href="#ProcessADCP-779"><span class="linenos"> 779</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_raw_pressure</span><span class="p">:</span>
</span><span id="ProcessADCP-780"><a href="#ProcessADCP-780"><span class="linenos"> 780</span></a>            <span class="c1"># Use raw pressure</span>
</span><span id="ProcessADCP-781"><a href="#ProcessADCP-781"><span class="linenos"> 781</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP-782"><a href="#ProcessADCP-782"><span class="linenos"> 782</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-783"><a href="#ProcessADCP-783"><span class="linenos"> 783</span></a>            <span class="c1"># Use low-pass filtered pressure</span>
</span><span id="ProcessADCP-784"><a href="#ProcessADCP-784"><span class="linenos"> 784</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">ens_num</span> <span class="o">&gt;=</span> <span class="n">dat</span><span class="o">.</span><span class="n">ens_num</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="ProcessADCP-785"><a href="#ProcessADCP-785"><span class="linenos"> 785</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">ens_num</span> <span class="o">&lt;=</span> <span class="n">dat</span><span class="o">.</span><span class="n">ens_num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-786"><a href="#ProcessADCP-786"><span class="linenos"> 786</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-787"><a href="#ProcessADCP-787"><span class="linenos"> 787</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_lp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="ProcessADCP-788"><a href="#ProcessADCP-788"><span class="linenos"> 788</span></a>
</span><span id="ProcessADCP-789"><a href="#ProcessADCP-789"><span class="linenos"> 789</span></a>        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="ProcessADCP-790"><a href="#ProcessADCP-790"><span class="linenos"> 790</span></a>        <span class="n">pdepth</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP-791"><a href="#ProcessADCP-791"><span class="linenos"> 791</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">dat</span><span class="o">.</span><span class="n">dep</span>
</span><span id="ProcessADCP-792"><a href="#ProcessADCP-792"><span class="linenos"> 792</span></a>        <span class="k">return</span> <span class="n">dat</span>
</span><span id="ProcessADCP-793"><a href="#ProcessADCP-793"><span class="linenos"> 793</span></a>
</span><span id="ProcessADCP-794"><a href="#ProcessADCP-794"><span class="linenos"> 794</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP-795"><a href="#ProcessADCP-795"><span class="linenos"> 795</span></a>    <span class="k">def</span> <span class="nf">magdec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-796"><a href="#ProcessADCP-796"><span class="linenos"> 796</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Magnetic declination.</span>
</span><span id="ProcessADCP-797"><a href="#ProcessADCP-797"><span class="linenos"> 797</span></a>
</span><span id="ProcessADCP-798"><a href="#ProcessADCP-798"><span class="linenos"> 798</span></a><span class="sd">        If not provided as input argument magdec is calculated using</span>
</span><span id="ProcessADCP-799"><a href="#ProcessADCP-799"><span class="linenos"> 799</span></a><span class="sd">        [magdec](https://currents.soest.hawaii.edu/hgstage/geomag/file/tip)</span>
</span><span id="ProcessADCP-800"><a href="#ProcessADCP-800"><span class="linenos"> 800</span></a><span class="sd">        (must be installed) based on `lon` and `lat`.</span>
</span><span id="ProcessADCP-801"><a href="#ProcessADCP-801"><span class="linenos"> 801</span></a>
</span><span id="ProcessADCP-802"><a href="#ProcessADCP-802"><span class="linenos"> 802</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-803"><a href="#ProcessADCP-803"><span class="linenos"> 803</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-804"><a href="#ProcessADCP-804"><span class="linenos"> 804</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-805"><a href="#ProcessADCP-805"><span class="linenos"> 805</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP-806"><a href="#ProcessADCP-806"><span class="linenos"> 806</span></a>                    <span class="s2">&quot;No lon/lat provided, cannot calculate magnetic declination.&quot;</span>
</span><span id="ProcessADCP-807"><a href="#ProcessADCP-807"><span class="linenos"> 807</span></a>                <span class="p">)</span>
</span><span id="ProcessADCP-808"><a href="#ProcessADCP-808"><span class="linenos"> 808</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ProcessADCP-809"><a href="#ProcessADCP-809"><span class="linenos"> 809</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-810"><a href="#ProcessADCP-810"><span class="linenos"> 810</span></a>                <span class="c1"># Look for magdec executable</span>
</span><span id="ProcessADCP-811"><a href="#ProcessADCP-811"><span class="linenos"> 811</span></a>                <span class="n">magdec_found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ProcessADCP-812"><a href="#ProcessADCP-812"><span class="linenos"> 812</span></a>                <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;magdec&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-813"><a href="#ProcessADCP-813"><span class="linenos"> 813</span></a>
</span><span id="ProcessADCP-814"><a href="#ProcessADCP-814"><span class="linenos"> 814</span></a>                <span class="k">if</span> <span class="n">magdec_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-815"><a href="#ProcessADCP-815"><span class="linenos"> 815</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ProcessADCP-816"><a href="#ProcessADCP-816"><span class="linenos"> 816</span></a>                    <span class="n">package_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
</span><span id="ProcessADCP-817"><a href="#ProcessADCP-817"><span class="linenos"> 817</span></a>
</span><span id="ProcessADCP-818"><a href="#ProcessADCP-818"><span class="linenos"> 818</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="ProcessADCP-819"><a href="#ProcessADCP-819"><span class="linenos"> 819</span></a>                    <span class="c1"># Try this package directory</span>
</span><span id="ProcessADCP-820"><a href="#ProcessADCP-820"><span class="linenos"> 820</span></a>                    <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;magdec&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-821"><a href="#ProcessADCP-821"><span class="linenos"> 821</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">magdec_path</span><span class="p">)</span>
</span><span id="ProcessADCP-822"><a href="#ProcessADCP-822"><span class="linenos"> 822</span></a>
</span><span id="ProcessADCP-823"><a href="#ProcessADCP-823"><span class="linenos"> 823</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="ProcessADCP-824"><a href="#ProcessADCP-824"><span class="linenos"> 824</span></a>                    <span class="c1"># Try the magdec installation directory</span>
</span><span id="ProcessADCP-825"><a href="#ProcessADCP-825"><span class="linenos"> 825</span></a>                    <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
</span><span id="ProcessADCP-826"><a href="#ProcessADCP-826"><span class="linenos"> 826</span></a>                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;../geomag/magdec&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-827"><a href="#ProcessADCP-827"><span class="linenos"> 827</span></a>                    <span class="p">)</span>
</span><span id="ProcessADCP-828"><a href="#ProcessADCP-828"><span class="linenos"> 828</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">magdec_path</span><span class="p">)</span>
</span><span id="ProcessADCP-829"><a href="#ProcessADCP-829"><span class="linenos"> 829</span></a>
</span><span id="ProcessADCP-830"><a href="#ProcessADCP-830"><span class="linenos"> 830</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="ProcessADCP-831"><a href="#ProcessADCP-831"><span class="linenos"> 831</span></a>                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
</span><span id="ProcessADCP-832"><a href="#ProcessADCP-832"><span class="linenos"> 832</span></a>                        <span class="s2">&quot;Cannot find program magdec on the system path or paths within velosearaptor.&quot;</span>
</span><span id="ProcessADCP-833"><a href="#ProcessADCP-833"><span class="linenos"> 833</span></a>                    <span class="p">)</span>
</span><span id="ProcessADCP-834"><a href="#ProcessADCP-834"><span class="linenos"> 834</span></a>
</span><span id="ProcessADCP-835"><a href="#ProcessADCP-835"><span class="linenos"> 835</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magdec found at </span><span class="si">{</span><span class="n">magdec_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-836"><a href="#ProcessADCP-836"><span class="linenos"> 836</span></a>
</span><span id="ProcessADCP-837"><a href="#ProcessADCP-837"><span class="linenos"> 837</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="ProcessADCP-838"><a href="#ProcessADCP-838"><span class="linenos"> 838</span></a>                <span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="ProcessADCP-839"><a href="#ProcessADCP-839"><span class="linenos"> 839</span></a>                <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="n">dday_mid</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ProcessADCP-840"><a href="#ProcessADCP-840"><span class="linenos"> 840</span></a>
</span><span id="ProcessADCP-841"><a href="#ProcessADCP-841"><span class="linenos"> 841</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span>
</span><span id="ProcessADCP-842"><a href="#ProcessADCP-842"><span class="linenos"> 842</span></a>                    <span class="p">[</span>
</span><span id="ProcessADCP-843"><a href="#ProcessADCP-843"><span class="linenos"> 843</span></a>                        <span class="n">magdec_path</span><span class="p">,</span>
</span><span id="ProcessADCP-844"><a href="#ProcessADCP-844"><span class="linenos"> 844</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span>
</span><span id="ProcessADCP-845"><a href="#ProcessADCP-845"><span class="linenos"> 845</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span>
</span><span id="ProcessADCP-846"><a href="#ProcessADCP-846"><span class="linenos"> 846</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
</span><span id="ProcessADCP-847"><a href="#ProcessADCP-847"><span class="linenos"> 847</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
</span><span id="ProcessADCP-848"><a href="#ProcessADCP-848"><span class="linenos"> 848</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
</span><span id="ProcessADCP-849"><a href="#ProcessADCP-849"><span class="linenos"> 849</span></a>                    <span class="p">],</span>
</span><span id="ProcessADCP-850"><a href="#ProcessADCP-850"><span class="linenos"> 850</span></a>                    <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="ProcessADCP-851"><a href="#ProcessADCP-851"><span class="linenos"> 851</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-852"><a href="#ProcessADCP-852"><span class="linenos"> 852</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="ProcessADCP-853"><a href="#ProcessADCP-853"><span class="linenos"> 853</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;magdec output is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span><span id="ProcessADCP-854"><a href="#ProcessADCP-854"><span class="linenos"> 854</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ProcessADCP-855"><a href="#ProcessADCP-855"><span class="linenos"> 855</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-856"><a href="#ProcessADCP-856"><span class="linenos"> 856</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magdec </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span><span class="si">}</span><span class="s2"> provided.&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-857"><a href="#ProcessADCP-857"><span class="linenos"> 857</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span>
</span><span id="ProcessADCP-858"><a href="#ProcessADCP-858"><span class="linenos"> 858</span></a>
</span><span id="ProcessADCP-859"><a href="#ProcessADCP-859"><span class="linenos"> 859</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP-860"><a href="#ProcessADCP-860"><span class="linenos"> 860</span></a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-861"><a href="#ProcessADCP-861"><span class="linenos"> 861</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw ADCP data.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-862"><a href="#ProcessADCP-862"><span class="linenos"> 862</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-863"><a href="#ProcessADCP-863"><span class="linenos"> 863</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading raw data...&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-864"><a href="#ProcessADCP-864"><span class="linenos"> 864</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read_raw_rdi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
</span><span id="ProcessADCP-865"><a href="#ProcessADCP-865"><span class="linenos"> 865</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
</span><span id="ProcessADCP-866"><a href="#ProcessADCP-866"><span class="linenos"> 866</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span>
</span><span id="ProcessADCP-867"><a href="#ProcessADCP-867"><span class="linenos"> 867</span></a>
</span><span id="ProcessADCP-868"><a href="#ProcessADCP-868"><span class="linenos"> 868</span></a>    <span class="k">def</span> <span class="nf">_edit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="ProcessADCP-869"><a href="#ProcessADCP-869"><span class="linenos"> 869</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply editing to xyze.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-870"><a href="#ProcessADCP-870"><span class="linenos"> 870</span></a>        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span>
</span><span id="ProcessADCP-871"><a href="#ProcessADCP-871"><span class="linenos"> 871</span></a>        <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">cor</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">.</span><span class="n">min_correlation</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-872"><a href="#ProcessADCP-872"><span class="linenos"> 872</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-873"><a href="#ProcessADCP-873"><span class="linenos"> 873</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="ProcessADCP-874"><a href="#ProcessADCP-874"><span class="linenos"> 874</span></a>        <span class="n">max_e</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">max_e</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">ep</span><span class="o">.</span><span class="n">max_e_deviation</span><span class="p">)</span>
</span><span id="ProcessADCP-875"><a href="#ProcessADCP-875"><span class="linenos"> 875</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">max_e_applied</span> <span class="o">=</span> <span class="n">max_e</span>
</span><span id="ProcessADCP-876"><a href="#ProcessADCP-876"><span class="linenos"> 876</span></a>        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_e</span>
</span><span id="ProcessADCP-877"><a href="#ProcessADCP-877"><span class="linenos"> 877</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-878"><a href="#ProcessADCP-878"><span class="linenos"> 878</span></a>        <span class="k">if</span> <span class="n">ep</span><span class="o">.</span><span class="n">maskbins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-879"><a href="#ProcessADCP-879"><span class="linenos"> 879</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">[:,</span> <span class="n">ep</span><span class="o">.</span><span class="n">maskbins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-880"><a href="#ProcessADCP-880"><span class="linenos"> 880</span></a>
</span><span id="ProcessADCP-881"><a href="#ProcessADCP-881"><span class="linenos"> 881</span></a>    <span class="k">def</span> <span class="nf">_to_enu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="ProcessADCP-882"><a href="#ProcessADCP-882"><span class="linenos"> 882</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-883"><a href="#ProcessADCP-883"><span class="linenos"> 883</span></a><span class="sd">        add enu</span>
</span><span id="ProcessADCP-884"><a href="#ProcessADCP-884"><span class="linenos"> 884</span></a><span class="sd">        GV: enu is east, north, up, errvel (optional) whereas xyz are</span>
</span><span id="ProcessADCP-885"><a href="#ProcessADCP-885"><span class="linenos"> 885</span></a><span class="sd">        instrument coordinates.</span>
</span><span id="ProcessADCP-886"><a href="#ProcessADCP-886"><span class="linenos"> 886</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-887"><a href="#ProcessADCP-887"><span class="linenos"> 887</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">enu</span> <span class="o">=</span> <span class="n">rdi_xyz_enu</span><span class="p">(</span>
</span><span id="ProcessADCP-888"><a href="#ProcessADCP-888"><span class="linenos"> 888</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span><span class="p">,</span>
</span><span id="ProcessADCP-889"><a href="#ProcessADCP-889"><span class="linenos"> 889</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">heading</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP-890"><a href="#ProcessADCP-890"><span class="linenos"> 890</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">pitch</span><span class="p">,</span>
</span><span id="ProcessADCP-891"><a href="#ProcessADCP-891"><span class="linenos"> 891</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">roll</span><span class="p">,</span>
</span><span id="ProcessADCP-892"><a href="#ProcessADCP-892"><span class="linenos"> 892</span></a>            <span class="n">orientation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">,</span>
</span><span id="ProcessADCP-893"><a href="#ProcessADCP-893"><span class="linenos"> 893</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-894"><a href="#ProcessADCP-894"><span class="linenos"> 894</span></a>
</span><span id="ProcessADCP-895"><a href="#ProcessADCP-895"><span class="linenos"> 895</span></a>    <span class="k">def</span> <span class="nf">_burst_average_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="ProcessADCP-896"><a href="#ProcessADCP-896"><span class="linenos"> 896</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Depth-average within a burst.</span>
</span><span id="ProcessADCP-897"><a href="#ProcessADCP-897"><span class="linenos"> 897</span></a>
</span><span id="ProcessADCP-898"><a href="#ProcessADCP-898"><span class="linenos"> 898</span></a><span class="sd">        Average the depth vectors if doing burst-averages. Otherwise we just</span>
</span><span id="ProcessADCP-899"><a href="#ProcessADCP-899"><span class="linenos"> 899</span></a><span class="sd">        return all depth vectors of this ensemble.</span>
</span><span id="ProcessADCP-900"><a href="#ProcessADCP-900"><span class="linenos"> 900</span></a>
</span><span id="ProcessADCP-901"><a href="#ProcessADCP-901"><span class="linenos"> 901</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-902"><a href="#ProcessADCP-902"><span class="linenos"> 902</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-903"><a href="#ProcessADCP-903"><span class="linenos"> 903</span></a><span class="sd">        ens : Bunch</span>
</span><span id="ProcessADCP-904"><a href="#ProcessADCP-904"><span class="linenos"> 904</span></a><span class="sd">            Ensemble data.</span>
</span><span id="ProcessADCP-905"><a href="#ProcessADCP-905"><span class="linenos"> 905</span></a>
</span><span id="ProcessADCP-906"><a href="#ProcessADCP-906"><span class="linenos"> 906</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-907"><a href="#ProcessADCP-907"><span class="linenos"> 907</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-908"><a href="#ProcessADCP-908"><span class="linenos"> 908</span></a><span class="sd">        depth : array-like</span>
</span><span id="ProcessADCP-909"><a href="#ProcessADCP-909"><span class="linenos"> 909</span></a><span class="sd">            Depth vector for each ping.</span>
</span><span id="ProcessADCP-910"><a href="#ProcessADCP-910"><span class="linenos"> 910</span></a>
</span><span id="ProcessADCP-911"><a href="#ProcessADCP-911"><span class="linenos"> 911</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-912"><a href="#ProcessADCP-912"><span class="linenos"> 912</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="ProcessADCP-913"><a href="#ProcessADCP-913"><span class="linenos"> 913</span></a>            <span class="n">depth_mean</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-914"><a href="#ProcessADCP-914"><span class="linenos"> 914</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">depth_mean</span><span class="p">,</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="ProcessADCP-915"><a href="#ProcessADCP-915"><span class="linenos"> 915</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-916"><a href="#ProcessADCP-916"><span class="linenos"> 916</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">depth</span>
</span><span id="ProcessADCP-917"><a href="#ProcessADCP-917"><span class="linenos"> 917</span></a>        <span class="k">return</span> <span class="n">depth</span>
</span><span id="ProcessADCP-918"><a href="#ProcessADCP-918"><span class="linenos"> 918</span></a>
</span><span id="ProcessADCP-919"><a href="#ProcessADCP-919"><span class="linenos"> 919</span></a>    <span class="k">def</span> <span class="nf">_regrid_enu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
</span><span id="ProcessADCP-920"><a href="#ProcessADCP-920"><span class="linenos"> 920</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Depth-grid enu velocities.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-921"><a href="#ProcessADCP-921"><span class="linenos"> 921</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ProcessADCP-922"><a href="#ProcessADCP-922"><span class="linenos"> 922</span></a>        <span class="n">enu_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ProcessADCP-923"><a href="#ProcessADCP-923"><span class="linenos"> 923</span></a>        <span class="n">enu_grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-924"><a href="#ProcessADCP-924"><span class="linenos"> 924</span></a>        <span class="c1"># Average the depth vectors if doing burst-averages. Otherwise we just</span>
</span><span id="ProcessADCP-925"><a href="#ProcessADCP-925"><span class="linenos"> 925</span></a>        <span class="c1"># return all depth vectors of this ensemble.</span>
</span><span id="ProcessADCP-926"><a href="#ProcessADCP-926"><span class="linenos"> 926</span></a>        <span class="c1"># TO DO: If calculating averages over regular time intervals, we need</span>
</span><span id="ProcessADCP-927"><a href="#ProcessADCP-927"><span class="linenos"> 927</span></a>        <span class="c1"># to low pass filter the pressure time series prior to creating the</span>
</span><span id="ProcessADCP-928"><a href="#ProcessADCP-928"><span class="linenos"> 928</span></a>        <span class="c1"># depth vectors.</span>
</span><span id="ProcessADCP-929"><a href="#ProcessADCP-929"><span class="linenos"> 929</span></a>        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-930"><a href="#ProcessADCP-930"><span class="linenos"> 930</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
</span><span id="ProcessADCP-931"><a href="#ProcessADCP-931"><span class="linenos"> 931</span></a>            <span class="n">enu_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="ProcessADCP-932"><a href="#ProcessADCP-932"><span class="linenos"> 932</span></a>                <span class="n">depth</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span>
</span><span id="ProcessADCP-933"><a href="#ProcessADCP-933"><span class="linenos"> 933</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-934"><a href="#ProcessADCP-934"><span class="linenos"> 934</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span> <span class="o">=</span> <span class="n">enu_grid</span>
</span><span id="ProcessADCP-935"><a href="#ProcessADCP-935"><span class="linenos"> 935</span></a>
</span><span id="ProcessADCP-936"><a href="#ProcessADCP-936"><span class="linenos"> 936</span></a>    <span class="k">def</span> <span class="nf">_regrid_amp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
</span><span id="ProcessADCP-937"><a href="#ProcessADCP-937"><span class="linenos"> 937</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Depth-grid amplitudes (averaged over all 4 beams).&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-938"><a href="#ProcessADCP-938"><span class="linenos"> 938</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="ProcessADCP-939"><a href="#ProcessADCP-939"><span class="linenos"> 939</span></a>        <span class="n">amp_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ProcessADCP-940"><a href="#ProcessADCP-940"><span class="linenos"> 940</span></a>        <span class="n">amp_grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-941"><a href="#ProcessADCP-941"><span class="linenos"> 941</span></a>        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-942"><a href="#ProcessADCP-942"><span class="linenos"> 942</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
</span><span id="ProcessADCP-943"><a href="#ProcessADCP-943"><span class="linenos"> 943</span></a>            <span class="n">amp_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="ProcessADCP-944"><a href="#ProcessADCP-944"><span class="linenos"> 944</span></a>                <span class="n">depth</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span id="ProcessADCP-945"><a href="#ProcessADCP-945"><span class="linenos"> 945</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
</span><span id="ProcessADCP-946"><a href="#ProcessADCP-946"><span class="linenos"> 946</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="ProcessADCP-947"><a href="#ProcessADCP-947"><span class="linenos"> 947</span></a>                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="ProcessADCP-948"><a href="#ProcessADCP-948"><span class="linenos"> 948</span></a>                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
</span><span id="ProcessADCP-949"><a href="#ProcessADCP-949"><span class="linenos"> 949</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-950"><a href="#ProcessADCP-950"><span class="linenos"> 950</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span> <span class="o">=</span> <span class="n">amp_grid</span>
</span><span id="ProcessADCP-951"><a href="#ProcessADCP-951"><span class="linenos"> 951</span></a>
</span><span id="ProcessADCP-952"><a href="#ProcessADCP-952"><span class="linenos"> 952</span></a>    <span class="k">def</span> <span class="nf">_binmap_one_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">beam_number</span><span class="p">):</span>
</span><span id="ProcessADCP-953"><a href="#ProcessADCP-953"><span class="linenos"> 953</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Binmap single ping data for a single beam by linear interpolation.</span>
</span><span id="ProcessADCP-954"><a href="#ProcessADCP-954"><span class="linenos"> 954</span></a>
</span><span id="ProcessADCP-955"><a href="#ProcessADCP-955"><span class="linenos"> 955</span></a><span class="sd">        Mapping is applied to velocity, amplitude and correlation.</span>
</span><span id="ProcessADCP-956"><a href="#ProcessADCP-956"><span class="linenos"> 956</span></a>
</span><span id="ProcessADCP-957"><a href="#ProcessADCP-957"><span class="linenos"> 957</span></a><span class="sd">        Currently only works for 4 beam ADCP.</span>
</span><span id="ProcessADCP-958"><a href="#ProcessADCP-958"><span class="linenos"> 958</span></a>
</span><span id="ProcessADCP-959"><a href="#ProcessADCP-959"><span class="linenos"> 959</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-960"><a href="#ProcessADCP-960"><span class="linenos"> 960</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-961"><a href="#ProcessADCP-961"><span class="linenos"> 961</span></a><span class="sd">        ens : Bunch</span>
</span><span id="ProcessADCP-962"><a href="#ProcessADCP-962"><span class="linenos"> 962</span></a><span class="sd">            An ADCP dataset read by Multiread.</span>
</span><span id="ProcessADCP-963"><a href="#ProcessADCP-963"><span class="linenos"> 963</span></a><span class="sd">        beam_number : int</span>
</span><span id="ProcessADCP-964"><a href="#ProcessADCP-964"><span class="linenos"> 964</span></a><span class="sd">            An integer from 1 to 4 representing the beam number.</span>
</span><span id="ProcessADCP-965"><a href="#ProcessADCP-965"><span class="linenos"> 965</span></a>
</span><span id="ProcessADCP-966"><a href="#ProcessADCP-966"><span class="linenos"> 966</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-967"><a href="#ProcessADCP-967"><span class="linenos"> 967</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-968"><a href="#ProcessADCP-968"><span class="linenos"> 968</span></a><span class="sd">        veli : ndarray</span>
</span><span id="ProcessADCP-969"><a href="#ProcessADCP-969"><span class="linenos"> 969</span></a><span class="sd">            Mapped velocity.</span>
</span><span id="ProcessADCP-970"><a href="#ProcessADCP-970"><span class="linenos"> 970</span></a><span class="sd">        ampi : ndarray</span>
</span><span id="ProcessADCP-971"><a href="#ProcessADCP-971"><span class="linenos"> 971</span></a><span class="sd">            Mapped amplitude.</span>
</span><span id="ProcessADCP-972"><a href="#ProcessADCP-972"><span class="linenos"> 972</span></a><span class="sd">        cori : ndarray</span>
</span><span id="ProcessADCP-973"><a href="#ProcessADCP-973"><span class="linenos"> 973</span></a><span class="sd">            Mapped correlation.</span>
</span><span id="ProcessADCP-974"><a href="#ProcessADCP-974"><span class="linenos"> 974</span></a>
</span><span id="ProcessADCP-975"><a href="#ProcessADCP-975"><span class="linenos"> 975</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-976"><a href="#ProcessADCP-976"><span class="linenos"> 976</span></a>
</span><span id="ProcessADCP-977"><a href="#ProcessADCP-977"><span class="linenos"> 977</span></a>        <span class="k">if</span> <span class="n">beam_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
</span><span id="ProcessADCP-978"><a href="#ProcessADCP-978"><span class="linenos"> 978</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Beam number must be 1, 2, 3 or 4.&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-979"><a href="#ProcessADCP-979"><span class="linenos"> 979</span></a>
</span><span id="ProcessADCP-980"><a href="#ProcessADCP-980"><span class="linenos"> 980</span></a>        <span class="n">tba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">angle</span><span class="p">))</span>  <span class="c1"># Tangent of beam angle</span>
</span><span id="ProcessADCP-981"><a href="#ProcessADCP-981"><span class="linenos"> 981</span></a>        <span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span>
</span><span id="ProcessADCP-982"><a href="#ProcessADCP-982"><span class="linenos"> 982</span></a>        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">roll</span><span class="p">)</span>
</span><span id="ProcessADCP-983"><a href="#ProcessADCP-983"><span class="linenos"> 983</span></a>
</span><span id="ProcessADCP-984"><a href="#ProcessADCP-984"><span class="linenos"> 984</span></a>        <span class="c1"># The true bin distances</span>
</span><span id="ProcessADCP-985"><a href="#ProcessADCP-985"><span class="linenos"> 985</span></a>        <span class="k">if</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ProcessADCP-986"><a href="#ProcessADCP-986"><span class="linenos"> 986</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ProcessADCP-987"><a href="#ProcessADCP-987"><span class="linenos"> 987</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ProcessADCP-988"><a href="#ProcessADCP-988"><span class="linenos"> 988</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span> <span class="o">-</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ProcessADCP-989"><a href="#ProcessADCP-989"><span class="linenos"> 989</span></a>            <span class="p">)</span>  <span class="c1"># None adds a new axis.</span>
</span><span id="ProcessADCP-990"><a href="#ProcessADCP-990"><span class="linenos"> 990</span></a>        <span class="k">elif</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ProcessADCP-991"><a href="#ProcessADCP-991"><span class="linenos"> 991</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ProcessADCP-992"><a href="#ProcessADCP-992"><span class="linenos"> 992</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ProcessADCP-993"><a href="#ProcessADCP-993"><span class="linenos"> 993</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span> <span class="o">+</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ProcessADCP-994"><a href="#ProcessADCP-994"><span class="linenos"> 994</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-995"><a href="#ProcessADCP-995"><span class="linenos"> 995</span></a>        <span class="k">elif</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="ProcessADCP-996"><a href="#ProcessADCP-996"><span class="linenos"> 996</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ProcessADCP-997"><a href="#ProcessADCP-997"><span class="linenos"> 997</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ProcessADCP-998"><a href="#ProcessADCP-998"><span class="linenos"> 998</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span> <span class="o">+</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ProcessADCP-999"><a href="#ProcessADCP-999"><span class="linenos"> 999</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-1000"><a href="#ProcessADCP-1000"><span class="linenos">1000</span></a>        <span class="k">elif</span> <span class="n">beam_number</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="ProcessADCP-1001"><a href="#ProcessADCP-1001"><span class="linenos">1001</span></a>            <span class="n">dep</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ProcessADCP-1002"><a href="#ProcessADCP-1002"><span class="linenos">1002</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ProcessADCP-1003"><a href="#ProcessADCP-1003"><span class="linenos">1003</span></a>                <span class="o">*</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">)</span> <span class="o">-</span> <span class="n">tba</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="ProcessADCP-1004"><a href="#ProcessADCP-1004"><span class="linenos">1004</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-1005"><a href="#ProcessADCP-1005"><span class="linenos">1005</span></a>
</span><span id="ProcessADCP-1006"><a href="#ProcessADCP-1006"><span class="linenos">1006</span></a>        <span class="n">vel</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">vel</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-1007"><a href="#ProcessADCP-1007"><span class="linenos">1007</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-1008"><a href="#ProcessADCP-1008"><span class="linenos">1008</span></a>        <span class="n">cor</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">cor</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-1009"><a href="#ProcessADCP-1009"><span class="linenos">1009</span></a>
</span><span id="ProcessADCP-1010"><a href="#ProcessADCP-1010"><span class="linenos">1010</span></a>        <span class="c1"># Calculate interpolating weights (this hogs RAM!)</span>
</span><span id="ProcessADCP-1011"><a href="#ProcessADCP-1011"><span class="linenos">1011</span></a>        <span class="n">dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1012"><a href="#ProcessADCP-1012"><span class="linenos">1012</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">ens</span><span class="o">.</span><span class="n">dep</span> <span class="o">-</span> <span class="n">dep</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1013"><a href="#ProcessADCP-1013"><span class="linenos">1013</span></a>
</span><span id="ProcessADCP-1014"><a href="#ProcessADCP-1014"><span class="linenos">1014</span></a>        <span class="c1"># Determine data above or below the deepest bins</span>
</span><span id="ProcessADCP-1015"><a href="#ProcessADCP-1015"><span class="linenos">1015</span></a>        <span class="n">above</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1016"><a href="#ProcessADCP-1016"><span class="linenos">1016</span></a>        <span class="n">below</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1017"><a href="#ProcessADCP-1017"><span class="linenos">1017</span></a>        <span class="n">bad</span> <span class="o">=</span> <span class="n">above</span> <span class="o">|</span> <span class="n">below</span>
</span><span id="ProcessADCP-1018"><a href="#ProcessADCP-1018"><span class="linenos">1018</span></a>
</span><span id="ProcessADCP-1019"><a href="#ProcessADCP-1019"><span class="linenos">1019</span></a>        <span class="c1"># Calculate differences</span>
</span><span id="ProcessADCP-1020"><a href="#ProcessADCP-1020"><span class="linenos">1020</span></a>        <span class="n">dvel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1021"><a href="#ProcessADCP-1021"><span class="linenos">1021</span></a>        <span class="n">damp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1022"><a href="#ProcessADCP-1022"><span class="linenos">1022</span></a>        <span class="n">dcor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1023"><a href="#ProcessADCP-1023"><span class="linenos">1023</span></a>
</span><span id="ProcessADCP-1024"><a href="#ProcessADCP-1024"><span class="linenos">1024</span></a>        <span class="n">veli</span> <span class="o">=</span> <span class="n">vel</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">dvel</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1025"><a href="#ProcessADCP-1025"><span class="linenos">1025</span></a>        <span class="n">veli</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="ProcessADCP-1026"><a href="#ProcessADCP-1026"><span class="linenos">1026</span></a>
</span><span id="ProcessADCP-1027"><a href="#ProcessADCP-1027"><span class="linenos">1027</span></a>        <span class="n">ampi</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">damp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1028"><a href="#ProcessADCP-1028"><span class="linenos">1028</span></a>        <span class="n">ampi</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="ProcessADCP-1029"><a href="#ProcessADCP-1029"><span class="linenos">1029</span></a>
</span><span id="ProcessADCP-1030"><a href="#ProcessADCP-1030"><span class="linenos">1030</span></a>        <span class="n">cori</span> <span class="o">=</span> <span class="n">cor</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">dcor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ProcessADCP-1031"><a href="#ProcessADCP-1031"><span class="linenos">1031</span></a>        <span class="n">cori</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="ProcessADCP-1032"><a href="#ProcessADCP-1032"><span class="linenos">1032</span></a>
</span><span id="ProcessADCP-1033"><a href="#ProcessADCP-1033"><span class="linenos">1033</span></a>        <span class="k">return</span> <span class="n">veli</span><span class="p">,</span> <span class="n">ampi</span><span class="p">,</span> <span class="n">cori</span>
</span><span id="ProcessADCP-1034"><a href="#ProcessADCP-1034"><span class="linenos">1034</span></a>
</span><span id="ProcessADCP-1035"><a href="#ProcessADCP-1035"><span class="linenos">1035</span></a>    <span class="k">def</span> <span class="nf">_binmap_all_beams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">):</span>
</span><span id="ProcessADCP-1036"><a href="#ProcessADCP-1036"><span class="linenos">1036</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Binmap single ping data for all beams.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1037"><a href="#ProcessADCP-1037"><span class="linenos">1037</span></a>
</span><span id="ProcessADCP-1038"><a href="#ProcessADCP-1038"><span class="linenos">1038</span></a>        <span class="k">for</span> <span class="n">beam_number</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
</span><span id="ProcessADCP-1039"><a href="#ProcessADCP-1039"><span class="linenos">1039</span></a>            <span class="n">veli</span><span class="p">,</span> <span class="n">ampi</span><span class="p">,</span> <span class="n">cori</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binmap_one_beam</span><span class="p">(</span><span class="n">ens</span><span class="p">,</span> <span class="n">beam_number</span><span class="p">)</span>
</span><span id="ProcessADCP-1040"><a href="#ProcessADCP-1040"><span class="linenos">1040</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">vel</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">veli</span>
</span><span id="ProcessADCP-1041"><a href="#ProcessADCP-1041"><span class="linenos">1041</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampi</span>
</span><span id="ProcessADCP-1042"><a href="#ProcessADCP-1042"><span class="linenos">1042</span></a>            <span class="n">ens</span><span class="o">.</span><span class="n">cor</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">beam_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cori</span>
</span><span id="ProcessADCP-1043"><a href="#ProcessADCP-1043"><span class="linenos">1043</span></a>
</span><span id="ProcessADCP-1044"><a href="#ProcessADCP-1044"><span class="linenos">1044</span></a>            <span class="n">ens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;vel</span><span class="si">{</span><span class="n">beam_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">veli</span>
</span><span id="ProcessADCP-1045"><a href="#ProcessADCP-1045"><span class="linenos">1045</span></a>            <span class="n">ens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;amp</span><span class="si">{</span><span class="n">beam_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ampi</span>
</span><span id="ProcessADCP-1046"><a href="#ProcessADCP-1046"><span class="linenos">1046</span></a>            <span class="n">ens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cor</span><span class="si">{</span><span class="n">beam_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cori</span>
</span><span id="ProcessADCP-1047"><a href="#ProcessADCP-1047"><span class="linenos">1047</span></a>
</span><span id="ProcessADCP-1048"><a href="#ProcessADCP-1048"><span class="linenos">1048</span></a>    <span class="k">def</span> <span class="nf">_calculate_xyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ens</span><span class="p">,</span> <span class="n">ibad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ProcessADCP-1049"><a href="#ProcessADCP-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate xyze from along-beam data.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1050"><a href="#ProcessADCP-1050"><span class="linenos">1050</span></a>        <span class="k">if</span> <span class="n">ens</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">convex</span><span class="p">:</span>
</span><span id="ProcessADCP-1051"><a href="#ProcessADCP-1051"><span class="linenos">1051</span></a>            <span class="n">geom</span> <span class="o">=</span> <span class="s2">&quot;convex&quot;</span>
</span><span id="ProcessADCP-1052"><a href="#ProcessADCP-1052"><span class="linenos">1052</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1053"><a href="#ProcessADCP-1053"><span class="linenos">1053</span></a>            <span class="n">geom</span> <span class="o">=</span> <span class="s2">&quot;concave&quot;</span>
</span><span id="ProcessADCP-1054"><a href="#ProcessADCP-1054"><span class="linenos">1054</span></a>
</span><span id="ProcessADCP-1055"><a href="#ProcessADCP-1055"><span class="linenos">1055</span></a>        <span class="n">trans</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="n">ens</span><span class="o">.</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geom</span><span class="p">)</span>
</span><span id="ProcessADCP-1056"><a href="#ProcessADCP-1056"><span class="linenos">1056</span></a>
</span><span id="ProcessADCP-1057"><a href="#ProcessADCP-1057"><span class="linenos">1057</span></a>        <span class="n">ens</span><span class="o">.</span><span class="n">xyze</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">beam_to_xyz</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">vel</span><span class="p">,</span> <span class="n">ibad</span><span class="o">=</span><span class="n">ibad</span><span class="p">)</span>
</span><span id="ProcessADCP-1058"><a href="#ProcessADCP-1058"><span class="linenos">1058</span></a>
</span><span id="ProcessADCP-1059"><a href="#ProcessADCP-1059"><span class="linenos">1059</span></a>    <span class="k">def</span> <span class="nf">process_pings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ens_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">):</span>
</span><span id="ProcessADCP-1060"><a href="#ProcessADCP-1060"><span class="linenos">1060</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process single ping data without averaging.</span>
</span><span id="ProcessADCP-1061"><a href="#ProcessADCP-1061"><span class="linenos">1061</span></a>
</span><span id="ProcessADCP-1062"><a href="#ProcessADCP-1062"><span class="linenos">1062</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="ProcessADCP-1063"><a href="#ProcessADCP-1063"><span class="linenos">1063</span></a>
</span><span id="ProcessADCP-1064"><a href="#ProcessADCP-1064"><span class="linenos">1064</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="ProcessADCP-1065"><a href="#ProcessADCP-1065"><span class="linenos">1065</span></a>
</span><span id="ProcessADCP-1066"><a href="#ProcessADCP-1066"><span class="linenos">1066</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-1067"><a href="#ProcessADCP-1067"><span class="linenos">1067</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-1068"><a href="#ProcessADCP-1068"><span class="linenos">1068</span></a><span class="sd">        start : int, optional</span>
</span><span id="ProcessADCP-1069"><a href="#ProcessADCP-1069"><span class="linenos">1069</span></a><span class="sd">            Start processing at this ping number.</span>
</span><span id="ProcessADCP-1070"><a href="#ProcessADCP-1070"><span class="linenos">1070</span></a><span class="sd">        stop : int, optional</span>
</span><span id="ProcessADCP-1071"><a href="#ProcessADCP-1071"><span class="linenos">1071</span></a><span class="sd">            Stop processing at this ping number.</span>
</span><span id="ProcessADCP-1072"><a href="#ProcessADCP-1072"><span class="linenos">1072</span></a><span class="sd">        binmap : bool, optional</span>
</span><span id="ProcessADCP-1073"><a href="#ProcessADCP-1073"><span class="linenos">1073</span></a><span class="sd">            Do binmapping of along-beam data.</span>
</span><span id="ProcessADCP-1074"><a href="#ProcessADCP-1074"><span class="linenos">1074</span></a><span class="sd">        ens_size : int, optional</span>
</span><span id="ProcessADCP-1075"><a href="#ProcessADCP-1075"><span class="linenos">1075</span></a><span class="sd">            Pings are processed in ensembles to reduce memory usage.</span>
</span><span id="ProcessADCP-1076"><a href="#ProcessADCP-1076"><span class="linenos">1076</span></a><span class="sd">            This parameter sets how many pings are in an ensemble. The default is 50000.</span>
</span><span id="ProcessADCP-1077"><a href="#ProcessADCP-1077"><span class="linenos">1077</span></a>
</span><span id="ProcessADCP-1078"><a href="#ProcessADCP-1078"><span class="linenos">1078</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1079"><a href="#ProcessADCP-1079"><span class="linenos">1079</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1080"><a href="#ProcessADCP-1080"><span class="linenos">1080</span></a>            <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span><span class="p">)</span>
</span><span id="ProcessADCP-1081"><a href="#ProcessADCP-1081"><span class="linenos">1081</span></a>        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1082"><a href="#ProcessADCP-1082"><span class="linenos">1082</span></a>            <span class="n">idx_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span><span class="p">)</span>
</span><span id="ProcessADCP-1083"><a href="#ProcessADCP-1083"><span class="linenos">1083</span></a>
</span><span id="ProcessADCP-1084"><a href="#ProcessADCP-1084"><span class="linenos">1084</span></a>        <span class="n">ens_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idx_start</span><span class="p">,</span> <span class="n">idx_stop</span><span class="p">,</span> <span class="n">ens_size</span><span class="p">),</span> <span class="n">idx_stop</span><span class="p">))</span>
</span><span id="ProcessADCP-1085"><a href="#ProcessADCP-1085"><span class="linenos">1085</span></a>        <span class="n">write_idxs</span> <span class="o">=</span> <span class="n">ens_idxs</span> <span class="o">-</span> <span class="n">ens_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Arrays we write to start at index 0</span>
</span><span id="ProcessADCP-1086"><a href="#ProcessADCP-1086"><span class="linenos">1086</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">idx_stop</span> <span class="o">-</span> <span class="n">idx_start</span>
</span><span id="ProcessADCP-1087"><a href="#ProcessADCP-1087"><span class="linenos">1087</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="n">ens_idxs</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="ProcessADCP-1088"><a href="#ProcessADCP-1088"><span class="linenos">1088</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dep</span><span class="o">.</span><span class="n">size</span>
</span><span id="ProcessADCP-1089"><a href="#ProcessADCP-1089"><span class="linenos">1089</span></a>
</span><span id="ProcessADCP-1090"><a href="#ProcessADCP-1090"><span class="linenos">1090</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing all pings&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1091"><a href="#ProcessADCP-1091"><span class="linenos">1091</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binmapping is </span><span class="si">{</span><span class="n">binmap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1092"><a href="#ProcessADCP-1092"><span class="linenos">1092</span></a>
</span><span id="ProcessADCP-1093"><a href="#ProcessADCP-1093"><span class="linenos">1093</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1094"><a href="#ProcessADCP-1094"><span class="linenos">1094</span></a>
</span><span id="ProcessADCP-1095"><a href="#ProcessADCP-1095"><span class="linenos">1095</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP-1096"><a href="#ProcessADCP-1096"><span class="linenos">1096</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1097"><a href="#ProcessADCP-1097"><span class="linenos">1097</span></a>
</span><span id="ProcessADCP-1098"><a href="#ProcessADCP-1098"><span class="linenos">1098</span></a>        <span class="c1"># temperature = np.ma.zeros((npings,), dtype=np.float32)</span>
</span><span id="ProcessADCP-1099"><a href="#ProcessADCP-1099"><span class="linenos">1099</span></a>        <span class="c1"># pressure = np.ma.zeros((npings,), dtype=np.float32)</span>
</span><span id="ProcessADCP-1100"><a href="#ProcessADCP-1100"><span class="linenos">1100</span></a>
</span><span id="ProcessADCP-1101"><a href="#ProcessADCP-1101"><span class="linenos">1101</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">temperature</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1102"><a href="#ProcessADCP-1102"><span class="linenos">1102</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1103"><a href="#ProcessADCP-1103"><span class="linenos">1103</span></a>
</span><span id="ProcessADCP-1104"><a href="#ProcessADCP-1104"><span class="linenos">1104</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1105"><a href="#ProcessADCP-1105"><span class="linenos">1105</span></a>
</span><span id="ProcessADCP-1106"><a href="#ProcessADCP-1106"><span class="linenos">1106</span></a>        <span class="c1"># Loop over ensembles</span>
</span><span id="ProcessADCP-1107"><a href="#ProcessADCP-1107"><span class="linenos">1107</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nens</span><span class="p">)):</span>
</span><span id="ProcessADCP-1108"><a href="#ProcessADCP-1108"><span class="linenos">1108</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">ens_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="n">ens_idxs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="ProcessADCP-1109"><a href="#ProcessADCP-1109"><span class="linenos">1109</span></a>            <span class="n">idx0</span> <span class="o">=</span> <span class="n">write_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="ProcessADCP-1110"><a href="#ProcessADCP-1110"><span class="linenos">1110</span></a>            <span class="n">idx1</span> <span class="o">=</span> <span class="n">write_idxs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP-1111"><a href="#ProcessADCP-1111"><span class="linenos">1111</span></a>
</span><span id="ProcessADCP-1112"><a href="#ProcessADCP-1112"><span class="linenos">1112</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1113"><a href="#ProcessADCP-1113"><span class="linenos">1113</span></a>                <span class="c1"># I pulled this out of read_ensembles because we need to</span>
</span><span id="ProcessADCP-1114"><a href="#ProcessADCP-1114"><span class="linenos">1114</span></a>                <span class="c1"># calculate depth for _ave2nc to work.</span>
</span><span id="ProcessADCP-1115"><a href="#ProcessADCP-1115"><span class="linenos">1115</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dday_orig</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">dday</span>
</span><span id="ProcessADCP-1116"><a href="#ProcessADCP-1116"><span class="linenos">1116</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday_orig</span><span class="p">)</span>
</span><span id="ProcessADCP-1117"><a href="#ProcessADCP-1117"><span class="linenos">1117</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1118"><a href="#ProcessADCP-1118"><span class="linenos">1118</span></a>                    <span class="c1"># Replace pressure if provided</span>
</span><span id="ProcessADCP-1119"><a href="#ProcessADCP-1119"><span class="linenos">1119</span></a>                    <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1120"><a href="#ProcessADCP-1120"><span class="linenos">1120</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1121"><a href="#ProcessADCP-1121"><span class="linenos">1121</span></a>                    <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1122"><a href="#ProcessADCP-1122"><span class="linenos">1122</span></a>                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="ProcessADCP-1123"><a href="#ProcessADCP-1123"><span class="linenos">1123</span></a>                <span class="n">pdepth</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP-1124"><a href="#ProcessADCP-1124"><span class="linenos">1124</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">dep</span>
</span><span id="ProcessADCP-1125"><a href="#ProcessADCP-1125"><span class="linenos">1125</span></a>
</span><span id="ProcessADCP-1126"><a href="#ProcessADCP-1126"><span class="linenos">1126</span></a>                <span class="k">if</span> <span class="n">binmap</span><span class="p">:</span>
</span><span id="ProcessADCP-1127"><a href="#ProcessADCP-1127"><span class="linenos">1127</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_binmap_all_beams</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1128"><a href="#ProcessADCP-1128"><span class="linenos">1128</span></a>                    <span class="c1"># Now we have to recalculate xyze with the binmapped data.</span>
</span><span id="ProcessADCP-1129"><a href="#ProcessADCP-1129"><span class="linenos">1129</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_xyze</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1130"><a href="#ProcessADCP-1130"><span class="linenos">1130</span></a>
</span><span id="ProcessADCP-1131"><a href="#ProcessADCP-1131"><span class="linenos">1131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="ProcessADCP-1132"><a href="#ProcessADCP-1132"><span class="linenos">1132</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="ProcessADCP-1133"><a href="#ProcessADCP-1133"><span class="linenos">1133</span></a>
</span><span id="ProcessADCP-1134"><a href="#ProcessADCP-1134"><span class="linenos">1134</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1135"><a href="#ProcessADCP-1135"><span class="linenos">1135</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1136"><a href="#ProcessADCP-1136"><span class="linenos">1136</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1137"><a href="#ProcessADCP-1137"><span class="linenos">1137</span></a>                <span class="c1"># pressure[idx0:idx1] = np.ma.masked</span>
</span><span id="ProcessADCP-1138"><a href="#ProcessADCP-1138"><span class="linenos">1138</span></a>                <span class="c1"># temperature[idx0:idx1] = np.ma.masked</span>
</span><span id="ProcessADCP-1139"><a href="#ProcessADCP-1139"><span class="linenos">1139</span></a>                <span class="k">continue</span>
</span><span id="ProcessADCP-1140"><a href="#ProcessADCP-1140"><span class="linenos">1140</span></a>
</span><span id="ProcessADCP-1141"><a href="#ProcessADCP-1141"><span class="linenos">1141</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span>
</span><span id="ProcessADCP-1142"><a href="#ProcessADCP-1142"><span class="linenos">1142</span></a>
</span><span id="ProcessADCP-1143"><a href="#ProcessADCP-1143"><span class="linenos">1143</span></a>            <span class="c1"># pgi = 100 * ens.enu_grid[..., 0].count(axis=0) // nprofs</span>
</span><span id="ProcessADCP-1144"><a href="#ProcessADCP-1144"><span class="linenos">1144</span></a>            <span class="c1"># pg[i] = pgi.astype(np.int8)</span>
</span><span id="ProcessADCP-1145"><a href="#ProcessADCP-1145"><span class="linenos">1145</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Average over beams... why?</span>
</span><span id="ProcessADCP-1146"><a href="#ProcessADCP-1146"><span class="linenos">1146</span></a>
</span><span id="ProcessADCP-1147"><a href="#ProcessADCP-1147"><span class="linenos">1147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="ProcessADCP-1148"><a href="#ProcessADCP-1148"><span class="linenos">1148</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP-1149"><a href="#ProcessADCP-1149"><span class="linenos">1149</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP-1150"><a href="#ProcessADCP-1150"><span class="linenos">1150</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP-1151"><a href="#ProcessADCP-1151"><span class="linenos">1151</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP-1152"><a href="#ProcessADCP-1152"><span class="linenos">1152</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="ProcessADCP-1153"><a href="#ProcessADCP-1153"><span class="linenos">1153</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="ProcessADCP-1154"><a href="#ProcessADCP-1154"><span class="linenos">1154</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="ProcessADCP-1155"><a href="#ProcessADCP-1155"><span class="linenos">1155</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="ProcessADCP-1156"><a href="#ProcessADCP-1156"><span class="linenos">1156</span></a>            <span class="c1"># npings=npings,</span>
</span><span id="ProcessADCP-1157"><a href="#ProcessADCP-1157"><span class="linenos">1157</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP-1158"><a href="#ProcessADCP-1158"><span class="linenos">1158</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="ProcessADCP-1159"><a href="#ProcessADCP-1159"><span class="linenos">1159</span></a>            <span class="n">dep</span><span class="o">=</span><span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">,</span>  <span class="c1"># &lt;&lt;&lt;&lt;----- BAD!!! This a fudge because I don&#39;t want to calculated a depth vector. We use the depth vector from the last ensemble.</span>
</span><span id="ProcessADCP-1160"><a href="#ProcessADCP-1160"><span class="linenos">1160</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1161"><a href="#ProcessADCP-1161"><span class="linenos">1161</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1162"><a href="#ProcessADCP-1162"><span class="linenos">1162</span></a>            <span class="c1"># dgridparams=self.dgridparams,</span>
</span><span id="ProcessADCP-1163"><a href="#ProcessADCP-1163"><span class="linenos">1163</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP-1164"><a href="#ProcessADCP-1164"><span class="linenos">1164</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP-1165"><a href="#ProcessADCP-1165"><span class="linenos">1165</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP-1166"><a href="#ProcessADCP-1166"><span class="linenos">1166</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1167"><a href="#ProcessADCP-1167"><span class="linenos">1167</span></a>
</span><span id="ProcessADCP-1168"><a href="#ProcessADCP-1168"><span class="linenos">1168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="ProcessADCP-1169"><a href="#ProcessADCP-1169"><span class="linenos">1169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="ProcessADCP-1170"><a href="#ProcessADCP-1170"><span class="linenos">1170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span><span id="ProcessADCP-1171"><a href="#ProcessADCP-1171"><span class="linenos">1171</span></a>
</span><span id="ProcessADCP-1172"><a href="#ProcessADCP-1172"><span class="linenos">1172</span></a>    <span class="k">def</span> <span class="nf">average_ensembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ProcessADCP-1173"><a href="#ProcessADCP-1173"><span class="linenos">1173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-averaging.</span>
</span><span id="ProcessADCP-1174"><a href="#ProcessADCP-1174"><span class="linenos">1174</span></a>
</span><span id="ProcessADCP-1175"><a href="#ProcessADCP-1175"><span class="linenos">1175</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="ProcessADCP-1176"><a href="#ProcessADCP-1176"><span class="linenos">1176</span></a>
</span><span id="ProcessADCP-1177"><a href="#ProcessADCP-1177"><span class="linenos">1177</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="ProcessADCP-1178"><a href="#ProcessADCP-1178"><span class="linenos">1178</span></a>
</span><span id="ProcessADCP-1179"><a href="#ProcessADCP-1179"><span class="linenos">1179</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-1180"><a href="#ProcessADCP-1180"><span class="linenos">1180</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-1181"><a href="#ProcessADCP-1181"><span class="linenos">1181</span></a><span class="sd">        start : int</span>
</span><span id="ProcessADCP-1182"><a href="#ProcessADCP-1182"><span class="linenos">1182</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP-1183"><a href="#ProcessADCP-1183"><span class="linenos">1183</span></a><span class="sd">            intervals.</span>
</span><span id="ProcessADCP-1184"><a href="#ProcessADCP-1184"><span class="linenos">1184</span></a><span class="sd">        stop : int</span>
</span><span id="ProcessADCP-1185"><a href="#ProcessADCP-1185"><span class="linenos">1185</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP-1186"><a href="#ProcessADCP-1186"><span class="linenos">1186</span></a><span class="sd">            intervals.</span>
</span><span id="ProcessADCP-1187"><a href="#ProcessADCP-1187"><span class="linenos">1187</span></a>
</span><span id="ProcessADCP-1188"><a href="#ProcessADCP-1188"><span class="linenos">1188</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1189"><a href="#ProcessADCP-1189"><span class="linenos">1189</span></a>
</span><span id="ProcessADCP-1190"><a href="#ProcessADCP-1190"><span class="linenos">1190</span></a>        <span class="n">nens_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="ProcessADCP-1191"><a href="#ProcessADCP-1191"><span class="linenos">1191</span></a>        <span class="n">indices_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens_orig</span><span class="p">)</span>
</span><span id="ProcessADCP-1192"><a href="#ProcessADCP-1192"><span class="linenos">1192</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_orig</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1193"><a href="#ProcessADCP-1193"><span class="linenos">1193</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1194"><a href="#ProcessADCP-1194"><span class="linenos">1194</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all ensembles&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1195"><a href="#ProcessADCP-1195"><span class="linenos">1195</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1196"><a href="#ProcessADCP-1196"><span class="linenos">1196</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaging ensembles </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1197"><a href="#ProcessADCP-1197"><span class="linenos">1197</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="ProcessADCP-1198"><a href="#ProcessADCP-1198"><span class="linenos">1198</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">)</span>
</span><span id="ProcessADCP-1199"><a href="#ProcessADCP-1199"><span class="linenos">1199</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1200"><a href="#ProcessADCP-1200"><span class="linenos">1200</span></a>        <span class="n">uvwe_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1201"><a href="#ProcessADCP-1201"><span class="linenos">1201</span></a>
</span><span id="ProcessADCP-1202"><a href="#ProcessADCP-1202"><span class="linenos">1202</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP-1203"><a href="#ProcessADCP-1203"><span class="linenos">1203</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1204"><a href="#ProcessADCP-1204"><span class="linenos">1204</span></a>
</span><span id="ProcessADCP-1205"><a href="#ProcessADCP-1205"><span class="linenos">1205</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1206"><a href="#ProcessADCP-1206"><span class="linenos">1206</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1207"><a href="#ProcessADCP-1207"><span class="linenos">1207</span></a>        <span class="n">pressure_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1208"><a href="#ProcessADCP-1208"><span class="linenos">1208</span></a>        <span class="n">pressure_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1209"><a href="#ProcessADCP-1209"><span class="linenos">1209</span></a>
</span><span id="ProcessADCP-1210"><a href="#ProcessADCP-1210"><span class="linenos">1210</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span><span id="ProcessADCP-1211"><a href="#ProcessADCP-1211"><span class="linenos">1211</span></a>
</span><span id="ProcessADCP-1212"><a href="#ProcessADCP-1212"><span class="linenos">1212</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1213"><a href="#ProcessADCP-1213"><span class="linenos">1213</span></a>
</span><span id="ProcessADCP-1214"><a href="#ProcessADCP-1214"><span class="linenos">1214</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
</span><span id="ProcessADCP-1215"><a href="#ProcessADCP-1215"><span class="linenos">1215</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ensemble</span><span class="p">(</span><span class="n">iens</span><span class="p">)</span>
</span><span id="ProcessADCP-1216"><a href="#ProcessADCP-1216"><span class="linenos">1216</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1217"><a href="#ProcessADCP-1217"><span class="linenos">1217</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="ProcessADCP-1218"><a href="#ProcessADCP-1218"><span class="linenos">1218</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="ProcessADCP-1219"><a href="#ProcessADCP-1219"><span class="linenos">1219</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1220"><a href="#ProcessADCP-1220"><span class="linenos">1220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_amp</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1221"><a href="#ProcessADCP-1221"><span class="linenos">1221</span></a>
</span><span id="ProcessADCP-1222"><a href="#ProcessADCP-1222"><span class="linenos">1222</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-1223"><a href="#ProcessADCP-1223"><span class="linenos">1223</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1224"><a href="#ProcessADCP-1224"><span class="linenos">1224</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ProcessADCP-1225"><a href="#ProcessADCP-1225"><span class="linenos">1225</span></a>            <span class="n">npings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP-1226"><a href="#ProcessADCP-1226"><span class="linenos">1226</span></a>            <span class="k">if</span> <span class="n">nprofs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ProcessADCP-1227"><a href="#ProcessADCP-1227"><span class="linenos">1227</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1228"><a href="#ProcessADCP-1228"><span class="linenos">1228</span></a>                <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1229"><a href="#ProcessADCP-1229"><span class="linenos">1229</span></a>                <span class="c1"># (pg is not a masked array)</span>
</span><span id="ProcessADCP-1230"><a href="#ProcessADCP-1230"><span class="linenos">1230</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1231"><a href="#ProcessADCP-1231"><span class="linenos">1231</span></a>                <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1232"><a href="#ProcessADCP-1232"><span class="linenos">1232</span></a>                <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1233"><a href="#ProcessADCP-1233"><span class="linenos">1233</span></a>                <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1234"><a href="#ProcessADCP-1234"><span class="linenos">1234</span></a>                <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1235"><a href="#ProcessADCP-1235"><span class="linenos">1235</span></a>                <span class="k">continue</span>
</span><span id="ProcessADCP-1236"><a href="#ProcessADCP-1236"><span class="linenos">1236</span></a>
</span><span id="ProcessADCP-1237"><a href="#ProcessADCP-1237"><span class="linenos">1237</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1238"><a href="#ProcessADCP-1238"><span class="linenos">1238</span></a>            <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1239"><a href="#ProcessADCP-1239"><span class="linenos">1239</span></a>
</span><span id="ProcessADCP-1240"><a href="#ProcessADCP-1240"><span class="linenos">1240</span></a>            <span class="n">pgi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP-1241"><a href="#ProcessADCP-1241"><span class="linenos">1241</span></a>            <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP-1242"><a href="#ProcessADCP-1242"><span class="linenos">1242</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1243"><a href="#ProcessADCP-1243"><span class="linenos">1243</span></a>
</span><span id="ProcessADCP-1244"><a href="#ProcessADCP-1244"><span class="linenos">1244</span></a>            <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP-1245"><a href="#ProcessADCP-1245"><span class="linenos">1245</span></a>            <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="ProcessADCP-1246"><a href="#ProcessADCP-1246"><span class="linenos">1246</span></a>            <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="ProcessADCP-1247"><a href="#ProcessADCP-1247"><span class="linenos">1247</span></a>            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP-1248"><a href="#ProcessADCP-1248"><span class="linenos">1248</span></a>
</span><span id="ProcessADCP-1249"><a href="#ProcessADCP-1249"><span class="linenos">1249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="ProcessADCP-1250"><a href="#ProcessADCP-1250"><span class="linenos">1250</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP-1251"><a href="#ProcessADCP-1251"><span class="linenos">1251</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP-1252"><a href="#ProcessADCP-1252"><span class="linenos">1252</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP-1253"><a href="#ProcessADCP-1253"><span class="linenos">1253</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP-1254"><a href="#ProcessADCP-1254"><span class="linenos">1254</span></a>            <span class="n">u_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP-1255"><a href="#ProcessADCP-1255"><span class="linenos">1255</span></a>            <span class="n">v_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP-1256"><a href="#ProcessADCP-1256"><span class="linenos">1256</span></a>            <span class="n">w_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP-1257"><a href="#ProcessADCP-1257"><span class="linenos">1257</span></a>            <span class="n">e_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP-1258"><a href="#ProcessADCP-1258"><span class="linenos">1258</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="ProcessADCP-1259"><a href="#ProcessADCP-1259"><span class="linenos">1259</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="ProcessADCP-1260"><a href="#ProcessADCP-1260"><span class="linenos">1260</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="ProcessADCP-1261"><a href="#ProcessADCP-1261"><span class="linenos">1261</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="ProcessADCP-1262"><a href="#ProcessADCP-1262"><span class="linenos">1262</span></a>            <span class="n">pressure_std</span><span class="o">=</span><span class="n">pressure_std</span><span class="p">,</span>
</span><span id="ProcessADCP-1263"><a href="#ProcessADCP-1263"><span class="linenos">1263</span></a>            <span class="n">pressure_max</span><span class="o">=</span><span class="n">pressure_max</span><span class="p">,</span>
</span><span id="ProcessADCP-1264"><a href="#ProcessADCP-1264"><span class="linenos">1264</span></a>            <span class="n">npings</span><span class="o">=</span><span class="n">npings</span><span class="p">,</span>
</span><span id="ProcessADCP-1265"><a href="#ProcessADCP-1265"><span class="linenos">1265</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP-1266"><a href="#ProcessADCP-1266"><span class="linenos">1266</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="ProcessADCP-1267"><a href="#ProcessADCP-1267"><span class="linenos">1267</span></a>            <span class="n">dep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="ProcessADCP-1268"><a href="#ProcessADCP-1268"><span class="linenos">1268</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1269"><a href="#ProcessADCP-1269"><span class="linenos">1269</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1270"><a href="#ProcessADCP-1270"><span class="linenos">1270</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1271"><a href="#ProcessADCP-1271"><span class="linenos">1271</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP-1272"><a href="#ProcessADCP-1272"><span class="linenos">1272</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP-1273"><a href="#ProcessADCP-1273"><span class="linenos">1273</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP-1274"><a href="#ProcessADCP-1274"><span class="linenos">1274</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1275"><a href="#ProcessADCP-1275"><span class="linenos">1275</span></a>
</span><span id="ProcessADCP-1276"><a href="#ProcessADCP-1276"><span class="linenos">1276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="ProcessADCP-1277"><a href="#ProcessADCP-1277"><span class="linenos">1277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="ProcessADCP-1278"><a href="#ProcessADCP-1278"><span class="linenos">1278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span><span id="ProcessADCP-1279"><a href="#ProcessADCP-1279"><span class="linenos">1279</span></a>
</span><span id="ProcessADCP-1280"><a href="#ProcessADCP-1280"><span class="linenos">1280</span></a>    <span class="k">def</span> <span class="nf">burst_average_ensembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interpolate_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ProcessADCP-1281"><a href="#ProcessADCP-1281"><span class="linenos">1281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-averaging prior to depth-gridding.</span>
</span><span id="ProcessADCP-1282"><a href="#ProcessADCP-1282"><span class="linenos">1282</span></a>
</span><span id="ProcessADCP-1283"><a href="#ProcessADCP-1283"><span class="linenos">1283</span></a><span class="sd">        Uses pre-defined editing parameters that can be updated with</span>
</span><span id="ProcessADCP-1284"><a href="#ProcessADCP-1284"><span class="linenos">1284</span></a><span class="sd">        `parse_editparams`.</span>
</span><span id="ProcessADCP-1285"><a href="#ProcessADCP-1285"><span class="linenos">1285</span></a>
</span><span id="ProcessADCP-1286"><a href="#ProcessADCP-1286"><span class="linenos">1286</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="ProcessADCP-1287"><a href="#ProcessADCP-1287"><span class="linenos">1287</span></a>
</span><span id="ProcessADCP-1288"><a href="#ProcessADCP-1288"><span class="linenos">1288</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="ProcessADCP-1289"><a href="#ProcessADCP-1289"><span class="linenos">1289</span></a>
</span><span id="ProcessADCP-1290"><a href="#ProcessADCP-1290"><span class="linenos">1290</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-1291"><a href="#ProcessADCP-1291"><span class="linenos">1291</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-1292"><a href="#ProcessADCP-1292"><span class="linenos">1292</span></a><span class="sd">        start : int, optional</span>
</span><span id="ProcessADCP-1293"><a href="#ProcessADCP-1293"><span class="linenos">1293</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP-1294"><a href="#ProcessADCP-1294"><span class="linenos">1294</span></a><span class="sd">            intervals. Defaults to None (start at beginning).</span>
</span><span id="ProcessADCP-1295"><a href="#ProcessADCP-1295"><span class="linenos">1295</span></a><span class="sd">        stop : int, optional</span>
</span><span id="ProcessADCP-1296"><a href="#ProcessADCP-1296"><span class="linenos">1296</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP-1297"><a href="#ProcessADCP-1297"><span class="linenos">1297</span></a><span class="sd">            intervals. Defaults to None (start at beginning).</span>
</span><span id="ProcessADCP-1298"><a href="#ProcessADCP-1298"><span class="linenos">1298</span></a><span class="sd">        interpolate_bin : int or None, optional</span>
</span><span id="ProcessADCP-1299"><a href="#ProcessADCP-1299"><span class="linenos">1299</span></a><span class="sd">            Interpolate over a single, previously masked, bin. Defaults to None (no interpolation).</span>
</span><span id="ProcessADCP-1300"><a href="#ProcessADCP-1300"><span class="linenos">1300</span></a>
</span><span id="ProcessADCP-1301"><a href="#ProcessADCP-1301"><span class="linenos">1301</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1302"><a href="#ProcessADCP-1302"><span class="linenos">1302</span></a>        <span class="n">pg_condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="o">.</span><span class="n">pg_limit</span>
</span><span id="ProcessADCP-1303"><a href="#ProcessADCP-1303"><span class="linenos">1303</span></a>        <span class="n">nens_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="ProcessADCP-1304"><a href="#ProcessADCP-1304"><span class="linenos">1304</span></a>        <span class="n">indices_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens_orig</span><span class="p">)</span>
</span><span id="ProcessADCP-1305"><a href="#ProcessADCP-1305"><span class="linenos">1305</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_orig</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1306"><a href="#ProcessADCP-1306"><span class="linenos">1306</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1307"><a href="#ProcessADCP-1307"><span class="linenos">1307</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all ensembles&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1308"><a href="#ProcessADCP-1308"><span class="linenos">1308</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1309"><a href="#ProcessADCP-1309"><span class="linenos">1309</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaging ensembles </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1310"><a href="#ProcessADCP-1310"><span class="linenos">1310</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="ProcessADCP-1311"><a href="#ProcessADCP-1311"><span class="linenos">1311</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">)</span>
</span><span id="ProcessADCP-1312"><a href="#ProcessADCP-1312"><span class="linenos">1312</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1313"><a href="#ProcessADCP-1313"><span class="linenos">1313</span></a>        <span class="n">uvwe_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1314"><a href="#ProcessADCP-1314"><span class="linenos">1314</span></a>
</span><span id="ProcessADCP-1315"><a href="#ProcessADCP-1315"><span class="linenos">1315</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP-1316"><a href="#ProcessADCP-1316"><span class="linenos">1316</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1317"><a href="#ProcessADCP-1317"><span class="linenos">1317</span></a>
</span><span id="ProcessADCP-1318"><a href="#ProcessADCP-1318"><span class="linenos">1318</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1319"><a href="#ProcessADCP-1319"><span class="linenos">1319</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1320"><a href="#ProcessADCP-1320"><span class="linenos">1320</span></a>        <span class="n">pressure_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1321"><a href="#ProcessADCP-1321"><span class="linenos">1321</span></a>        <span class="n">pressure_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP-1322"><a href="#ProcessADCP-1322"><span class="linenos">1322</span></a>
</span><span id="ProcessADCP-1323"><a href="#ProcessADCP-1323"><span class="linenos">1323</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span><span id="ProcessADCP-1324"><a href="#ProcessADCP-1324"><span class="linenos">1324</span></a>
</span><span id="ProcessADCP-1325"><a href="#ProcessADCP-1325"><span class="linenos">1325</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP-1326"><a href="#ProcessADCP-1326"><span class="linenos">1326</span></a>
</span><span id="ProcessADCP-1327"><a href="#ProcessADCP-1327"><span class="linenos">1327</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
</span><span id="ProcessADCP-1328"><a href="#ProcessADCP-1328"><span class="linenos">1328</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ensemble</span><span class="p">(</span><span class="n">iens</span><span class="p">)</span>
</span><span id="ProcessADCP-1329"><a href="#ProcessADCP-1329"><span class="linenos">1329</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1330"><a href="#ProcessADCP-1330"><span class="linenos">1330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="ProcessADCP-1331"><a href="#ProcessADCP-1331"><span class="linenos">1331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="ProcessADCP-1332"><a href="#ProcessADCP-1332"><span class="linenos">1332</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1333"><a href="#ProcessADCP-1333"><span class="linenos">1333</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_amp</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1334"><a href="#ProcessADCP-1334"><span class="linenos">1334</span></a>
</span><span id="ProcessADCP-1335"><a href="#ProcessADCP-1335"><span class="linenos">1335</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-1336"><a href="#ProcessADCP-1336"><span class="linenos">1336</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1337"><a href="#ProcessADCP-1337"><span class="linenos">1337</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ProcessADCP-1338"><a href="#ProcessADCP-1338"><span class="linenos">1338</span></a>            <span class="n">npings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP-1339"><a href="#ProcessADCP-1339"><span class="linenos">1339</span></a>            <span class="k">if</span> <span class="n">nprofs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ProcessADCP-1340"><a href="#ProcessADCP-1340"><span class="linenos">1340</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1341"><a href="#ProcessADCP-1341"><span class="linenos">1341</span></a>                <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1342"><a href="#ProcessADCP-1342"><span class="linenos">1342</span></a>                <span class="c1"># (pg is not a masked array)</span>
</span><span id="ProcessADCP-1343"><a href="#ProcessADCP-1343"><span class="linenos">1343</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1344"><a href="#ProcessADCP-1344"><span class="linenos">1344</span></a>                <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1345"><a href="#ProcessADCP-1345"><span class="linenos">1345</span></a>                <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1346"><a href="#ProcessADCP-1346"><span class="linenos">1346</span></a>                <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1347"><a href="#ProcessADCP-1347"><span class="linenos">1347</span></a>                <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1348"><a href="#ProcessADCP-1348"><span class="linenos">1348</span></a>                <span class="k">continue</span>
</span><span id="ProcessADCP-1349"><a href="#ProcessADCP-1349"><span class="linenos">1349</span></a>
</span><span id="ProcessADCP-1350"><a href="#ProcessADCP-1350"><span class="linenos">1350</span></a>            <span class="c1"># Depth vector for interpolation</span>
</span><span id="ProcessADCP-1351"><a href="#ProcessADCP-1351"><span class="linenos">1351</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP-1352"><a href="#ProcessADCP-1352"><span class="linenos">1352</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ProcessADCP-1353"><a href="#ProcessADCP-1353"><span class="linenos">1353</span></a>
</span><span id="ProcessADCP-1354"><a href="#ProcessADCP-1354"><span class="linenos">1354</span></a>            <span class="c1"># Calculate burst-average on instrument-relative depth grid</span>
</span><span id="ProcessADCP-1355"><a href="#ProcessADCP-1355"><span class="linenos">1355</span></a>            <span class="n">uvwe_inst</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1356"><a href="#ProcessADCP-1356"><span class="linenos">1356</span></a>            <span class="n">uvwe_std_inst</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1357"><a href="#ProcessADCP-1357"><span class="linenos">1357</span></a>
</span><span id="ProcessADCP-1358"><a href="#ProcessADCP-1358"><span class="linenos">1358</span></a>            <span class="n">pgi_inst</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP-1359"><a href="#ProcessADCP-1359"><span class="linenos">1359</span></a>
</span><span id="ProcessADCP-1360"><a href="#ProcessADCP-1360"><span class="linenos">1360</span></a>            <span class="k">if</span> <span class="n">pg_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1361"><a href="#ProcessADCP-1361"><span class="linenos">1361</span></a>                <span class="n">pgi_index</span> <span class="o">=</span> <span class="n">pgi_inst</span> <span class="o">&lt;</span> <span class="n">pg_condition</span>
</span><span id="ProcessADCP-1362"><a href="#ProcessADCP-1362"><span class="linenos">1362</span></a>                <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">pgi_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1363"><a href="#ProcessADCP-1363"><span class="linenos">1363</span></a>                <span class="n">uvwe_std_inst</span><span class="p">[</span><span class="n">pgi_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP-1364"><a href="#ProcessADCP-1364"><span class="linenos">1364</span></a>
</span><span id="ProcessADCP-1365"><a href="#ProcessADCP-1365"><span class="linenos">1365</span></a>            <span class="k">if</span> <span class="n">interpolate_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1366"><a href="#ProcessADCP-1366"><span class="linenos">1366</span></a>                <span class="n">zi</span> <span class="o">=</span> <span class="n">interpolate_bin</span>
</span><span id="ProcessADCP-1367"><a href="#ProcessADCP-1367"><span class="linenos">1367</span></a>                <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">zi</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zi</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="ProcessADCP-1368"><a href="#ProcessADCP-1368"><span class="linenos">1368</span></a>                <span class="n">dtmp</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span>
</span><span id="ProcessADCP-1369"><a href="#ProcessADCP-1369"><span class="linenos">1369</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="ProcessADCP-1370"><a href="#ProcessADCP-1370"><span class="linenos">1370</span></a>                    <span class="n">dtmp</span><span class="p">,</span>
</span><span id="ProcessADCP-1371"><a href="#ProcessADCP-1371"><span class="linenos">1371</span></a>                    <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">neighbors</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="ProcessADCP-1372"><a href="#ProcessADCP-1372"><span class="linenos">1372</span></a>                    <span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">],</span>
</span><span id="ProcessADCP-1373"><a href="#ProcessADCP-1373"><span class="linenos">1373</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="ProcessADCP-1374"><a href="#ProcessADCP-1374"><span class="linenos">1374</span></a>                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1375"><a href="#ProcessADCP-1375"><span class="linenos">1375</span></a>                <span class="p">)</span>
</span><span id="ProcessADCP-1376"><a href="#ProcessADCP-1376"><span class="linenos">1376</span></a>                <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="ProcessADCP-1377"><a href="#ProcessADCP-1377"><span class="linenos">1377</span></a>
</span><span id="ProcessADCP-1378"><a href="#ProcessADCP-1378"><span class="linenos">1378</span></a>            <span class="c1"># Interpolate burst-average to universal depth grid.</span>
</span><span id="ProcessADCP-1379"><a href="#ProcessADCP-1379"><span class="linenos">1379</span></a>            <span class="n">uvwe_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">uvwe_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1380"><a href="#ProcessADCP-1380"><span class="linenos">1380</span></a>            <span class="n">uvwe_std_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="ProcessADCP-1381"><a href="#ProcessADCP-1381"><span class="linenos">1381</span></a>                <span class="n">depth</span><span class="p">,</span> <span class="n">uvwe_std_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
</span><span id="ProcessADCP-1382"><a href="#ProcessADCP-1382"><span class="linenos">1382</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-1383"><a href="#ProcessADCP-1383"><span class="linenos">1383</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvwe_grid</span>
</span><span id="ProcessADCP-1384"><a href="#ProcessADCP-1384"><span class="linenos">1384</span></a>            <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvwe_std_grid</span>
</span><span id="ProcessADCP-1385"><a href="#ProcessADCP-1385"><span class="linenos">1385</span></a>
</span><span id="ProcessADCP-1386"><a href="#ProcessADCP-1386"><span class="linenos">1386</span></a>            <span class="c1"># Interpolate pg to universal depth grid. Not overly satisfying but</span>
</span><span id="ProcessADCP-1387"><a href="#ProcessADCP-1387"><span class="linenos">1387</span></a>            <span class="c1"># seems like that&#39;s what we need to do here.</span>
</span><span id="ProcessADCP-1388"><a href="#ProcessADCP-1388"><span class="linenos">1388</span></a>            <span class="n">pgi_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">pgi_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1389"><a href="#ProcessADCP-1389"><span class="linenos">1389</span></a>            <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi_grid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP-1390"><a href="#ProcessADCP-1390"><span class="linenos">1390</span></a>
</span><span id="ProcessADCP-1391"><a href="#ProcessADCP-1391"><span class="linenos">1391</span></a>            <span class="c1"># Not changed to averaging in instrument-relative coordinates first.</span>
</span><span id="ProcessADCP-1392"><a href="#ProcessADCP-1392"><span class="linenos">1392</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1393"><a href="#ProcessADCP-1393"><span class="linenos">1393</span></a>
</span><span id="ProcessADCP-1394"><a href="#ProcessADCP-1394"><span class="linenos">1394</span></a>            <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP-1395"><a href="#ProcessADCP-1395"><span class="linenos">1395</span></a>            <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="ProcessADCP-1396"><a href="#ProcessADCP-1396"><span class="linenos">1396</span></a>            <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="ProcessADCP-1397"><a href="#ProcessADCP-1397"><span class="linenos">1397</span></a>            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP-1398"><a href="#ProcessADCP-1398"><span class="linenos">1398</span></a>
</span><span id="ProcessADCP-1399"><a href="#ProcessADCP-1399"><span class="linenos">1399</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="ProcessADCP-1400"><a href="#ProcessADCP-1400"><span class="linenos">1400</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP-1401"><a href="#ProcessADCP-1401"><span class="linenos">1401</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP-1402"><a href="#ProcessADCP-1402"><span class="linenos">1402</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP-1403"><a href="#ProcessADCP-1403"><span class="linenos">1403</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP-1404"><a href="#ProcessADCP-1404"><span class="linenos">1404</span></a>            <span class="n">u_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP-1405"><a href="#ProcessADCP-1405"><span class="linenos">1405</span></a>            <span class="n">v_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP-1406"><a href="#ProcessADCP-1406"><span class="linenos">1406</span></a>            <span class="n">w_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP-1407"><a href="#ProcessADCP-1407"><span class="linenos">1407</span></a>            <span class="n">e_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP-1408"><a href="#ProcessADCP-1408"><span class="linenos">1408</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="ProcessADCP-1409"><a href="#ProcessADCP-1409"><span class="linenos">1409</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="ProcessADCP-1410"><a href="#ProcessADCP-1410"><span class="linenos">1410</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="ProcessADCP-1411"><a href="#ProcessADCP-1411"><span class="linenos">1411</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="ProcessADCP-1412"><a href="#ProcessADCP-1412"><span class="linenos">1412</span></a>            <span class="n">pressure_std</span><span class="o">=</span><span class="n">pressure_std</span><span class="p">,</span>
</span><span id="ProcessADCP-1413"><a href="#ProcessADCP-1413"><span class="linenos">1413</span></a>            <span class="n">pressure_max</span><span class="o">=</span><span class="n">pressure_max</span><span class="p">,</span>
</span><span id="ProcessADCP-1414"><a href="#ProcessADCP-1414"><span class="linenos">1414</span></a>            <span class="n">npings</span><span class="o">=</span><span class="n">npings</span><span class="p">,</span>
</span><span id="ProcessADCP-1415"><a href="#ProcessADCP-1415"><span class="linenos">1415</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP-1416"><a href="#ProcessADCP-1416"><span class="linenos">1416</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="ProcessADCP-1417"><a href="#ProcessADCP-1417"><span class="linenos">1417</span></a>            <span class="n">dep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="ProcessADCP-1418"><a href="#ProcessADCP-1418"><span class="linenos">1418</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1419"><a href="#ProcessADCP-1419"><span class="linenos">1419</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1420"><a href="#ProcessADCP-1420"><span class="linenos">1420</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP-1421"><a href="#ProcessADCP-1421"><span class="linenos">1421</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP-1422"><a href="#ProcessADCP-1422"><span class="linenos">1422</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP-1423"><a href="#ProcessADCP-1423"><span class="linenos">1423</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP-1424"><a href="#ProcessADCP-1424"><span class="linenos">1424</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1425"><a href="#ProcessADCP-1425"><span class="linenos">1425</span></a>
</span><span id="ProcessADCP-1426"><a href="#ProcessADCP-1426"><span class="linenos">1426</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="ProcessADCP-1427"><a href="#ProcessADCP-1427"><span class="linenos">1427</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="ProcessADCP-1428"><a href="#ProcessADCP-1428"><span class="linenos">1428</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span><span id="ProcessADCP-1429"><a href="#ProcessADCP-1429"><span class="linenos">1429</span></a>
</span><span id="ProcessADCP-1430"><a href="#ProcessADCP-1430"><span class="linenos">1430</span></a>    <span class="k">def</span> <span class="nf">_safely_add_attribute_from_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="ProcessADCP-1431"><a href="#ProcessADCP-1431"><span class="linenos">1431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add attribute from dictionary and throw an exception if the key is missing.</span>
</span><span id="ProcessADCP-1432"><a href="#ProcessADCP-1432"><span class="linenos">1432</span></a>
</span><span id="ProcessADCP-1433"><a href="#ProcessADCP-1433"><span class="linenos">1433</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-1434"><a href="#ProcessADCP-1434"><span class="linenos">1434</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-1435"><a href="#ProcessADCP-1435"><span class="linenos">1435</span></a><span class="sd">        key : str</span>
</span><span id="ProcessADCP-1436"><a href="#ProcessADCP-1436"><span class="linenos">1436</span></a><span class="sd">        d : dict</span>
</span><span id="ProcessADCP-1437"><a href="#ProcessADCP-1437"><span class="linenos">1437</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1438"><a href="#ProcessADCP-1438"><span class="linenos">1438</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ProcessADCP-1439"><a href="#ProcessADCP-1439"><span class="linenos">1439</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="ProcessADCP-1440"><a href="#ProcessADCP-1440"><span class="linenos">1440</span></a>        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
</span><span id="ProcessADCP-1441"><a href="#ProcessADCP-1441"><span class="linenos">1441</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2"> is missing in input parameters&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1442"><a href="#ProcessADCP-1442"><span class="linenos">1442</span></a>            <span class="k">raise</span>
</span><span id="ProcessADCP-1443"><a href="#ProcessADCP-1443"><span class="linenos">1443</span></a>
</span><span id="ProcessADCP-1444"><a href="#ProcessADCP-1444"><span class="linenos">1444</span></a>    <span class="k">def</span> <span class="nf">_set_up_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-1445"><a href="#ProcessADCP-1445"><span class="linenos">1445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up logging to both a file and to screen.</span>
</span><span id="ProcessADCP-1446"><a href="#ProcessADCP-1446"><span class="linenos">1446</span></a>
</span><span id="ProcessADCP-1447"><a href="#ProcessADCP-1447"><span class="linenos">1447</span></a><span class="sd">        Default for screen logging is to show only warnings unless `verbose` is</span>
</span><span id="ProcessADCP-1448"><a href="#ProcessADCP-1448"><span class="linenos">1448</span></a><span class="sd">        set to True.</span>
</span><span id="ProcessADCP-1449"><a href="#ProcessADCP-1449"><span class="linenos">1449</span></a>
</span><span id="ProcessADCP-1450"><a href="#ProcessADCP-1450"><span class="linenos">1450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1451"><a href="#ProcessADCP-1451"><span class="linenos">1451</span></a>
</span><span id="ProcessADCP-1452"><a href="#ProcessADCP-1452"><span class="linenos">1452</span></a>        <span class="c1"># Parse metadata for naming the log.</span>
</span><span id="ProcessADCP-1453"><a href="#ProcessADCP-1453"><span class="linenos">1453</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1454"><a href="#ProcessADCP-1454"><span class="linenos">1454</span></a>            <span class="k">if</span> <span class="s2">&quot;sn&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="ow">and</span> <span class="s2">&quot;mooring&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
</span><span id="ProcessADCP-1455"><a href="#ProcessADCP-1455"><span class="linenos">1455</span></a>                <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;sn&quot;</span><span class="p">]</span>
</span><span id="ProcessADCP-1456"><a href="#ProcessADCP-1456"><span class="linenos">1456</span></a>                <span class="n">mooring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="s2">&quot;mooring&quot;</span><span class="p">]</span>
</span><span id="ProcessADCP-1457"><a href="#ProcessADCP-1457"><span class="linenos">1457</span></a>                <span class="n">has_mooring_id</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ProcessADCP-1458"><a href="#ProcessADCP-1458"><span class="linenos">1458</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1459"><a href="#ProcessADCP-1459"><span class="linenos">1459</span></a>                <span class="n">sn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP-1460"><a href="#ProcessADCP-1460"><span class="linenos">1460</span></a>                <span class="n">mooring</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP-1461"><a href="#ProcessADCP-1461"><span class="linenos">1461</span></a>                <span class="n">has_mooring_id</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ProcessADCP-1462"><a href="#ProcessADCP-1462"><span class="linenos">1462</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1463"><a href="#ProcessADCP-1463"><span class="linenos">1463</span></a>            <span class="n">has_mooring_id</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ProcessADCP-1464"><a href="#ProcessADCP-1464"><span class="linenos">1464</span></a>
</span><span id="ProcessADCP-1465"><a href="#ProcessADCP-1465"><span class="linenos">1465</span></a>        <span class="c1"># Set up a logger that will collect log info from this module and the</span>
</span><span id="ProcessADCP-1466"><a href="#ProcessADCP-1466"><span class="linenos">1466</span></a>        <span class="c1"># other pycurrent methods as well.</span>
</span><span id="ProcessADCP-1467"><a href="#ProcessADCP-1467"><span class="linenos">1467</span></a>        <span class="n">logdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logdir</span><span class="p">)</span>
</span><span id="ProcessADCP-1468"><a href="#ProcessADCP-1468"><span class="linenos">1468</span></a>        <span class="n">logdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP-1469"><a href="#ProcessADCP-1469"><span class="linenos">1469</span></a>        <span class="k">if</span> <span class="n">has_mooring_id</span><span class="p">:</span>
</span><span id="ProcessADCP-1470"><a href="#ProcessADCP-1470"><span class="linenos">1470</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mooring</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2">.log&quot;</span>
</span><span id="ProcessADCP-1471"><a href="#ProcessADCP-1471"><span class="linenos">1471</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1472"><a href="#ProcessADCP-1472"><span class="linenos">1472</span></a>            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;adcp_proc.log&quot;</span>
</span><span id="ProcessADCP-1473"><a href="#ProcessADCP-1473"><span class="linenos">1473</span></a>        <span class="c1"># Delete any existing handlers. This may be bad style, but I kept adding handlers when developing this.</span>
</span><span id="ProcessADCP-1474"><a href="#ProcessADCP-1474"><span class="linenos">1474</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ProcessADCP-1475"><a href="#ProcessADCP-1475"><span class="linenos">1475</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span id="ProcessADCP-1476"><a href="#ProcessADCP-1476"><span class="linenos">1476</span></a>            <span class="n">filename</span><span class="o">=</span><span class="n">logdir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
</span><span id="ProcessADCP-1477"><a href="#ProcessADCP-1477"><span class="linenos">1477</span></a>            <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1478"><a href="#ProcessADCP-1478"><span class="linenos">1478</span></a>            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(name)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1479"><a href="#ProcessADCP-1479"><span class="linenos">1479</span></a>            <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1480"><a href="#ProcessADCP-1480"><span class="linenos">1480</span></a>            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span id="ProcessADCP-1481"><a href="#ProcessADCP-1481"><span class="linenos">1481</span></a>            <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP-1482"><a href="#ProcessADCP-1482"><span class="linenos">1482</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1483"><a href="#ProcessADCP-1483"><span class="linenos">1483</span></a>        <span class="n">ConsoleOutputHandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span id="ProcessADCP-1484"><a href="#ProcessADCP-1484"><span class="linenos">1484</span></a>        <span class="n">ConsoleOutputHandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span><span id="ProcessADCP-1485"><a href="#ProcessADCP-1485"><span class="linenos">1485</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="ProcessADCP-1486"><a href="#ProcessADCP-1486"><span class="linenos">1486</span></a>            <span class="n">ConsoleOutputHandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="ProcessADCP-1487"><a href="#ProcessADCP-1487"><span class="linenos">1487</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ConsoleOutputHandler</span><span class="p">)</span>
</span><span id="ProcessADCP-1488"><a href="#ProcessADCP-1488"><span class="linenos">1488</span></a>
</span><span id="ProcessADCP-1489"><a href="#ProcessADCP-1489"><span class="linenos">1489</span></a>        <span class="c1"># current date</span>
</span><span id="ProcessADCP-1490"><a href="#ProcessADCP-1490"><span class="linenos">1490</span></a>        <span class="n">datestr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
</span><span id="ProcessADCP-1491"><a href="#ProcessADCP-1491"><span class="linenos">1491</span></a>        <span class="n">strformat</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span id="ProcessADCP-1492"><a href="#ProcessADCP-1492"><span class="linenos">1492</span></a>        <span class="n">datestr</span> <span class="o">=</span> <span class="n">datestr</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">strformat</span><span class="p">)</span>
</span><span id="ProcessADCP-1493"><a href="#ProcessADCP-1493"><span class="linenos">1493</span></a>
</span><span id="ProcessADCP-1494"><a href="#ProcessADCP-1494"><span class="linenos">1494</span></a>        <span class="k">if</span> <span class="n">has_mooring_id</span><span class="p">:</span>
</span><span id="ProcessADCP-1495"><a href="#ProcessADCP-1495"><span class="linenos">1495</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">mooring</span><span class="si">}</span><span class="s2"> SN </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">datestr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1496"><a href="#ProcessADCP-1496"><span class="linenos">1496</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1497"><a href="#ProcessADCP-1497"><span class="linenos">1497</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP-1498"><a href="#ProcessADCP-1498"><span class="linenos">1498</span></a>                <span class="s2">&quot;No meta data provided, logging to generic filename &#39;adcp_proc.log&#39;&quot;</span>
</span><span id="ProcessADCP-1499"><a href="#ProcessADCP-1499"><span class="linenos">1499</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP-1500"><a href="#ProcessADCP-1500"><span class="linenos">1500</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing on </span><span class="si">{</span><span class="n">datestr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1501"><a href="#ProcessADCP-1501"><span class="linenos">1501</span></a>
</span><span id="ProcessADCP-1502"><a href="#ProcessADCP-1502"><span class="linenos">1502</span></a>    <span class="k">def</span> <span class="nf">_log_processing_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-1503"><a href="#ProcessADCP-1503"><span class="linenos">1503</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write processing parameters to log file.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1504"><a href="#ProcessADCP-1504"><span class="linenos">1504</span></a>
</span><span id="ProcessADCP-1505"><a href="#ProcessADCP-1505"><span class="linenos">1505</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;processing settings&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1506"><a href="#ProcessADCP-1506"><span class="linenos">1506</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1507"><a href="#ProcessADCP-1507"><span class="linenos">1507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP-1508"><a href="#ProcessADCP-1508"><span class="linenos">1508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP-1509"><a href="#ProcessADCP-1509"><span class="linenos">1509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">)</span>
</span><span id="ProcessADCP-1510"><a href="#ProcessADCP-1510"><span class="linenos">1510</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1511"><a href="#ProcessADCP-1511"><span class="linenos">1511</span></a>
</span><span id="ProcessADCP-1512"><a href="#ProcessADCP-1512"><span class="linenos">1512</span></a>    <span class="k">def</span> <span class="nf">_log_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pd</span><span class="p">):</span>
</span><span id="ProcessADCP-1513"><a href="#ProcessADCP-1513"><span class="linenos">1513</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Print ADCP processing parameter dict to logs.</span>
</span><span id="ProcessADCP-1514"><a href="#ProcessADCP-1514"><span class="linenos">1514</span></a>
</span><span id="ProcessADCP-1515"><a href="#ProcessADCP-1515"><span class="linenos">1515</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-1516"><a href="#ProcessADCP-1516"><span class="linenos">1516</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-1517"><a href="#ProcessADCP-1517"><span class="linenos">1517</span></a><span class="sd">        pd : dict</span>
</span><span id="ProcessADCP-1518"><a href="#ProcessADCP-1518"><span class="linenos">1518</span></a><span class="sd">            Parameter dict.</span>
</span><span id="ProcessADCP-1519"><a href="#ProcessADCP-1519"><span class="linenos">1519</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1520"><a href="#ProcessADCP-1520"><span class="linenos">1520</span></a>
</span><span id="ProcessADCP-1521"><a href="#ProcessADCP-1521"><span class="linenos">1521</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ProcessADCP-1522"><a href="#ProcessADCP-1522"><span class="linenos">1522</span></a>            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;maskbins&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1523"><a href="#ProcessADCP-1523"><span class="linenos">1523</span></a>                <span class="n">logstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span><span id="ProcessADCP-1524"><a href="#ProcessADCP-1524"><span class="linenos">1524</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">logstr</span><span class="p">)</span>
</span><span id="ProcessADCP-1525"><a href="#ProcessADCP-1525"><span class="linenos">1525</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP-1526"><a href="#ProcessADCP-1526"><span class="linenos">1526</span></a>                <span class="n">logstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="ProcessADCP-1527"><a href="#ProcessADCP-1527"><span class="linenos">1527</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">logstr</span><span class="p">)</span>
</span><span id="ProcessADCP-1528"><a href="#ProcessADCP-1528"><span class="linenos">1528</span></a>
</span><span id="ProcessADCP-1529"><a href="#ProcessADCP-1529"><span class="linenos">1529</span></a>    <span class="k">def</span> <span class="nf">_ave2nc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-1530"><a href="#ProcessADCP-1530"><span class="linenos">1530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert data structure from ave to xarray.Dataset format.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1531"><a href="#ProcessADCP-1531"><span class="linenos">1531</span></a>        <span class="c1"># load npz file</span>
</span><span id="ProcessADCP-1532"><a href="#ProcessADCP-1532"><span class="linenos">1532</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ave</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="ProcessADCP-1533"><a href="#ProcessADCP-1533"><span class="linenos">1533</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP-1534"><a href="#ProcessADCP-1534"><span class="linenos">1534</span></a>        <span class="c1"># identify variables</span>
</span><span id="ProcessADCP-1535"><a href="#ProcessADCP-1535"><span class="linenos">1535</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="ProcessADCP-1536"><a href="#ProcessADCP-1536"><span class="linenos">1536</span></a>        <span class="n">varsint</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ProcessADCP-1537"><a href="#ProcessADCP-1537"><span class="linenos">1537</span></a>        <span class="n">vars1d</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ProcessADCP-1538"><a href="#ProcessADCP-1538"><span class="linenos">1538</span></a>        <span class="n">vars2d</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ProcessADCP-1539"><a href="#ProcessADCP-1539"><span class="linenos">1539</span></a>        <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
</span><span id="ProcessADCP-1540"><a href="#ProcessADCP-1540"><span class="linenos">1540</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="ProcessADCP-1541"><a href="#ProcessADCP-1541"><span class="linenos">1541</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ProcessADCP-1542"><a href="#ProcessADCP-1542"><span class="linenos">1542</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ProcessADCP-1543"><a href="#ProcessADCP-1543"><span class="linenos">1543</span></a>                    <span class="n">vars1d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>
</span><span id="ProcessADCP-1544"><a href="#ProcessADCP-1544"><span class="linenos">1544</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ProcessADCP-1545"><a href="#ProcessADCP-1545"><span class="linenos">1545</span></a>                    <span class="n">vars2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>
</span><span id="ProcessADCP-1546"><a href="#ProcessADCP-1546"><span class="linenos">1546</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="ProcessADCP-1547"><a href="#ProcessADCP-1547"><span class="linenos">1547</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP-1548"><a href="#ProcessADCP-1548"><span class="linenos">1548</span></a>                <span class="n">varsint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span>
</span><span id="ProcessADCP-1549"><a href="#ProcessADCP-1549"><span class="linenos">1549</span></a>            <span class="c1"># print(ki, tmp)</span>
</span><span id="ProcessADCP-1550"><a href="#ProcessADCP-1550"><span class="linenos">1550</span></a>
</span><span id="ProcessADCP-1551"><a href="#ProcessADCP-1551"><span class="linenos">1551</span></a>        <span class="c1"># generate time vector</span>
</span><span id="ProcessADCP-1552"><a href="#ProcessADCP-1552"><span class="linenos">1552</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP-1553"><a href="#ProcessADCP-1553"><span class="linenos">1553</span></a>        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">ti</span><span class="p">)</span> <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span><span class="p">]</span>
</span><span id="ProcessADCP-1554"><a href="#ProcessADCP-1554"><span class="linenos">1554</span></a>        <span class="n">adcptime</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">time</span><span class="p">]</span>
</span><span id="ProcessADCP-1555"><a href="#ProcessADCP-1555"><span class="linenos">1555</span></a>        <span class="c1"># generate Dataset</span>
</span><span id="ProcessADCP-1556"><a href="#ProcessADCP-1556"><span class="linenos">1556</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
</span><span id="ProcessADCP-1557"><a href="#ProcessADCP-1557"><span class="linenos">1557</span></a>            <span class="p">{</span><span class="s2">&quot;pg&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">T</span><span class="p">)},</span>
</span><span id="ProcessADCP-1558"><a href="#ProcessADCP-1558"><span class="linenos">1558</span></a>            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">adcptime</span><span class="p">),</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="o">.</span><span class="n">dep</span><span class="p">)},</span>
</span><span id="ProcessADCP-1559"><a href="#ProcessADCP-1559"><span class="linenos">1559</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1560"><a href="#ProcessADCP-1560"><span class="linenos">1560</span></a>        <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="n">vars2d</span><span class="p">:</span>
</span><span id="ProcessADCP-1561"><a href="#ProcessADCP-1561"><span class="linenos">1561</span></a>            <span class="n">out</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="ProcessADCP-1562"><a href="#ProcessADCP-1562"><span class="linenos">1562</span></a>        <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="n">vars1d</span><span class="p">:</span>
</span><span id="ProcessADCP-1563"><a href="#ProcessADCP-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="n">vari</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dep&quot;</span><span class="p">,</span> <span class="s2">&quot;dday&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP-1564"><a href="#ProcessADCP-1564"><span class="linenos">1564</span></a>                <span class="n">out</span><span class="p">[</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">dat</span><span class="p">[</span><span class="n">vari</span><span class="p">])</span>
</span><span id="ProcessADCP-1565"><a href="#ProcessADCP-1565"><span class="linenos">1565</span></a>
</span><span id="ProcessADCP-1566"><a href="#ProcessADCP-1566"><span class="linenos">1566</span></a>        <span class="c1"># Percent good is currently defined everywhere. Set to NaN where we</span>
</span><span id="ProcessADCP-1567"><a href="#ProcessADCP-1567"><span class="linenos">1567</span></a>        <span class="c1"># don&#39;t have any amplitude data (i.e. no data).</span>
</span><span id="ProcessADCP-1568"><a href="#ProcessADCP-1568"><span class="linenos">1568</span></a>        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;pg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">pg</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">amp</span><span class="p">),</span> <span class="n">other</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</span><span id="ProcessADCP-1569"><a href="#ProcessADCP-1569"><span class="linenos">1569</span></a>
</span><span id="ProcessADCP-1570"><a href="#ProcessADCP-1570"><span class="linenos">1570</span></a>        <span class="c1"># Drop depth levels with all nan</span>
</span><span id="ProcessADCP-1571"><a href="#ProcessADCP-1571"><span class="linenos">1571</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;depth&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1572"><a href="#ProcessADCP-1572"><span class="linenos">1572</span></a>
</span><span id="ProcessADCP-1573"><a href="#ProcessADCP-1573"><span class="linenos">1573</span></a>        <span class="c1"># Drop pressure_std, pressure_max, and e_std</span>
</span><span id="ProcessADCP-1574"><a href="#ProcessADCP-1574"><span class="linenos">1574</span></a>        <span class="n">dropvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pressure_std&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure_max&quot;</span><span class="p">,</span> <span class="s2">&quot;e_std&quot;</span><span class="p">]</span>
</span><span id="ProcessADCP-1575"><a href="#ProcessADCP-1575"><span class="linenos">1575</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dropvars</span><span class="p">:</span>
</span><span id="ProcessADCP-1576"><a href="#ProcessADCP-1576"><span class="linenos">1576</span></a>            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
</span><span id="ProcessADCP-1577"><a href="#ProcessADCP-1577"><span class="linenos">1577</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</span><span id="ProcessADCP-1578"><a href="#ProcessADCP-1578"><span class="linenos">1578</span></a>
</span><span id="ProcessADCP-1579"><a href="#ProcessADCP-1579"><span class="linenos">1579</span></a>        <span class="c1"># Change u/v/w std to standard error by dividing by sqrt(npings)</span>
</span><span id="ProcessADCP-1580"><a href="#ProcessADCP-1580"><span class="linenos">1580</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP-1581"><a href="#ProcessADCP-1581"><span class="linenos">1581</span></a>            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_std&quot;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
</span><span id="ProcessADCP-1582"><a href="#ProcessADCP-1582"><span class="linenos">1582</span></a>                <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_std&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">})</span>
</span><span id="ProcessADCP-1583"><a href="#ProcessADCP-1583"><span class="linenos">1583</span></a>                <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_error&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;npings&quot;</span><span class="p">])</span>
</span><span id="ProcessADCP-1584"><a href="#ProcessADCP-1584"><span class="linenos">1584</span></a>
</span><span id="ProcessADCP-1585"><a href="#ProcessADCP-1585"><span class="linenos">1585</span></a>        <span class="c1"># Calculate transducer depth from pressure</span>
</span><span id="ProcessADCP-1586"><a href="#ProcessADCP-1586"><span class="linenos">1586</span></a>        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;xducer_depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">gsw</span><span class="o">.</span><span class="n">z_from_p</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP-1587"><a href="#ProcessADCP-1587"><span class="linenos">1587</span></a>
</span><span id="ProcessADCP-1588"><a href="#ProcessADCP-1588"><span class="linenos">1588</span></a>        <span class="c1"># add variable names and units for plotting</span>
</span><span id="ProcessADCP-1589"><a href="#ProcessADCP-1589"><span class="linenos">1589</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_names_and_units</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="ProcessADCP-1590"><a href="#ProcessADCP-1590"><span class="linenos">1590</span></a>
</span><span id="ProcessADCP-1591"><a href="#ProcessADCP-1591"><span class="linenos">1591</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">out</span>
</span><span id="ProcessADCP-1592"><a href="#ProcessADCP-1592"><span class="linenos">1592</span></a>
</span><span id="ProcessADCP-1593"><a href="#ProcessADCP-1593"><span class="linenos">1593</span></a>    <span class="k">def</span> <span class="nf">_add_names_and_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
</span><span id="ProcessADCP-1594"><a href="#ProcessADCP-1594"><span class="linenos">1594</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add variable attributes based on CF conventions.</span>
</span><span id="ProcessADCP-1595"><a href="#ProcessADCP-1595"><span class="linenos">1595</span></a>
</span><span id="ProcessADCP-1596"><a href="#ProcessADCP-1596"><span class="linenos">1596</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP-1597"><a href="#ProcessADCP-1597"><span class="linenos">1597</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP-1598"><a href="#ProcessADCP-1598"><span class="linenos">1598</span></a><span class="sd">        ds : xarray.Dataset</span>
</span><span id="ProcessADCP-1599"><a href="#ProcessADCP-1599"><span class="linenos">1599</span></a>
</span><span id="ProcessADCP-1600"><a href="#ProcessADCP-1600"><span class="linenos">1600</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP-1601"><a href="#ProcessADCP-1601"><span class="linenos">1601</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP-1602"><a href="#ProcessADCP-1602"><span class="linenos">1602</span></a><span class="sd">        ds : xarray.Dataset</span>
</span><span id="ProcessADCP-1603"><a href="#ProcessADCP-1603"><span class="linenos">1603</span></a>
</span><span id="ProcessADCP-1604"><a href="#ProcessADCP-1604"><span class="linenos">1604</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1605"><a href="#ProcessADCP-1605"><span class="linenos">1605</span></a>        <span class="n">CF</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">cf_conventions</span><span class="p">()</span>
</span><span id="ProcessADCP-1606"><a href="#ProcessADCP-1606"><span class="linenos">1606</span></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
</span><span id="ProcessADCP-1607"><a href="#ProcessADCP-1607"><span class="linenos">1607</span></a>            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CF</span><span class="p">:</span>
</span><span id="ProcessADCP-1608"><a href="#ProcessADCP-1608"><span class="linenos">1608</span></a>                <span class="n">ds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">CF</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
</span><span id="ProcessADCP-1609"><a href="#ProcessADCP-1609"><span class="linenos">1609</span></a>        <span class="k">return</span> <span class="n">ds</span>
</span><span id="ProcessADCP-1610"><a href="#ProcessADCP-1610"><span class="linenos">1610</span></a>
</span><span id="ProcessADCP-1611"><a href="#ProcessADCP-1611"><span class="linenos">1611</span></a>    <span class="k">def</span> <span class="nf">_add_meta_data_to_ds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-1612"><a href="#ProcessADCP-1612"><span class="linenos">1612</span></a>        <span class="c1"># Add some more info.</span>
</span><span id="ProcessADCP-1613"><a href="#ProcessADCP-1613"><span class="linenos">1613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
</span><span id="ProcessADCP-1614"><a href="#ProcessADCP-1614"><span class="linenos">1614</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;magdec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magdec</span>
</span><span id="ProcessADCP-1615"><a href="#ProcessADCP-1615"><span class="linenos">1615</span></a>        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;max_e&quot;</span><span class="p">,</span> <span class="s2">&quot;max_e_deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;min_correlation&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP-1616"><a href="#ProcessADCP-1616"><span class="linenos">1616</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>
</span><span id="ProcessADCP-1617"><a href="#ProcessADCP-1617"><span class="linenos">1617</span></a>
</span><span id="ProcessADCP-1618"><a href="#ProcessADCP-1618"><span class="linenos">1618</span></a>        <span class="c1"># Add meta data if provided.</span>
</span><span id="ProcessADCP-1619"><a href="#ProcessADCP-1619"><span class="linenos">1619</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP-1620"><a href="#ProcessADCP-1620"><span class="linenos">1620</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ProcessADCP-1621"><a href="#ProcessADCP-1621"><span class="linenos">1621</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="ProcessADCP-1622"><a href="#ProcessADCP-1622"><span class="linenos">1622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;proc time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;now&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1623"><a href="#ProcessADCP-1623"><span class="linenos">1623</span></a>
</span><span id="ProcessADCP-1624"><a href="#ProcessADCP-1624"><span class="linenos">1624</span></a>    <span class="k">def</span> <span class="nf">plot_echo_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-1625"><a href="#ProcessADCP-1625"><span class="linenos">1625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot beam statistics (correlation and amplitude) from raw ADCP data.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1626"><a href="#ProcessADCP-1626"><span class="linenos">1626</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>
</span><span id="ProcessADCP-1627"><a href="#ProcessADCP-1627"><span class="linenos">1627</span></a>
</span><span id="ProcessADCP-1628"><a href="#ProcessADCP-1628"><span class="linenos">1628</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="ProcessADCP-1629"><a href="#ProcessADCP-1629"><span class="linenos">1629</span></a>            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP-1630"><a href="#ProcessADCP-1630"><span class="linenos">1630</span></a>            <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="ProcessADCP-1631"><a href="#ProcessADCP-1631"><span class="linenos">1631</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">),</span>
</span><span id="ProcessADCP-1632"><a href="#ProcessADCP-1632"><span class="linenos">1632</span></a>            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP-1633"><a href="#ProcessADCP-1633"><span class="linenos">1633</span></a>            <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP-1634"><a href="#ProcessADCP-1634"><span class="linenos">1634</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1635"><a href="#ProcessADCP-1635"><span class="linenos">1635</span></a>        <span class="n">r</span><span class="o">.</span><span class="n">cor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="ProcessADCP-1636"><a href="#ProcessADCP-1636"><span class="linenos">1636</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP-1637"><a href="#ProcessADCP-1637"><span class="linenos">1637</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1638"><a href="#ProcessADCP-1638"><span class="linenos">1638</span></a>        <span class="n">r</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="ProcessADCP-1639"><a href="#ProcessADCP-1639"><span class="linenos">1639</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1640"><a href="#ProcessADCP-1640"><span class="linenos">1640</span></a>            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1641"><a href="#ProcessADCP-1641"><span class="linenos">1641</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1642"><a href="#ProcessADCP-1642"><span class="linenos">1642</span></a>            <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="ProcessADCP-1643"><a href="#ProcessADCP-1643"><span class="linenos">1643</span></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP-1644"><a href="#ProcessADCP-1644"><span class="linenos">1644</span></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP-1645"><a href="#ProcessADCP-1645"><span class="linenos">1645</span></a>            <span class="n">add_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP-1646"><a href="#ProcessADCP-1646"><span class="linenos">1646</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1647"><a href="#ProcessADCP-1647"><span class="linenos">1647</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</span><span id="ProcessADCP-1648"><a href="#ProcessADCP-1648"><span class="linenos">1648</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1649"><a href="#ProcessADCP-1649"><span class="linenos">1649</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="ProcessADCP-1650"><a href="#ProcessADCP-1650"><span class="linenos">1650</span></a>        <span class="k">for</span> <span class="n">axi</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
</span><span id="ProcessADCP-1651"><a href="#ProcessADCP-1651"><span class="linenos">1651</span></a>            <span class="n">axi</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP-1652"><a href="#ProcessADCP-1652"><span class="linenos">1652</span></a>
</span><span id="ProcessADCP-1653"><a href="#ProcessADCP-1653"><span class="linenos">1653</span></a>    <span class="k">def</span> <span class="nf">plot_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP-1654"><a href="#ProcessADCP-1654"><span class="linenos">1654</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot pressure time series and mark time at depth.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP-1655"><a href="#ProcessADCP-1655"><span class="linenos">1655</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="ProcessADCP-1656"><a href="#ProcessADCP-1656"><span class="linenos">1656</span></a>            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP-1657"><a href="#ProcessADCP-1657"><span class="linenos">1657</span></a>            <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP-1658"><a href="#ProcessADCP-1658"><span class="linenos">1658</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
</span><span id="ProcessADCP-1659"><a href="#ProcessADCP-1659"><span class="linenos">1659</span></a>            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP-1660"><a href="#ProcessADCP-1660"><span class="linenos">1660</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP-1661"><a href="#ProcessADCP-1661"><span class="linenos">1661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1662"><a href="#ProcessADCP-1662"><span class="linenos">1662</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;subsurface&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1663"><a href="#ProcessADCP-1663"><span class="linenos">1663</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</span><span id="ProcessADCP-1664"><a href="#ProcessADCP-1664"><span class="linenos">1664</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;pressure [dbar]&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP-1665"><a href="#ProcessADCP-1665"><span class="linenos">1665</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="ProcessADCP-1666"><a href="#ProcessADCP-1666"><span class="linenos">1666</span></a>
</span><span id="ProcessADCP-1667"><a href="#ProcessADCP-1667"><span class="linenos">1667</span></a>    <span class="k">def</span> <span class="nf">generate_binmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="ProcessADCP-1668"><a href="#ProcessADCP-1668"><span class="linenos">1668</span></a>        <span class="n">binmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="ProcessADCP-1669"><a href="#ProcessADCP-1669"><span class="linenos">1669</span></a>        <span class="n">binmask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ProcessADCP-1670"><a href="#ProcessADCP-1670"><span class="linenos">1670</span></a>        <span class="k">return</span> <span class="n">binmask</span>
</span></pre></div>


            <div class="docstring"><p>Moored ADCP Processing.</p>

<p>An instance of ProcessADCP is initialized by providing raw data and
processing parameters. Once initialized, the instance method
<code><a href="#ProcessADCP.average_ensembles">average_ensembles()</a></code> can be used to average over just a few or
all pings.</p>

<p>Magnetic declination is automatically calculated via a call to the command
line tool
<a href="https://currents.soest.hawaii.edu/hgstage/geomag/file/tip">magdec</a> that
must be installed. Once calculated, the magnetic declination is stored in
<code><a href="#ProcessADCP.magdec">magdec</a></code> and automatically applied to the data.</p>

<p>Prior to time averaging, data are edited based on correlation and error
velocity thresholds. The variable <code>pg</code> is calculated based on the number of
excluded pings, i.e. it is the numbur of good pings divided by the number
of total pings within one depth bin and one time bin. It may be used to
further filter the data.</p>

<p>A pdf document on ADCP data collection and processing principles can be
downloaded from RDI
<a href="https://www.comm-tec.com/Docs/Manuali/RDI/BBPRIME.pdf">here</a>.</p>

<p>Time-averaged data are grouped together in an <code>xarray.Dataset</code> in the
instance attribute <code>ds</code> for easy access and convenient output to netcdf
format.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>raw_data</strong> (str or list or Path):
Location(s) of raw data.</li>
<li><strong>meta_data</strong> (dict):
Dictionary with meta data. At a minimum entries for <code>lon</code> and <code>lat</code> are
needed. If <code>mooring</code> and <code>sn</code> provide mooring name and serial number
then these will be used to name the log file produced during
processing.</li>
<li><strong>driftparams</strong> (dict, optional):
Time drift parameters. See notes below.</li>
<li><strong>tgridparams</strong> (dict, optional):
Time gridding parameters. See notes below.</li>
<li><strong>dgridparams</strong> (dict, optional):
Depth gridding parameters. See notes below.</li>
<li><strong>editparams</strong> (dict, optional):
Editing parameters. See notes below.</li>
<li><strong>ibad</strong> (int, optional):
Mark beam with bad data (zero based). Defaults to None.</li>
<li><strong>logdir</strong> (str, optional):
Log file directory. Defaults to <code>log/</code>.</li>
<li><strong>verbose</strong> (bool, optional):
Output more processing info to screen.</li>
<li><strong>magdec</strong> (float, optional):
Magnetic declination in degrees.</li>
<li><strong>pressure</strong> (xr.DataArray, optional):
Supply external pressure time series in dbar as xr.DataAarray with
coordinate <code>time</code>.</li>
<li><strong>use_raw_pressure</strong> (bool, optional):
Pressure time series is low-pass filtered at 30 minutes or 50 ping
cutoff period, whatever is shorter. Set this to True to use raw
pressure. Defaults to False. Does not matter for burst-averaging
(pressure is averaged over full burst) or when supplying external
pressure time series.</li>
<li><strong>pressure_scale_factor</strong> (float, optional):
Can be used to scale a (likely broken) pressure time series. Defaults
to 1 (no scaling).</li>
</ul>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>files</strong> (list):
List pointing to raw data file(s).</li>
<li><strong>dday_start</strong> (float):
Start time of ADCP time series, determined either through <code>t0</code> in
<code>tgridparams</code> or the start of the time series once at depth.</li>
<li><strong>dday_end</strong> (float):
End time of ADCP time series, determined either through <code>t1</code> in
<code>tgridparams</code> or the end of the time series at depth.</li>
<li><strong>start_ddays</strong> (list):
Start times of averaging intervals</li>
<li><strong>dday_mid</strong> (float):
Time stamp for ping average as determined in <code><a href="#ProcessADCP.make_start_ddays">make_start_ddays()</a></code>.</li>
<li><strong>dt</strong> (float):
Time that is inclusive of one average. For regular averaging, this is
<code>dt_hours</code> in <code>tgridparams</code> converted to Julian days. For
burst-averagint, this is a time interval that is inclusive of all pings
in one bursts (but goes slightly beyond that into the time between
bursts).</li>
<li><strong>time_drift_rate</strong> (float):
Clock drift calculated from <code>driftparams</code>.</li>
<li><strong>orientation</strong> (str):
Instrument orientation <code>up</code> or <code>down</code>.</li>
<li><strong>magdec</strong> (float):
Magnetic declination.</li>
<li><strong>m</strong> (pycurrents.adcp.rdiraw.Multiread):
Multiread instance.</li>
<li><strong>tsdat</strong> (Bunch):
Auxiliary data.</li>
<li><strong>raw</strong> (xarray.Dataset):
Raw ADCP data.</li>
<li><strong>ds</strong> (xarray.Dataset):
Time-averaged dataset added by running <code><a href="#ProcessADCP.average_ensembles">average_ensembles()</a></code>.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>Various parameters are passed to the instance through dictionaries. Their
specifics are described below. Gridding and editing parameters can be
updated after creating the ProcessADCP instance via <code><a href="#ProcessADCP.parse_dgridparams">parse_dgridparams</a></code>,
<code><a href="#ProcessADCP.parse_tgridparams">parse_tgridparams</a></code>, and  <code><a href="#ProcessADCP.parse_editparams">parse_editparams</a></code>.</p>

<p><strong>Time drift parameters</strong>
Provide clock drift parameters via <code>driftparams</code>. Accepted entries are</p>

<ul>
<li><code>end_adcp</code> : Time of ADCP at data download</li>
<li><code>end_pc</code> : UTC time at data download</li>
</ul>

<p>The difference between <code>end_adcp</code> and <code>end_pc</code> is used to linearly correct
for instrument clock drift.</p>

<p><strong>Time gridding parameters</strong>
Provide time gridding parameters via <code>tgridparams</code>. Accepted entries are</p>

<ul>
<li><code>dt_hours</code> : Time grid interval. Defaults to 0.5h.</li>
<li><code>t0</code> : Start time for gridding. Determined from data if not provided.</li>
<li><code>t1</code> : End time for gridding. Determined from data if not provided.</li>
<li>burst_average : bool
Set ensemble averaging to act on burst sampling scheme. Defaults to False.</li>
</ul>

<p><strong>Depth gridding parameters</strong>
Provide depth gridding parameters via <code>dgridparams</code>. Accepted entries are</p>

<ul>
<li><code>dtop</code> : Shallow depth in m.</li>
<li><code>dbot</code> : Deep depth in m.</li>
<li><code>dinterval</code> : Vertical grid size in m. Defaults to 5m.</li>
</ul>

<p>Values for <code>dbot</code> and <code>dtop</code> are generated if not provided.</p>

<p><strong>Editing parameters</strong>
Provide editing parameters via <code>editparams</code>.</p>

<ul>
<li><code>max_e</code>=0.2,  # absolute max e</li>
<li><code>max_e_deviation</code>=2,  # max in terms of sigma</li>
<li><code>min_correlation</code>=64,  # 64 is RDI default</li>
<li><code>maskbins</code> : Array with booleans indexing into the ADCP bins. Use the
convenience method <code><a href="#ProcessADCP.generate_binmask">generate_binmask</a></code>.</li>
<li><code>pg_limit</code> : float or int or None.
Percent good limit applied prior to interpolating to the universal
depth grid in <code><a href="#ProcessADCP.burst_average_ensembles">burst_average_ensembles</a></code>. Not applied in
<code><a href="#ProcessADCP.average_ensembles">average_ensembles</a></code> as the user can filter based on pg later.</li>
</ul>
</div>


                            <div id="ProcessADCP.__init__" class="classattr">
                                        <input id="ProcessADCP.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ProcessADCP</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">raw_data</span>,</span><span class="param">	<span class="n">meta_data</span>,</span><span class="param">	<span class="n">driftparams</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">tgridparams</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">dgridparams</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">editparams</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ibad</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">logdir</span><span class="o">=</span><span class="s1">&#39;log&#39;</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">magdec</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">pressure</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">use_raw_pressure</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">pressure_scale_factor</span><span class="o">=</span><span class="mi">1</span></span>)</span>

                <label class="view-source-button" for="ProcessADCP.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.__init__-221"><a href="#ProcessADCP.__init__-221"><span class="linenos">221</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ProcessADCP.__init__-222"><a href="#ProcessADCP.__init__-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-223"><a href="#ProcessADCP.__init__-223"><span class="linenos">223</span></a>        <span class="n">raw_data</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-224"><a href="#ProcessADCP.__init__-224"><span class="linenos">224</span></a>        <span class="n">meta_data</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-225"><a href="#ProcessADCP.__init__-225"><span class="linenos">225</span></a>        <span class="n">driftparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-226"><a href="#ProcessADCP.__init__-226"><span class="linenos">226</span></a>        <span class="n">tgridparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-227"><a href="#ProcessADCP.__init__-227"><span class="linenos">227</span></a>        <span class="n">dgridparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-228"><a href="#ProcessADCP.__init__-228"><span class="linenos">228</span></a>        <span class="n">editparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-229"><a href="#ProcessADCP.__init__-229"><span class="linenos">229</span></a>        <span class="n">ibad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-230"><a href="#ProcessADCP.__init__-230"><span class="linenos">230</span></a>        <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-231"><a href="#ProcessADCP.__init__-231"><span class="linenos">231</span></a>        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-232"><a href="#ProcessADCP.__init__-232"><span class="linenos">232</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-233"><a href="#ProcessADCP.__init__-233"><span class="linenos">233</span></a>        <span class="n">magdec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-234"><a href="#ProcessADCP.__init__-234"><span class="linenos">234</span></a>        <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-235"><a href="#ProcessADCP.__init__-235"><span class="linenos">235</span></a>        <span class="n">use_raw_pressure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-236"><a href="#ProcessADCP.__init__-236"><span class="linenos">236</span></a>        <span class="n">pressure_scale_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP.__init__-237"><a href="#ProcessADCP.__init__-237"><span class="linenos">237</span></a>    <span class="p">):</span>
</span><span id="ProcessADCP.__init__-238"><a href="#ProcessADCP.__init__-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">meta_data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="ProcessADCP.__init__-239"><a href="#ProcessADCP.__init__-239"><span class="linenos">239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ibad</span> <span class="o">=</span> <span class="n">ibad</span>
</span><span id="ProcessADCP.__init__-240"><a href="#ProcessADCP.__init__-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logdir</span> <span class="o">=</span> <span class="n">logdir</span>
</span><span id="ProcessADCP.__init__-241"><a href="#ProcessADCP.__init__-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="ProcessADCP.__init__-242"><a href="#ProcessADCP.__init__-242"><span class="linenos">242</span></a>
</span><span id="ProcessADCP.__init__-243"><a href="#ProcessADCP.__init__-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span> <span class="o">=</span> <span class="n">magdec</span>
</span><span id="ProcessADCP.__init__-244"><a href="#ProcessADCP.__init__-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="n">magdec</span>
</span><span id="ProcessADCP.__init__-245"><a href="#ProcessADCP.__init__-245"><span class="linenos">245</span></a>
</span><span id="ProcessADCP.__init__-246"><a href="#ProcessADCP.__init__-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="o">=</span> <span class="n">pressure</span>
</span><span id="ProcessADCP.__init__-247"><a href="#ProcessADCP.__init__-247"><span class="linenos">247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_scale_factor</span> <span class="o">=</span> <span class="n">pressure_scale_factor</span>
</span><span id="ProcessADCP.__init__-248"><a href="#ProcessADCP.__init__-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_use_raw_pressure</span> <span class="o">=</span> <span class="n">use_raw_pressure</span>
</span><span id="ProcessADCP.__init__-249"><a href="#ProcessADCP.__init__-249"><span class="linenos">249</span></a>
</span><span id="ProcessADCP.__init__-250"><a href="#ProcessADCP.__init__-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP.__init__-251"><a href="#ProcessADCP.__init__-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ProcessADCP.__init__-252"><a href="#ProcessADCP.__init__-252"><span class="linenos">252</span></a>
</span><span id="ProcessADCP.__init__-253"><a href="#ProcessADCP.__init__-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_file_locations</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span><span id="ProcessADCP.__init__-254"><a href="#ProcessADCP.__init__-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_data_reader</span><span class="p">()</span>
</span><span id="ProcessADCP.__init__-255"><a href="#ProcessADCP.__init__-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_read_auxiliary_data</span><span class="p">()</span>
</span><span id="ProcessADCP.__init__-256"><a href="#ProcessADCP.__init__-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_meta_data</span><span class="p">()</span>
</span><span id="ProcessADCP.__init__-257"><a href="#ProcessADCP.__init__-257"><span class="linenos">257</span></a>
</span><span id="ProcessADCP.__init__-258"><a href="#ProcessADCP.__init__-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_up_logger</span><span class="p">()</span>
</span><span id="ProcessADCP.__init__-259"><a href="#ProcessADCP.__init__-259"><span class="linenos">259</span></a>
</span><span id="ProcessADCP.__init__-260"><a href="#ProcessADCP.__init__-260"><span class="linenos">260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_driftparams</span><span class="p">(</span><span class="n">driftparams</span><span class="p">)</span>
</span><span id="ProcessADCP.__init__-261"><a href="#ProcessADCP.__init__-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sysconfig</span><span class="p">()</span>
</span><span id="ProcessADCP.__init__-262"><a href="#ProcessADCP.__init__-262"><span class="linenos">262</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_dgridparams</span><span class="p">(</span><span class="n">dgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP.__init__-263"><a href="#ProcessADCP.__init__-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_tgridparams</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP.__init__-264"><a href="#ProcessADCP.__init__-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parse_editparams</span><span class="p">(</span><span class="n">editparams</span><span class="p">)</span>
</span><span id="ProcessADCP.__init__-265"><a href="#ProcessADCP.__init__-265"><span class="linenos">265</span></a>
</span><span id="ProcessADCP.__init__-266"><a href="#ProcessADCP.__init__-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">make_start_ddays</span><span class="p">()</span>
</span><span id="ProcessADCP.__init__-267"><a href="#ProcessADCP.__init__-267"><span class="linenos">267</span></a>
</span><span id="ProcessADCP.__init__-268"><a href="#ProcessADCP.__init__-268"><span class="linenos">268</span></a>        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="ProcessADCP.__init__-269"><a href="#ProcessADCP.__init__-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plot_pressure</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="ProcessADCP.meta_data" class="classattr">
                                <div class="attr variable">
            <span class="name">meta_data</span>

        
    </div>
    <a class="headerlink" href="#ProcessADCP.meta_data"></a>
    
    

                            </div>
                            <div id="ProcessADCP.ibad" class="classattr">
                                <div class="attr variable">
            <span class="name">ibad</span>

        
    </div>
    <a class="headerlink" href="#ProcessADCP.ibad"></a>
    
    

                            </div>
                            <div id="ProcessADCP.logdir" class="classattr">
                                <div class="attr variable">
            <span class="name">logdir</span>

        
    </div>
    <a class="headerlink" href="#ProcessADCP.logdir"></a>
    
    

                            </div>
                            <div id="ProcessADCP.verbose" class="classattr">
                                <div class="attr variable">
            <span class="name">verbose</span>

        
    </div>
    <a class="headerlink" href="#ProcessADCP.verbose"></a>
    
    

                            </div>
                            <div id="ProcessADCP.parse_file_locations" class="classattr">
                                        <input id="ProcessADCP.parse_file_locations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_file_locations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">raw_data</span>, </span><span class="param"><span class="n">min_file_size</span><span class="o">=</span><span class="mf">10000.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.parse_file_locations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.parse_file_locations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.parse_file_locations-271"><a href="#ProcessADCP.parse_file_locations-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="nf">parse_file_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">min_file_size</span><span class="o">=</span><span class="mf">1e4</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_file_locations-272"><a href="#ProcessADCP.parse_file_locations-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse input for raw data files.</span>
</span><span id="ProcessADCP.parse_file_locations-273"><a href="#ProcessADCP.parse_file_locations-273"><span class="linenos">273</span></a>
</span><span id="ProcessADCP.parse_file_locations-274"><a href="#ProcessADCP.parse_file_locations-274"><span class="linenos">274</span></a><span class="sd">        Input can either be a single file name as a str, a single file as a</span>
</span><span id="ProcessADCP.parse_file_locations-275"><a href="#ProcessADCP.parse_file_locations-275"><span class="linenos">275</span></a><span class="sd">        Path instance, a list of either of these, or a Path instance pointing to a</span>
</span><span id="ProcessADCP.parse_file_locations-276"><a href="#ProcessADCP.parse_file_locations-276"><span class="linenos">276</span></a><span class="sd">        directory with raw ADCP files. In the latter case, files that are</span>
</span><span id="ProcessADCP.parse_file_locations-277"><a href="#ProcessADCP.parse_file_locations-277"><span class="linenos">277</span></a><span class="sd">        smaller than a threshold will not be included in the processing.</span>
</span><span id="ProcessADCP.parse_file_locations-278"><a href="#ProcessADCP.parse_file_locations-278"><span class="linenos">278</span></a>
</span><span id="ProcessADCP.parse_file_locations-279"><a href="#ProcessADCP.parse_file_locations-279"><span class="linenos">279</span></a><span class="sd">        Outputs to attribute `files`. The output can be fed to Multiread instances.</span>
</span><span id="ProcessADCP.parse_file_locations-280"><a href="#ProcessADCP.parse_file_locations-280"><span class="linenos">280</span></a>
</span><span id="ProcessADCP.parse_file_locations-281"><a href="#ProcessADCP.parse_file_locations-281"><span class="linenos">281</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.parse_file_locations-282"><a href="#ProcessADCP.parse_file_locations-282"><span class="linenos">282</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.parse_file_locations-283"><a href="#ProcessADCP.parse_file_locations-283"><span class="linenos">283</span></a><span class="sd">        raw_data : str or list or Path</span>
</span><span id="ProcessADCP.parse_file_locations-284"><a href="#ProcessADCP.parse_file_locations-284"><span class="linenos">284</span></a><span class="sd">            Location(s) of raw data.</span>
</span><span id="ProcessADCP.parse_file_locations-285"><a href="#ProcessADCP.parse_file_locations-285"><span class="linenos">285</span></a><span class="sd">        min_file_size : int</span>
</span><span id="ProcessADCP.parse_file_locations-286"><a href="#ProcessADCP.parse_file_locations-286"><span class="linenos">286</span></a><span class="sd">            Minimum size for file to be included. Defaults to 1e4 which</span>
</span><span id="ProcessADCP.parse_file_locations-287"><a href="#ProcessADCP.parse_file_locations-287"><span class="linenos">287</span></a><span class="sd">            corresponds to about 10kB and is a good value for excluding small</span>
</span><span id="ProcessADCP.parse_file_locations-288"><a href="#ProcessADCP.parse_file_locations-288"><span class="linenos">288</span></a><span class="sd">            files without any actual data.</span>
</span><span id="ProcessADCP.parse_file_locations-289"><a href="#ProcessADCP.parse_file_locations-289"><span class="linenos">289</span></a>
</span><span id="ProcessADCP.parse_file_locations-290"><a href="#ProcessADCP.parse_file_locations-290"><span class="linenos">290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.parse_file_locations-291"><a href="#ProcessADCP.parse_file_locations-291"><span class="linenos">291</span></a>
</span><span id="ProcessADCP.parse_file_locations-292"><a href="#ProcessADCP.parse_file_locations-292"><span class="linenos">292</span></a>        <span class="k">def</span> <span class="nf">list_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">min_file_size</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_file_locations-293"><a href="#ProcessADCP.parse_file_locations-293"><span class="linenos">293</span></a>            <span class="c1"># List all raw files.</span>
</span><span id="ProcessADCP.parse_file_locations-294"><a href="#ProcessADCP.parse_file_locations-294"><span class="linenos">294</span></a>            <span class="n">all_raw_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.00*&quot;</span><span class="p">)))</span>
</span><span id="ProcessADCP.parse_file_locations-295"><a href="#ProcessADCP.parse_file_locations-295"><span class="linenos">295</span></a>            <span class="c1"># only files larger than about 10kB</span>
</span><span id="ProcessADCP.parse_file_locations-296"><a href="#ProcessADCP.parse_file_locations-296"><span class="linenos">296</span></a>            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ProcessADCP.parse_file_locations-297"><a href="#ProcessADCP.parse_file_locations-297"><span class="linenos">297</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
</span><span id="ProcessADCP.parse_file_locations-298"><a href="#ProcessADCP.parse_file_locations-298"><span class="linenos">298</span></a>                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">all_raw_files</span>
</span><span id="ProcessADCP.parse_file_locations-299"><a href="#ProcessADCP.parse_file_locations-299"><span class="linenos">299</span></a>                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="n">min_file_size</span>
</span><span id="ProcessADCP.parse_file_locations-300"><a href="#ProcessADCP.parse_file_locations-300"><span class="linenos">300</span></a>            <span class="p">]</span>
</span><span id="ProcessADCP.parse_file_locations-301"><a href="#ProcessADCP.parse_file_locations-301"><span class="linenos">301</span></a>            <span class="k">return</span> <span class="n">files</span>
</span><span id="ProcessADCP.parse_file_locations-302"><a href="#ProcessADCP.parse_file_locations-302"><span class="linenos">302</span></a>
</span><span id="ProcessADCP.parse_file_locations-303"><a href="#ProcessADCP.parse_file_locations-303"><span class="linenos">303</span></a>        <span class="n">input_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_file_locations-304"><a href="#ProcessADCP.parse_file_locations-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-305"><a href="#ProcessADCP.parse_file_locations-305"><span class="linenos">305</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-306"><a href="#ProcessADCP.parse_file_locations-306"><span class="linenos">306</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">raw_data</span>
</span><span id="ProcessADCP.parse_file_locations-307"><a href="#ProcessADCP.parse_file_locations-307"><span class="linenos">307</span></a>            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-308"><a href="#ProcessADCP.parse_file_locations-308"><span class="linenos">308</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_file_locations-309"><a href="#ProcessADCP.parse_file_locations-309"><span class="linenos">309</span></a>        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-310"><a href="#ProcessADCP.parse_file_locations-310"><span class="linenos">310</span></a>            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="ProcessADCP.parse_file_locations-311"><a href="#ProcessADCP.parse_file_locations-311"><span class="linenos">311</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">list_dir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">raw_data</span><span class="p">),</span> <span class="n">min_file_size</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_file_locations-312"><a href="#ProcessADCP.parse_file_locations-312"><span class="linenos">312</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-313"><a href="#ProcessADCP.parse_file_locations-313"><span class="linenos">313</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_data</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_file_locations-314"><a href="#ProcessADCP.parse_file_locations-314"><span class="linenos">314</span></a>        <span class="k">elif</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-315"><a href="#ProcessADCP.parse_file_locations-315"><span class="linenos">315</span></a>            <span class="k">if</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="ProcessADCP.parse_file_locations-316"><a href="#ProcessADCP.parse_file_locations-316"><span class="linenos">316</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">list_dir</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">min_file_size</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_file_locations-317"><a href="#ProcessADCP.parse_file_locations-317"><span class="linenos">317</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_file_locations-318"><a href="#ProcessADCP.parse_file_locations-318"><span class="linenos">318</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_data</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()]</span>
</span></pre></div>


            <div class="docstring"><p>Parse input for raw data files.</p>

<p>Input can either be a single file name as a str, a single file as a
Path instance, a list of either of these, or a Path instance pointing to a
directory with raw ADCP files. In the latter case, files that are
smaller than a threshold will not be included in the processing.</p>

<p>Outputs to attribute <code>files</code>. The output can be fed to Multiread instances.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>raw_data</strong> (str or list or Path):
Location(s) of raw data.</li>
<li><strong>min_file_size</strong> (int):
Minimum size for file to be included. Defaults to 1e4 which
corresponds to about 10kB and is a good value for excluding small
files without any actual data.</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.pressure_lp" class="classattr">
                                        <input id="ProcessADCP.pressure_lp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">pressure_lp</span>

                <label class="view-source-button" for="ProcessADCP.pressure_lp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.pressure_lp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.pressure_lp-409"><a href="#ProcessADCP.pressure_lp-409"><span class="linenos">409</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP.pressure_lp-410"><a href="#ProcessADCP.pressure_lp-410"><span class="linenos">410</span></a>    <span class="k">def</span> <span class="nf">pressure_lp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.pressure_lp-411"><a href="#ProcessADCP.pressure_lp-411"><span class="linenos">411</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Low-pass filtered pressure time series&quot;&quot;&quot;</span>
</span><span id="ProcessADCP.pressure_lp-412"><a href="#ProcessADCP.pressure_lp-412"><span class="linenos">412</span></a>        <span class="k">if</span> <span class="s2">&quot;pressure_lp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="p">:</span>
</span><span id="ProcessADCP.pressure_lp-413"><a href="#ProcessADCP.pressure_lp-413"><span class="linenos">413</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure_lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lowpassfilter_pressure</span><span class="p">()</span>
</span><span id="ProcessADCP.pressure_lp-414"><a href="#ProcessADCP.pressure_lp-414"><span class="linenos">414</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure_lp</span>
</span></pre></div>


            <div class="docstring"><p>Low-pass filtered pressure time series</p>
</div>


                            </div>
                            <div id="ProcessADCP.default_dgridparams" class="classattr">
                                        <input id="ProcessADCP.default_dgridparams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">default_dgridparams</span>

                <label class="view-source-button" for="ProcessADCP.default_dgridparams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.default_dgridparams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.default_dgridparams-471"><a href="#ProcessADCP.default_dgridparams-471"><span class="linenos">471</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP.default_dgridparams-472"><a href="#ProcessADCP.default_dgridparams-472"><span class="linenos">472</span></a>    <span class="k">def</span> <span class="nf">default_dgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.default_dgridparams-473"><a href="#ProcessADCP.default_dgridparams-473"><span class="linenos">473</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine default depth gridding parameters.</span>
</span><span id="ProcessADCP.default_dgridparams-474"><a href="#ProcessADCP.default_dgridparams-474"><span class="linenos">474</span></a>
</span><span id="ProcessADCP.default_dgridparams-475"><a href="#ProcessADCP.default_dgridparams-475"><span class="linenos">475</span></a><span class="sd">        The grid is centered on the  median depth of the ADCP (plus distance to</span>
</span><span id="ProcessADCP.default_dgridparams-476"><a href="#ProcessADCP.default_dgridparams-476"><span class="linenos">476</span></a><span class="sd">        the center of the first bin) to avoid unnecessary binning into</span>
</span><span id="ProcessADCP.default_dgridparams-477"><a href="#ProcessADCP.default_dgridparams-477"><span class="linenos">477</span></a><span class="sd">        neighboring depth cells. The default size of the depth bins mimicks the</span>
</span><span id="ProcessADCP.default_dgridparams-478"><a href="#ProcessADCP.default_dgridparams-478"><span class="linenos">478</span></a><span class="sd">        size of ADCP bins.</span>
</span><span id="ProcessADCP.default_dgridparams-479"><a href="#ProcessADCP.default_dgridparams-479"><span class="linenos">479</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.default_dgridparams-480"><a href="#ProcessADCP.default_dgridparams-480"><span class="linenos">480</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.default_dgridparams-481"><a href="#ProcessADCP.default_dgridparams-481"><span class="linenos">481</span></a>            <span class="c1"># Only use pressure at depth, not on deck</span>
</span><span id="ProcessADCP.default_dgridparams-482"><a href="#ProcessADCP.default_dgridparams-482"><span class="linenos">482</span></a>            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="ProcessADCP.default_dgridparams-483"><a href="#ProcessADCP.default_dgridparams-483"><span class="linenos">483</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
</span><span id="ProcessADCP.default_dgridparams-484"><a href="#ProcessADCP.default_dgridparams-484"><span class="linenos">484</span></a>            <span class="c1"># Determine limits of the pressure distribution but leave out the</span>
</span><span id="ProcessADCP.default_dgridparams-485"><a href="#ProcessADCP.default_dgridparams-485"><span class="linenos">485</span></a>            <span class="c1"># top 5 and bottom 2 percent of data points. This way we are hoping</span>
</span><span id="ProcessADCP.default_dgridparams-486"><a href="#ProcessADCP.default_dgridparams-486"><span class="linenos">486</span></a>            <span class="c1"># to avoid any outliers and a possible pressure record of ascent</span>
</span><span id="ProcessADCP.default_dgridparams-487"><a href="#ProcessADCP.default_dgridparams-487"><span class="linenos">487</span></a>            <span class="c1"># and/or descent.</span>
</span><span id="ProcessADCP.default_dgridparams-488"><a href="#ProcessADCP.default_dgridparams-488"><span class="linenos">488</span></a>            <span class="n">p_top</span><span class="p">,</span> <span class="n">p_bot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="ProcessADCP.default_dgridparams-489"><a href="#ProcessADCP.default_dgridparams-489"><span class="linenos">489</span></a>                <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">98</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP.default_dgridparams-490"><a href="#ProcessADCP.default_dgridparams-490"><span class="linenos">490</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.default_dgridparams-491"><a href="#ProcessADCP.default_dgridparams-491"><span class="linenos">491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="ProcessADCP.default_dgridparams-492"><a href="#ProcessADCP.default_dgridparams-492"><span class="linenos">492</span></a>            <span class="n">pdep_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_median</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
</span><span id="ProcessADCP.default_dgridparams-493"><a href="#ProcessADCP.default_dgridparams-493"><span class="linenos">493</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">NCells</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="ProcessADCP.default_dgridparams-494"><a href="#ProcessADCP.default_dgridparams-494"><span class="linenos">494</span></a>            <span class="n">d_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">CellSize</span>
</span><span id="ProcessADCP.default_dgridparams-495"><a href="#ProcessADCP.default_dgridparams-495"><span class="linenos">495</span></a>            <span class="n">distance_to_first_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">Bin1Dist</span><span class="p">)</span>
</span><span id="ProcessADCP.default_dgridparams-496"><a href="#ProcessADCP.default_dgridparams-496"><span class="linenos">496</span></a>            <span class="n">distance_to_last_bin</span> <span class="o">=</span> <span class="n">distance_to_first_bin</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">d_interval</span>
</span><span id="ProcessADCP.default_dgridparams-497"><a href="#ProcessADCP.default_dgridparams-497"><span class="linenos">497</span></a>
</span><span id="ProcessADCP.default_dgridparams-498"><a href="#ProcessADCP.default_dgridparams-498"><span class="linenos">498</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysconfig</span><span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP.default_dgridparams-499"><a href="#ProcessADCP.default_dgridparams-499"><span class="linenos">499</span></a>                <span class="c1"># Set minimum grid depth level. Anything shallower than 10m</span>
</span><span id="ProcessADCP.default_dgridparams-500"><a href="#ProcessADCP.default_dgridparams-500"><span class="linenos">500</span></a>                <span class="c1"># will be garbage anyways so let&#39;s throw this out.</span>
</span><span id="ProcessADCP.default_dgridparams-501"><a href="#ProcessADCP.default_dgridparams-501"><span class="linenos">501</span></a>                <span class="n">dtop</span> <span class="o">=</span> <span class="n">p_top</span> <span class="o">-</span> <span class="n">distance_to_last_bin</span>
</span><span id="ProcessADCP.default_dgridparams-502"><a href="#ProcessADCP.default_dgridparams-502"><span class="linenos">502</span></a>                <span class="k">if</span> <span class="n">dtop</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="ProcessADCP.default_dgridparams-503"><a href="#ProcessADCP.default_dgridparams-503"><span class="linenos">503</span></a>                    <span class="n">dtop</span> <span class="o">=</span> <span class="mi">10</span>
</span><span id="ProcessADCP.default_dgridparams-504"><a href="#ProcessADCP.default_dgridparams-504"><span class="linenos">504</span></a>                <span class="n">dbot</span> <span class="o">=</span> <span class="n">pdep_median</span> <span class="o">-</span> <span class="n">distance_to_first_bin</span>
</span><span id="ProcessADCP.default_dgridparams-505"><a href="#ProcessADCP.default_dgridparams-505"><span class="linenos">505</span></a>                <span class="c1"># Successively add bins until we reach maximum pressure. This</span>
</span><span id="ProcessADCP.default_dgridparams-506"><a href="#ProcessADCP.default_dgridparams-506"><span class="linenos">506</span></a>                <span class="c1"># will take care of mooring knockdowns.</span>
</span><span id="ProcessADCP.default_dgridparams-507"><a href="#ProcessADCP.default_dgridparams-507"><span class="linenos">507</span></a>                <span class="k">while</span> <span class="n">dbot</span> <span class="o">&lt;</span> <span class="n">p_bot</span><span class="p">:</span>
</span><span id="ProcessADCP.default_dgridparams-508"><a href="#ProcessADCP.default_dgridparams-508"><span class="linenos">508</span></a>                    <span class="n">dbot</span> <span class="o">+=</span> <span class="n">d_interval</span>
</span><span id="ProcessADCP.default_dgridparams-509"><a href="#ProcessADCP.default_dgridparams-509"><span class="linenos">509</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.default_dgridparams-510"><a href="#ProcessADCP.default_dgridparams-510"><span class="linenos">510</span></a>                <span class="n">dtop</span> <span class="o">=</span> <span class="n">pdep_median</span> <span class="o">+</span> <span class="n">distance_to_first_bin</span>
</span><span id="ProcessADCP.default_dgridparams-511"><a href="#ProcessADCP.default_dgridparams-511"><span class="linenos">511</span></a>                <span class="k">while</span> <span class="n">dtop</span> <span class="o">&gt;</span> <span class="n">p_top</span><span class="p">:</span>
</span><span id="ProcessADCP.default_dgridparams-512"><a href="#ProcessADCP.default_dgridparams-512"><span class="linenos">512</span></a>                    <span class="n">dtop</span> <span class="o">-=</span> <span class="n">d_interval</span>
</span><span id="ProcessADCP.default_dgridparams-513"><a href="#ProcessADCP.default_dgridparams-513"><span class="linenos">513</span></a>                <span class="n">dbot</span> <span class="o">=</span> <span class="n">p_bot</span> <span class="o">+</span> <span class="n">distance_to_last_bin</span>
</span><span id="ProcessADCP.default_dgridparams-514"><a href="#ProcessADCP.default_dgridparams-514"><span class="linenos">514</span></a>
</span><span id="ProcessADCP.default_dgridparams-515"><a href="#ProcessADCP.default_dgridparams-515"><span class="linenos">515</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ProcessADCP.default_dgridparams-516"><a href="#ProcessADCP.default_dgridparams-516"><span class="linenos">516</span></a>                <span class="n">dtop</span><span class="o">=</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="ProcessADCP.default_dgridparams-517"><a href="#ProcessADCP.default_dgridparams-517"><span class="linenos">517</span></a>                <span class="n">dbot</span><span class="o">=</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="ProcessADCP.default_dgridparams-518"><a href="#ProcessADCP.default_dgridparams-518"><span class="linenos">518</span></a>                <span class="n">d_interval</span><span class="o">=</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="ProcessADCP.default_dgridparams-519"><a href="#ProcessADCP.default_dgridparams-519"><span class="linenos">519</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.default_dgridparams-520"><a href="#ProcessADCP.default_dgridparams-520"><span class="linenos">520</span></a>
</span><span id="ProcessADCP.default_dgridparams-521"><a href="#ProcessADCP.default_dgridparams-521"><span class="linenos">521</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_dgridparams</span>
</span></pre></div>


            <div class="docstring"><p>Determine default depth gridding parameters.</p>

<p>The grid is centered on the  median depth of the ADCP (plus distance to
the center of the first bin) to avoid unnecessary binning into
neighboring depth cells. The default size of the depth bins mimicks the
size of ADCP bins.</p>
</div>


                            </div>
                            <div id="ProcessADCP.parse_dgridparams" class="classattr">
                                        <input id="ProcessADCP.parse_dgridparams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_dgridparams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dgridparams</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.parse_dgridparams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.parse_dgridparams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.parse_dgridparams-523"><a href="#ProcessADCP.parse_dgridparams-523"><span class="linenos">523</span></a>    <span class="k">def</span> <span class="nf">parse_dgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgridparams</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_dgridparams-524"><a href="#ProcessADCP.parse_dgridparams-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse depth gridding parameters.</span>
</span><span id="ProcessADCP.parse_dgridparams-525"><a href="#ProcessADCP.parse_dgridparams-525"><span class="linenos">525</span></a>
</span><span id="ProcessADCP.parse_dgridparams-526"><a href="#ProcessADCP.parse_dgridparams-526"><span class="linenos">526</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP.parse_dgridparams-527"><a href="#ProcessADCP.parse_dgridparams-527"><span class="linenos">527</span></a>
</span><span id="ProcessADCP.parse_dgridparams-528"><a href="#ProcessADCP.parse_dgridparams-528"><span class="linenos">528</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.parse_dgridparams-529"><a href="#ProcessADCP.parse_dgridparams-529"><span class="linenos">529</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.parse_dgridparams-530"><a href="#ProcessADCP.parse_dgridparams-530"><span class="linenos">530</span></a><span class="sd">        dgridparams : dict</span>
</span><span id="ProcessADCP.parse_dgridparams-531"><a href="#ProcessADCP.parse_dgridparams-531"><span class="linenos">531</span></a>
</span><span id="ProcessADCP.parse_dgridparams-532"><a href="#ProcessADCP.parse_dgridparams-532"><span class="linenos">532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.parse_dgridparams-533"><a href="#ProcessADCP.parse_dgridparams-533"><span class="linenos">533</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_dgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_dgridparams-534"><a href="#ProcessADCP.parse_dgridparams-534"><span class="linenos">534</span></a>        <span class="k">if</span> <span class="n">dgridparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_dgridparams-535"><a href="#ProcessADCP.parse_dgridparams-535"><span class="linenos">535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">dgridparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_dgridparams-536"><a href="#ProcessADCP.parse_dgridparams-536"><span class="linenos">536</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_dgridparams-537"><a href="#ProcessADCP.parse_dgridparams-537"><span class="linenos">537</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP.parse_dgridparams-538"><a href="#ProcessADCP.parse_dgridparams-538"><span class="linenos">538</span></a>                <span class="s2">&quot;No depth gridding parameters provided, using default values.&quot;</span>
</span><span id="ProcessADCP.parse_dgridparams-539"><a href="#ProcessADCP.parse_dgridparams-539"><span class="linenos">539</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.parse_dgridparams-540"><a href="#ProcessADCP.parse_dgridparams-540"><span class="linenos">540</span></a>        <span class="c1"># Default depth grid parameters are based on the median pressure to</span>
</span><span id="ProcessADCP.parse_dgridparams-541"><a href="#ProcessADCP.parse_dgridparams-541"><span class="linenos">541</span></a>        <span class="c1"># avoid binning into neighboring grid cells as much as possible.</span>
</span><span id="ProcessADCP.parse_dgridparams-542"><a href="#ProcessADCP.parse_dgridparams-542"><span class="linenos">542</span></a>        <span class="c1"># Therefore, we start assembling the depth grid from the bottom up for</span>
</span><span id="ProcessADCP.parse_dgridparams-543"><a href="#ProcessADCP.parse_dgridparams-543"><span class="linenos">543</span></a>        <span class="c1"># an uplooker and from the top down for a downlooker.</span>
</span><span id="ProcessADCP.parse_dgridparams-544"><a href="#ProcessADCP.parse_dgridparams-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_dgridparams-545"><a href="#ProcessADCP.parse_dgridparams-545"><span class="linenos">545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="ProcessADCP.parse_dgridparams-546"><a href="#ProcessADCP.parse_dgridparams-546"><span class="linenos">546</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-547"><a href="#ProcessADCP.parse_dgridparams-547"><span class="linenos">547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-548"><a href="#ProcessADCP.parse_dgridparams-548"><span class="linenos">548</span></a>                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-549"><a href="#ProcessADCP.parse_dgridparams-549"><span class="linenos">549</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-550"><a href="#ProcessADCP.parse_dgridparams-550"><span class="linenos">550</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.parse_dgridparams-551"><a href="#ProcessADCP.parse_dgridparams-551"><span class="linenos">551</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_dgridparams-552"><a href="#ProcessADCP.parse_dgridparams-552"><span class="linenos">552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
</span><span id="ProcessADCP.parse_dgridparams-553"><a href="#ProcessADCP.parse_dgridparams-553"><span class="linenos">553</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dtop</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-554"><a href="#ProcessADCP.parse_dgridparams-554"><span class="linenos">554</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">dbot</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-555"><a href="#ProcessADCP.parse_dgridparams-555"><span class="linenos">555</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="o">.</span><span class="n">d_interval</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-556"><a href="#ProcessADCP.parse_dgridparams-556"><span class="linenos">556</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
</span><span id="ProcessADCP.parse_dgridparams-557"><a href="#ProcessADCP.parse_dgridparams-557"><span class="linenos">557</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse depth gridding parameters.</p>

<p>See top level class notes for more info.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>dgridparams</strong> (dict):</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.parse_tgridparams" class="classattr">
                                        <input id="ProcessADCP.parse_tgridparams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_tgridparams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tgridparams</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.parse_tgridparams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.parse_tgridparams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.parse_tgridparams-559"><a href="#ProcessADCP.parse_tgridparams-559"><span class="linenos">559</span></a>    <span class="k">def</span> <span class="nf">parse_tgridparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tgridparams</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_tgridparams-560"><a href="#ProcessADCP.parse_tgridparams-560"><span class="linenos">560</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse time gridding parameters.</span>
</span><span id="ProcessADCP.parse_tgridparams-561"><a href="#ProcessADCP.parse_tgridparams-561"><span class="linenos">561</span></a>
</span><span id="ProcessADCP.parse_tgridparams-562"><a href="#ProcessADCP.parse_tgridparams-562"><span class="linenos">562</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP.parse_tgridparams-563"><a href="#ProcessADCP.parse_tgridparams-563"><span class="linenos">563</span></a>
</span><span id="ProcessADCP.parse_tgridparams-564"><a href="#ProcessADCP.parse_tgridparams-564"><span class="linenos">564</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.parse_tgridparams-565"><a href="#ProcessADCP.parse_tgridparams-565"><span class="linenos">565</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.parse_tgridparams-566"><a href="#ProcessADCP.parse_tgridparams-566"><span class="linenos">566</span></a><span class="sd">        tgridparams : dict</span>
</span><span id="ProcessADCP.parse_tgridparams-567"><a href="#ProcessADCP.parse_tgridparams-567"><span class="linenos">567</span></a>
</span><span id="ProcessADCP.parse_tgridparams-568"><a href="#ProcessADCP.parse_tgridparams-568"><span class="linenos">568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.parse_tgridparams-569"><a href="#ProcessADCP.parse_tgridparams-569"><span class="linenos">569</span></a>        <span class="c1"># Find time at depth to determine default time grid parameters.</span>
</span><span id="ProcessADCP.parse_tgridparams-570"><a href="#ProcessADCP.parse_tgridparams-570"><span class="linenos">570</span></a>        <span class="c1"># Differentiate between time series only in the water and time series</span>
</span><span id="ProcessADCP.parse_tgridparams-571"><a href="#ProcessADCP.parse_tgridparams-571"><span class="linenos">571</span></a>        <span class="c1"># including the overshoot on mooring deployment.</span>
</span><span id="ProcessADCP.parse_tgridparams-572"><a href="#ProcessADCP.parse_tgridparams-572"><span class="linenos">572</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span>
</span><span id="ProcessADCP.parse_tgridparams-573"><a href="#ProcessADCP.parse_tgridparams-573"><span class="linenos">573</span></a>        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_tgridparams-574"><a href="#ProcessADCP.parse_tgridparams-574"><span class="linenos">574</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_tgridparams-575"><a href="#ProcessADCP.parse_tgridparams-575"><span class="linenos">575</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_tgridparams-576"><a href="#ProcessADCP.parse_tgridparams-576"><span class="linenos">576</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_tgridparams-577"><a href="#ProcessADCP.parse_tgridparams-577"><span class="linenos">577</span></a>            <span class="n">at_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_tgridparams-578"><a href="#ProcessADCP.parse_tgridparams-578"><span class="linenos">578</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">at_depth</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_tgridparams-579"><a href="#ProcessADCP.parse_tgridparams-579"><span class="linenos">579</span></a>            <span class="c1"># in_water = np.nonzero(p &gt; self.p_median / 2)[0][-1]</span>
</span><span id="ProcessADCP.parse_tgridparams-580"><a href="#ProcessADCP.parse_tgridparams-580"><span class="linenos">580</span></a>            <span class="c1"># t1 = self.dday[in_water]</span>
</span><span id="ProcessADCP.parse_tgridparams-581"><a href="#ProcessADCP.parse_tgridparams-581"><span class="linenos">581</span></a>            <span class="n">at_depth_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_median</span> <span class="o">/</span> <span class="mf">1.05</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_tgridparams-582"><a href="#ProcessADCP.parse_tgridparams-582"><span class="linenos">582</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">at_depth_last</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_tgridparams-583"><a href="#ProcessADCP.parse_tgridparams-583"><span class="linenos">583</span></a>
</span><span id="ProcessADCP.parse_tgridparams-584"><a href="#ProcessADCP.parse_tgridparams-584"><span class="linenos">584</span></a>        <span class="c1"># Generate a set of default time gridding parameters and then update</span>
</span><span id="ProcessADCP.parse_tgridparams-585"><a href="#ProcessADCP.parse_tgridparams-585"><span class="linenos">585</span></a>        <span class="c1"># from the input parameters provided.</span>
</span><span id="ProcessADCP.parse_tgridparams-586"><a href="#ProcessADCP.parse_tgridparams-586"><span class="linenos">586</span></a>        <span class="n">default_tgridparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt_hours</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">burst_average</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_tgridparams-587"><a href="#ProcessADCP.parse_tgridparams-587"><span class="linenos">587</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">default_tgridparams</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_tgridparams-588"><a href="#ProcessADCP.parse_tgridparams-588"><span class="linenos">588</span></a>        <span class="k">if</span> <span class="n">tgridparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_tgridparams-589"><a href="#ProcessADCP.parse_tgridparams-589"><span class="linenos">589</span></a>            <span class="c1"># convert time to dday if provided as str</span>
</span><span id="ProcessADCP.parse_tgridparams-590"><a href="#ProcessADCP.parse_tgridparams-590"><span class="linenos">590</span></a>            <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">,</span> <span class="s2">&quot;t1&quot;</span><span class="p">]:</span>
</span><span id="ProcessADCP.parse_tgridparams-591"><a href="#ProcessADCP.parse_tgridparams-591"><span class="linenos">591</span></a>                <span class="k">if</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">tgridparams</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_tgridparams-592"><a href="#ProcessADCP.parse_tgridparams-592"><span class="linenos">592</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_tgridparams-593"><a href="#ProcessADCP.parse_tgridparams-593"><span class="linenos">593</span></a>                        <span class="n">t64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>
</span><span id="ProcessADCP.parse_tgridparams-594"><a href="#ProcessADCP.parse_tgridparams-594"><span class="linenos">594</span></a>                        <span class="n">year</span><span class="p">,</span> <span class="n">dday</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">datetime64_to_yday0</span><span class="p">(</span><span class="n">t64</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_tgridparams-595"><a href="#ProcessADCP.parse_tgridparams-595"><span class="linenos">595</span></a>                        <span class="n">tgridparams</span><span class="p">[</span><span class="n">time</span><span class="p">]</span> <span class="o">=</span> <span class="n">dday</span>
</span><span id="ProcessADCP.parse_tgridparams-596"><a href="#ProcessADCP.parse_tgridparams-596"><span class="linenos">596</span></a>            <span class="c1"># update parameters in processing object</span>
</span><span id="ProcessADCP.parse_tgridparams-597"><a href="#ProcessADCP.parse_tgridparams-597"><span class="linenos">597</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">tgridparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_tgridparams-598"><a href="#ProcessADCP.parse_tgridparams-598"><span class="linenos">598</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_tgridparams-599"><a href="#ProcessADCP.parse_tgridparams-599"><span class="linenos">599</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP.parse_tgridparams-600"><a href="#ProcessADCP.parse_tgridparams-600"><span class="linenos">600</span></a>                <span class="s2">&quot;No time gridding parameters provided, using default values.&quot;</span>
</span><span id="ProcessADCP.parse_tgridparams-601"><a href="#ProcessADCP.parse_tgridparams-601"><span class="linenos">601</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse time gridding parameters.</p>

<p>See top level class notes for more info.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>tgridparams</strong> (dict):</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.parse_editparams" class="classattr">
                                        <input id="ProcessADCP.parse_editparams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_editparams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">editparams</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.parse_editparams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.parse_editparams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.parse_editparams-603"><a href="#ProcessADCP.parse_editparams-603"><span class="linenos">603</span></a>    <span class="k">def</span> <span class="nf">parse_editparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">editparams</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_editparams-604"><a href="#ProcessADCP.parse_editparams-604"><span class="linenos">604</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse editing parameters.</span>
</span><span id="ProcessADCP.parse_editparams-605"><a href="#ProcessADCP.parse_editparams-605"><span class="linenos">605</span></a>
</span><span id="ProcessADCP.parse_editparams-606"><a href="#ProcessADCP.parse_editparams-606"><span class="linenos">606</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP.parse_editparams-607"><a href="#ProcessADCP.parse_editparams-607"><span class="linenos">607</span></a>
</span><span id="ProcessADCP.parse_editparams-608"><a href="#ProcessADCP.parse_editparams-608"><span class="linenos">608</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.parse_editparams-609"><a href="#ProcessADCP.parse_editparams-609"><span class="linenos">609</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.parse_editparams-610"><a href="#ProcessADCP.parse_editparams-610"><span class="linenos">610</span></a><span class="sd">        editparams : dict</span>
</span><span id="ProcessADCP.parse_editparams-611"><a href="#ProcessADCP.parse_editparams-611"><span class="linenos">611</span></a>
</span><span id="ProcessADCP.parse_editparams-612"><a href="#ProcessADCP.parse_editparams-612"><span class="linenos">612</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.parse_editparams-613"><a href="#ProcessADCP.parse_editparams-613"><span class="linenos">613</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_editparams</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_editparams-614"><a href="#ProcessADCP.parse_editparams-614"><span class="linenos">614</span></a>        <span class="k">if</span> <span class="n">editparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_editparams-615"><a href="#ProcessADCP.parse_editparams-615"><span class="linenos">615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">editparams</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_editparams-616"><a href="#ProcessADCP.parse_editparams-616"><span class="linenos">616</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_editparams-617"><a href="#ProcessADCP.parse_editparams-617"><span class="linenos">617</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No edit parameters provided, using default values.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse editing parameters.</p>

<p>See top level class notes for more info.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>editparams</strong> (dict):</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.parse_driftparams" class="classattr">
                                        <input id="ProcessADCP.parse_driftparams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_driftparams</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">driftparams</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.parse_driftparams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.parse_driftparams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.parse_driftparams-619"><a href="#ProcessADCP.parse_driftparams-619"><span class="linenos">619</span></a>    <span class="k">def</span> <span class="nf">parse_driftparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driftparams</span><span class="p">):</span>
</span><span id="ProcessADCP.parse_driftparams-620"><a href="#ProcessADCP.parse_driftparams-620"><span class="linenos">620</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse time drift parameters.</span>
</span><span id="ProcessADCP.parse_driftparams-621"><a href="#ProcessADCP.parse_driftparams-621"><span class="linenos">621</span></a>
</span><span id="ProcessADCP.parse_driftparams-622"><a href="#ProcessADCP.parse_driftparams-622"><span class="linenos">622</span></a><span class="sd">        See top level class notes for more info.</span>
</span><span id="ProcessADCP.parse_driftparams-623"><a href="#ProcessADCP.parse_driftparams-623"><span class="linenos">623</span></a>
</span><span id="ProcessADCP.parse_driftparams-624"><a href="#ProcessADCP.parse_driftparams-624"><span class="linenos">624</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.parse_driftparams-625"><a href="#ProcessADCP.parse_driftparams-625"><span class="linenos">625</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.parse_driftparams-626"><a href="#ProcessADCP.parse_driftparams-626"><span class="linenos">626</span></a><span class="sd">        driftparams : dict</span>
</span><span id="ProcessADCP.parse_driftparams-627"><a href="#ProcessADCP.parse_driftparams-627"><span class="linenos">627</span></a>
</span><span id="ProcessADCP.parse_driftparams-628"><a href="#ProcessADCP.parse_driftparams-628"><span class="linenos">628</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.parse_driftparams-629"><a href="#ProcessADCP.parse_driftparams-629"><span class="linenos">629</span></a>        <span class="n">driftparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">driftparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">driftparams</span>
</span><span id="ProcessADCP.parse_driftparams-630"><a href="#ProcessADCP.parse_driftparams-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">driftparams</span> <span class="o">=</span> <span class="n">driftparams</span>
</span><span id="ProcessADCP.parse_driftparams-631"><a href="#ProcessADCP.parse_driftparams-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span>
</span><span id="ProcessADCP.parse_driftparams-632"><a href="#ProcessADCP.parse_driftparams-632"><span class="linenos">632</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.parse_driftparams-633"><a href="#ProcessADCP.parse_driftparams-633"><span class="linenos">633</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span>
</span><span id="ProcessADCP.parse_driftparams-634"><a href="#ProcessADCP.parse_driftparams-634"><span class="linenos">634</span></a>        <span class="n">t1_adcp</span> <span class="o">=</span> <span class="n">driftparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_adcp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_driftparams-635"><a href="#ProcessADCP.parse_driftparams-635"><span class="linenos">635</span></a>        <span class="k">if</span> <span class="n">t1_adcp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_driftparams-636"><a href="#ProcessADCP.parse_driftparams-636"><span class="linenos">636</span></a>            <span class="n">t1_pc</span> <span class="o">=</span> <span class="n">to_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="o">*</span><span class="n">driftparams</span><span class="p">[</span><span class="s2">&quot;end_pc&quot;</span><span class="p">])</span>
</span><span id="ProcessADCP.parse_driftparams-637"><a href="#ProcessADCP.parse_driftparams-637"><span class="linenos">637</span></a>            <span class="n">t1_adcp</span> <span class="o">=</span> <span class="n">to_day</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="o">*</span><span class="n">driftparams</span><span class="p">[</span><span class="s2">&quot;end_adcp&quot;</span><span class="p">])</span>
</span><span id="ProcessADCP.parse_driftparams-638"><a href="#ProcessADCP.parse_driftparams-638"><span class="linenos">638</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1_pc</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t1_adcp</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
</span><span id="ProcessADCP.parse_driftparams-639"><a href="#ProcessADCP.parse_driftparams-639"><span class="linenos">639</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.parse_driftparams-640"><a href="#ProcessADCP.parse_driftparams-640"><span class="linenos">640</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP.parse_driftparams-641"><a href="#ProcessADCP.parse_driftparams-641"><span class="linenos">641</span></a>                <span class="s2">&quot;No time drift parameters provided, not applying any clock correction.&quot;</span>
</span><span id="ProcessADCP.parse_driftparams-642"><a href="#ProcessADCP.parse_driftparams-642"><span class="linenos">642</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.parse_driftparams-643"><a href="#ProcessADCP.parse_driftparams-643"><span class="linenos">643</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">time_drift_rate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ProcessADCP.parse_driftparams-644"><a href="#ProcessADCP.parse_driftparams-644"><span class="linenos">644</span></a>
</span><span id="ProcessADCP.parse_driftparams-645"><a href="#ProcessADCP.parse_driftparams-645"><span class="linenos">645</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Parse time drift parameters.</p>

<p>See top level class notes for more info.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>driftparams</strong> (dict):</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.make_start_ddays" class="classattr">
                                        <input id="ProcessADCP.make_start_ddays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_start_ddays</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.make_start_ddays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.make_start_ddays"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.make_start_ddays-680"><a href="#ProcessADCP.make_start_ddays-680"><span class="linenos">680</span></a>    <span class="k">def</span> <span class="nf">make_start_ddays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.make_start_ddays-681"><a href="#ProcessADCP.make_start_ddays-681"><span class="linenos">681</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate time stamps for ping averaging.</span>
</span><span id="ProcessADCP.make_start_ddays-682"><a href="#ProcessADCP.make_start_ddays-682"><span class="linenos">682</span></a>
</span><span id="ProcessADCP.make_start_ddays-683"><a href="#ProcessADCP.make_start_ddays-683"><span class="linenos">683</span></a><span class="sd">        Notes</span>
</span><span id="ProcessADCP.make_start_ddays-684"><a href="#ProcessADCP.make_start_ddays-684"><span class="linenos">684</span></a><span class="sd">        -----</span>
</span><span id="ProcessADCP.make_start_ddays-685"><a href="#ProcessADCP.make_start_ddays-685"><span class="linenos">685</span></a><span class="sd">        If turning on burst averaging, other input values will be ignored and</span>
</span><span id="ProcessADCP.make_start_ddays-686"><a href="#ProcessADCP.make_start_ddays-686"><span class="linenos">686</span></a><span class="sd">        the averaging interval will be determined from the burst sampling</span>
</span><span id="ProcessADCP.make_start_ddays-687"><a href="#ProcessADCP.make_start_ddays-687"><span class="linenos">687</span></a><span class="sd">        scheme apparent in the ping pattern.</span>
</span><span id="ProcessADCP.make_start_ddays-688"><a href="#ProcessADCP.make_start_ddays-688"><span class="linenos">688</span></a>
</span><span id="ProcessADCP.make_start_ddays-689"><a href="#ProcessADCP.make_start_ddays-689"><span class="linenos">689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.make_start_ddays-690"><a href="#ProcessADCP.make_start_ddays-690"><span class="linenos">690</span></a>        <span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">t0</span>
</span><span id="ProcessADCP.make_start_ddays-691"><a href="#ProcessADCP.make_start_ddays-691"><span class="linenos">691</span></a>        <span class="n">dday_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">t1</span>
</span><span id="ProcessADCP.make_start_ddays-692"><a href="#ProcessADCP.make_start_ddays-692"><span class="linenos">692</span></a>        <span class="n">dt_hours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">dt_hours</span>
</span><span id="ProcessADCP.make_start_ddays-693"><a href="#ProcessADCP.make_start_ddays-693"><span class="linenos">693</span></a>        <span class="n">is_burst_average</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="o">.</span><span class="n">burst_average</span>
</span><span id="ProcessADCP.make_start_ddays-694"><a href="#ProcessADCP.make_start_ddays-694"><span class="linenos">694</span></a>
</span><span id="ProcessADCP.make_start_ddays-695"><a href="#ProcessADCP.make_start_ddays-695"><span class="linenos">695</span></a>        <span class="c1"># Save whether we are averaging over bursts or not.</span>
</span><span id="ProcessADCP.make_start_ddays-696"><a href="#ProcessADCP.make_start_ddays-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span> <span class="o">=</span> <span class="n">is_burst_average</span>
</span><span id="ProcessADCP.make_start_ddays-697"><a href="#ProcessADCP.make_start_ddays-697"><span class="linenos">697</span></a>        <span class="c1"># Generate time stamps and stuff.</span>
</span><span id="ProcessADCP.make_start_ddays-698"><a href="#ProcessADCP.make_start_ddays-698"><span class="linenos">698</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="ProcessADCP.make_start_ddays-699"><a href="#ProcessADCP.make_start_ddays-699"><span class="linenos">699</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no burst average&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-700"><a href="#ProcessADCP.make_start_ddays-700"><span class="linenos">700</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="n">dday_start</span>
</span><span id="ProcessADCP.make_start_ddays-701"><a href="#ProcessADCP.make_start_ddays-701"><span class="linenos">701</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span> <span class="o">=</span> <span class="n">dday_end</span>
</span><span id="ProcessADCP.make_start_ddays-702"><a href="#ProcessADCP.make_start_ddays-702"><span class="linenos">702</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt_hours</span> <span class="o">/</span> <span class="mf">24.0</span>
</span><span id="ProcessADCP.make_start_ddays-703"><a href="#ProcessADCP.make_start_ddays-703"><span class="linenos">703</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dday_start</span><span class="p">,</span> <span class="n">dday_end</span><span class="p">,</span> <span class="n">dt_hours</span> <span class="o">/</span> <span class="mf">24.0</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-704"><a href="#ProcessADCP.make_start_ddays-704"><span class="linenos">704</span></a>            <span class="c1"># Time stamps for the averages. Midpoints of averaging intervals.</span>
</span><span id="ProcessADCP.make_start_ddays-705"><a href="#ProcessADCP.make_start_ddays-705"><span class="linenos">705</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ProcessADCP.make_start_ddays-706"><a href="#ProcessADCP.make_start_ddays-706"><span class="linenos">706</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.make_start_ddays-707"><a href="#ProcessADCP.make_start_ddays-707"><span class="linenos">707</span></a>            <span class="n">dday_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-708"><a href="#ProcessADCP.make_start_ddays-708"><span class="linenos">708</span></a>            <span class="c1"># Determine ping interval within burst and time between bursts.</span>
</span><span id="ProcessADCP.make_start_ddays-709"><a href="#ProcessADCP.make_start_ddays-709"><span class="linenos">709</span></a>            <span class="n">burst_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dday_diff</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-710"><a href="#ProcessADCP.make_start_ddays-710"><span class="linenos">710</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time between pings within burst: </span><span class="si">{</span><span class="n">burst_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-711"><a href="#ProcessADCP.make_start_ddays-711"><span class="linenos">711</span></a>            <span class="c1"># It seems safe to assume that the time between bursts is at least</span>
</span><span id="ProcessADCP.make_start_ddays-712"><a href="#ProcessADCP.make_start_ddays-712"><span class="linenos">712</span></a>            <span class="c1"># four times as long as the time between individual pings within a</span>
</span><span id="ProcessADCP.make_start_ddays-713"><a href="#ProcessADCP.make_start_ddays-713"><span class="linenos">713</span></a>            <span class="c1"># burst.</span>
</span><span id="ProcessADCP.make_start_ddays-714"><a href="#ProcessADCP.make_start_ddays-714"><span class="linenos">714</span></a>            <span class="n">inter_burst_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dday_diff</span><span class="p">[</span><span class="n">dday_diff</span> <span class="o">&gt;</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="ProcessADCP.make_start_ddays-715"><a href="#ProcessADCP.make_start_ddays-715"><span class="linenos">715</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time between bursts: </span><span class="si">{</span><span class="n">inter_burst_dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">1.1f</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-716"><a href="#ProcessADCP.make_start_ddays-716"><span class="linenos">716</span></a>            <span class="c1"># Find starting points of all bursts.</span>
</span><span id="ProcessADCP.make_start_ddays-717"><a href="#ProcessADCP.make_start_ddays-717"><span class="linenos">717</span></a>            <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">dday_diff</span> <span class="o">&gt;</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-718"><a href="#ProcessADCP.make_start_ddays-718"><span class="linenos">718</span></a>            <span class="c1"># Increase index so we are at the end of the larger time differences.</span>
</span><span id="ProcessADCP.make_start_ddays-719"><a href="#ProcessADCP.make_start_ddays-719"><span class="linenos">719</span></a>            <span class="n">start_indices</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ProcessADCP.make_start_ddays-720"><a href="#ProcessADCP.make_start_ddays-720"><span class="linenos">720</span></a>            <span class="c1"># Include the very beginning.</span>
</span><span id="ProcessADCP.make_start_ddays-721"><a href="#ProcessADCP.make_start_ddays-721"><span class="linenos">721</span></a>            <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">start_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-722"><a href="#ProcessADCP.make_start_ddays-722"><span class="linenos">722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">start_indices</span><span class="p">]</span>
</span><span id="ProcessADCP.make_start_ddays-723"><a href="#ProcessADCP.make_start_ddays-723"><span class="linenos">723</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.make_start_ddays-724"><a href="#ProcessADCP.make_start_ddays-724"><span class="linenos">724</span></a>            <span class="c1"># Generate a dt that is inclusive of one burst.  We know the number</span>
</span><span id="ProcessADCP.make_start_ddays-725"><a href="#ProcessADCP.make_start_ddays-725"><span class="linenos">725</span></a>            <span class="c1"># of pings in a burst from the difference between the</span>
</span><span id="ProcessADCP.make_start_ddays-726"><a href="#ProcessADCP.make_start_ddays-726"><span class="linenos">726</span></a>            <span class="c1"># start_indices. Let&#39;s go a bit beyond the time needed (3 more ping</span>
</span><span id="ProcessADCP.make_start_ddays-727"><a href="#ProcessADCP.make_start_ddays-727"><span class="linenos">727</span></a>            <span class="c1"># intervals chosen here).</span>
</span><span id="ProcessADCP.make_start_ddays-728"><a href="#ProcessADCP.make_start_ddays-728"><span class="linenos">728</span></a>            <span class="n">pings_per_burst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">start_indices</span><span class="p">)))</span>
</span><span id="ProcessADCP.make_start_ddays-729"><a href="#ProcessADCP.make_start_ddays-729"><span class="linenos">729</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pings_per_burst</span><span class="si">}</span><span class="s2"> pings per burst&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-730"><a href="#ProcessADCP.make_start_ddays-730"><span class="linenos">730</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> bursts total&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.make_start_ddays-731"><a href="#ProcessADCP.make_start_ddays-731"><span class="linenos">731</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="n">pings_per_burst</span> <span class="o">+</span> <span class="n">burst_dt</span> <span class="o">*</span> <span class="mi">3</span>
</span><span id="ProcessADCP.make_start_ddays-732"><a href="#ProcessADCP.make_start_ddays-732"><span class="linenos">732</span></a>
</span><span id="ProcessADCP.make_start_ddays-733"><a href="#ProcessADCP.make_start_ddays-733"><span class="linenos">733</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.make_start_ddays-734"><a href="#ProcessADCP.make_start_ddays-734"><span class="linenos">734</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span> <span class="o">=</span> <span class="n">dday_end</span>
</span><span id="ProcessADCP.make_start_ddays-735"><a href="#ProcessADCP.make_start_ddays-735"><span class="linenos">735</span></a>
</span><span id="ProcessADCP.make_start_ddays-736"><a href="#ProcessADCP.make_start_ddays-736"><span class="linenos">736</span></a>            <span class="c1"># Time stamps in the middle of the burst</span>
</span><span id="ProcessADCP.make_start_ddays-737"><a href="#ProcessADCP.make_start_ddays-737"><span class="linenos">737</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span> <span class="o">+</span> <span class="n">pings_per_burst</span> <span class="o">*</span> <span class="n">burst_dt</span> <span class="o">/</span> <span class="mi">2</span>
</span></pre></div>


            <div class="docstring"><p>Generate time stamps for ping averaging.</p>

<h6 id="notes">Notes</h6>

<p>If turning on burst averaging, other input values will be ignored and
the averaging interval will be determined from the burst sampling
scheme apparent in the ping pattern.</p>
</div>


                            </div>
                            <div id="ProcessADCP.read_ensemble" class="classattr">
                                        <input id="ProcessADCP.read_ensemble-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read_ensemble</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">iens</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.read_ensemble-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.read_ensemble"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.read_ensemble-739"><a href="#ProcessADCP.read_ensemble-739"><span class="linenos">739</span></a>    <span class="k">def</span> <span class="nf">read_ensemble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iens</span><span class="p">):</span>
</span><span id="ProcessADCP.read_ensemble-740"><a href="#ProcessADCP.read_ensemble-740"><span class="linenos">740</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Read ensembles (several individual pings grouped together).</span>
</span><span id="ProcessADCP.read_ensemble-741"><a href="#ProcessADCP.read_ensemble-741"><span class="linenos">741</span></a>
</span><span id="ProcessADCP.read_ensemble-742"><a href="#ProcessADCP.read_ensemble-742"><span class="linenos">742</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.read_ensemble-743"><a href="#ProcessADCP.read_ensemble-743"><span class="linenos">743</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.read_ensemble-744"><a href="#ProcessADCP.read_ensemble-744"><span class="linenos">744</span></a><span class="sd">        iens : int</span>
</span><span id="ProcessADCP.read_ensemble-745"><a href="#ProcessADCP.read_ensemble-745"><span class="linenos">745</span></a><span class="sd">            Index into ensemble start times (they are generated in</span>
</span><span id="ProcessADCP.read_ensemble-746"><a href="#ProcessADCP.read_ensemble-746"><span class="linenos">746</span></a><span class="sd">            :meth:`make_start_ddays`).</span>
</span><span id="ProcessADCP.read_ensemble-747"><a href="#ProcessADCP.read_ensemble-747"><span class="linenos">747</span></a>
</span><span id="ProcessADCP.read_ensemble-748"><a href="#ProcessADCP.read_ensemble-748"><span class="linenos">748</span></a><span class="sd">        Returns</span>
</span><span id="ProcessADCP.read_ensemble-749"><a href="#ProcessADCP.read_ensemble-749"><span class="linenos">749</span></a><span class="sd">        -------</span>
</span><span id="ProcessADCP.read_ensemble-750"><a href="#ProcessADCP.read_ensemble-750"><span class="linenos">750</span></a><span class="sd">        dat : pycurrents.adcp.rdiraw.Bunch</span>
</span><span id="ProcessADCP.read_ensemble-751"><a href="#ProcessADCP.read_ensemble-751"><span class="linenos">751</span></a><span class="sd">            Dictionary with data.</span>
</span><span id="ProcessADCP.read_ensemble-752"><a href="#ProcessADCP.read_ensemble-752"><span class="linenos">752</span></a>
</span><span id="ProcessADCP.read_ensemble-753"><a href="#ProcessADCP.read_ensemble-753"><span class="linenos">753</span></a><span class="sd">        Raises</span>
</span><span id="ProcessADCP.read_ensemble-754"><a href="#ProcessADCP.read_ensemble-754"><span class="linenos">754</span></a><span class="sd">        ------</span>
</span><span id="ProcessADCP.read_ensemble-755"><a href="#ProcessADCP.read_ensemble-755"><span class="linenos">755</span></a><span class="sd">        ValueError</span>
</span><span id="ProcessADCP.read_ensemble-756"><a href="#ProcessADCP.read_ensemble-756"><span class="linenos">756</span></a><span class="sd">            If `iens` is too large to index into `start_ddays`.</span>
</span><span id="ProcessADCP.read_ensemble-757"><a href="#ProcessADCP.read_ensemble-757"><span class="linenos">757</span></a>
</span><span id="ProcessADCP.read_ensemble-758"><a href="#ProcessADCP.read_ensemble-758"><span class="linenos">758</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.read_ensemble-759"><a href="#ProcessADCP.read_ensemble-759"><span class="linenos">759</span></a>
</span><span id="ProcessADCP.read_ensemble-760"><a href="#ProcessADCP.read_ensemble-760"><span class="linenos">760</span></a>        <span class="k">if</span> <span class="n">iens</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ProcessADCP.read_ensemble-761"><a href="#ProcessADCP.read_ensemble-761"><span class="linenos">761</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ens num </span><span class="si">%d</span><span class="s2"> is out of range&quot;</span> <span class="o">%</span> <span class="n">iens</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-762"><a href="#ProcessADCP.read_ensemble-762"><span class="linenos">762</span></a>
</span><span id="ProcessADCP.read_ensemble-763"><a href="#ProcessADCP.read_ensemble-763"><span class="linenos">763</span></a>        <span class="c1"># Get indices within the interval</span>
</span><span id="ProcessADCP.read_ensemble-764"><a href="#ProcessADCP.read_ensemble-764"><span class="linenos">764</span></a>        <span class="n">sl</span> <span class="o">=</span> <span class="n">rangeslice</span><span class="p">(</span>
</span><span id="ProcessADCP.read_ensemble-765"><a href="#ProcessADCP.read_ensemble-765"><span class="linenos">765</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">iens</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">iens</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
</span><span id="ProcessADCP.read_ensemble-766"><a href="#ProcessADCP.read_ensemble-766"><span class="linenos">766</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-767"><a href="#ProcessADCP.read_ensemble-767"><span class="linenos">767</span></a>        <span class="c1"># Use the indices to extract data</span>
</span><span id="ProcessADCP.read_ensemble-768"><a href="#ProcessADCP.read_ensemble-768"><span class="linenos">768</span></a>        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">sl</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-769"><a href="#ProcessADCP.read_ensemble-769"><span class="linenos">769</span></a>        <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.read_ensemble-770"><a href="#ProcessADCP.read_ensemble-770"><span class="linenos">770</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ProcessADCP.read_ensemble-771"><a href="#ProcessADCP.read_ensemble-771"><span class="linenos">771</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">dday_orig</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">dday</span>
</span><span id="ProcessADCP.read_ensemble-772"><a href="#ProcessADCP.read_ensemble-772"><span class="linenos">772</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">dday_orig</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-773"><a href="#ProcessADCP.read_ensemble-773"><span class="linenos">773</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.read_ensemble-774"><a href="#ProcessADCP.read_ensemble-774"><span class="linenos">774</span></a>            <span class="c1"># Replace pressure if provided</span>
</span><span id="ProcessADCP.read_ensemble-775"><a href="#ProcessADCP.read_ensemble-775"><span class="linenos">775</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-776"><a href="#ProcessADCP.read_ensemble-776"><span class="linenos">776</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_burst_average</span><span class="p">:</span>
</span><span id="ProcessADCP.read_ensemble-777"><a href="#ProcessADCP.read_ensemble-777"><span class="linenos">777</span></a>            <span class="c1"># Use raw pressure</span>
</span><span id="ProcessADCP.read_ensemble-778"><a href="#ProcessADCP.read_ensemble-778"><span class="linenos">778</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-779"><a href="#ProcessADCP.read_ensemble-779"><span class="linenos">779</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_raw_pressure</span><span class="p">:</span>
</span><span id="ProcessADCP.read_ensemble-780"><a href="#ProcessADCP.read_ensemble-780"><span class="linenos">780</span></a>            <span class="c1"># Use raw pressure</span>
</span><span id="ProcessADCP.read_ensemble-781"><a href="#ProcessADCP.read_ensemble-781"><span class="linenos">781</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-782"><a href="#ProcessADCP.read_ensemble-782"><span class="linenos">782</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.read_ensemble-783"><a href="#ProcessADCP.read_ensemble-783"><span class="linenos">783</span></a>            <span class="c1"># Use low-pass filtered pressure</span>
</span><span id="ProcessADCP.read_ensemble-784"><a href="#ProcessADCP.read_ensemble-784"><span class="linenos">784</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">ens_num</span> <span class="o">&gt;=</span> <span class="n">dat</span><span class="o">.</span><span class="n">ens_num</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
</span><span id="ProcessADCP.read_ensemble-785"><a href="#ProcessADCP.read_ensemble-785"><span class="linenos">785</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">ens_num</span> <span class="o">&lt;=</span> <span class="n">dat</span><span class="o">.</span><span class="n">ens_num</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP.read_ensemble-786"><a href="#ProcessADCP.read_ensemble-786"><span class="linenos">786</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-787"><a href="#ProcessADCP.read_ensemble-787"><span class="linenos">787</span></a>            <span class="n">dat</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_lp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="ProcessADCP.read_ensemble-788"><a href="#ProcessADCP.read_ensemble-788"><span class="linenos">788</span></a>
</span><span id="ProcessADCP.read_ensemble-789"><a href="#ProcessADCP.read_ensemble-789"><span class="linenos">789</span></a>        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="ProcessADCP.read_ensemble-790"><a href="#ProcessADCP.read_ensemble-790"><span class="linenos">790</span></a>        <span class="n">pdepth</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP.read_ensemble-791"><a href="#ProcessADCP.read_ensemble-791"><span class="linenos">791</span></a>        <span class="n">dat</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">dat</span><span class="o">.</span><span class="n">dep</span>
</span><span id="ProcessADCP.read_ensemble-792"><a href="#ProcessADCP.read_ensemble-792"><span class="linenos">792</span></a>        <span class="k">return</span> <span class="n">dat</span>
</span></pre></div>


            <div class="docstring"><p>Read ensembles (several individual pings grouped together).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>iens</strong> (int):
Index into ensemble start times (they are generated in
<code><a href="#ProcessADCP.make_start_ddays">make_start_ddays()</a></code>).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dat</strong> (pycurrents.adcp.rdiraw.Bunch):
Dictionary with data.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If <code>iens</code> is too large to index into <code>start_ddays</code>.</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.magdec" class="classattr">
                                        <input id="ProcessADCP.magdec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">magdec</span>

                <label class="view-source-button" for="ProcessADCP.magdec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.magdec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.magdec-794"><a href="#ProcessADCP.magdec-794"><span class="linenos">794</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP.magdec-795"><a href="#ProcessADCP.magdec-795"><span class="linenos">795</span></a>    <span class="k">def</span> <span class="nf">magdec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.magdec-796"><a href="#ProcessADCP.magdec-796"><span class="linenos">796</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Magnetic declination.</span>
</span><span id="ProcessADCP.magdec-797"><a href="#ProcessADCP.magdec-797"><span class="linenos">797</span></a>
</span><span id="ProcessADCP.magdec-798"><a href="#ProcessADCP.magdec-798"><span class="linenos">798</span></a><span class="sd">        If not provided as input argument magdec is calculated using</span>
</span><span id="ProcessADCP.magdec-799"><a href="#ProcessADCP.magdec-799"><span class="linenos">799</span></a><span class="sd">        [magdec](https://currents.soest.hawaii.edu/hgstage/geomag/file/tip)</span>
</span><span id="ProcessADCP.magdec-800"><a href="#ProcessADCP.magdec-800"><span class="linenos">800</span></a><span class="sd">        (must be installed) based on `lon` and `lat`.</span>
</span><span id="ProcessADCP.magdec-801"><a href="#ProcessADCP.magdec-801"><span class="linenos">801</span></a>
</span><span id="ProcessADCP.magdec-802"><a href="#ProcessADCP.magdec-802"><span class="linenos">802</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.magdec-803"><a href="#ProcessADCP.magdec-803"><span class="linenos">803</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-804"><a href="#ProcessADCP.magdec-804"><span class="linenos">804</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-805"><a href="#ProcessADCP.magdec-805"><span class="linenos">805</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="ProcessADCP.magdec-806"><a href="#ProcessADCP.magdec-806"><span class="linenos">806</span></a>                    <span class="s2">&quot;No lon/lat provided, cannot calculate magnetic declination.&quot;</span>
</span><span id="ProcessADCP.magdec-807"><a href="#ProcessADCP.magdec-807"><span class="linenos">807</span></a>                <span class="p">)</span>
</span><span id="ProcessADCP.magdec-808"><a href="#ProcessADCP.magdec-808"><span class="linenos">808</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ProcessADCP.magdec-809"><a href="#ProcessADCP.magdec-809"><span class="linenos">809</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-810"><a href="#ProcessADCP.magdec-810"><span class="linenos">810</span></a>                <span class="c1"># Look for magdec executable</span>
</span><span id="ProcessADCP.magdec-811"><a href="#ProcessADCP.magdec-811"><span class="linenos">811</span></a>                <span class="n">magdec_found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ProcessADCP.magdec-812"><a href="#ProcessADCP.magdec-812"><span class="linenos">812</span></a>                <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s2">&quot;magdec&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-813"><a href="#ProcessADCP.magdec-813"><span class="linenos">813</span></a>
</span><span id="ProcessADCP.magdec-814"><a href="#ProcessADCP.magdec-814"><span class="linenos">814</span></a>                <span class="k">if</span> <span class="n">magdec_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-815"><a href="#ProcessADCP.magdec-815"><span class="linenos">815</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="ProcessADCP.magdec-816"><a href="#ProcessADCP.magdec-816"><span class="linenos">816</span></a>                    <span class="n">package_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-817"><a href="#ProcessADCP.magdec-817"><span class="linenos">817</span></a>
</span><span id="ProcessADCP.magdec-818"><a href="#ProcessADCP.magdec-818"><span class="linenos">818</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-819"><a href="#ProcessADCP.magdec-819"><span class="linenos">819</span></a>                    <span class="c1"># Try this package directory</span>
</span><span id="ProcessADCP.magdec-820"><a href="#ProcessADCP.magdec-820"><span class="linenos">820</span></a>                    <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;magdec&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-821"><a href="#ProcessADCP.magdec-821"><span class="linenos">821</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">magdec_path</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-822"><a href="#ProcessADCP.magdec-822"><span class="linenos">822</span></a>
</span><span id="ProcessADCP.magdec-823"><a href="#ProcessADCP.magdec-823"><span class="linenos">823</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-824"><a href="#ProcessADCP.magdec-824"><span class="linenos">824</span></a>                    <span class="c1"># Try the magdec installation directory</span>
</span><span id="ProcessADCP.magdec-825"><a href="#ProcessADCP.magdec-825"><span class="linenos">825</span></a>                    <span class="n">magdec_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
</span><span id="ProcessADCP.magdec-826"><a href="#ProcessADCP.magdec-826"><span class="linenos">826</span></a>                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s2">&quot;../geomag/magdec&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-827"><a href="#ProcessADCP.magdec-827"><span class="linenos">827</span></a>                    <span class="p">)</span>
</span><span id="ProcessADCP.magdec-828"><a href="#ProcessADCP.magdec-828"><span class="linenos">828</span></a>                    <span class="n">magdec_found</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">magdec_path</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-829"><a href="#ProcessADCP.magdec-829"><span class="linenos">829</span></a>
</span><span id="ProcessADCP.magdec-830"><a href="#ProcessADCP.magdec-830"><span class="linenos">830</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">magdec_found</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-831"><a href="#ProcessADCP.magdec-831"><span class="linenos">831</span></a>                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
</span><span id="ProcessADCP.magdec-832"><a href="#ProcessADCP.magdec-832"><span class="linenos">832</span></a>                        <span class="s2">&quot;Cannot find program magdec on the system path or paths within velosearaptor.&quot;</span>
</span><span id="ProcessADCP.magdec-833"><a href="#ProcessADCP.magdec-833"><span class="linenos">833</span></a>                    <span class="p">)</span>
</span><span id="ProcessADCP.magdec-834"><a href="#ProcessADCP.magdec-834"><span class="linenos">834</span></a>
</span><span id="ProcessADCP.magdec-835"><a href="#ProcessADCP.magdec-835"><span class="linenos">835</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magdec found at </span><span class="si">{</span><span class="n">magdec_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-836"><a href="#ProcessADCP.magdec-836"><span class="linenos">836</span></a>
</span><span id="ProcessADCP.magdec-837"><a href="#ProcessADCP.magdec-837"><span class="linenos">837</span></a>                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-838"><a href="#ProcessADCP.magdec-838"><span class="linenos">838</span></a>                <span class="n">dday_mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">[</span><span class="n">n</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="ProcessADCP.magdec-839"><a href="#ProcessADCP.magdec-839"><span class="linenos">839</span></a>                <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span> <span class="n">dday_mid</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ProcessADCP.magdec-840"><a href="#ProcessADCP.magdec-840"><span class="linenos">840</span></a>
</span><span id="ProcessADCP.magdec-841"><a href="#ProcessADCP.magdec-841"><span class="linenos">841</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span>
</span><span id="ProcessADCP.magdec-842"><a href="#ProcessADCP.magdec-842"><span class="linenos">842</span></a>                    <span class="p">[</span>
</span><span id="ProcessADCP.magdec-843"><a href="#ProcessADCP.magdec-843"><span class="linenos">843</span></a>                        <span class="n">magdec_path</span><span class="p">,</span>
</span><span id="ProcessADCP.magdec-844"><a href="#ProcessADCP.magdec-844"><span class="linenos">844</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span>
</span><span id="ProcessADCP.magdec-845"><a href="#ProcessADCP.magdec-845"><span class="linenos">845</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span>
</span><span id="ProcessADCP.magdec-846"><a href="#ProcessADCP.magdec-846"><span class="linenos">846</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
</span><span id="ProcessADCP.magdec-847"><a href="#ProcessADCP.magdec-847"><span class="linenos">847</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
</span><span id="ProcessADCP.magdec-848"><a href="#ProcessADCP.magdec-848"><span class="linenos">848</span></a>                        <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
</span><span id="ProcessADCP.magdec-849"><a href="#ProcessADCP.magdec-849"><span class="linenos">849</span></a>                    <span class="p">],</span>
</span><span id="ProcessADCP.magdec-850"><a href="#ProcessADCP.magdec-850"><span class="linenos">850</span></a>                    <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="ProcessADCP.magdec-851"><a href="#ProcessADCP.magdec-851"><span class="linenos">851</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.magdec-852"><a href="#ProcessADCP.magdec-852"><span class="linenos">852</span></a>                <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="ProcessADCP.magdec-853"><a href="#ProcessADCP.magdec-853"><span class="linenos">853</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;magdec output is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-854"><a href="#ProcessADCP.magdec-854"><span class="linenos">854</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ProcessADCP.magdec-855"><a href="#ProcessADCP.magdec-855"><span class="linenos">855</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.magdec-856"><a href="#ProcessADCP.magdec-856"><span class="linenos">856</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magdec </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_magdec_provided</span><span class="si">}</span><span class="s2"> provided.&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.magdec-857"><a href="#ProcessADCP.magdec-857"><span class="linenos">857</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_magdec</span>
</span></pre></div>


            <div class="docstring"><p>Magnetic declination.</p>

<p>If not provided as input argument magdec is calculated using
<a href="https://currents.soest.hawaii.edu/hgstage/geomag/file/tip">magdec</a>
(must be installed) based on <code>lon</code> and <code>lat</code>.</p>
</div>


                            </div>
                            <div id="ProcessADCP.raw" class="classattr">
                                        <input id="ProcessADCP.raw-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">raw</span>

                <label class="view-source-button" for="ProcessADCP.raw-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.raw"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.raw-859"><a href="#ProcessADCP.raw-859"><span class="linenos">859</span></a>    <span class="nd">@property</span>
</span><span id="ProcessADCP.raw-860"><a href="#ProcessADCP.raw-860"><span class="linenos">860</span></a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.raw-861"><a href="#ProcessADCP.raw-861"><span class="linenos">861</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Raw ADCP data.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP.raw-862"><a href="#ProcessADCP.raw-862"><span class="linenos">862</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.raw-863"><a href="#ProcessADCP.raw-863"><span class="linenos">863</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading raw data...&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.raw-864"><a href="#ProcessADCP.raw-864"><span class="linenos">864</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read_raw_rdi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
</span><span id="ProcessADCP.raw-865"><a href="#ProcessADCP.raw-865"><span class="linenos">865</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
</span><span id="ProcessADCP.raw-866"><a href="#ProcessADCP.raw-866"><span class="linenos">866</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span>
</span></pre></div>


            <div class="docstring"><p>Raw ADCP data.</p>
</div>


                            </div>
                            <div id="ProcessADCP.process_pings" class="classattr">
                                        <input id="ProcessADCP.process_pings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_pings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">stop</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">binmap</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">ens_size</span><span class="o">=</span><span class="mi">50000</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.process_pings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.process_pings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.process_pings-1059"><a href="#ProcessADCP.process_pings-1059"><span class="linenos">1059</span></a>    <span class="k">def</span> <span class="nf">process_pings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">binmap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ens_size</span><span class="o">=</span><span class="mi">50000</span><span class="p">):</span>
</span><span id="ProcessADCP.process_pings-1060"><a href="#ProcessADCP.process_pings-1060"><span class="linenos">1060</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process single ping data without averaging.</span>
</span><span id="ProcessADCP.process_pings-1061"><a href="#ProcessADCP.process_pings-1061"><span class="linenos">1061</span></a>
</span><span id="ProcessADCP.process_pings-1062"><a href="#ProcessADCP.process_pings-1062"><span class="linenos">1062</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="ProcessADCP.process_pings-1063"><a href="#ProcessADCP.process_pings-1063"><span class="linenos">1063</span></a>
</span><span id="ProcessADCP.process_pings-1064"><a href="#ProcessADCP.process_pings-1064"><span class="linenos">1064</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="ProcessADCP.process_pings-1065"><a href="#ProcessADCP.process_pings-1065"><span class="linenos">1065</span></a>
</span><span id="ProcessADCP.process_pings-1066"><a href="#ProcessADCP.process_pings-1066"><span class="linenos">1066</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.process_pings-1067"><a href="#ProcessADCP.process_pings-1067"><span class="linenos">1067</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.process_pings-1068"><a href="#ProcessADCP.process_pings-1068"><span class="linenos">1068</span></a><span class="sd">        start : int, optional</span>
</span><span id="ProcessADCP.process_pings-1069"><a href="#ProcessADCP.process_pings-1069"><span class="linenos">1069</span></a><span class="sd">            Start processing at this ping number.</span>
</span><span id="ProcessADCP.process_pings-1070"><a href="#ProcessADCP.process_pings-1070"><span class="linenos">1070</span></a><span class="sd">        stop : int, optional</span>
</span><span id="ProcessADCP.process_pings-1071"><a href="#ProcessADCP.process_pings-1071"><span class="linenos">1071</span></a><span class="sd">            Stop processing at this ping number.</span>
</span><span id="ProcessADCP.process_pings-1072"><a href="#ProcessADCP.process_pings-1072"><span class="linenos">1072</span></a><span class="sd">        binmap : bool, optional</span>
</span><span id="ProcessADCP.process_pings-1073"><a href="#ProcessADCP.process_pings-1073"><span class="linenos">1073</span></a><span class="sd">            Do binmapping of along-beam data.</span>
</span><span id="ProcessADCP.process_pings-1074"><a href="#ProcessADCP.process_pings-1074"><span class="linenos">1074</span></a><span class="sd">        ens_size : int, optional</span>
</span><span id="ProcessADCP.process_pings-1075"><a href="#ProcessADCP.process_pings-1075"><span class="linenos">1075</span></a><span class="sd">            Pings are processed in ensembles to reduce memory usage.</span>
</span><span id="ProcessADCP.process_pings-1076"><a href="#ProcessADCP.process_pings-1076"><span class="linenos">1076</span></a><span class="sd">            This parameter sets how many pings are in an ensemble. The default is 50000.</span>
</span><span id="ProcessADCP.process_pings-1077"><a href="#ProcessADCP.process_pings-1077"><span class="linenos">1077</span></a>
</span><span id="ProcessADCP.process_pings-1078"><a href="#ProcessADCP.process_pings-1078"><span class="linenos">1078</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.process_pings-1079"><a href="#ProcessADCP.process_pings-1079"><span class="linenos">1079</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1080"><a href="#ProcessADCP.process_pings-1080"><span class="linenos">1080</span></a>            <span class="n">idx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_start</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1081"><a href="#ProcessADCP.process_pings-1081"><span class="linenos">1081</span></a>        <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1082"><a href="#ProcessADCP.process_pings-1082"><span class="linenos">1082</span></a>            <span class="n">idx_stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_end</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1083"><a href="#ProcessADCP.process_pings-1083"><span class="linenos">1083</span></a>
</span><span id="ProcessADCP.process_pings-1084"><a href="#ProcessADCP.process_pings-1084"><span class="linenos">1084</span></a>        <span class="n">ens_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idx_start</span><span class="p">,</span> <span class="n">idx_stop</span><span class="p">,</span> <span class="n">ens_size</span><span class="p">),</span> <span class="n">idx_stop</span><span class="p">))</span>
</span><span id="ProcessADCP.process_pings-1085"><a href="#ProcessADCP.process_pings-1085"><span class="linenos">1085</span></a>        <span class="n">write_idxs</span> <span class="o">=</span> <span class="n">ens_idxs</span> <span class="o">-</span> <span class="n">ens_idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Arrays we write to start at index 0</span>
</span><span id="ProcessADCP.process_pings-1086"><a href="#ProcessADCP.process_pings-1086"><span class="linenos">1086</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">idx_stop</span> <span class="o">-</span> <span class="n">idx_start</span>
</span><span id="ProcessADCP.process_pings-1087"><a href="#ProcessADCP.process_pings-1087"><span class="linenos">1087</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="n">ens_idxs</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="ProcessADCP.process_pings-1088"><a href="#ProcessADCP.process_pings-1088"><span class="linenos">1088</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">dep</span><span class="o">.</span><span class="n">size</span>
</span><span id="ProcessADCP.process_pings-1089"><a href="#ProcessADCP.process_pings-1089"><span class="linenos">1089</span></a>
</span><span id="ProcessADCP.process_pings-1090"><a href="#ProcessADCP.process_pings-1090"><span class="linenos">1090</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing all pings&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1091"><a href="#ProcessADCP.process_pings-1091"><span class="linenos">1091</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binmapping is </span><span class="si">{</span><span class="n">binmap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1092"><a href="#ProcessADCP.process_pings-1092"><span class="linenos">1092</span></a>
</span><span id="ProcessADCP.process_pings-1093"><a href="#ProcessADCP.process_pings-1093"><span class="linenos">1093</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1094"><a href="#ProcessADCP.process_pings-1094"><span class="linenos">1094</span></a>
</span><span id="ProcessADCP.process_pings-1095"><a href="#ProcessADCP.process_pings-1095"><span class="linenos">1095</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1096"><a href="#ProcessADCP.process_pings-1096"><span class="linenos">1096</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npings</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1097"><a href="#ProcessADCP.process_pings-1097"><span class="linenos">1097</span></a>
</span><span id="ProcessADCP.process_pings-1098"><a href="#ProcessADCP.process_pings-1098"><span class="linenos">1098</span></a>        <span class="c1"># temperature = np.ma.zeros((npings,), dtype=np.float32)</span>
</span><span id="ProcessADCP.process_pings-1099"><a href="#ProcessADCP.process_pings-1099"><span class="linenos">1099</span></a>        <span class="c1"># pressure = np.ma.zeros((npings,), dtype=np.float32)</span>
</span><span id="ProcessADCP.process_pings-1100"><a href="#ProcessADCP.process_pings-1100"><span class="linenos">1100</span></a>
</span><span id="ProcessADCP.process_pings-1101"><a href="#ProcessADCP.process_pings-1101"><span class="linenos">1101</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">temperature</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="ProcessADCP.process_pings-1102"><a href="#ProcessADCP.process_pings-1102"><span class="linenos">1102</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsdat</span><span class="o">.</span><span class="n">pressure</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="ProcessADCP.process_pings-1103"><a href="#ProcessADCP.process_pings-1103"><span class="linenos">1103</span></a>
</span><span id="ProcessADCP.process_pings-1104"><a href="#ProcessADCP.process_pings-1104"><span class="linenos">1104</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday</span><span class="p">[</span><span class="n">idx_start</span><span class="p">:</span><span class="n">idx_stop</span><span class="p">]</span>
</span><span id="ProcessADCP.process_pings-1105"><a href="#ProcessADCP.process_pings-1105"><span class="linenos">1105</span></a>
</span><span id="ProcessADCP.process_pings-1106"><a href="#ProcessADCP.process_pings-1106"><span class="linenos">1106</span></a>        <span class="c1"># Loop over ensembles</span>
</span><span id="ProcessADCP.process_pings-1107"><a href="#ProcessADCP.process_pings-1107"><span class="linenos">1107</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nens</span><span class="p">)):</span>
</span><span id="ProcessADCP.process_pings-1108"><a href="#ProcessADCP.process_pings-1108"><span class="linenos">1108</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">ens_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">stop</span><span class="o">=</span><span class="n">ens_idxs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="ProcessADCP.process_pings-1109"><a href="#ProcessADCP.process_pings-1109"><span class="linenos">1109</span></a>            <span class="n">idx0</span> <span class="o">=</span> <span class="n">write_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="ProcessADCP.process_pings-1110"><a href="#ProcessADCP.process_pings-1110"><span class="linenos">1110</span></a>            <span class="n">idx1</span> <span class="o">=</span> <span class="n">write_idxs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="ProcessADCP.process_pings-1111"><a href="#ProcessADCP.process_pings-1111"><span class="linenos">1111</span></a>
</span><span id="ProcessADCP.process_pings-1112"><a href="#ProcessADCP.process_pings-1112"><span class="linenos">1112</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1113"><a href="#ProcessADCP.process_pings-1113"><span class="linenos">1113</span></a>                <span class="c1"># I pulled this out of read_ensembles because we need to</span>
</span><span id="ProcessADCP.process_pings-1114"><a href="#ProcessADCP.process_pings-1114"><span class="linenos">1114</span></a>                <span class="c1"># calculate depth for _ave2nc to work.</span>
</span><span id="ProcessADCP.process_pings-1115"><a href="#ProcessADCP.process_pings-1115"><span class="linenos">1115</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dday_orig</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">dday</span>
</span><span id="ProcessADCP.process_pings-1116"><a href="#ProcessADCP.process_pings-1116"><span class="linenos">1116</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_dday</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">dday_orig</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1117"><a href="#ProcessADCP.process_pings-1117"><span class="linenos">1117</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure_provided</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1118"><a href="#ProcessADCP.process_pings-1118"><span class="linenos">1118</span></a>                    <span class="c1"># Replace pressure if provided</span>
</span><span id="ProcessADCP.process_pings-1119"><a href="#ProcessADCP.process_pings-1119"><span class="linenos">1119</span></a>                    <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_pressure_to_dat</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1120"><a href="#ProcessADCP.process_pings-1120"><span class="linenos">1120</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1121"><a href="#ProcessADCP.process_pings-1121"><span class="linenos">1121</span></a>                    <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_pycurrents_pressure</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1122"><a href="#ProcessADCP.process_pings-1122"><span class="linenos">1122</span></a>                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="s2">&quot;up&quot;</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="ProcessADCP.process_pings-1123"><a href="#ProcessADCP.process_pings-1123"><span class="linenos">1123</span></a>                <span class="n">pdepth</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">depth2</span><span class="p">(</span><span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1124"><a href="#ProcessADCP.process_pings-1124"><span class="linenos">1124</span></a>                <span class="n">ens</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">pdepth</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">dep</span>
</span><span id="ProcessADCP.process_pings-1125"><a href="#ProcessADCP.process_pings-1125"><span class="linenos">1125</span></a>
</span><span id="ProcessADCP.process_pings-1126"><a href="#ProcessADCP.process_pings-1126"><span class="linenos">1126</span></a>                <span class="k">if</span> <span class="n">binmap</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1127"><a href="#ProcessADCP.process_pings-1127"><span class="linenos">1127</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_binmap_all_beams</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1128"><a href="#ProcessADCP.process_pings-1128"><span class="linenos">1128</span></a>                    <span class="c1"># Now we have to recalculate xyze with the binmapped data.</span>
</span><span id="ProcessADCP.process_pings-1129"><a href="#ProcessADCP.process_pings-1129"><span class="linenos">1129</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_xyze</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1130"><a href="#ProcessADCP.process_pings-1130"><span class="linenos">1130</span></a>
</span><span id="ProcessADCP.process_pings-1131"><a href="#ProcessADCP.process_pings-1131"><span class="linenos">1131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="ProcessADCP.process_pings-1132"><a href="#ProcessADCP.process_pings-1132"><span class="linenos">1132</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="ProcessADCP.process_pings-1133"><a href="#ProcessADCP.process_pings-1133"><span class="linenos">1133</span></a>
</span><span id="ProcessADCP.process_pings-1134"><a href="#ProcessADCP.process_pings-1134"><span class="linenos">1134</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.process_pings-1135"><a href="#ProcessADCP.process_pings-1135"><span class="linenos">1135</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.process_pings-1136"><a href="#ProcessADCP.process_pings-1136"><span class="linenos">1136</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.process_pings-1137"><a href="#ProcessADCP.process_pings-1137"><span class="linenos">1137</span></a>                <span class="c1"># pressure[idx0:idx1] = np.ma.masked</span>
</span><span id="ProcessADCP.process_pings-1138"><a href="#ProcessADCP.process_pings-1138"><span class="linenos">1138</span></a>                <span class="c1"># temperature[idx0:idx1] = np.ma.masked</span>
</span><span id="ProcessADCP.process_pings-1139"><a href="#ProcessADCP.process_pings-1139"><span class="linenos">1139</span></a>                <span class="k">continue</span>
</span><span id="ProcessADCP.process_pings-1140"><a href="#ProcessADCP.process_pings-1140"><span class="linenos">1140</span></a>
</span><span id="ProcessADCP.process_pings-1141"><a href="#ProcessADCP.process_pings-1141"><span class="linenos">1141</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span>
</span><span id="ProcessADCP.process_pings-1142"><a href="#ProcessADCP.process_pings-1142"><span class="linenos">1142</span></a>
</span><span id="ProcessADCP.process_pings-1143"><a href="#ProcessADCP.process_pings-1143"><span class="linenos">1143</span></a>            <span class="c1"># pgi = 100 * ens.enu_grid[..., 0].count(axis=0) // nprofs</span>
</span><span id="ProcessADCP.process_pings-1144"><a href="#ProcessADCP.process_pings-1144"><span class="linenos">1144</span></a>            <span class="c1"># pg[i] = pgi.astype(np.int8)</span>
</span><span id="ProcessADCP.process_pings-1145"><a href="#ProcessADCP.process_pings-1145"><span class="linenos">1145</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Average over beams... why?</span>
</span><span id="ProcessADCP.process_pings-1146"><a href="#ProcessADCP.process_pings-1146"><span class="linenos">1146</span></a>
</span><span id="ProcessADCP.process_pings-1147"><a href="#ProcessADCP.process_pings-1147"><span class="linenos">1147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="ProcessADCP.process_pings-1148"><a href="#ProcessADCP.process_pings-1148"><span class="linenos">1148</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP.process_pings-1149"><a href="#ProcessADCP.process_pings-1149"><span class="linenos">1149</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP.process_pings-1150"><a href="#ProcessADCP.process_pings-1150"><span class="linenos">1150</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP.process_pings-1151"><a href="#ProcessADCP.process_pings-1151"><span class="linenos">1151</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP.process_pings-1152"><a href="#ProcessADCP.process_pings-1152"><span class="linenos">1152</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1153"><a href="#ProcessADCP.process_pings-1153"><span class="linenos">1153</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1154"><a href="#ProcessADCP.process_pings-1154"><span class="linenos">1154</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1155"><a href="#ProcessADCP.process_pings-1155"><span class="linenos">1155</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1156"><a href="#ProcessADCP.process_pings-1156"><span class="linenos">1156</span></a>            <span class="c1"># npings=npings,</span>
</span><span id="ProcessADCP.process_pings-1157"><a href="#ProcessADCP.process_pings-1157"><span class="linenos">1157</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1158"><a href="#ProcessADCP.process_pings-1158"><span class="linenos">1158</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1159"><a href="#ProcessADCP.process_pings-1159"><span class="linenos">1159</span></a>            <span class="n">dep</span><span class="o">=</span><span class="n">ens</span><span class="o">.</span><span class="n">dep</span><span class="p">,</span>  <span class="c1"># &lt;&lt;&lt;&lt;----- BAD!!! This a fudge because I don&#39;t want to calculated a depth vector. We use the depth vector from the last ensemble.</span>
</span><span id="ProcessADCP.process_pings-1160"><a href="#ProcessADCP.process_pings-1160"><span class="linenos">1160</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1161"><a href="#ProcessADCP.process_pings-1161"><span class="linenos">1161</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1162"><a href="#ProcessADCP.process_pings-1162"><span class="linenos">1162</span></a>            <span class="c1"># dgridparams=self.dgridparams,</span>
</span><span id="ProcessADCP.process_pings-1163"><a href="#ProcessADCP.process_pings-1163"><span class="linenos">1163</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1164"><a href="#ProcessADCP.process_pings-1164"><span class="linenos">1164</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1165"><a href="#ProcessADCP.process_pings-1165"><span class="linenos">1165</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP.process_pings-1166"><a href="#ProcessADCP.process_pings-1166"><span class="linenos">1166</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.process_pings-1167"><a href="#ProcessADCP.process_pings-1167"><span class="linenos">1167</span></a>
</span><span id="ProcessADCP.process_pings-1168"><a href="#ProcessADCP.process_pings-1168"><span class="linenos">1168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="ProcessADCP.process_pings-1169"><a href="#ProcessADCP.process_pings-1169"><span class="linenos">1169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="ProcessADCP.process_pings-1170"><a href="#ProcessADCP.process_pings-1170"><span class="linenos">1170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Process single ping data without averaging.</p>

<p>Adds results as dictionary under <code>ave</code> and as <code>xarray.Dataset</code> under <code>ds</code>.</p>

<p>Writes processing parameters to the log file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>start</strong> (int, optional):
Start processing at this ping number.</li>
<li><strong>stop</strong> (int, optional):
Stop processing at this ping number.</li>
<li><strong>binmap</strong> (bool, optional):
Do binmapping of along-beam data.</li>
<li><strong>ens_size</strong> (int, optional):
Pings are processed in ensembles to reduce memory usage.
This parameter sets how many pings are in an ensemble. The default is 50000.</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.average_ensembles" class="classattr">
                                        <input id="ProcessADCP.average_ensembles-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">average_ensembles</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">stop</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.average_ensembles-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.average_ensembles"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.average_ensembles-1172"><a href="#ProcessADCP.average_ensembles-1172"><span class="linenos">1172</span></a>    <span class="k">def</span> <span class="nf">average_ensembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ProcessADCP.average_ensembles-1173"><a href="#ProcessADCP.average_ensembles-1173"><span class="linenos">1173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-averaging.</span>
</span><span id="ProcessADCP.average_ensembles-1174"><a href="#ProcessADCP.average_ensembles-1174"><span class="linenos">1174</span></a>
</span><span id="ProcessADCP.average_ensembles-1175"><a href="#ProcessADCP.average_ensembles-1175"><span class="linenos">1175</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="ProcessADCP.average_ensembles-1176"><a href="#ProcessADCP.average_ensembles-1176"><span class="linenos">1176</span></a>
</span><span id="ProcessADCP.average_ensembles-1177"><a href="#ProcessADCP.average_ensembles-1177"><span class="linenos">1177</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="ProcessADCP.average_ensembles-1178"><a href="#ProcessADCP.average_ensembles-1178"><span class="linenos">1178</span></a>
</span><span id="ProcessADCP.average_ensembles-1179"><a href="#ProcessADCP.average_ensembles-1179"><span class="linenos">1179</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.average_ensembles-1180"><a href="#ProcessADCP.average_ensembles-1180"><span class="linenos">1180</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.average_ensembles-1181"><a href="#ProcessADCP.average_ensembles-1181"><span class="linenos">1181</span></a><span class="sd">        start : int</span>
</span><span id="ProcessADCP.average_ensembles-1182"><a href="#ProcessADCP.average_ensembles-1182"><span class="linenos">1182</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP.average_ensembles-1183"><a href="#ProcessADCP.average_ensembles-1183"><span class="linenos">1183</span></a><span class="sd">            intervals.</span>
</span><span id="ProcessADCP.average_ensembles-1184"><a href="#ProcessADCP.average_ensembles-1184"><span class="linenos">1184</span></a><span class="sd">        stop : int</span>
</span><span id="ProcessADCP.average_ensembles-1185"><a href="#ProcessADCP.average_ensembles-1185"><span class="linenos">1185</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP.average_ensembles-1186"><a href="#ProcessADCP.average_ensembles-1186"><span class="linenos">1186</span></a><span class="sd">            intervals.</span>
</span><span id="ProcessADCP.average_ensembles-1187"><a href="#ProcessADCP.average_ensembles-1187"><span class="linenos">1187</span></a>
</span><span id="ProcessADCP.average_ensembles-1188"><a href="#ProcessADCP.average_ensembles-1188"><span class="linenos">1188</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.average_ensembles-1189"><a href="#ProcessADCP.average_ensembles-1189"><span class="linenos">1189</span></a>
</span><span id="ProcessADCP.average_ensembles-1190"><a href="#ProcessADCP.average_ensembles-1190"><span class="linenos">1190</span></a>        <span class="n">nens_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1191"><a href="#ProcessADCP.average_ensembles-1191"><span class="linenos">1191</span></a>        <span class="n">indices_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens_orig</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1192"><a href="#ProcessADCP.average_ensembles-1192"><span class="linenos">1192</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_orig</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP.average_ensembles-1193"><a href="#ProcessADCP.average_ensembles-1193"><span class="linenos">1193</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.average_ensembles-1194"><a href="#ProcessADCP.average_ensembles-1194"><span class="linenos">1194</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all ensembles&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1195"><a href="#ProcessADCP.average_ensembles-1195"><span class="linenos">1195</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.average_ensembles-1196"><a href="#ProcessADCP.average_ensembles-1196"><span class="linenos">1196</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaging ensembles </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1197"><a href="#ProcessADCP.average_ensembles-1197"><span class="linenos">1197</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1198"><a href="#ProcessADCP.average_ensembles-1198"><span class="linenos">1198</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1199"><a href="#ProcessADCP.average_ensembles-1199"><span class="linenos">1199</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1200"><a href="#ProcessADCP.average_ensembles-1200"><span class="linenos">1200</span></a>        <span class="n">uvwe_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1201"><a href="#ProcessADCP.average_ensembles-1201"><span class="linenos">1201</span></a>
</span><span id="ProcessADCP.average_ensembles-1202"><a href="#ProcessADCP.average_ensembles-1202"><span class="linenos">1202</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1203"><a href="#ProcessADCP.average_ensembles-1203"><span class="linenos">1203</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1204"><a href="#ProcessADCP.average_ensembles-1204"><span class="linenos">1204</span></a>
</span><span id="ProcessADCP.average_ensembles-1205"><a href="#ProcessADCP.average_ensembles-1205"><span class="linenos">1205</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1206"><a href="#ProcessADCP.average_ensembles-1206"><span class="linenos">1206</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1207"><a href="#ProcessADCP.average_ensembles-1207"><span class="linenos">1207</span></a>        <span class="n">pressure_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1208"><a href="#ProcessADCP.average_ensembles-1208"><span class="linenos">1208</span></a>        <span class="n">pressure_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1209"><a href="#ProcessADCP.average_ensembles-1209"><span class="linenos">1209</span></a>
</span><span id="ProcessADCP.average_ensembles-1210"><a href="#ProcessADCP.average_ensembles-1210"><span class="linenos">1210</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1211"><a href="#ProcessADCP.average_ensembles-1211"><span class="linenos">1211</span></a>
</span><span id="ProcessADCP.average_ensembles-1212"><a href="#ProcessADCP.average_ensembles-1212"><span class="linenos">1212</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP.average_ensembles-1213"><a href="#ProcessADCP.average_ensembles-1213"><span class="linenos">1213</span></a>
</span><span id="ProcessADCP.average_ensembles-1214"><a href="#ProcessADCP.average_ensembles-1214"><span class="linenos">1214</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
</span><span id="ProcessADCP.average_ensembles-1215"><a href="#ProcessADCP.average_ensembles-1215"><span class="linenos">1215</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ensemble</span><span class="p">(</span><span class="n">iens</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1216"><a href="#ProcessADCP.average_ensembles-1216"><span class="linenos">1216</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.average_ensembles-1217"><a href="#ProcessADCP.average_ensembles-1217"><span class="linenos">1217</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="ProcessADCP.average_ensembles-1218"><a href="#ProcessADCP.average_ensembles-1218"><span class="linenos">1218</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="ProcessADCP.average_ensembles-1219"><a href="#ProcessADCP.average_ensembles-1219"><span class="linenos">1219</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1220"><a href="#ProcessADCP.average_ensembles-1220"><span class="linenos">1220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_amp</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1221"><a href="#ProcessADCP.average_ensembles-1221"><span class="linenos">1221</span></a>
</span><span id="ProcessADCP.average_ensembles-1222"><a href="#ProcessADCP.average_ensembles-1222"><span class="linenos">1222</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.average_ensembles-1223"><a href="#ProcessADCP.average_ensembles-1223"><span class="linenos">1223</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.average_ensembles-1224"><a href="#ProcessADCP.average_ensembles-1224"><span class="linenos">1224</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ProcessADCP.average_ensembles-1225"><a href="#ProcessADCP.average_ensembles-1225"><span class="linenos">1225</span></a>            <span class="n">npings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP.average_ensembles-1226"><a href="#ProcessADCP.average_ensembles-1226"><span class="linenos">1226</span></a>            <span class="k">if</span> <span class="n">nprofs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ProcessADCP.average_ensembles-1227"><a href="#ProcessADCP.average_ensembles-1227"><span class="linenos">1227</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1228"><a href="#ProcessADCP.average_ensembles-1228"><span class="linenos">1228</span></a>                <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1229"><a href="#ProcessADCP.average_ensembles-1229"><span class="linenos">1229</span></a>                <span class="c1"># (pg is not a masked array)</span>
</span><span id="ProcessADCP.average_ensembles-1230"><a href="#ProcessADCP.average_ensembles-1230"><span class="linenos">1230</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1231"><a href="#ProcessADCP.average_ensembles-1231"><span class="linenos">1231</span></a>                <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1232"><a href="#ProcessADCP.average_ensembles-1232"><span class="linenos">1232</span></a>                <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1233"><a href="#ProcessADCP.average_ensembles-1233"><span class="linenos">1233</span></a>                <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1234"><a href="#ProcessADCP.average_ensembles-1234"><span class="linenos">1234</span></a>                <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.average_ensembles-1235"><a href="#ProcessADCP.average_ensembles-1235"><span class="linenos">1235</span></a>                <span class="k">continue</span>
</span><span id="ProcessADCP.average_ensembles-1236"><a href="#ProcessADCP.average_ensembles-1236"><span class="linenos">1236</span></a>
</span><span id="ProcessADCP.average_ensembles-1237"><a href="#ProcessADCP.average_ensembles-1237"><span class="linenos">1237</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1238"><a href="#ProcessADCP.average_ensembles-1238"><span class="linenos">1238</span></a>            <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1239"><a href="#ProcessADCP.average_ensembles-1239"><span class="linenos">1239</span></a>
</span><span id="ProcessADCP.average_ensembles-1240"><a href="#ProcessADCP.average_ensembles-1240"><span class="linenos">1240</span></a>            <span class="n">pgi</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP.average_ensembles-1241"><a href="#ProcessADCP.average_ensembles-1241"><span class="linenos">1241</span></a>            <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1242"><a href="#ProcessADCP.average_ensembles-1242"><span class="linenos">1242</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1243"><a href="#ProcessADCP.average_ensembles-1243"><span class="linenos">1243</span></a>
</span><span id="ProcessADCP.average_ensembles-1244"><a href="#ProcessADCP.average_ensembles-1244"><span class="linenos">1244</span></a>            <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP.average_ensembles-1245"><a href="#ProcessADCP.average_ensembles-1245"><span class="linenos">1245</span></a>            <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="ProcessADCP.average_ensembles-1246"><a href="#ProcessADCP.average_ensembles-1246"><span class="linenos">1246</span></a>            <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="ProcessADCP.average_ensembles-1247"><a href="#ProcessADCP.average_ensembles-1247"><span class="linenos">1247</span></a>            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP.average_ensembles-1248"><a href="#ProcessADCP.average_ensembles-1248"><span class="linenos">1248</span></a>
</span><span id="ProcessADCP.average_ensembles-1249"><a href="#ProcessADCP.average_ensembles-1249"><span class="linenos">1249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="ProcessADCP.average_ensembles-1250"><a href="#ProcessADCP.average_ensembles-1250"><span class="linenos">1250</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1251"><a href="#ProcessADCP.average_ensembles-1251"><span class="linenos">1251</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1252"><a href="#ProcessADCP.average_ensembles-1252"><span class="linenos">1252</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1253"><a href="#ProcessADCP.average_ensembles-1253"><span class="linenos">1253</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1254"><a href="#ProcessADCP.average_ensembles-1254"><span class="linenos">1254</span></a>            <span class="n">u_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1255"><a href="#ProcessADCP.average_ensembles-1255"><span class="linenos">1255</span></a>            <span class="n">v_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1256"><a href="#ProcessADCP.average_ensembles-1256"><span class="linenos">1256</span></a>            <span class="n">w_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1257"><a href="#ProcessADCP.average_ensembles-1257"><span class="linenos">1257</span></a>            <span class="n">e_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP.average_ensembles-1258"><a href="#ProcessADCP.average_ensembles-1258"><span class="linenos">1258</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1259"><a href="#ProcessADCP.average_ensembles-1259"><span class="linenos">1259</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1260"><a href="#ProcessADCP.average_ensembles-1260"><span class="linenos">1260</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1261"><a href="#ProcessADCP.average_ensembles-1261"><span class="linenos">1261</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1262"><a href="#ProcessADCP.average_ensembles-1262"><span class="linenos">1262</span></a>            <span class="n">pressure_std</span><span class="o">=</span><span class="n">pressure_std</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1263"><a href="#ProcessADCP.average_ensembles-1263"><span class="linenos">1263</span></a>            <span class="n">pressure_max</span><span class="o">=</span><span class="n">pressure_max</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1264"><a href="#ProcessADCP.average_ensembles-1264"><span class="linenos">1264</span></a>            <span class="n">npings</span><span class="o">=</span><span class="n">npings</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1265"><a href="#ProcessADCP.average_ensembles-1265"><span class="linenos">1265</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1266"><a href="#ProcessADCP.average_ensembles-1266"><span class="linenos">1266</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1267"><a href="#ProcessADCP.average_ensembles-1267"><span class="linenos">1267</span></a>            <span class="n">dep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1268"><a href="#ProcessADCP.average_ensembles-1268"><span class="linenos">1268</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1269"><a href="#ProcessADCP.average_ensembles-1269"><span class="linenos">1269</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1270"><a href="#ProcessADCP.average_ensembles-1270"><span class="linenos">1270</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1271"><a href="#ProcessADCP.average_ensembles-1271"><span class="linenos">1271</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1272"><a href="#ProcessADCP.average_ensembles-1272"><span class="linenos">1272</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1273"><a href="#ProcessADCP.average_ensembles-1273"><span class="linenos">1273</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP.average_ensembles-1274"><a href="#ProcessADCP.average_ensembles-1274"><span class="linenos">1274</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.average_ensembles-1275"><a href="#ProcessADCP.average_ensembles-1275"><span class="linenos">1275</span></a>
</span><span id="ProcessADCP.average_ensembles-1276"><a href="#ProcessADCP.average_ensembles-1276"><span class="linenos">1276</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="ProcessADCP.average_ensembles-1277"><a href="#ProcessADCP.average_ensembles-1277"><span class="linenos">1277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="ProcessADCP.average_ensembles-1278"><a href="#ProcessADCP.average_ensembles-1278"><span class="linenos">1278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Time-averaging.</p>

<p>Adds results as dictionary under <code>ave</code> and as <code>xarray.Dataset</code> under <code>ds</code>.</p>

<p>Writes processing parameters to the log file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>start</strong> (int):
Range start for averaging. Index into start times of averaging
intervals.</li>
<li><strong>stop</strong> (int):
Range start for averaging. Index into start times of averaging
intervals.</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.burst_average_ensembles" class="classattr">
                                        <input id="ProcessADCP.burst_average_ensembles-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">burst_average_ensembles</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">start</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">stop</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">interpolate_bin</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.burst_average_ensembles-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.burst_average_ensembles"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.burst_average_ensembles-1280"><a href="#ProcessADCP.burst_average_ensembles-1280"><span class="linenos">1280</span></a>    <span class="k">def</span> <span class="nf">burst_average_ensembles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interpolate_bin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ProcessADCP.burst_average_ensembles-1281"><a href="#ProcessADCP.burst_average_ensembles-1281"><span class="linenos">1281</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Time-averaging prior to depth-gridding.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1282"><a href="#ProcessADCP.burst_average_ensembles-1282"><span class="linenos">1282</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1283"><a href="#ProcessADCP.burst_average_ensembles-1283"><span class="linenos">1283</span></a><span class="sd">        Uses pre-defined editing parameters that can be updated with</span>
</span><span id="ProcessADCP.burst_average_ensembles-1284"><a href="#ProcessADCP.burst_average_ensembles-1284"><span class="linenos">1284</span></a><span class="sd">        `parse_editparams`.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1285"><a href="#ProcessADCP.burst_average_ensembles-1285"><span class="linenos">1285</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1286"><a href="#ProcessADCP.burst_average_ensembles-1286"><span class="linenos">1286</span></a><span class="sd">        Adds results as dictionary under `ave` and as `xarray.Dataset` under `ds`.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1287"><a href="#ProcessADCP.burst_average_ensembles-1287"><span class="linenos">1287</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1288"><a href="#ProcessADCP.burst_average_ensembles-1288"><span class="linenos">1288</span></a><span class="sd">        Writes processing parameters to the log file.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1289"><a href="#ProcessADCP.burst_average_ensembles-1289"><span class="linenos">1289</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1290"><a href="#ProcessADCP.burst_average_ensembles-1290"><span class="linenos">1290</span></a><span class="sd">        Parameters</span>
</span><span id="ProcessADCP.burst_average_ensembles-1291"><a href="#ProcessADCP.burst_average_ensembles-1291"><span class="linenos">1291</span></a><span class="sd">        ----------</span>
</span><span id="ProcessADCP.burst_average_ensembles-1292"><a href="#ProcessADCP.burst_average_ensembles-1292"><span class="linenos">1292</span></a><span class="sd">        start : int, optional</span>
</span><span id="ProcessADCP.burst_average_ensembles-1293"><a href="#ProcessADCP.burst_average_ensembles-1293"><span class="linenos">1293</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP.burst_average_ensembles-1294"><a href="#ProcessADCP.burst_average_ensembles-1294"><span class="linenos">1294</span></a><span class="sd">            intervals. Defaults to None (start at beginning).</span>
</span><span id="ProcessADCP.burst_average_ensembles-1295"><a href="#ProcessADCP.burst_average_ensembles-1295"><span class="linenos">1295</span></a><span class="sd">        stop : int, optional</span>
</span><span id="ProcessADCP.burst_average_ensembles-1296"><a href="#ProcessADCP.burst_average_ensembles-1296"><span class="linenos">1296</span></a><span class="sd">            Range start for averaging. Index into start times of averaging</span>
</span><span id="ProcessADCP.burst_average_ensembles-1297"><a href="#ProcessADCP.burst_average_ensembles-1297"><span class="linenos">1297</span></a><span class="sd">            intervals. Defaults to None (start at beginning).</span>
</span><span id="ProcessADCP.burst_average_ensembles-1298"><a href="#ProcessADCP.burst_average_ensembles-1298"><span class="linenos">1298</span></a><span class="sd">        interpolate_bin : int or None, optional</span>
</span><span id="ProcessADCP.burst_average_ensembles-1299"><a href="#ProcessADCP.burst_average_ensembles-1299"><span class="linenos">1299</span></a><span class="sd">            Interpolate over a single, previously masked, bin. Defaults to None (no interpolation).</span>
</span><span id="ProcessADCP.burst_average_ensembles-1300"><a href="#ProcessADCP.burst_average_ensembles-1300"><span class="linenos">1300</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1301"><a href="#ProcessADCP.burst_average_ensembles-1301"><span class="linenos">1301</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ProcessADCP.burst_average_ensembles-1302"><a href="#ProcessADCP.burst_average_ensembles-1302"><span class="linenos">1302</span></a>        <span class="n">pg_condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="o">.</span><span class="n">pg_limit</span>
</span><span id="ProcessADCP.burst_average_ensembles-1303"><a href="#ProcessADCP.burst_average_ensembles-1303"><span class="linenos">1303</span></a>        <span class="n">nens_orig</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_ddays</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1304"><a href="#ProcessADCP.burst_average_ensembles-1304"><span class="linenos">1304</span></a>        <span class="n">indices_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nens_orig</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1305"><a href="#ProcessADCP.burst_average_ensembles-1305"><span class="linenos">1305</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices_orig</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP.burst_average_ensembles-1306"><a href="#ProcessADCP.burst_average_ensembles-1306"><span class="linenos">1306</span></a>        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1307"><a href="#ProcessADCP.burst_average_ensembles-1307"><span class="linenos">1307</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Averaging all ensembles&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1308"><a href="#ProcessADCP.burst_average_ensembles-1308"><span class="linenos">1308</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1309"><a href="#ProcessADCP.burst_average_ensembles-1309"><span class="linenos">1309</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Averaging ensembles </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1310"><a href="#ProcessADCP.burst_average_ensembles-1310"><span class="linenos">1310</span></a>        <span class="n">nens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1311"><a href="#ProcessADCP.burst_average_ensembles-1311"><span class="linenos">1311</span></a>        <span class="n">ndgrid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1312"><a href="#ProcessADCP.burst_average_ensembles-1312"><span class="linenos">1312</span></a>        <span class="n">uvwe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1313"><a href="#ProcessADCP.burst_average_ensembles-1313"><span class="linenos">1313</span></a>        <span class="n">uvwe_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1314"><a href="#ProcessADCP.burst_average_ensembles-1314"><span class="linenos">1314</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1315"><a href="#ProcessADCP.burst_average_ensembles-1315"><span class="linenos">1315</span></a>        <span class="n">pg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1316"><a href="#ProcessADCP.burst_average_ensembles-1316"><span class="linenos">1316</span></a>        <span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,</span> <span class="n">ndgrid</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1317"><a href="#ProcessADCP.burst_average_ensembles-1317"><span class="linenos">1317</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1318"><a href="#ProcessADCP.burst_average_ensembles-1318"><span class="linenos">1318</span></a>        <span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1319"><a href="#ProcessADCP.burst_average_ensembles-1319"><span class="linenos">1319</span></a>        <span class="n">pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1320"><a href="#ProcessADCP.burst_average_ensembles-1320"><span class="linenos">1320</span></a>        <span class="n">pressure_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1321"><a href="#ProcessADCP.burst_average_ensembles-1321"><span class="linenos">1321</span></a>        <span class="n">pressure_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1322"><a href="#ProcessADCP.burst_average_ensembles-1322"><span class="linenos">1322</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1323"><a href="#ProcessADCP.burst_average_ensembles-1323"><span class="linenos">1323</span></a>        <span class="n">npings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nens</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1324"><a href="#ProcessADCP.burst_average_ensembles-1324"><span class="linenos">1324</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1325"><a href="#ProcessADCP.burst_average_ensembles-1325"><span class="linenos">1325</span></a>        <span class="n">dday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dday_mid</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
</span><span id="ProcessADCP.burst_average_ensembles-1326"><a href="#ProcessADCP.burst_average_ensembles-1326"><span class="linenos">1326</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1327"><a href="#ProcessADCP.burst_average_ensembles-1327"><span class="linenos">1327</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
</span><span id="ProcessADCP.burst_average_ensembles-1328"><a href="#ProcessADCP.burst_average_ensembles-1328"><span class="linenos">1328</span></a>            <span class="n">ens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ensemble</span><span class="p">(</span><span class="n">iens</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1329"><a href="#ProcessADCP.burst_average_ensembles-1329"><span class="linenos">1329</span></a>            <span class="k">if</span> <span class="n">ens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1330"><a href="#ProcessADCP.burst_average_ensembles-1330"><span class="linenos">1330</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_edit</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># modifies xyze</span>
</span><span id="ProcessADCP.burst_average_ensembles-1331"><a href="#ProcessADCP.burst_average_ensembles-1331"><span class="linenos">1331</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_to_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>  <span class="c1"># transform to earth coords (east, north, up)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1332"><a href="#ProcessADCP.burst_average_ensembles-1332"><span class="linenos">1332</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_enu</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1333"><a href="#ProcessADCP.burst_average_ensembles-1333"><span class="linenos">1333</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_regrid_amp</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1334"><a href="#ProcessADCP.burst_average_ensembles-1334"><span class="linenos">1334</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1335"><a href="#ProcessADCP.burst_average_ensembles-1335"><span class="linenos">1335</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.burst_average_ensembles-1336"><a href="#ProcessADCP.burst_average_ensembles-1336"><span class="linenos">1336</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1337"><a href="#ProcessADCP.burst_average_ensembles-1337"><span class="linenos">1337</span></a>                <span class="n">nprofs</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ProcessADCP.burst_average_ensembles-1338"><a href="#ProcessADCP.burst_average_ensembles-1338"><span class="linenos">1338</span></a>            <span class="n">npings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP.burst_average_ensembles-1339"><a href="#ProcessADCP.burst_average_ensembles-1339"><span class="linenos">1339</span></a>            <span class="k">if</span> <span class="n">nprofs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1340"><a href="#ProcessADCP.burst_average_ensembles-1340"><span class="linenos">1340</span></a>                <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1341"><a href="#ProcessADCP.burst_average_ensembles-1341"><span class="linenos">1341</span></a>                <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1342"><a href="#ProcessADCP.burst_average_ensembles-1342"><span class="linenos">1342</span></a>                <span class="c1"># (pg is not a masked array)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1343"><a href="#ProcessADCP.burst_average_ensembles-1343"><span class="linenos">1343</span></a>                <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1344"><a href="#ProcessADCP.burst_average_ensembles-1344"><span class="linenos">1344</span></a>                <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1345"><a href="#ProcessADCP.burst_average_ensembles-1345"><span class="linenos">1345</span></a>                <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1346"><a href="#ProcessADCP.burst_average_ensembles-1346"><span class="linenos">1346</span></a>                <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1347"><a href="#ProcessADCP.burst_average_ensembles-1347"><span class="linenos">1347</span></a>                <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1348"><a href="#ProcessADCP.burst_average_ensembles-1348"><span class="linenos">1348</span></a>                <span class="k">continue</span>
</span><span id="ProcessADCP.burst_average_ensembles-1349"><a href="#ProcessADCP.burst_average_ensembles-1349"><span class="linenos">1349</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1350"><a href="#ProcessADCP.burst_average_ensembles-1350"><span class="linenos">1350</span></a>            <span class="c1"># Depth vector for interpolation</span>
</span><span id="ProcessADCP.burst_average_ensembles-1351"><a href="#ProcessADCP.burst_average_ensembles-1351"><span class="linenos">1351</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_burst_average_depth</span><span class="p">(</span><span class="n">ens</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1352"><a href="#ProcessADCP.burst_average_ensembles-1352"><span class="linenos">1352</span></a>            <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="ProcessADCP.burst_average_ensembles-1353"><a href="#ProcessADCP.burst_average_ensembles-1353"><span class="linenos">1353</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1354"><a href="#ProcessADCP.burst_average_ensembles-1354"><span class="linenos">1354</span></a>            <span class="c1"># Calculate burst-average on instrument-relative depth grid</span>
</span><span id="ProcessADCP.burst_average_ensembles-1355"><a href="#ProcessADCP.burst_average_ensembles-1355"><span class="linenos">1355</span></a>            <span class="n">uvwe_inst</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1356"><a href="#ProcessADCP.burst_average_ensembles-1356"><span class="linenos">1356</span></a>            <span class="n">uvwe_std_inst</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1357"><a href="#ProcessADCP.burst_average_ensembles-1357"><span class="linenos">1357</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1358"><a href="#ProcessADCP.burst_average_ensembles-1358"><span class="linenos">1358</span></a>            <span class="n">pgi_inst</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">ens</span><span class="o">.</span><span class="n">enu</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">//</span> <span class="n">nprofs</span>
</span><span id="ProcessADCP.burst_average_ensembles-1359"><a href="#ProcessADCP.burst_average_ensembles-1359"><span class="linenos">1359</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1360"><a href="#ProcessADCP.burst_average_ensembles-1360"><span class="linenos">1360</span></a>            <span class="k">if</span> <span class="n">pg_condition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1361"><a href="#ProcessADCP.burst_average_ensembles-1361"><span class="linenos">1361</span></a>                <span class="n">pgi_index</span> <span class="o">=</span> <span class="n">pgi_inst</span> <span class="o">&lt;</span> <span class="n">pg_condition</span>
</span><span id="ProcessADCP.burst_average_ensembles-1362"><a href="#ProcessADCP.burst_average_ensembles-1362"><span class="linenos">1362</span></a>                <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">pgi_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1363"><a href="#ProcessADCP.burst_average_ensembles-1363"><span class="linenos">1363</span></a>                <span class="n">uvwe_std_inst</span><span class="p">[</span><span class="n">pgi_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
</span><span id="ProcessADCP.burst_average_ensembles-1364"><a href="#ProcessADCP.burst_average_ensembles-1364"><span class="linenos">1364</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1365"><a href="#ProcessADCP.burst_average_ensembles-1365"><span class="linenos">1365</span></a>            <span class="k">if</span> <span class="n">interpolate_bin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ProcessADCP.burst_average_ensembles-1366"><a href="#ProcessADCP.burst_average_ensembles-1366"><span class="linenos">1366</span></a>                <span class="n">zi</span> <span class="o">=</span> <span class="n">interpolate_bin</span>
</span><span id="ProcessADCP.burst_average_ensembles-1367"><a href="#ProcessADCP.burst_average_ensembles-1367"><span class="linenos">1367</span></a>                <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">zi</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">zi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zi</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="ProcessADCP.burst_average_ensembles-1368"><a href="#ProcessADCP.burst_average_ensembles-1368"><span class="linenos">1368</span></a>                <span class="n">dtmp</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span>
</span><span id="ProcessADCP.burst_average_ensembles-1369"><a href="#ProcessADCP.burst_average_ensembles-1369"><span class="linenos">1369</span></a>                <span class="n">tmp</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="ProcessADCP.burst_average_ensembles-1370"><a href="#ProcessADCP.burst_average_ensembles-1370"><span class="linenos">1370</span></a>                    <span class="n">dtmp</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1371"><a href="#ProcessADCP.burst_average_ensembles-1371"><span class="linenos">1371</span></a>                    <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">neighbors</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1372"><a href="#ProcessADCP.burst_average_ensembles-1372"><span class="linenos">1372</span></a>                    <span class="n">depth</span><span class="p">[</span><span class="n">zi</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1373"><a href="#ProcessADCP.burst_average_ensembles-1373"><span class="linenos">1373</span></a>                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1374"><a href="#ProcessADCP.burst_average_ensembles-1374"><span class="linenos">1374</span></a>                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1375"><a href="#ProcessADCP.burst_average_ensembles-1375"><span class="linenos">1375</span></a>                <span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1376"><a href="#ProcessADCP.burst_average_ensembles-1376"><span class="linenos">1376</span></a>                <span class="n">uvwe_inst</span><span class="p">[</span><span class="n">zi</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tmp</span>
</span><span id="ProcessADCP.burst_average_ensembles-1377"><a href="#ProcessADCP.burst_average_ensembles-1377"><span class="linenos">1377</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1378"><a href="#ProcessADCP.burst_average_ensembles-1378"><span class="linenos">1378</span></a>            <span class="c1"># Interpolate burst-average to universal depth grid.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1379"><a href="#ProcessADCP.burst_average_ensembles-1379"><span class="linenos">1379</span></a>            <span class="n">uvwe_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">uvwe_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1380"><a href="#ProcessADCP.burst_average_ensembles-1380"><span class="linenos">1380</span></a>            <span class="n">uvwe_std_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span>
</span><span id="ProcessADCP.burst_average_ensembles-1381"><a href="#ProcessADCP.burst_average_ensembles-1381"><span class="linenos">1381</span></a>                <span class="n">depth</span><span class="p">,</span> <span class="n">uvwe_std_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
</span><span id="ProcessADCP.burst_average_ensembles-1382"><a href="#ProcessADCP.burst_average_ensembles-1382"><span class="linenos">1382</span></a>            <span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1383"><a href="#ProcessADCP.burst_average_ensembles-1383"><span class="linenos">1383</span></a>            <span class="n">uvwe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvwe_grid</span>
</span><span id="ProcessADCP.burst_average_ensembles-1384"><a href="#ProcessADCP.burst_average_ensembles-1384"><span class="linenos">1384</span></a>            <span class="n">uvwe_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvwe_std_grid</span>
</span><span id="ProcessADCP.burst_average_ensembles-1385"><a href="#ProcessADCP.burst_average_ensembles-1385"><span class="linenos">1385</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1386"><a href="#ProcessADCP.burst_average_ensembles-1386"><span class="linenos">1386</span></a>            <span class="c1"># Interpolate pg to universal depth grid. Not overly satisfying but</span>
</span><span id="ProcessADCP.burst_average_ensembles-1387"><a href="#ProcessADCP.burst_average_ensembles-1387"><span class="linenos">1387</span></a>            <span class="c1"># seems like that&#39;s what we need to do here.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1388"><a href="#ProcessADCP.burst_average_ensembles-1388"><span class="linenos">1388</span></a>            <span class="n">pgi_grid</span> <span class="o">=</span> <span class="n">interp1</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">pgi_inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1389"><a href="#ProcessADCP.burst_average_ensembles-1389"><span class="linenos">1389</span></a>            <span class="n">pg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi_grid</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1390"><a href="#ProcessADCP.burst_average_ensembles-1390"><span class="linenos">1390</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1391"><a href="#ProcessADCP.burst_average_ensembles-1391"><span class="linenos">1391</span></a>            <span class="c1"># Not changed to averaging in instrument-relative coordinates first.</span>
</span><span id="ProcessADCP.burst_average_ensembles-1392"><a href="#ProcessADCP.burst_average_ensembles-1392"><span class="linenos">1392</span></a>            <span class="n">amp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">amp_grid</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1393"><a href="#ProcessADCP.burst_average_ensembles-1393"><span class="linenos">1393</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1394"><a href="#ProcessADCP.burst_average_ensembles-1394"><span class="linenos">1394</span></a>            <span class="n">pressure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP.burst_average_ensembles-1395"><a href="#ProcessADCP.burst_average_ensembles-1395"><span class="linenos">1395</span></a>            <span class="n">pressure_std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="ProcessADCP.burst_average_ensembles-1396"><a href="#ProcessADCP.burst_average_ensembles-1396"><span class="linenos">1396</span></a>            <span class="n">pressure_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="ProcessADCP.burst_average_ensembles-1397"><a href="#ProcessADCP.burst_average_ensembles-1397"><span class="linenos">1397</span></a>            <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ProcessADCP.burst_average_ensembles-1398"><a href="#ProcessADCP.burst_average_ensembles-1398"><span class="linenos">1398</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1399"><a href="#ProcessADCP.burst_average_ensembles-1399"><span class="linenos">1399</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ave</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span>
</span><span id="ProcessADCP.burst_average_ensembles-1400"><a href="#ProcessADCP.burst_average_ensembles-1400"><span class="linenos">1400</span></a>            <span class="n">u</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1401"><a href="#ProcessADCP.burst_average_ensembles-1401"><span class="linenos">1401</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1402"><a href="#ProcessADCP.burst_average_ensembles-1402"><span class="linenos">1402</span></a>            <span class="n">w</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1403"><a href="#ProcessADCP.burst_average_ensembles-1403"><span class="linenos">1403</span></a>            <span class="n">e</span><span class="o">=</span><span class="n">uvwe</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1404"><a href="#ProcessADCP.burst_average_ensembles-1404"><span class="linenos">1404</span></a>            <span class="n">u_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1405"><a href="#ProcessADCP.burst_average_ensembles-1405"><span class="linenos">1405</span></a>            <span class="n">v_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1406"><a href="#ProcessADCP.burst_average_ensembles-1406"><span class="linenos">1406</span></a>            <span class="n">w_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1407"><a href="#ProcessADCP.burst_average_ensembles-1407"><span class="linenos">1407</span></a>            <span class="n">e_std</span><span class="o">=</span><span class="n">uvwe_std</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="ProcessADCP.burst_average_ensembles-1408"><a href="#ProcessADCP.burst_average_ensembles-1408"><span class="linenos">1408</span></a>            <span class="n">pg</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1409"><a href="#ProcessADCP.burst_average_ensembles-1409"><span class="linenos">1409</span></a>            <span class="n">amp</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1410"><a href="#ProcessADCP.burst_average_ensembles-1410"><span class="linenos">1410</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1411"><a href="#ProcessADCP.burst_average_ensembles-1411"><span class="linenos">1411</span></a>            <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1412"><a href="#ProcessADCP.burst_average_ensembles-1412"><span class="linenos">1412</span></a>            <span class="n">pressure_std</span><span class="o">=</span><span class="n">pressure_std</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1413"><a href="#ProcessADCP.burst_average_ensembles-1413"><span class="linenos">1413</span></a>            <span class="n">pressure_max</span><span class="o">=</span><span class="n">pressure_max</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1414"><a href="#ProcessADCP.burst_average_ensembles-1414"><span class="linenos">1414</span></a>            <span class="n">npings</span><span class="o">=</span><span class="n">npings</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1415"><a href="#ProcessADCP.burst_average_ensembles-1415"><span class="linenos">1415</span></a>            <span class="n">dday</span><span class="o">=</span><span class="n">dday</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1416"><a href="#ProcessADCP.burst_average_ensembles-1416"><span class="linenos">1416</span></a>            <span class="n">yearbase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">yearbase</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1417"><a href="#ProcessADCP.burst_average_ensembles-1417"><span class="linenos">1417</span></a>            <span class="n">dep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgrid</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1418"><a href="#ProcessADCP.burst_average_ensembles-1418"><span class="linenos">1418</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editparams</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1419"><a href="#ProcessADCP.burst_average_ensembles-1419"><span class="linenos">1419</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1420"><a href="#ProcessADCP.burst_average_ensembles-1420"><span class="linenos">1420</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgridparams</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1421"><a href="#ProcessADCP.burst_average_ensembles-1421"><span class="linenos">1421</span></a>            <span class="n">magdec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magdec</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1422"><a href="#ProcessADCP.burst_average_ensembles-1422"><span class="linenos">1422</span></a>            <span class="n">lon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1423"><a href="#ProcessADCP.burst_average_ensembles-1423"><span class="linenos">1423</span></a>            <span class="n">lat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
</span><span id="ProcessADCP.burst_average_ensembles-1424"><a href="#ProcessADCP.burst_average_ensembles-1424"><span class="linenos">1424</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.burst_average_ensembles-1425"><a href="#ProcessADCP.burst_average_ensembles-1425"><span class="linenos">1425</span></a>
</span><span id="ProcessADCP.burst_average_ensembles-1426"><a href="#ProcessADCP.burst_average_ensembles-1426"><span class="linenos">1426</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ave2nc</span><span class="p">()</span>
</span><span id="ProcessADCP.burst_average_ensembles-1427"><a href="#ProcessADCP.burst_average_ensembles-1427"><span class="linenos">1427</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_meta_data_to_ds</span><span class="p">()</span>
</span><span id="ProcessADCP.burst_average_ensembles-1428"><a href="#ProcessADCP.burst_average_ensembles-1428"><span class="linenos">1428</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_processing_params</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Time-averaging prior to depth-gridding.</p>

<p>Uses pre-defined editing parameters that can be updated with
<code><a href="#ProcessADCP.parse_editparams">parse_editparams</a></code>.</p>

<p>Adds results as dictionary under <code>ave</code> and as <code>xarray.Dataset</code> under <code>ds</code>.</p>

<p>Writes processing parameters to the log file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>start</strong> (int, optional):
Range start for averaging. Index into start times of averaging
intervals. Defaults to None (start at beginning).</li>
<li><strong>stop</strong> (int, optional):
Range start for averaging. Index into start times of averaging
intervals. Defaults to None (start at beginning).</li>
<li><strong>interpolate_bin</strong> (int or None, optional):
Interpolate over a single, previously masked, bin. Defaults to None (no interpolation).</li>
</ul>
</div>


                            </div>
                            <div id="ProcessADCP.plot_echo_stats" class="classattr">
                                        <input id="ProcessADCP.plot_echo_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_echo_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.plot_echo_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.plot_echo_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.plot_echo_stats-1624"><a href="#ProcessADCP.plot_echo_stats-1624"><span class="linenos">1624</span></a>    <span class="k">def</span> <span class="nf">plot_echo_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.plot_echo_stats-1625"><a href="#ProcessADCP.plot_echo_stats-1625"><span class="linenos">1625</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot beam statistics (correlation and amplitude) from raw ADCP data.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP.plot_echo_stats-1626"><a href="#ProcessADCP.plot_echo_stats-1626"><span class="linenos">1626</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>
</span><span id="ProcessADCP.plot_echo_stats-1627"><a href="#ProcessADCP.plot_echo_stats-1627"><span class="linenos">1627</span></a>
</span><span id="ProcessADCP.plot_echo_stats-1628"><a href="#ProcessADCP.plot_echo_stats-1628"><span class="linenos">1628</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="ProcessADCP.plot_echo_stats-1629"><a href="#ProcessADCP.plot_echo_stats-1629"><span class="linenos">1629</span></a>            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1630"><a href="#ProcessADCP.plot_echo_stats-1630"><span class="linenos">1630</span></a>            <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1631"><a href="#ProcessADCP.plot_echo_stats-1631"><span class="linenos">1631</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">),</span>
</span><span id="ProcessADCP.plot_echo_stats-1632"><a href="#ProcessADCP.plot_echo_stats-1632"><span class="linenos">1632</span></a>            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1633"><a href="#ProcessADCP.plot_echo_stats-1633"><span class="linenos">1633</span></a>            <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1634"><a href="#ProcessADCP.plot_echo_stats-1634"><span class="linenos">1634</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.plot_echo_stats-1635"><a href="#ProcessADCP.plot_echo_stats-1635"><span class="linenos">1635</span></a>        <span class="n">r</span><span class="o">.</span><span class="n">cor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="ProcessADCP.plot_echo_stats-1636"><a href="#ProcessADCP.plot_echo_stats-1636"><span class="linenos">1636</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProcessADCP.plot_echo_stats-1637"><a href="#ProcessADCP.plot_echo_stats-1637"><span class="linenos">1637</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.plot_echo_stats-1638"><a href="#ProcessADCP.plot_echo_stats-1638"><span class="linenos">1638</span></a>        <span class="n">r</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="ProcessADCP.plot_echo_stats-1639"><a href="#ProcessADCP.plot_echo_stats-1639"><span class="linenos">1639</span></a>            <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;beam&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1640"><a href="#ProcessADCP.plot_echo_stats-1640"><span class="linenos">1640</span></a>            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1641"><a href="#ProcessADCP.plot_echo_stats-1641"><span class="linenos">1641</span></a>            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1642"><a href="#ProcessADCP.plot_echo_stats-1642"><span class="linenos">1642</span></a>            <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1643"><a href="#ProcessADCP.plot_echo_stats-1643"><span class="linenos">1643</span></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1644"><a href="#ProcessADCP.plot_echo_stats-1644"><span class="linenos">1644</span></a>            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="ProcessADCP.plot_echo_stats-1645"><a href="#ProcessADCP.plot_echo_stats-1645"><span class="linenos">1645</span></a>            <span class="n">add_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_echo_stats-1646"><a href="#ProcessADCP.plot_echo_stats-1646"><span class="linenos">1646</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.plot_echo_stats-1647"><a href="#ProcessADCP.plot_echo_stats-1647"><span class="linenos">1647</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</span><span id="ProcessADCP.plot_echo_stats-1648"><a href="#ProcessADCP.plot_echo_stats-1648"><span class="linenos">1648</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.plot_echo_stats-1649"><a href="#ProcessADCP.plot_echo_stats-1649"><span class="linenos">1649</span></a>        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span id="ProcessADCP.plot_echo_stats-1650"><a href="#ProcessADCP.plot_echo_stats-1650"><span class="linenos">1650</span></a>        <span class="k">for</span> <span class="n">axi</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
</span><span id="ProcessADCP.plot_echo_stats-1651"><a href="#ProcessADCP.plot_echo_stats-1651"><span class="linenos">1651</span></a>            <span class="n">axi</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Plot beam statistics (correlation and amplitude) from raw ADCP data.</p>
</div>


                            </div>
                            <div id="ProcessADCP.plot_pressure" class="classattr">
                                        <input id="ProcessADCP.plot_pressure-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_pressure</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.plot_pressure-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.plot_pressure"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.plot_pressure-1653"><a href="#ProcessADCP.plot_pressure-1653"><span class="linenos">1653</span></a>    <span class="k">def</span> <span class="nf">plot_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ProcessADCP.plot_pressure-1654"><a href="#ProcessADCP.plot_pressure-1654"><span class="linenos">1654</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot pressure time series and mark time at depth.&quot;&quot;&quot;</span>
</span><span id="ProcessADCP.plot_pressure-1655"><a href="#ProcessADCP.plot_pressure-1655"><span class="linenos">1655</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
</span><span id="ProcessADCP.plot_pressure-1656"><a href="#ProcessADCP.plot_pressure-1656"><span class="linenos">1656</span></a>            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_pressure-1657"><a href="#ProcessADCP.plot_pressure-1657"><span class="linenos">1657</span></a>            <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_pressure-1658"><a href="#ProcessADCP.plot_pressure-1658"><span class="linenos">1658</span></a>            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
</span><span id="ProcessADCP.plot_pressure-1659"><a href="#ProcessADCP.plot_pressure-1659"><span class="linenos">1659</span></a>            <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="ProcessADCP.plot_pressure-1660"><a href="#ProcessADCP.plot_pressure-1660"><span class="linenos">1660</span></a>        <span class="p">)</span>
</span><span id="ProcessADCP.plot_pressure-1661"><a href="#ProcessADCP.plot_pressure-1661"><span class="linenos">1661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.plot_pressure-1662"><a href="#ProcessADCP.plot_pressure-1662"><span class="linenos">1662</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">pressure</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;subsurface&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.plot_pressure-1663"><a href="#ProcessADCP.plot_pressure-1663"><span class="linenos">1663</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</span><span id="ProcessADCP.plot_pressure-1664"><a href="#ProcessADCP.plot_pressure-1664"><span class="linenos">1664</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;pressure [dbar]&quot;</span><span class="p">)</span>
</span><span id="ProcessADCP.plot_pressure-1665"><a href="#ProcessADCP.plot_pressure-1665"><span class="linenos">1665</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Plot pressure time series and mark time at depth.</p>
</div>


                            </div>
                            <div id="ProcessADCP.generate_binmask" class="classattr">
                                        <input id="ProcessADCP.generate_binmask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_binmask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">indices</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProcessADCP.generate_binmask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCP.generate_binmask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCP.generate_binmask-1667"><a href="#ProcessADCP.generate_binmask-1667"><span class="linenos">1667</span></a>    <span class="k">def</span> <span class="nf">generate_binmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
</span><span id="ProcessADCP.generate_binmask-1668"><a href="#ProcessADCP.generate_binmask-1668"><span class="linenos">1668</span></a>        <span class="n">binmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">bin</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="ProcessADCP.generate_binmask-1669"><a href="#ProcessADCP.generate_binmask-1669"><span class="linenos">1669</span></a>        <span class="n">binmask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="ProcessADCP.generate_binmask-1670"><a href="#ProcessADCP.generate_binmask-1670"><span class="linenos">1670</span></a>        <span class="k">return</span> <span class="n">binmask</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="ProcessADCPyml">
                            <input id="ProcessADCPyml-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ProcessADCPyml</span><wbr>(<span class="base"><a href="#ProcessADCP">ProcessADCP</a></span>):

                <label class="view-source-button" for="ProcessADCPyml-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCPyml"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCPyml-1673"><a href="#ProcessADCPyml-1673"><span class="linenos">1673</span></a><span class="k">class</span> <span class="nc">ProcessADCPyml</span><span class="p">(</span><span class="n">ProcessADCP</span><span class="p">):</span>
</span><span id="ProcessADCPyml-1674"><a href="#ProcessADCPyml-1674"><span class="linenos">1674</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Moored ADCP processing with parameters provided via .yml file.</span>
</span><span id="ProcessADCPyml-1675"><a href="#ProcessADCPyml-1675"><span class="linenos">1675</span></a>
</span><span id="ProcessADCPyml-1676"><a href="#ProcessADCPyml-1676"><span class="linenos">1676</span></a><span class="sd">    An example parameter file is included at</span>
</span><span id="ProcessADCPyml-1677"><a href="#ProcessADCPyml-1677"><span class="linenos">1677</span></a><span class="sd">    [`notebooks/parameters.yml`](https://github.com/modscripps/velosearaptor/tree/main/notebooks/parameters.yml)</span>
</span><span id="ProcessADCPyml-1678"><a href="#ProcessADCPyml-1678"><span class="linenos">1678</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ProcessADCPyml-1679"><a href="#ProcessADCPyml-1679"><span class="linenos">1679</span></a>
</span><span id="ProcessADCPyml-1680"><a href="#ProcessADCPyml-1680"><span class="linenos">1680</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_file</span><span class="p">,</span> <span class="n">mooring</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ProcessADCPyml-1681"><a href="#ProcessADCPyml-1681"><span class="linenos">1681</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">parse_yaml_input</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="n">mooring</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span><span id="ProcessADCPyml-1682"><a href="#ProcessADCPyml-1682"><span class="linenos">1682</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ProcessADCPyml-1683"><a href="#ProcessADCPyml-1683"><span class="linenos">1683</span></a>            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml-1684"><a href="#ProcessADCPyml-1684"><span class="linenos">1684</span></a>            <span class="n">meta_data</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml-1685"><a href="#ProcessADCPyml-1685"><span class="linenos">1685</span></a>            <span class="n">driftparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;driftparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml-1686"><a href="#ProcessADCPyml-1686"><span class="linenos">1686</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;tgridparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml-1687"><a href="#ProcessADCPyml-1687"><span class="linenos">1687</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;dgridparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml-1688"><a href="#ProcessADCPyml-1688"><span class="linenos">1688</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;editparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml-1689"><a href="#ProcessADCPyml-1689"><span class="linenos">1689</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ProcessADCPyml-1690"><a href="#ProcessADCPyml-1690"><span class="linenos">1690</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Moored ADCP processing with parameters provided via .yml file.</p>

<p>An example parameter file is included at
<a href="https://github.com/modscripps/velosearaptor/tree/main/notebooks/parameters.yml"><code>notebooks/parameters.yml</code></a></p>
</div>


                            <div id="ProcessADCPyml.__init__" class="classattr">
                                        <input id="ProcessADCPyml.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ProcessADCPyml</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">parameter_file</span>, </span><span class="param"><span class="n">mooring</span>, </span><span class="param"><span class="n">sn</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="ProcessADCPyml.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProcessADCPyml.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProcessADCPyml.__init__-1680"><a href="#ProcessADCPyml.__init__-1680"><span class="linenos">1680</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_file</span><span class="p">,</span> <span class="n">mooring</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ProcessADCPyml.__init__-1681"><a href="#ProcessADCPyml.__init__-1681"><span class="linenos">1681</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">parse_yaml_input</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">,</span> <span class="n">mooring</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span><span id="ProcessADCPyml.__init__-1682"><a href="#ProcessADCPyml.__init__-1682"><span class="linenos">1682</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ProcessADCPyml.__init__-1683"><a href="#ProcessADCPyml.__init__-1683"><span class="linenos">1683</span></a>            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml.__init__-1684"><a href="#ProcessADCPyml.__init__-1684"><span class="linenos">1684</span></a>            <span class="n">meta_data</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;meta_data&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml.__init__-1685"><a href="#ProcessADCPyml.__init__-1685"><span class="linenos">1685</span></a>            <span class="n">driftparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;driftparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml.__init__-1686"><a href="#ProcessADCPyml.__init__-1686"><span class="linenos">1686</span></a>            <span class="n">tgridparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;tgridparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml.__init__-1687"><a href="#ProcessADCPyml.__init__-1687"><span class="linenos">1687</span></a>            <span class="n">dgridparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;dgridparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml.__init__-1688"><a href="#ProcessADCPyml.__init__-1688"><span class="linenos">1688</span></a>            <span class="n">editparams</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;editparams&quot;</span><span class="p">],</span>
</span><span id="ProcessADCPyml.__init__-1689"><a href="#ProcessADCPyml.__init__-1689"><span class="linenos">1689</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ProcessADCPyml.__init__-1690"><a href="#ProcessADCPyml.__init__-1690"><span class="linenos">1690</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ProcessADCP">ProcessADCP</a></dt>
                                <dd id="ProcessADCPyml.meta_data" class="variable"><a href="#ProcessADCP.meta_data">meta_data</a></dd>
                <dd id="ProcessADCPyml.ibad" class="variable"><a href="#ProcessADCP.ibad">ibad</a></dd>
                <dd id="ProcessADCPyml.logdir" class="variable"><a href="#ProcessADCP.logdir">logdir</a></dd>
                <dd id="ProcessADCPyml.verbose" class="variable"><a href="#ProcessADCP.verbose">verbose</a></dd>
                <dd id="ProcessADCPyml.parse_file_locations" class="function"><a href="#ProcessADCP.parse_file_locations">parse_file_locations</a></dd>
                <dd id="ProcessADCPyml.pressure_lp" class="variable"><a href="#ProcessADCP.pressure_lp">pressure_lp</a></dd>
                <dd id="ProcessADCPyml.default_dgridparams" class="variable"><a href="#ProcessADCP.default_dgridparams">default_dgridparams</a></dd>
                <dd id="ProcessADCPyml.parse_dgridparams" class="function"><a href="#ProcessADCP.parse_dgridparams">parse_dgridparams</a></dd>
                <dd id="ProcessADCPyml.parse_tgridparams" class="function"><a href="#ProcessADCP.parse_tgridparams">parse_tgridparams</a></dd>
                <dd id="ProcessADCPyml.parse_editparams" class="function"><a href="#ProcessADCP.parse_editparams">parse_editparams</a></dd>
                <dd id="ProcessADCPyml.parse_driftparams" class="function"><a href="#ProcessADCP.parse_driftparams">parse_driftparams</a></dd>
                <dd id="ProcessADCPyml.make_start_ddays" class="function"><a href="#ProcessADCP.make_start_ddays">make_start_ddays</a></dd>
                <dd id="ProcessADCPyml.read_ensemble" class="function"><a href="#ProcessADCP.read_ensemble">read_ensemble</a></dd>
                <dd id="ProcessADCPyml.magdec" class="variable"><a href="#ProcessADCP.magdec">magdec</a></dd>
                <dd id="ProcessADCPyml.raw" class="variable"><a href="#ProcessADCP.raw">raw</a></dd>
                <dd id="ProcessADCPyml.process_pings" class="function"><a href="#ProcessADCP.process_pings">process_pings</a></dd>
                <dd id="ProcessADCPyml.average_ensembles" class="function"><a href="#ProcessADCP.average_ensembles">average_ensembles</a></dd>
                <dd id="ProcessADCPyml.burst_average_ensembles" class="function"><a href="#ProcessADCP.burst_average_ensembles">burst_average_ensembles</a></dd>
                <dd id="ProcessADCPyml.plot_echo_stats" class="function"><a href="#ProcessADCP.plot_echo_stats">plot_echo_stats</a></dd>
                <dd id="ProcessADCPyml.plot_pressure" class="function"><a href="#ProcessADCP.plot_pressure">plot_pressure</a></dd>
                <dd id="ProcessADCPyml.generate_binmask" class="function"><a href="#ProcessADCP.generate_binmask">generate_binmask</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>